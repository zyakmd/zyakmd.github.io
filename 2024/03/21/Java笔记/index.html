<!-- build time:Sat Apr 13 2024 21:44:04 GMT+0800 (中国标准时间) --><!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><link rel="alternate" type="application/rss+xml" title="世界上只有一种真正的英雄主义，就是认清了生活的真相后还依然热爱它" href="https://zyakmd.github.io/rss.xml"><link rel="alternate" type="application/atom+xml" title="世界上只有一种真正的英雄主义，就是认清了生活的真相后还依然热爱它" href="https://zyakmd.github.io/atom.xml"><link rel="alternate" type="application/json" title="世界上只有一种真正的英雄主义，就是认清了生活的真相后还依然热爱它" href="https://zyakmd.github.io/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="JAVA"><link rel="canonical" href="https://zyakmd.github.io/2024/03/21/Java%E7%AC%94%E8%AE%B0/"><title>Java笔记 | ZY Blog = 世界上只有一种真正的英雄主义，就是认清了生活的真相后还依然热爱它</title><meta name="generator" content="Hexo 5.4.2"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">Java笔记</h1><div class="meta"><span class="item" title="Created: 2024-03-21 21:05:07"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">Posted on</span> <time itemprop="dateCreated datePublished" datetime="2024-03-21T21:05:07+08:00">2024-03-21</time> </span><span class="item" title="Symbols count in article"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">Symbols count in article</span> <span>64k</span> <span class="text">words</span> </span><span class="item" title="Reading time"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">Reading time</span> <span>59 mins.</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="Toggle navigation bar"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">ZY Blog</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://t.mwm.moe/fj?12637"></li><li class="item" data-background-image="https://t.mwm.moe/fj?382042"></li><li class="item" data-background-image="https://t.mwm.moe/fj?429481"></li><li class="item" data-background-image="https://t.mwm.moe/fj?122103"></li><li class="item" data-background-image="https://t.mwm.moe/fj?624521"></li><li class="item" data-background-image="https://t.mwm.moe/fj?416228"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">Home</a></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="en"><link itemprop="mainEntityOfPage" href="https://zyakmd.github.io/2024/03/21/Java%E7%AC%94%E8%AE%B0/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="ZY"><meta itemprop="description" content=", 行到水穷处，坐看云起时"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="世界上只有一种真正的英雄主义，就是认清了生活的真相后还依然热爱它"></span><div class="body md" itemprop="articleBody"><p>记录一些 java 的机制利于复习</p><ul><li><p>JDK（Java Development Kit），它是功能齐全的 Java SDK，是提供给开发者使用，能够创建和编译 Java 程序的开发套件。它包含了 JRE，同时还包含了编译 java 源码的编译器 javac 以及一些其他工具比如 javadoc（文档注释工具）、jdb（调试器）、jconsole（基于 JMX 的可视化监控⼯具）、javap（反编译工具）等等。</p></li><li><p>JRE（Java Runtime Environment） 是 Java 运行时环境。它是运行已编译 Java 程序所需的所有内容的集合，主要包括 Java 虚拟机（JVM）、Java 基础类库（Class Library）。</p></li></ul><p>也就是说，JRE 是 Java 运行时环境，仅包含 Java 应用程序的运行时环境和必要的类库。而 JDK 则包含了 JRE，同时还包括了 javac、javadoc、jdb、jconsole、javap 等工具，可以用于 Java 应用程序的开发和调试。如果需要进行 Java 编程工作，比如编写和编译 Java 程序、使用 Java API 文档等，就需要安装 JDK。而对于某些需要使用 Java 特性的应用程序，如 JSP 转换为 Java Servlet、使用反射等，也需要 JDK 来编译和运行 Java 代码。因此，即使不打算进行 Java 应用程序的开发工作，也有可能需要安装 JDK。</p><p><img data-src="https://oss.javaguide.cn/github/javaguide/java/basis/jdk-include-jre.png" alt=""></p><h1 id="jvm"><a class="anchor" href="#jvm">#</a> JVM</h1><p><img data-src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9pbWctbXkuY3Nkbi5uZXQvdXBsb2Fkcy8yMDEyMTIvMTUvMTM1NTU3MTUwMV85NjY5LmpwZw" alt=""><br>JVM 是 Java Virtual Machine 的缩写，它是一个虚构出来的计算机，一种规范。通过在实际的计算机上仿真模拟各类计算机功能实现</p><p>jvm 虚拟机位于操作系统的堆中，java 程序的运行就是由它管理</p><h2 id="执行过程"><a class="anchor" href="#执行过程">#</a> 执行过程</h2><p><strong>JVM</strong> 是不认识文本文件的，所以它需要一个 <strong>编译</strong> ，让其成为一个它会读二进制文件的 <strong>HelloWorld.class</strong></p><p>Java 源文件通过编译器，能够生产相应的.Class 文件，也就是字节码文件，而字节码文件又通过 Java 虚拟机中的解释器，编译成特定机器上的机器码 。</p><ul><li>Java 源文件 —-&gt; 编译器 —-&gt; 字节码文件</li><li>字节码文件 —-&gt;JVM—-&gt; 机器码</li><li>虚拟机主要的 5 大块：方法区，堆都为线程共享区域，有线程安全问题，栈和本地方法栈和计数器都是独享区域，不存在线程安全问题，而 JVM 的调优主要就是围绕堆，栈两大块进行</li></ul><ol><li><p>类加载器</p><ul><li>如果 <strong>JVM</strong> 想要执行这个 <strong>.class</strong> 文件，我们需要将其装进一个 <strong>类加载器</strong> 中，它就像一个搬运工一样，会把所有的 <strong>.class</strong> 文件全部搬进 JVM 里面来。<br><img data-src="https://static001.geekbang.org/infoq/2f/2f012fde94376f43a25dbe1dd07e0dd8.png" alt=""></li></ul></li><li><p>方法区</p><ul><li><strong>方法区</strong>是用于存放类似于元数据信息方面的数据的，比如类信息，常量，静态变量，编译后代码・・・等</li></ul></li><li><p>堆</p><ul><li><strong>堆</strong> 主要放了一些存储的数据，比如对象实例，数组・・・等，它和方法区都同属于 <strong>线程共享区域</strong> 。也就是说它们都是 <strong>线程不安全</strong> 的</li></ul></li><li><p>栈</p><ul><li><strong>栈</strong> 这是我们的代码运行空间。我们编写的每一个方法都会放到 <strong>栈</strong> 里面运行。<br>我们会听说过 本地方法栈 或者 本地方法接口 这两个名词，不过我们基本不会涉及这两块的内容，它俩底层是使用 C 来进行工作的，和 Java 没有太大的关系。</li></ul></li><li><p>程序计数器</p><ul><li>主要就是完成一个加载工作，类似于一个指针一样的，指向下一行我们需要执行的代码。和栈一样，都是 <strong>线程独享</strong> 的，就是说每一个线程都会有自己对应的一块区域而不会存在并发和多线程的问题。</li></ul></li></ol><p><img data-src="https://static001.geekbang.org/infoq/c6/c602f57ea9297f50bbc265f1821d6263.png" alt=""></p><ul><li>以一个包含 name 属性的学生类 student 为例：</li></ul><blockquote><p>执行 main 方法的步骤如下:</p></blockquote><ol><li>编译好 App.java 后得到 App.class 后，执行 App.class，系统会启动一个 JVM 进程，从 classpath 路径中找到一个名为 App.class 的二进制文件，将 App 的类信息加载到运行时数据区的方法区内，这个过程叫做 App 类的加载</li><li>JVM 找到 App 的主程序入口，执行 main 方法</li><li>这个 main 中的第一条语句为 Student student = new Student (&quot;tellUrDream&quot;) ，就是让 JVM 创建一个 Student 对象，但是这个时候方法区中是没有 Student 类的信息的，所以 JVM 马上加载 Student 类，把 Student 类的信息放到方法区中</li><li>加载完 Student 类后，JVM 在堆中为一个新的 Student 实例分配内存，然后调用构造函数初始化 Student 实例，这个 Student 实例持有 <strong>指向方法区中的 Student 类的类型信息</strong> 的引用</li><li>执行 student.sayName (); 时，JVM 根据 student 的引用找到 student 对象，然后根据 student 对象持有的引用定位到方法区中 student 类的类型信息的方法表，获得 sayName () 的字节码地址。</li><li>执行 sayName ()</li></ol><p>其实也不用管太多，只需要知道对象实例初始化时会去方法区中找类信息，完成后再到栈那里去运行方法。找方法就在方法表中找</p><h2 id="字节码"><a class="anchor" href="#字节码">#</a> 字节码</h2><p>在 Java 中，JVM 可以理解的代码就叫做字节码（即扩展名为 <code>.class</code> 的文件），它不面向任何特定的处理器，只面向虚拟机。Java 语言通过字节码的方式，在一定程度上解决了传统解释型语言执行效率低的问题，同时又保留了解释型语言可移植的特点。所以， Java 程序运行时相对来说还是高效的（不过，和 C、 C++，Rust，Go 等语言还是有一定差距的），而且，由于字节码并不针对一种特定的机器，因此，Java 程序无须重新编译便可在多种不同操作系统的计算机上运行</p><h3 id="编译与解释"><a class="anchor" href="#编译与解释">#</a> 编译与解释</h3><p>为什么说 java 语言编译与解释并存？<br>我们可以将高级编程语言按照程序的执行方式分为两种：</p><ul><li><strong>编译型</strong>：<span class="exturl" data-url="aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvJUU3JUI3JUE4JUU4JUFEJUFGJUU4JUFBJTlFJUU4JUE4JTgw">编译型语言 open in new window</span> 会通过<span class="exturl" data-url="aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvJUU3JUI3JUE4JUU4JUFEJUFGJUU1JTk5JUE4">编译器 open in new window</span> 将源代码一次性翻译成可被该平台执行的机器码。一般情况下，编译语言的执行速度比较快，开发效率比较低。常见的编译性语言有 C、C++、Go、Rust 等等。</li><li><strong>解释型</strong>：<span class="exturl" data-url="aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvJUU3JTlCJUI0JUU4JUFEJUFGJUU4JUFBJTlFJUU4JUE4JTgw">解释型语言 open in new window</span> 会通过<span class="exturl" data-url="aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvJUU3JTlCJUI0JUU4JUFEJUFGJUU1JTk5JUE4">解释器 open in new window</span> 一句一句的将代码解释（interpret）为机器代码后再执行。解释型语言开发效率比较快，执行速度比较慢。常见的解释性语言有 Python、JavaScript、PHP 等等。<br><img data-src="https://oss.javaguide.cn/github/javaguide/java/basis/compiled-and-interpreted-languages.png" alt=""><br>Java 语言既具有编译型语言的特征，也具有解释型语言的特征。因为 Java 程序要经过先编译，后解释两个步骤，由 Java 编写的程序需要先经过编译步骤，生成字节码（ <code>.class</code> 文件），这种字节码必须由 Java 解释器来解释执行。</li></ul><h2 id="类加载器"><a class="anchor" href="#类加载器">#</a> 类加载器</h2><ul><li>ClassLoader 只负责 class 文件的加载，而是否能够运行则由 Execution Engine 来决定</li><li>从类被加载到虚拟机内存中开始，到释放内存总共有 7 个步骤：加载，验证，准备，解析，初始化，使用，卸载。其中<strong>验证，准备，解析三个部分统称为连接</strong></li></ul><h3 id="加载"><a class="anchor" href="#加载">#</a> 加载</h3><ol><li>将 class 文件加载到内存</li><li>将静态数据结构转化成方法区中运行时的数据结构</li><li>在堆中生成一个代表这个类的 java.lang.Class 对象作为数据访问的入口</li></ol><h3 id="连接"><a class="anchor" href="#连接">#</a> 连接</h3><ol><li>验证：确保加载的类符合 JVM 规范和安全，保证被校验类的方法在运行时不会做出危害虚拟机的事件，其实就是一个安全检查</li><li>准备：为 static 变量在方法区中分配内存空间，设置变量的初始值，例如 static int a = 3 （注意：准备阶段只设置类中的静态变量（方法区中），不包括实例变量（堆内存中），实例变量是对象初始化时赋值的）</li><li>解析：虚拟机将常量池内的符号引用替换为直接引用的过程（符号引用比如我现在 import java.util.ArrayList 这就算符号引用，直接引用就是指针或者对象地址，注意引用对象一定是在内存进行）</li></ol><h3 id="初始化"><a class="anchor" href="#初始化">#</a> 初始化</h3><ul><li>初始化其实就是一个赋值的操作，它会执行一个类构造器的 &lt;clinit&gt;() 方法。由编译器自动收集类中所有变量的赋值动作，此时准备阶段时的那个 static int a = 3 的例子，在这个时候就正式赋值为 3</li></ul><h3 id="卸载"><a class="anchor" href="#卸载">#</a> 卸载</h3><ul><li>GC 将无用对象从内存中卸载</li></ul><h3 id="加载顺序"><a class="anchor" href="#加载顺序">#</a> 加载顺序</h3><p>加载一个 Class 类的顺序也是有优先级的，类加载器从最底层开始往上的顺序是这样的</p><ol><li>BootStrap ClassLoader：rt.jar</li><li>Extention ClassLoader: 加载扩展的 jar 包</li><li>App ClassLoader：指定的 classpath 下面的 jar 包</li><li>Custom ClassLoader：自定义的类加载器</li></ol><h2 id="运行时数据区"><a class="anchor" href="#运行时数据区">#</a> 运行时数据区</h2><p>JVM 内存区域主要分为线程私有区域【程序计数器、虚拟机栈、本地方法区】、线程共享区域【JAVA 堆（虚拟机堆？）、方法区】、直接内存。</p><h3 id="方法区"><a class="anchor" href="#方法区">#</a> 方法区</h3><ul><li>方法区主要的作用技术存放类的元数据信息，常量和静态变量・・・等。当它存储的信息过大时，会在无法满足内存分配时报错。</li></ul><h3 id="虚拟机栈和虚拟机堆"><a class="anchor" href="#虚拟机栈和虚拟机堆">#</a> 虚拟机栈和虚拟机堆</h3><p>一句话便是：栈管运行，堆管存储。则虚拟机栈负责运行代码，而虚拟机堆负责存储数据。</p><h4 id="栈"><a class="anchor" href="#栈">#</a> 栈</h4><p>概念：</p><ul><li>它是 Java 方法执行的内存模型。栈由一个个栈帧组成，而每个栈帧中都拥有：局部变量表、操作数栈、动态链接、方法返回地址，且线程独享。同时如果我们听到局部变量表，那也是在说虚拟机栈，和数据结构上的栈类似，两者都是先进后出的数据结构，只支持出栈和入栈两种操作。<ul><li><strong>局部变量表</strong> 主要存放了编译期可知的各种数据类型（boolean、byte、char、short、int、float、long、double）、对象引用</li><li><strong>操作数栈</strong> 主要作为方法调用的中转站使用，用于存放方法执行过程中产生的中间计算结果</li><li><strong>动态链接</strong> 主要服务一个方法需要调用其他方法的场景。</li></ul></li></ul><p>异常：</p><ul><li>如果线程请求的栈的深度大于虚拟机栈的最大深度，就会报 <strong>StackOverflowError</strong> （这种错误经常出现在递归中）。Java 虚拟机也可以动态扩展，但随着扩展会不断地申请内存，当无法申请足够内存时就会报错 <strong>OutOfMemoryError</strong>。</li></ul><p>生命周期：</p><ul><li>对于栈来说，不存在垃圾回收。只要程序运行结束，栈的空间自然就会释放了。栈的生命周期和所处的线程是一致的。</li></ul><p>执行：</p><ul><li>经常说的栈帧数据，说白了在 JVM 中叫栈帧，放到 Java 中其实就是方法，它也是存放在栈中的。</li><li>栈中的数据都是以栈帧的格式存在，它是一个<mark>关于方法和运行期数据的数据集</mark>。比如我们执行一个方法 a，就会对应产生一个栈帧 A1，然后 A1 会被压入栈中。同理方法 b 会有一个 B1，方法 c 会有一个 C1，等到这个线程执行完毕后，栈会先弹出 C1，后 B1,A1。它是一个先进后出，后进先出原则。</li></ul><h4 id="堆"><a class="anchor" href="#堆">#</a> 堆</h4><p>概念：</p><ul><li>JVM 内存会划分为堆内存和非堆内存，堆内存中也会划分为<strong>年轻代</strong>和<strong>老年代</strong>，而非堆内存则为<strong>永久代</strong>。年轻代又会分为<strong> Eden</strong> 和<strong> Survivor</strong> 区。Survivor 也会分为<strong> FromPlace</strong> 和<strong> ToPlace</strong>，toPlace 的 survivor 区域是空的。Eden，FromPlace 和 ToPlace 的默认占比为 <strong>8:1:1</strong>。当然这个东西其实也可以通过一个 -XX:+UsePSAdaptiveSurvivorSizePolicy 参数来根据生成对象的速率动态调整</li><li>堆内存中存放的是对象，垃圾收集就是收集这些对象然后交给 GC 算法进行回收。非堆内存其实我们已经说过了，就是方法区。在 1.8 中已经移除永久代，替代品是一个元空间 (MetaSpace)，最大区别是 metaSpace 是不存在于 JVM 中的，它使用的是本地内存。并有两个参数</li></ul><p>既然堆是随着 JVM 开启的全局资源，不像栈随着线程的开启 / 关闭而创建 / 销毁资源，就需要相应的管理手段，GC 回收。但哪些资源被判定要回收呢？<br><img data-src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/1/14/16fa2057cf851442~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.png" alt=""></p><p>有两个基础的计算方法</p><ol><li><p>引用计数器计算：给对象添加一个引用计数器，每次引用这个对象时计数器加一，引用失效时减一，计数器等于 0 时就是不会再次使用的。不过这个方法有一种情况就是出现对象的<mark>循环引用</mark>时 GC 没法回收。</p></li><li><p>可达性分析计算：这是一种类似于二叉树的实现，将一系列的 GC ROOTS 作为起始的存活对象集，从这个节点往下搜索，搜索所走过的路径成为引用链，把能被该集合引用到的对象加入到集合中。搜索当一个对象到 GC Roots 没有使用任何引用链时，则说明该对象是不可用的。主流的商用程序语言，例如 Java，C# 等都是靠这招去判定对象是否存活的。</p><ul><li>在 Java 语言汇总能作为 GC Roots 的对象分为以下几种：</li></ul><ol><li>虚拟机栈（栈帧中的本地方法表）中引用的对象（局部变量）</li><li>方法区中静态变量所引用的对象（静态变量）</li><li>方法区中常量引用的对象</li><li>本地方法栈（即 native 修饰的方法）中 JNI 引用的对象（JNI 是 Java 虚拟机调用对应的 C 函数的方式，通过 JNI 函数也可以创建新的 Java 对象。且 JNI 对于对象的局部引用或者全局引用都会把它们指向的对象都标记为不可回收）</li><li>已启动的且未终止的 Java 线程</li></ol></li></ol><p>这种方法的优点是能够解决循环引用的问题，可它的实现需要耗费大量资源和时间，也需要 GC</p><h4 id="区别"><a class="anchor" href="#区别">#</a> 区别</h4><ol><li>堆和栈区别</li></ol><ul><li><p>堆：主要用于储存实例化的对象，数组。由 JVM 动态分配内存空间。一个 JVM 只有一个堆内存，线程是可以共享数据的。</p></li><li><p>栈：主要用于储存局部变量和对象的引用变量，每个线程都会有一个独立的栈空间，所以线程之间是不共享数据的。</p></li></ul><ol start="2"><li>堆内存和栈内存区别</li></ol><ul><li><p>堆内存：储存的是数组和对象 (其实数组就是对象)，凡是 new 建立的都是在堆中，堆中存放的都是实体 (对象)，实体用于封装数据，而且是封装多个 (实体的多个属性)，如果一个数据消失，这个实体也没有消失，还可以用，所以堆是不会随时释放的，但是栈不一样，栈里存放的都是单个变量，变量被释放了，那就没有了。堆里的实体虽然不会被释放，但是会被当成垃圾，Java 有垃圾回收机制不定时的收取。</p></li><li><p>栈内存：栈内存首先是一片内存区域，存储的都是局部变量，凡是定义在方法中的都是局部变量 (方法外的是全局变量)，for 循环内部定义的也是局部变量，是先加载函数才能进行局部变量的定义，所以方法先进栈，然后再定义变量，变量有自己的作用域，一旦离开作用域，变量就会被释放。栈内存的更新速度很快，因为局部变量的生命周期很短。</p></li></ul><h3 id="本地方法栈"><a class="anchor" href="#本地方法栈">#</a> 本地方法栈</h3><p>和虚拟机栈所发挥的作用非常相似，区别是：<strong>虚拟机栈为虚拟机执行 Java 方法 （也就是字节码）服务，而本地方法栈则为虚拟机使用到的 Native 方法服务。</strong> 在 HotSpot 虚拟机中和 Java 虚拟机栈合二为一。</p><p>本地方法被执行的时候，在本地方法栈也会创建一个栈帧，用于存放该本地方法的局部变量表、操作数栈、动态链接、出口信息。</p><p>方法执行完毕后相应的栈帧也会出栈并释放内存空间，也会出现 <code>StackOverFlowError</code> 和 <code>OutOfMemoryError</code> 两种错误。</p><h3 id="方法区-2"><a class="anchor" href="#方法区-2">#</a> 方法区</h3><p>方法区属于是 JVM 运行时数据区域的一块逻辑区域，是各个线程共享的内存区域。</p><p>《Java 虚拟机规范》只是规定了有方法区这么个概念和它的作用，方法区到底要如何实现那就是虚拟机自己要考虑的事情了。也就是说，在不同的虚拟机实现上，方法区的实现是不同的。</p><p>当虚拟机要使用一个类时，它需要读取并解析 Class 文件获取相关信息，再将信息存入到方法区。方法区会存储已被虚拟机加载的 <strong>类信息、字段信息、方法信息、常量、静态变量、即时编译器编译后的代码缓存等数据</strong>。</p><p><strong>方法区和永久代以及元空间是什么关系呢？</strong> 方法区和永久代以及元空间的关系很像 Java 中接口和类的关系，类实现了接口，这里的类就可以看作是永久代和元空间，接口可以看作是方法区，也就是说永久代以及元空间是 HotSpot 虚拟机对虚拟机规范中方法区的两种实现方式。并且，永久代是 JDK 1.8 之前的方法区实现，JDK 1.8 及以后方法区的实现变成了元空间。</p><h3 id="运行时常量池"><a class="anchor" href="#运行时常量池">#</a> 运行时常量池</h3><p>Class 文件中除了有类的版本、字段、方法、接口等描述信息外，还有用于存放编译期生成的各种字面量（Literal）和符号引用（Symbolic Reference）的 <strong>常量池表 (Constant Pool Table)</strong> 。</p><ul><li>字面量是源代码中的固定值的表示法，即通过字面我们就能知道其值的含义。字面量包括整数、浮点数和字符串字面量。常见的符号引用包括类符号引用、字段符号引用、方法符号引用、接口方法符号。</li></ul><h3 id="字符串常量池"><a class="anchor" href="#字符串常量池">#</a> 字符串常量池</h3><p><strong>字符串常量池</strong> 是 JVM 为了提升性能和减少内存消耗针对字符串（String 类）专门开辟的一块区域，主要目的是为了避免字符串的重复创建。</p><h3 id="hotspot虚拟机案例"><a class="anchor" href="#hotspot虚拟机案例">#</a> HotSpot 虚拟机案例</h3><h4 id="对象的创建"><a class="anchor" href="#对象的创建">#</a> 对象的创建</h4><blockquote><p>Step1: 类加载检查</p></blockquote><p>虚拟机遇到一条 new 指令时，首先将去检查这个指令的参数是否能在常量池中定位到这个类的符号引用，并且检查这个符号引用代表的类是否已被加载过、解析和初始化过。如果没有，那必须先执行相应的类加载过程。</p><blockquote><p>Step2: 分配内存</p></blockquote><p>在<strong>类加载检查</strong>通过后，接下来虚拟机将为新生对象<strong>分配内存</strong>。对象所需的内存大小在类加载完成后便可确定，为对象分配空间的任务等同于把一块确定大小的内存从 Java 堆中划分出来。<strong>分配方式</strong>有 <strong>“指针碰撞”</strong> 和 <strong>“空闲列表”</strong> 两种，<strong>选择哪种分配方式由 Java 堆是否规整决定，而 Java 堆是否规整又由所采用的垃圾收集器是否带有压缩整理功能决定</strong>。</p><ul><li><p><strong>内存分配的两种方式</strong> （补充内容，需要掌握）：</p><ul><li>指针碰撞：<ul><li>适用场合：堆内存规整（即没有内存碎片）的情况下。</li><li>原理：用过的内存全部整合到一边，没有用过的内存放在另一边，中间有一个分界指针，只需要向着没用过的内存方向将该指针移动对象内存大小位置即可。</li><li>使用该分配方式的 GC 收集器：Serial, ParNew</li></ul></li><li>空闲列表：<ul><li>适用场合：堆内存不规整的情况下。</li><li>原理：虚拟机会维护一个列表，该列表中会记录哪些内存块是可用的，在分配的时候，找一块儿足够大的内存块儿来划分给对象实例，最后更新列表记录。</li><li>使用该分配方式的 GC 收集器：CMS</li></ul></li></ul></li></ul><p>选择以上两种方式中的哪一种，取决于 Java 堆内存是否规整。而 Java 堆内存是否规整，取决于 GC 收集器的算法是 &quot;标记 - 清除&quot;，还是 &quot;标记 - 整理&quot;（也称作 &quot;标记 - 压缩&quot;），值得注意的是，复制算法内存也是规整的。</p><ul><li><p><strong>内存分配并发问题（补充内容，需要掌握）</strong></p><p>在创建对象的时候有一个很重要的问题，就是线程安全，因为在实际开发过程中，创建对象是很频繁的事情，作为虚拟机来说，必须要保证线程是安全的，通常来讲，虚拟机采用两种方式来保证线程安全：</p><ul><li><strong>CAS + 失败重试：</strong> CAS 是乐观锁的一种实现方式。所谓乐观锁就是，每次不加锁而是假设没有冲突而去完成某项操作，如果因为冲突失败就重试，直到成功为止。<strong>虚拟机采用 CAS 配上失败重试的方式保证更新操作的原子性。</strong></li><li><strong>TLAB：</strong> 为每一个线程预先在 Eden 区分配一块儿内存，JVM 在给线程中的对象分配内存时，首先在 TLAB 分配，当对象大于 TLAB 中的剩余内存或 TLAB 的内存已用尽时，再采用上述的 CAS 进行内存分配</li></ul></li></ul><blockquote><p>Step3: 初始化零值</p></blockquote><p>内存分配完成后，虚拟机需要将分配到的内存空间都初始化为零值（不包括对象头），这一步操作保证了对象的实例字段在 Java 代码中可以不赋初始值就直接使用，程序能访问到这些字段的数据类型所对应的零值。</p><blockquote><p>Step4: 设置对象头</p></blockquote><p>初始化零值完成之后，<strong>虚拟机要对对象进行必要的设置</strong>，例如这个对象是哪个类的实例、如何才能找到类的元数据信息、对象的哈希码、对象的 GC 分代年龄等信息。 <strong>这些信息存放在对象头中。</strong> 另外，根据虚拟机当前运行状态的不同，如是否启用偏向锁等，对象头会有不同的设置方式。</p><blockquote><p>step5 - 执行 - init - 方法</p></blockquote><p>在上面工作都完成之后，从虚拟机的视角来看，一个新的对象已经产生了，但从 Java 程序的视角来看，对象创建才刚开始， <code>&lt;init&gt;</code> 方法还没有执行，所有的字段都还为零。所以一般来说，执行 new 指令之后会接着执行 <code>&lt;init&gt;</code> 方法，把对象按照程序员的意愿进行初始化，这样一个真正可用的对象才算完全产生出来。</p><h4 id="对象的内存布局"><a class="anchor" href="#对象的内存布局">#</a> 对象的内存布局</h4><p>在 Hotspot 虚拟机中，对象在内存中的布局可以分为 3 块区域：<strong>对象头</strong>、<strong>实例数据</strong>和<strong>对齐填充</strong>。</p><p><strong>Hotspot 虚拟机的对象头包括两部分信息</strong>，<strong>第一部分用于存储对象自身的运行时数据</strong>（哈希码、GC 分代年龄、锁状态标志等等），<strong>另一部分是类型指针</strong>，即对象指向它的类元数据的指针，虚拟机通过这个指针来确定这个对象是哪个类的实例。</p><p><strong>实例数据部分是对象真正存储的有效信息</strong>，也是在程序中所定义的各种类型的字段内容。</p><p><strong>对齐填充部分不是必然存在的，也没有什么特别的含义，仅仅起占位作用。</strong> 因为 Hotspot 虚拟机的自动内存管理系统要求对象起始地址必须是 8 字节的整数倍，换句话说就是对象的大小必须是 8 字节的整数倍。而对象头部分正好是 8 字节的倍数（1 倍或 2 倍），因此，当对象实例数据部分没有对齐时，就需要通过对齐填充来补全。</p><h4 id="对象的访问定位"><a class="anchor" href="#对象的访问定位">#</a> 对象的访问定位</h4><p>建立对象就是为了使用对象，我们的 Java 程序通过栈上的 reference 数据来操作堆上的具体对象。对象的访问方式由虚拟机实现而定，目前主流的访问方式有：<strong>使用句柄</strong>、<strong>直接指针</strong>。</p><h5 id="句柄"><a class="anchor" href="#句柄">#</a> 句柄</h5><p>如果使用句柄的话，那么 Java 堆中将会划分出一块内存来作为句柄池，reference 中存储的就是对象的句柄地址，而句柄中包含了对象实例数据与对象类型数据各自的具体地址信息</p><p><img data-src="https://oss.javaguide.cn/github/javaguide/java/jvm/access-location-of-object-handle.png" alt=""></p><h5 id="直接指针"><a class="anchor" href="#直接指针">#</a> 直接指针</h5><p>如果使用直接指针访问，reference 中存储的直接就是对象的地址。</p><p><img data-src="https://oss.javaguide.cn/github/javaguide/java/jvm/access-location-of-object-handle-direct-pointer.png" alt=""></p><p>这两种对象访问方式各有优势。使用句柄来访问的最大好处是 reference 中存储的是稳定的句柄地址，在对象被移动时只会改变句柄中的实例数据指针，而 reference 本身不需要修改。使用直接指针访问方式最大的好处就是速度快，它节省了一次指针定位的时间开销。</p><p>HotSpot 虚拟机主要使用的就是这种方式来进行对象访问。</p><h2 id="垃圾回收算法"><a class="anchor" href="#垃圾回收算法">#</a> 垃圾回收算法</h2><h3 id="标记清除算法"><a class="anchor" href="#标记清除算法">#</a> 标记清除算法</h3><p>标记清除算法就是分为 “标记” 和 “清除” 两个阶段。标记出所有需要回收的对象，标记结束后统一回收。这个套路很简单，也存在不足，后续的算法都是根据这个基础来加以改进的。</p><ul><li>其实它就是把已死亡的对象标记为空闲内存，然后记录在一个空闲列表中，当我们需要 new 一个对象时，内存管理模块会从空闲列表中寻找空闲的内存来分给新的对象。</li><li>不足的方面就是标记和清除的效率比较低下。且这种做法会让内存中的碎片非常多。这个导致了如果我们需要使用到较大的内存块时，无法分配到足够的连续内存。<br><img data-src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/1/15/16fa593b220bd65b~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.png" alt=""></li></ul><h3 id="复制算法"><a class="anchor" href="#复制算法">#</a> 复制算法</h3><p>为了解决效率问题，复制算法就出现了。</p><ul><li>它将可用内存按容量划分成两等分，每次只使用其中的一块。和 survivor 一样也是用 from 和 to 两个指针这样的玩法。</li><li>fromPlace 存满了，就把存活的对象 copy 到另一块 toPlace 上，然后交换指针的内容。这样就解决了碎片的问题。</li></ul><p>这个算法的代价就是把内存缩水了，堆内存的使用效率会变得十分低<br><img data-src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/1/15/16fa599ea6f4ce56~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.png" alt=""></p><h3 id="标记整理算法"><a class="anchor" href="#标记整理算法">#</a> 标记整理算法</h3><p>复制算法在对象存活率高的时候会有一定的效率问题，标记过程仍然与 “标记 - 清除” 算法一样，但后续步骤不是直接对可回收对象进行清理，而是让所有存活的对象都向一端移动，然后直接清理掉边界以外的内存</p><p><img data-src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/1/15/16fa59da25a1629e~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.png" alt=""></p><h3 id="分代收集算法"><a class="anchor" href="#分代收集算法">#</a> 分代收集算法</h3><p>根据对象存活周期的不同将内存划分为几块。一般是把 Java 堆分为新生代和老年代，这样就可以根据各个年代的特点采用最适当的收集算法。</p><ul><li>在新生代中，每次垃圾收集时都发现有大批对象死去，只有少量存活，那就选用复制算法，只需要付出少量存活对象的复制成本就可以完成收集。</li><li>而老年代中因为对象存活率高、没有额外空间对它进行分配担保，就必须使用 “标记 - 清理” 或者 “标记 - 整理” 算法来进行回收。</li></ul><h2 id="调优"><a class="anchor" href="#调优">#</a> 调优</h2><p>针对堆内存主要是：不同代的分配进行调整、最大最小堆内存调整</p><ul><li>所有线程共享数据区大小 = 新生代大小 + 年老代大小 + 持久代大小。持久代一般固定大小为 64m。所以 java 堆中增大年轻代后，将会减小年老代大小（因为老年代的清理是使用 fullgc，所以老年代过小的话反而是会增多 fullgc 的）。此值对系统性能影响较大，Sun 官方推荐配置为 java 堆的 3/8</li></ul><p>对于栈就是调整每个线程栈空间的大小</p><ul><li>JDK5.0 以后每个线程堆栈大小为 1M，以前每个线程堆栈大小为 256K。在相同物理内存下，减小这个值能生成更多的线程。但是操作系统对一个进程内的线程数还是有限制的，不能无限生成，经验值在 3000~5000 左右</li></ul><h1 id="juc"><a class="anchor" href="#juc">#</a> JUC</h1><p>JUC 是 java.util.concurrent 包的简称，在 Java5.0 添加，目的就是为了更好的支持高并发任务。让开发者进行多线程编程时减少竞争条件和死锁的问题</p><p><img data-src="https://img-blog.csdnimg.cn/20210508223838713.png" alt=""></p><ol><li><p>tools（工具类）：又叫信号量三组工具类，包含有:</p><ul><li>CountDownLatch（闭锁） 是一个同步辅助类，在完成一组正在其他线程中执行的操作之前，它允许一个或多个线程一直等待</li><li>CyclicBarrier（栅栏） 之所以叫 barrier，是因为是一个同步辅助类，允许一组线程互相等待，直到到达某个公共屏障点 ，并且在释放等待线程后可以重用</li><li>Semaphore（信号量） 是一个计数信号量，它的本质是一个 “共享锁 “。信号量维护了一个信号量许可集。线程可以通过调用 acquire () 来获取信号量的许可；当信号量中有可用的许可时，线程能获取该许可；否则线程必须等待，直到有可用的许可为止。 线程可以通过 release () 来释放它所持有的信号量许可。</li></ul></li><li><p>executor (执行者)：是 Java 里面线程池的顶级接口，但它只是一个执行线程的工具，真正的线程池接口是 ExecutorService，里面包含的类有：</p><ul><li>ScheduledExecutorService 解决那些需要任务重复执行的问题</li><li>ScheduledThreadPoolExecutor 周期性任务调度的类实现</li></ul></li><li><p>atomic (原子性包)：是 JDK 提供的一组原子操作类，</p><ul><li>包含有 AtomicBoolean、AtomicInteger、AtomicIntegerArray 等原子变量类，他们的实现原理大多是持有它们各自的对应的类型变量 value，而且被 volatile 关键字修饰了。这样来保证每次一个线程要使用它都会拿到最新的值。</li></ul></li><li><p>locks（锁包）：是 JDK 提供的锁机制，相比 synchronized 关键字来进行同步锁，功能更加强大，它为锁提供了一个框架，该框架允许更灵活地使用锁包含的实现类有：</p><ul><li>ReentrantLock 它是独占锁，是指只能被独自占领，即同一个时间点只能被一个线程锁获取到的锁</li><li>ReentrantReadWriteLock 它包括子类 ReadLock 和 WriteLock。ReadLock 是共享锁，而 WriteLock 是独占锁</li><li>LockSupport 它具备阻塞线程和解除阻塞线程的功能，并且不会引发死锁。</li></ul></li><li><p>collections (集合类)：主要是提供线程安全的集合， 比如：</p><ul><li>ArrayList 对应的高并发类是 CopyOnWriteArrayList</li><li>HashSet 对应的高并发类是 CopyOnWriteArraySet</li><li>HashMap 对应的高并发类是 ConcurrentHashMap 等等</li></ul></li></ol><p>只是一个应用包，但牵扯到的：<br><img data-src="https://ucc.alicdn.com/pic/developer-ecology/2ebkmj4srtokq_965b1006254c4780a1ae6418902460f3.png" alt=""></p><p><span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIuYWxpeXVuLmNvbS9hcnRpY2xlLzEzNTI2MTc=">超多，对着整理下</span></p><h1 id="线程"><a class="anchor" href="#线程">#</a> 线程</h1><ul><li>Hotspot JVM 中的 Java 线程与原生操作系统线程有直接的映射关系。当线程本地存储、缓冲区分配、同步对象、栈、程序计数器等准备好以后，就会创建一个操作系统原生线程。Java 线程结束，原生线程随之被回收。操作系统负责调度所有线程，并把它们分配到任何可用的 CPU 上。当原生线程初始化完毕，就会调用 Java 线程的 run () 方法。当线程结束时，会释放原生线程和 Java 线程的所有资源。</li></ul><table><thead><tr><th>虚拟机线程（VM thread）</th><th>这个线程等待 JVM 到达安全点操作出现。这些操作必须要在独立的线程里执行，因为当堆修改无法进行时，线程都需要 JVM 位于安全点。这些操作的类型有：stop-theworld 垃圾回收、线程栈 dump、线程暂停、线程偏向锁（biased locking）解除。</th></tr></thead><tbody><tr><td>周期性任务线程</td><td>这线程负责定时器事件（也就是中断），用来调度周期性操作的执行。</td></tr><tr><td>GC 线程</td><td>这些线程支持 JVM 中不同的垃圾回收活动。</td></tr><tr><td>编译器线程</td><td>这些线程在运行时将字节码动态编译成本地平台相关的机器码。</td></tr><tr><td>信号分发线程</td><td>这个线程接收发送到 JVM 的信号并调用适当的 JVM 方法处理。</td></tr></tbody></table><h2 id="状态生命周期"><a class="anchor" href="#状态生命周期">#</a> 状态 / 生命周期</h2><p><img data-src="https://img-blog.csdnimg.cn/20190825102819846.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2l0YWt5dWJp,size_16,color_FFFFFF,t_70" alt=""></p><ol><li><p>新建状态<br>使用 new 关键字和 Thread 类或其子类建立一个线程对象后，该线程对象就处于新建状态。它保持这个状态直到程序 start () 这个线程。</p></li><li><p>就绪状态<br>当线程对象调用了 start () 方法之后，该线程就进入就绪状态。就绪状态的线程处于就绪队列中，要等待 JVM 里线程调度器的调度。</p></li><li><p>运行状态<br>如果就绪状态的线程获取 CPU 资源，就可以执行 run ()，此时线程便处于运行状态。处于运行状态的线程最为复杂，它可以变为阻塞状态、就绪状态和死亡状态。</p></li><li><p>阻塞状态<br>如果一个线程执行了 sleep（睡眠）、suspend（挂起）等方法，失去所占用资源之后，该线程就从运行状态进入阻塞状态。在睡眠时间已到或获得设备资源后可以重新进入就绪状态。可以分为三种：</p><ul><li>等待阻塞，运行状态中的线程执行 wait () 方法，使线程进入到等待阻塞状态。wait () 释放锁</li><li>同步阻塞，线程在获取 synchronized 同步锁失败 (因为同步锁被其他线程占用)。</li><li>其他阻塞，通过调用线程的 sleep () 或 join () 发出了 I/O 请求时，线程就会进入到阻塞状态。当 sleep () 状态超时，join () 等待线程终止或超时，或者 I/O 处理完毕，线程重新转入就绪状态。sleep () 不释放锁</li></ul></li><li><p>死亡状态<br>一个运行状态的线程完成任务或者其他终止条件发生时，该线程就切换到终止状态。</p></li></ol><h2 id="创建方法"><a class="anchor" href="#创建方法">#</a> 创建方法</h2><h3 id="继承thread类"><a class="anchor" href="#继承thread类">#</a> 继承 Thread 类</h3><ol><li>创建一个继承与 Thread 的子类</li><li>重写 Thread 的 run（）方法</li><li>创建 Thread 类子类的对象</li><li>通过这个对象调用 start（）</li></ol><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">class</span>  <span class="token class-name">Mythread</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span><span class="token punctuation">&#123;</span><span class="token comment">// 创建一个继承与 Thread 的子类</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 重写 Thread 的 run（）方法</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;=</span><span class="token number">100</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>            <span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">%</span><span class="token number">2</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">"分支线程--->"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token comment">// 创建 Thread 类的子类对象  </span></pre></td></tr><tr><td data-num="14"></td><td><pre>		<span class="token class-name">Mythread</span> mythread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Mythread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="15"></td><td><pre>		<span class="token comment">// 不会启动线程，不会分配新的分支栈。（这种方式就是单线程。）  </span></pre></td></tr><tr><td data-num="16"></td><td><pre>		mythread<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="17"></td><td><pre>		<span class="token comment">//start（）启动一个分支线程  </span></pre></td></tr><tr><td data-num="18"></td><td><pre>		<span class="token comment">// mythread.start();  </span></pre></td></tr><tr><td data-num="19"></td><td><pre>		  </pre></td></tr><tr><td data-num="20"></td><td><pre>		<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;=</span><span class="token number">100</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="21"></td><td><pre>		    <span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">%</span><span class="token number">2</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="22"></td><td><pre>		        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"主线程--->"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="23"></td><td><pre>		    <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="24"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><div class="note info no-icon"><ul><li>t.run () 不会启动线程，只是普通的调用方法而已。不会分配新的分支栈。（这种方式就是单线程。）</li><li>t.start () 方法的作用是：启动一个分支线程，在 JVM 中开辟一个新的栈空间，这段代码任务完成之后，瞬间就结束了。<br>这段代码的任务只是为了开启一个新的栈空间，只要新的栈空间开出来，start () 方法就结束了。线程就启动成功了。启动成功的线程会自动调用 run 方法，并且 run 方法在分支栈的栈底部（压栈）。</li><li>run 方法在分支栈的栈底部，main 方法在主栈的栈底部。run 和 main 是平级的。</li><li>Thread 还有个 Yield 方法可以暂停当前正在执行的线程对象，让其它有相同优先级的线程执行。它是一个静态方法，而且只保证当前线程放弃 CPU 占用而不能保证使其它线程一定能占用 CPU，执行 yield () 的线程有可能在进入到暂停状态后马上又被执行。</li></ul></div><p>终止 Thread 方法：</p><ol><li>使用退出标志，使线程正常退出，也就是当 run 方法完成后线程终止</li><li>使用 stop 方法强行终止，但是不推荐这个方法，因为 stop 和 suspend 及 resume 一样都是过期作废的方法</li><li>使用 interrupt 方法中断线程</li></ol><h4 id="匿名创建thread类子类"><a class="anchor" href="#匿名创建thread类子类">#</a> 匿名创建 Thread 类子类</h4><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;=</span><span class="token number">100</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>                <span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">%</span><span class="token number">2</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h4 id="thread中的常用方法"><a class="anchor" href="#thread中的常用方法">#</a> Thread 中的常用方法</h4><ol><li>currentThread ()：静态方法，返回当前代码的线程</li><li>getName ()：获得当先线程的名字</li><li>setName ()：设置当前线程的名字</li><li>yield（）：释放当前 cpu 的执行权</li><li>join（）：在线程 a 中调用线程 b 的 join（）；则线程 a 进入阻塞状态，等线程 b 结束后结束阻塞状态，哪怕 b 是 start（）单独开的栈</li><li>sleep（Long militime）让当前线程阻断指定的 militime 毫秒，此时为阻塞状态</li><li>isAlive（）；判断线程是否存活</li></ol><figure class="highlight java"><figcaption data-lang="java"><span>title:Thread</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token import static"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token static">sleep</span></span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="2"></td><td><pre>  </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">Mythread</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span><span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="4"></td><td><pre>  </pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token annotation punctuation">@Override</span>  </pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;=</span><span class="token number">50</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="8"></td><td><pre>            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="9"></td><td><pre>                <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 阻断 100 毫秒  </span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="11"></td><td><pre>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="13"></td><td><pre>            <span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">%</span><span class="token number">2</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="14"></td><td><pre>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">" "</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 输出线程名  </span></pre></td></tr><tr><td data-num="15"></td><td><pre>            <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="19"></td><td><pre>  </pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token class-name">Mythread</span> mythread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Mythread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="23"></td><td><pre>        mythread<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"线程一"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 设置线程名  </span></pre></td></tr><tr><td data-num="24"></td><td><pre>        mythread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="25"></td><td><pre>  </pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"主线程"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;=</span><span class="token number">100</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="28"></td><td><pre>            <span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">%</span><span class="token number">2</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="29"></td><td><pre>                <span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">==</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="30"></td><td><pre>                    mythread<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="31"></td><td><pre>                <span class="token punctuation">&#125;</span> <span class="token comment">// 阻断主线程  </span></pre></td></tr><tr><td data-num="32"></td><td><pre>                <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 阻断 100 毫秒  </span></pre></td></tr><tr><td data-num="33"></td><td><pre>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">" "</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 获取主前线程的名字  </span></pre></td></tr><tr><td data-num="34"></td><td><pre>            <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token comment">// 判断 mythread 线程是否还存活  </span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>mythread<span class="token punctuation">.</span><span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="线程的优先级"><a class="anchor" href="#线程的优先级">#</a> 线程的优先级</h4><ul><li>MAX_PRIORITY:10</li><li>MIN_PRIORITY:1</li><li>NORM_PRIORITY:5 (默认)<br>使用方法 <code>setPriority()</code><br><strong>注意：高优先级抢占低优先级线程 cpu，但不代表一定先执行完高优先级再执行低优先级</strong></li></ul><h4 id="抢票案例"><a class="anchor" href="#抢票案例">#</a> 抢票案例</h4><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">class</span>  piao <span class="token keyword">extends</span> <span class="token class-name">Thread</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> tickect<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token keyword">while</span> <span class="token punctuation">(</span>tickect<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"卖了"</span><span class="token operator">+</span>tickect<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>            tickect<span class="token operator">=</span>tickect<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        piao p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">piao</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token comment">// 给 p1 设定优先级</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        p1<span class="token punctuation">.</span><span class="token function">setPriority</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token constant">MAX_PRIORITY</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        piao p2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">piao</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        piao p3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">piao</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>        </pre></td></tr><tr><td data-num="21"></td><td><pre>        p1<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"窗口一"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        p2<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"窗口二"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        p3<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"窗口三"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>        p1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        p2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        p3<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="实现runnable接口"><a class="anchor" href="#实现runnable接口">#</a> 实现 Runnable 接口</h3><ol><li>创建一个实现了 Runnable 接口的类</li><li>重写 run（）；</li><li>创建实现 Runnable 类的对象；</li><li>将此对象作为参数传递到 Thread 类的构造器中，创建 Thread 类的对象；</li><li>通过 Thread 类的对象调用 start（）；</li></ol><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 创建一个实现了 Runnable 接口的类</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">class</span> mythread <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token keyword">private</span> <span class="token keyword">int</span> tickect <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">// 重写 run（）；</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>		<span class="token keyword">while</span> <span class="token punctuation">(</span>tickect <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>			<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"卖了第"</span> <span class="token operator">+</span> tickect <span class="token operator">+</span> <span class="token string">"张票"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>			tickect<span class="token operator">--</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>		<span class="token comment">// 创建实现类的对象；</span></pre></td></tr><tr><td data-num="20"></td><td><pre>		mythread mythread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">mythread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>		<span class="token comment">// 将此对象作为参数传递到 Thread 类的构造器中，创建 Thread 类的对象；</span></pre></td></tr><tr><td data-num="22"></td><td><pre>		<span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>mythread<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>		<span class="token class-name">Thread</span> t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>mythread<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>		<span class="token class-name">Thread</span> t3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>mythread<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>		t1<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"一号窗口"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>		t2<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"二号窗口"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>		t3<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"三号窗口"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>		t1<span class="token punctuation">.</span><span class="token function">setPriority</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token constant">MAX_PRIORITY</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>		<span class="token comment">// 通过 Thread 类的对象调用 start（）；</span></pre></td></tr><tr><td data-num="31"></td><td><pre>		t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>		t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>		t3<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>优势：实现的方式没有类的单继承的局限性，实现的方式更适合处理多个共享数据的类型</p><h4 id="采用匿名内部类创建"><a class="anchor" href="#采用匿名内部类创建">#</a> 采用匿名内部类创建：</h4><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadTest</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token comment">// 创建线程对象，采用匿名内部类方式。</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token class-name">Thread</span> mythread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>            <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="6"></td><td><pre>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>                <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"mythread线程---> "</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token comment">// 启动线程</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        mythread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"main线程---> "</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="实现callable接口"><a class="anchor" href="#实现callable接口">#</a> 实现 Callable 接口</h3><p>优点:</p><ol><li>call 方法相比于 run 方法可以有返回值</li><li>可以抛出异常</li><li>支持泛型</li></ol><p>操作步骤:</p><ol><li>创建一个实现 Callable 的实现类</li><li>实现 call 方法，将操作声明在 call 方法中</li><li>创建 Callable 实现类的对象</li><li>将此实现类的对象作为参数，传递到 FutureTask 构造器，创建 FutureTask 对象</li><li>将 FutureTask 的对象作为参数传递到 Thread 类的构造器中，创建 Thread 对象</li></ol><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//1. 创建一个实现 Callable 的实现类</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">class</span> call <span class="token keyword">implements</span> <span class="token class-name">Callable</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">int</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment">//2. 实现 call 方法，将操作声明在 call 方法中</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            sum<span class="token operator">+=</span>i<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token keyword">return</span> sum<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">public</span>  <span class="token keyword">class</span> text01 <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token comment">//3. 创建 Callable 实现类的对象</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        call call<span class="token operator">=</span><span class="token keyword">new</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token comment">//4, 将此实现类的对象作为参数，传递到 FutureTask 构造器，创建 FutureTask 对象</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token class-name">FutureTask</span> futureTask<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">FutureTask</span><span class="token punctuation">(</span>call<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>       <span class="token comment">//5. 将 FutureTask 的对象作为参数传递到 Thread 类的构造器中，创建 Thread 对象</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>futureTask<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>            <span class="token class-name">Object</span> sum <span class="token operator">=</span> futureTask<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"总计"</span><span class="token operator">+</span>sum<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ExecutionException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="runnable和callable的区别"><a class="anchor" href="#runnable和callable的区别">#</a> Runnable 和 Callable 的区别</h3><p>Runnable 和 Callable 都是用于创建线程任务的接口，它们之间的主要区别在于以下几点：</p><ol><li>返回值<ul><li>Runnable 接口的 run () 方法没有返回值，因此线程任务无法返回执行结果。</li><li>Callable 接口的 call () 方法可以返回执行结果，并且可以抛出受检查的异常。</li></ul></li><li>异常处理<ul><li>Runnable 接口的 run () 方法不能抛出受检查的异常，只能抛出非受检查的 RuntimeException。</li><li>Callable 接口的 call () 方法可以抛出任何类型的异常，包括受检查的异常。</li></ul></li><li>兼容性<ul><li>Callable 接口是在 Java 5 中引入的新接口，而 Runnable 接口是在 Java 1.0 中就存在的。</li><li>Callable 接口提供了更多的灵活性和功能，但 Runnable 接口仍然是使用较多的接口之一，因为它的简单性和兼容性。</li></ul></li><li>并发集合<ul><li>Callable 接口通常与 ExecutorService 和 Future 配合使用，以支持异步任务执行和获取结果。</li><li>Runnable 接口通常与 Thread 类或者 Executor 框架一起使用，用于执行简单的线程任务。</li></ul></li></ol><ul><li>受检查的异常：这种在编译时被强制检查的异常称为 &quot;受检查的异常&quot;。即在方法的声明中声明的异常</li><li>不受检查的异常：在方法的声明中没有声明，但在方法的运行过程中发生的各种异常被称为 &quot;不被检查的异常&quot;。这种异常是错误，会被自动捕获</li></ul><h3 id="future"><a class="anchor" href="#future">#</a> Future</h3><p>在并发编程中，我们经常用到非阻塞的模型，在之前的多线程的三种实现中，不管是继承 thread 类还是实现 runnable 接口，都无法保证获取到之前的执行结果。通过实现 Callback 接口，并用 Future 可以来接收多线程的执行结果。</p><p>Future 表示一个可能还没有完成的异步任务的结果，针对这个结果可以添加 Callback 以便在任务执行成功或失败后作出相应的操作。</p><p>包含函数：</p><ul><li>get（）方法可以当任务结束后返回一个结果，如果调用时，工作还没有结束，则会阻塞线程，直到任务执行完毕</li><li>get（long timeout,TimeUnit unit）做多等待 timeout 的时间就会返回结果</li><li>cancel（boolean mayInterruptIfRunning）方法可以用来停止一个任务，如果任务可以停止（通过 mayInterruptIfRunning 来进行判断），则可以返回 true, 如果任务已经完成或者已经停止，或者这个任务无法停止，则会返回 false</li><li>isDone（）方法判断当前方法是否完成</li><li>isCancel（）方法判断当前方法是否取消</li></ul><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">ExecutionException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>		<span class="token keyword">long</span> start <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>		</pre></td></tr><tr><td data-num="4"></td><td><pre>		<span class="token comment">// 等凉菜 </span></pre></td></tr><tr><td data-num="5"></td><td><pre>		<span class="token class-name">Callable</span> ca1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Callable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre> </pre></td></tr><tr><td data-num="7"></td><td><pre>			<span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="8"></td><td><pre>			<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>				<span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>					<span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>				<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>					e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>				<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>				<span class="token keyword">return</span> <span class="token string">"凉菜准备完毕"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>		<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>		<span class="token class-name">FutureTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> ft1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FutureTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>ca1<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>		<span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>ft1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>		</pre></td></tr><tr><td data-num="20"></td><td><pre>		<span class="token comment">// 等包子 -- 必须要等待返回的结果，所以要调用 join 方法</span></pre></td></tr><tr><td data-num="21"></td><td><pre>		<span class="token class-name">Callable</span> ca2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Callable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre> </pre></td></tr><tr><td data-num="23"></td><td><pre>				<span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="24"></td><td><pre>				<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>					<span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>						<span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token operator">*</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>					<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>						e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>					<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>					<span class="token keyword">return</span> <span class="token string">"包子准备完毕"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>		<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>		<span class="token class-name">FutureTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> ft2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FutureTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>ca2<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>		<span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>ft2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>		</pre></td></tr><tr><td data-num="36"></td><td><pre>		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>ft1<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>ft2<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>		</pre></td></tr><tr><td data-num="39"></td><td><pre>		<span class="token keyword">long</span> end <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"准备完毕时间："</span><span class="token operator">+</span><span class="token punctuation">(</span>end<span class="token operator">-</span>start<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="42"></td><td><pre></pre></td></tr><tr><td data-num="43"></td><td><pre>凉菜准备完毕</pre></td></tr><tr><td data-num="44"></td><td><pre>包子准备完毕</pre></td></tr><tr><td data-num="45"></td><td><pre>准备完毕时间：<span class="token number">3012</span></pre></td></tr></table></figure><h3 id="线程池"><a class="anchor" href="#线程池">#</a> 线程池</h3><p>每个线程都有自己的调用栈，自己的寄存器环境，创建一个新线程，CPU 需要执行额外的命令为这些线程分配对应的内存。此外，线程创建后并不会马上被执行，它需要被列入操作系统的调度中。同样，销毁线程的时候也一样需要清理现场。另外，线程切换的时候 CPU 需要保存当前线程的程序计数器，寄存器中的值，打开的文件等信息，因此创建过多的线程，也会增加线程切换带来的 CPU 开销。所以应该<strong>尽量复用已经创建好的线程</strong>，<strong>线程池就是为解决此问题而生的</strong>。</p><p>好处:</p><ol><li>提高响应速度，在执行大量异步任务时提高了性能</li><li>降低资源消耗，节约系统的开销。线程的创建和销毁由线程池维护，一个线程在完成任务后并不会立即销毁，而是由后续的任务复用这个线程，从而减少线程的创建和销毁。</li><li>便于线程管理，Java 内置的一套 ExecutorService 线程池相关的 api，可以更方便的控制线程的最大并发数、线程的定时任务、单线程的顺序执行等</li></ol><p>实现方法:</p><ol><li>提供指定线程数量的线程池</li><li>执行指定的线程操作，需要实现 Runnable 接口或者 Callable 接口实现类的对象</li><li>将实例化的对象作为参数 执行 service.execute ();</li><li>关闭线程池</li></ol><figure class="highlight java"><figcaption data-lang="java"><span>title:ThreadPoolDemo</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">class</span> thread <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>            <span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">%</span><span class="token number">2</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">":"</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">class</span> thread0 <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            <span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">%</span><span class="token number">2</span><span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">":"</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> pool <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token comment">//1 提供指定线程数量的线程池</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token class-name">ExecutorService</span> service <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token comment">//2 执行指定的线程操作，需要实现 Runnable 接口或者 Callable 接口实现类的对象</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        thread thread1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        thread0 thread2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">thread0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token comment">//3 将实例化的对象作为参数 执行 service.execute ();</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        service<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>thread1<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        service<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>thread2<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token comment">//service.submit (); 适用于 callable</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>service<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token class-name">ThreadPoolExecutor</span> service1<span class="token operator">=</span><span class="token punctuation">(</span><span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">)</span>service<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        service1<span class="token punctuation">.</span><span class="token function">setCorePoolSize</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token comment">//4 关闭线程池</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        service<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre></pre></td></tr><tr><td data-num="44"></td><td><pre>		<span class="token comment">// 直接使用 ThreadPoolExecutor</span></pre></td></tr><tr><td data-num="45"></td><td><pre>		<span class="token class-name">ThreadPoolExecutor</span> pool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">60L</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token comment">// 任务 1</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        pool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"--helloWorld_001--"</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>        <span class="token comment">// 任务 2</span></pre></td></tr><tr><td data-num="56"></td><td><pre>        pool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"--helloWorld_002--"</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="58"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><ul><li>corePoolSize：核心池的大小</li><li>maximumPoolSize：最大线程数</li><li>keepAliveTime：线程没有任务时最多保存多长时间后终止</li><li><strong>workQueue</strong> ：当线程数目超过核心线程数时用于保存任务的队列。主要有 3 种类型的 BlockingQueue 可供选择：无界队列，有界队列和同步移交。将在下文中详细阐述。从参数中可以看到，此队列仅保存实现 Runnable 接口的任务。 别看这个参数位置很靠后，但是真的很重要，因为楼主的坑就因这个参数而起，这些细节有必要仔细了解清楚</li><li>threadFactory： 执行程序创建新线程时使用的工厂</li><li>handler：阻塞队列已满且线程数达到最大值时所采取的饱和策略。java 默认提供了 4 种饱和策略的实现方式：中止、抛弃、抛弃最旧的、调用者运行。将在下文中详细阐述。</li></ul><p><strong>无界队列</strong></p><p>队列大小无限制，常用的为无界的 LinkedBlockingQueue，使用该队列做为阻塞队列时要尤其当心，当任务耗时较长时可能会导致大量新任务在队列中堆积最终导致 OOM。阅读代码发现，Executors.newFixedThreadPool 采用就是 LinkedBlockingQueue，而楼主踩到的就是这个坑，当 QPS 很高，发送数据很大，大量的任务被添加到这个无界 LinkedBlockingQueue 中，导致 cpu 和内存飙升服务器挂掉。</p><p><strong>有界队列</strong></p><p>常用的有两类，一类是遵循 FIFO 原则的队列如 ArrayBlockingQueue，另一类是优先级队列如 PriorityBlockingQueue。使用有界队列时队列大小需和线程池大小互相配合，线程池较小有界队列较大时可减少内存消耗，降低 cpu 使用率和上下文切换，但是可能会限制系统吞吐量。</p><p><strong>同步移交队列</strong></p><p>如果不希望任务在队列中等待而是希望将任务直接移交给工作线程，可使用 SynchronousQueue 作为等待队列。SynchronousQueue 不是一个真正的队列，而是一种线程之间移交的机制。要将一个元素放入 SynchronousQueue 中，必须有另一个线程正在等待接收这个元素。只有在使用无界线程池或者有饱和策略时才建议使用该队列。</p><p><strong>四种线程池解析</strong>：</p><ul><li>newSingleThreadExecutor：创建一个单线程的线程池，此线程池保证所有任务的执行顺序按照任务的提交顺序执行</li><li>newFixedThreadPool：创建固定大小的线程池，每次提交一个任务就创建一个线程，直到线程达到线程池的最大大小</li><li>newCachedThreadPool：创建一个可缓存的线程池，此线程池不会对线程池大小做限制，线程池大小完全依赖于操作系统（或者说 JVM）能够创建的最大线程大小</li><li>newScheduledThreadPool：创建一个大小无限的线程池，此线程池支持定时以及周期性执行任务的需求</li></ul><p><strong>简述对线程池的理解</strong>：<br>如果问到了这样的问题，可以展开的说一下线程池如何用、线程池的好处、线程池的启动策略）合理利用线程池能够带来三个好处</p><ul><li>有以上几种创建，对应不同的情形，其中了解过第二种，有个最小和最大的两个参数，小于 corePoolSize 时，有任务了直接创建，大于时添加进队列，询问是否大于最大，没到则创建。若阻塞队列和当前线程数等于最大，则抛异常。</li><li>前面最开始的好处：降低消耗、提高速度、便于管理</li><li>讲下队列、讲下 handle</li></ul><h4 id="复用及原理"><a class="anchor" href="#复用及原理">#</a> 复用及原理</h4><p>假设现在有 100 个任务，我们创建一个固定线程的线程池（FixedThreadPool），核心线程数和最大线程数都是 3，那么当这个 100 个任务执行完，都只会使用三个线程。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FixedThreadPoolDemo</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">static</span> <span class="token class-name">ExecutorService</span> executorService <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>            executorService<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"-> 执行"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token comment">// 关闭线程池</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        executorService<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>pool-1-thread-1-<span class="token operator">></span> 执行</pre></td></tr><tr><td data-num="2"></td><td><pre>pool-1-thread-2-<span class="token operator">></span> 执行</pre></td></tr><tr><td data-num="3"></td><td><pre>pool-1-thread-3-<span class="token operator">></span> 执行</pre></td></tr><tr><td data-num="4"></td><td><pre>pool-1-thread-1-<span class="token operator">></span> 执行</pre></td></tr><tr><td data-num="5"></td><td><pre>pool-1-thread-3-<span class="token operator">></span> 执行</pre></td></tr><tr><td data-num="6"></td><td><pre>pool-1-thread-2-<span class="token operator">></span> 执行</pre></td></tr><tr><td data-num="7"></td><td><pre>pool-1-thread-3-<span class="token operator">></span> 执行</pre></td></tr><tr><td data-num="8"></td><td><pre>pool-1-thread-1-<span class="token operator">></span> 执行</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">..</span>.</pre></td></tr></table></figure><ul><li>线程池将线程和任务进行解耦，线程是线程，任务是任务，摆脱了之前通过 Thread 创建线程时的一个线程必须对应一个任务的限制</li><li>在线程池中，同一个线程可以从阻塞队列中不断获取新任务来执行，其核心原理在于线程池对 Thread 进行了封装，并不是每次执行任务都会调用 Thread.start () 来创建新线程，而是让每个线程去执行一个 “循环任务”</li><li>在这个 “循环任务” 中不停的检查是否有任务需要被执行，如果有则直接执行，也就是调用任务中的 run 方法，将 run 方法当成一个普通的方法执行，通过这种方式将只使用固定的线程就将所有任务的 run 方法串联起来。</li></ul><div class="note default no-icon"><ul><li>当池中正在运行的线程数（包括空闲线程数）大于等于 corePoolSize 时，新插入的任务进入 workQueue 排队 (如果 workQueue 长度允许)，等待空闲线程来执行</li><li>当队列里的任务达到上限，并且池中正在进行的线程小于 maxinumPoolSize, 对于新加入的任务，新建线程</li><li>队列里的任务达到上限，并且池中正在运行的线程等于 maximumPoolSize，对于新加入的任务，执行拒绝策略（线程池默认的策略是抛异常）</li></ul></div><h4 id="拒绝策略"><a class="anchor" href="#拒绝策略">#</a> 拒绝策略</h4><ol><li>ThreadPoolExecutor.AbortPolicy：丢弃任务并抛出 RejectedExecutionException 异常。</li><li>ThreadPoolExecutor.DiscardPolicy：丢弃任务，但是不抛出异常。</li><li>ThreadPoolExecutor.DiscardOldestPolicy：丢弃队列最前面的任务，然后重新提交被拒绝的任务</li><li>ThreadPoolExecutor.CallerRunsPolicy：由调用线程（提交任务的线程）处理该任务</li></ol><p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3hpZXdlbmZlbmc1MjAvYXJ0aWNsZS9kZXRhaWxzLzEwNzAxMzY2NQ==">源码解析</span></p><div class="note info no-icon"><p>核心就是：</p><ul><li>通过取 Worker 的 firstTask 或者 getTask 方法从 workQueue 中取出了新任务，并直接调用 Runnable 的 run 方法来执行任务，也就是如之前所说的，每个线程都始终在一个大循环中，反复获取任务，然后执行任务，从而实现了线程的复用</li></ul></div><h2 id="安全问题"><a class="anchor" href="#安全问题">#</a> 安全问题</h2><p>问题场景：比如买票同时被多人买<br>原因：当某个线程尚未操作完成时，其他线程参与过来，也操作车票</p><h3 id="synchronized"><a class="anchor" href="#synchronized">#</a> synchronized</h3><p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3poYW5ncWlsdUdydWJieS9hcnRpY2xlL2RldGFpbHMvODA1MDA1MDU=">更多案例</span></p><blockquote><p>方法一：同步代码块</p></blockquote><p><strong>关键字 synchronized（同步监视器）</strong></p><ol><li>操作共享数据的代码就是需要同步的代码</li><li>同步监视器俗称锁，任何一个类的对象都可以充当锁</li><li>要求：需要同步的线程要共用同一把锁</li><li>操作同步代码时只能运行一个线程，相当于一个单线程，但能保证安全问题</li></ol><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">class</span> mythread <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">int</span> tickect <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token class-name">Object</span> object<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">/* 如果是继承方法的多线程，要这样书写</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    Object static object=new Object ();</pre></td></tr><tr><td data-num="6"></td><td><pre>    因为在主函数中创建了三个 mythread 对象，要加 static 只生成一个 object 确保公用一把锁。*/</pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>object<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>			<span class="token comment">// 也可以直接写成 synchronized (this) 这里的 this 指 myehread 对象</span></pre></td></tr><tr><td data-num="14"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>tickect <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>                    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>                        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>                    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"卖了第"</span> <span class="token operator">+</span> tickect <span class="token operator">+</span> <span class="token string">"张票"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>                    tickect<span class="token operator">--</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>                    <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        mythread mythread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">mythread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>mythread<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token class-name">Thread</span> t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>mythread<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token class-name">Thread</span> t3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>mythread<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre></pre></td></tr><tr><td data-num="39"></td><td><pre>        t1<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"一号窗口"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        t2<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"二号窗口"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        t3<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"三号窗口"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre></pre></td></tr><tr><td data-num="43"></td><td><pre>        t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>        t3<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><div class="note warning no-icon"><ul><li>在实现 Runnable 接口创建多线程的方式中，可以考虑用 this 充当对象</li><li>在继承 thread 创建多线程的方式中，慎用 this 充当对象，可以考虑用当前类充当对象</li></ul></div><blockquote><p>方法二：同步方法接口</p></blockquote><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">class</span> mythread <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">int</span> tickect <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token keyword">boolean</span> ture <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token keyword">while</span> <span class="token punctuation">(</span>ture<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>                <span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    </pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token comment">// 实现接口多线程使用同步方法</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>tickect <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"卖了第"</span> <span class="token operator">+</span> tickect <span class="token operator">+</span> <span class="token string">"张票"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            tickect<span class="token operator">--</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><div class="note warning no-icon"><p>继承 thread 多线程同步方法需要调用静态方法<br><code>public static synchronized void show()&#123;&#125;</code></p></div><ol><li>同步方法依然涉及到同步监视器，只是不显示说明。</li><li>非静态同步方法的同步监视器是：this</li></ol><p>​ 静态同步方法的同步监视器是：当前类</p><h2 id="多线程综合案例"><a class="anchor" href="#多线程综合案例">#</a> 多线程综合案例</h2><h3 id="买票"><a class="anchor" href="#买票">#</a> 买票</h3><p>使用生产者消费者模式。通过缓存区，保证产品数量大于消费数量</p><figure class="highlight java"><figcaption data-lang="java"><span>title:Thread1</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token doc-comment comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 测试生产者消费者-->利用缓冲区：管程法</pre></td></tr><tr><td data-num="3"></td><td><pre> */</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">// 成产者，消费者，产品，缓存区</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestPC</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token class-name">Syncontainer</span> syncontainer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Syncontainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token keyword">new</span> <span class="token class-name">Productor</span><span class="token punctuation">(</span>syncontainer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token keyword">new</span> <span class="token class-name">Consumer</span><span class="token punctuation">(</span>syncontainer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment">// 生产者</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">Productor</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token class-name">Syncontainer</span> container<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Productor</span><span class="token punctuation">(</span><span class="token class-name">Syncontainer</span> container<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>container<span class="token operator">=</span>container<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token comment">// 生产</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>                container<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Chicken</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"生产了"</span><span class="token operator">+</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"只鸡"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token comment">// 消费者</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">Consumer</span> <span class="token keyword">extends</span>  <span class="token class-name">Thread</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token class-name">Syncontainer</span> container<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Consumer</span><span class="token punctuation">(</span><span class="token class-name">Syncontainer</span> container<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>container<span class="token operator">=</span>container<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token comment">// 消费</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"消费了->"</span><span class="token operator">+</span>container<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>id<span class="token operator">+</span><span class="token string">"只鸡"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="54"></td><td><pre><span class="token comment">// 产品</span></pre></td></tr><tr><td data-num="55"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">Chicken</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>    <span class="token keyword">int</span> id<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>    <span class="token class-name">Chicken</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token operator">=</span>id<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="61"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="62"></td><td><pre><span class="token comment">// 缓冲区</span></pre></td></tr><tr><td data-num="63"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">Syncontainer</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>    <span class="token comment">// 需要一个容器大小</span></pre></td></tr><tr><td data-num="65"></td><td><pre>    <span class="token class-name">Chicken</span><span class="token punctuation">[</span><span class="token punctuation">]</span> chickens <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Chicken</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>    <span class="token keyword">int</span> count <span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>    <span class="token comment">// 生产者放入产品</span></pre></td></tr><tr><td data-num="68"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">push</span><span class="token punctuation">(</span><span class="token class-name">Chicken</span> chicken<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>        <span class="token comment">// 如果容器满了，需要消费者消费</span></pre></td></tr><tr><td data-num="70"></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span>count <span class="token operator">==</span>chickens<span class="token punctuation">.</span>length<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="71"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="74"></td><td><pre></pre></td></tr><tr><td data-num="75"></td><td><pre>        <span class="token comment">// 如果没有满，就需要生产产品放入</span></pre></td></tr><tr><td data-num="76"></td><td><pre>        chickens<span class="token punctuation">[</span>count<span class="token punctuation">]</span> <span class="token operator">=</span> chicken<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>        count<span class="token operator">++</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="78"></td><td><pre></pre></td></tr><tr><td data-num="79"></td><td><pre>        <span class="token comment">// 可以通知消费者了</span></pre></td></tr><tr><td data-num="80"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>    <span class="token comment">// 消费者消费产品</span></pre></td></tr><tr><td data-num="83"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token class-name">Chicken</span> <span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>        <span class="token comment">// 判断缓冲区是否还有产品</span></pre></td></tr><tr><td data-num="85"></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span>count<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="86"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>            <span class="token comment">// 等待生产者生产，消费者等待</span></pre></td></tr><tr><td data-num="88"></td><td><pre>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="89"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="90"></td><td><pre>        count<span class="token operator">--</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="91"></td><td><pre>        <span class="token keyword">return</span> chickens<span class="token punctuation">[</span>count<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="92"></td><td><pre><span class="token comment">//        this.notifyAll();</span></pre></td></tr><tr><td data-num="93"></td><td><pre>        <span class="token comment">// 吃完了，通知生产者生产</span></pre></td></tr><tr><td data-num="94"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="95"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="信号灯法通过标志为解决"><a class="anchor" href="#信号灯法通过标志为解决">#</a> 信号灯法，通过标志为解决</h3><figure class="highlight java"><figcaption data-lang="java"><span>title:Thread2</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>xjt<span class="token punctuation">.</span>gaoji</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token doc-comment comment">/**</span></pre></td></tr><tr><td data-num="4"></td><td><pre> * 测试生产者，消费者问题 2：信号灯法</pre></td></tr><tr><td data-num="5"></td><td><pre> * 标志位解决</pre></td></tr><tr><td data-num="6"></td><td><pre> */</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestPC2</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token class-name">TV</span> tv <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TV</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token keyword">new</span> <span class="token function">actor</span><span class="token punctuation">(</span>tv<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token keyword">new</span> <span class="token function">watcher</span><span class="token punctuation">(</span>tv<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment">// 生产者 -> 演员</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">class</span> actor <span class="token keyword">extends</span> <span class="token class-name">Thread</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token class-name">TV</span> tv<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">public</span> <span class="token function">actor</span><span class="token punctuation">(</span><span class="token class-name">TV</span> tv<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>tv<span class="token operator">=</span>tv<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>                <span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">%</span><span class="token number">2</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="26"></td><td><pre>                <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>                    tv<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token string">"抖音:记录美好生活"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>                <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>                    tv<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token string">"快乐大本营"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token comment">// 消费者 -> 观众</span></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token keyword">class</span> watcher <span class="token keyword">extends</span> <span class="token class-name">Thread</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token class-name">TV</span> tv<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token keyword">public</span> <span class="token function">watcher</span><span class="token punctuation">(</span><span class="token class-name">TV</span> tv<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>tv<span class="token operator">=</span>tv<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>                tv<span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">"观众"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="57"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="58"></td><td><pre><span class="token comment">// 产品 ->Tv</span></pre></td></tr><tr><td data-num="59"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">TV</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>    <span class="token class-name">String</span> video<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre><span class="token comment">//    String Watchername;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>    <span class="token keyword">boolean</span> flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>    <span class="token comment">// 演员表演，观众等待 T</span></pre></td></tr><tr><td data-num="64"></td><td><pre>    <span class="token comment">// 观众观看，演员等待 F</span></pre></td></tr><tr><td data-num="65"></td><td><pre>    <span class="token comment">// 表演方法</span></pre></td></tr><tr><td data-num="66"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">play</span><span class="token punctuation">(</span><span class="token class-name">String</span> vidio<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>        <span class="token comment">// 判断如果是 true，则表演节目</span></pre></td></tr><tr><td data-num="68"></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="69"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"演员表演了->"</span><span class="token operator">+</span>vidio<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>            <span class="token comment">// 通知观众观看</span></pre></td></tr><tr><td data-num="73"></td><td><pre>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 通知观众观看节目</span></pre></td></tr><tr><td data-num="74"></td><td><pre>            <span class="token keyword">this</span><span class="token punctuation">.</span>video<span class="token operator">=</span>vidio<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>            flag<span class="token operator">=</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>flag<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 否则，等待观众观看</span></pre></td></tr><tr><td data-num="77"></td><td><pre>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">watch</span><span class="token punctuation">(</span><span class="token class-name">String</span> watchername<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>        <span class="token comment">// 判断如果为 flase，则观众观看节目</span></pre></td></tr><tr><td data-num="82"></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>flag<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="83"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>watchername<span class="token operator">+</span><span class="token string">"观看了"</span><span class="token operator">+</span>video<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>            flag<span class="token operator">=</span><span class="token operator">!</span>flag<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="88"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>  <span class="token comment">// 否则等待，直到表演者表演完，再继续观看</span></pre></td></tr><tr><td data-num="89"></td><td><pre>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="90"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="91"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="92"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="加锁解决并发"><a class="anchor" href="#加锁解决并发">#</a> 加锁解决并发</h3><figure class="highlight java"><figcaption data-lang="java"><span>title:Thread3</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>locks<span class="token punctuation">.</span></span><span class="token class-name">Lock</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>locks<span class="token punctuation">.</span></span><span class="token class-name">ReentrantLock</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token doc-comment comment">/**</span></pre></td></tr><tr><td data-num="5"></td><td><pre> * 买票系统会出现不安全</pre></td></tr><tr><td data-num="6"></td><td><pre> * 需要加上锁</pre></td></tr><tr><td data-num="7"></td><td><pre> * 通过ReenTrantlock对象进行加锁，解锁</pre></td></tr><tr><td data-num="8"></td><td><pre> * private final ReentrantLock locks = new ReentrantLock();</pre></td></tr><tr><td data-num="9"></td><td><pre> */</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestReentrantLock</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        buyticket person <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">buyticket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token class-name">Thread</span> t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        t<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        t<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        t<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        t<span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        t<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token comment">// 一个卖票的类</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token keyword">class</span> buyticket <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token comment">//Reentrantlock: 可重进锁</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> locks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token comment">// 票数</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token keyword">int</span> ticket <span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token comment">// 重写的方法</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>                <span class="token comment">// 开启一个锁        开启一个锁最好放在 try 语句</span></pre></td></tr><tr><td data-num="35"></td><td><pre>                locks<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>                <span class="token keyword">if</span><span class="token punctuation">(</span>ticket<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="37"></td><td><pre>                <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>                    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>                        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>                    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>ticket<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>                <span class="token keyword">else</span></pre></td></tr><tr><td data-num="46"></td><td><pre>                <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"你买的票已经被购完"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>                    <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>            <span class="token punctuation">&#125;</span><span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>                <span class="token comment">// 关闭一个锁</span></pre></td></tr><tr><td data-num="52"></td><td><pre>                locks<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h1 id="锁"><a class="anchor" href="#锁">#</a> 锁</h1><p>自旋锁、适应性自旋锁、锁消除、锁粗化、偏向锁、轻量级锁<br>锁的状态从低到高依次为无锁 -&gt; 偏向锁 -&gt; 轻量级锁 -&gt; 重量级锁，升级的过程就是从低到高，降级在一定条件也是有可能发生的。</p><p><strong>自旋锁</strong>：由于大部分时候，锁被占用的时间很短，共享变量的锁定时间也很短，所有没有必要挂起线程，用户态和内核态的来回上下文切换严重影响性能。自旋的概念就是让线程执行一个忙循环，可以理解为就是啥也不干，防止从用户态转入内核态，自旋锁可以通过设置 - XX:+UseSpining 来开启，自旋的默认次数是 10 次，可以使用 - XX:PreBlockSpin 设置。</p><ul><li>性能提升、减少上下文切换的消耗。但不适合竞争激烈或者持有锁的线程需要长时间占用锁执行同步块，因为会占用 cpu 做无用功造成 CPU 浪费</li><li>为防止一直自旋抢不到锁的，又有 <code>TicketLock</code> 采用排队叫号的机制，但需要缓存同步，这会导致繁重的系统总线和内存的流量，大大降低系统整体的性能。又有 CLHLock 和 MCSLock 通过链表的方式避免了减少了处理器缓存同步</li></ul><p><strong>自适应锁</strong>：自适应锁就是自适应的自旋锁，自旋的时间不是固定时间，而是由前一次在同一个锁上的自旋时间和锁的持有者状态来决定。</p><p><strong>锁消除</strong>：锁消除指的是 JVM 检测到一些同步的代码块，完全不存在数据竞争的场景，也就是不需要加锁，就会进行锁消除。</p><p><strong>锁粗化</strong>：锁粗化指的是有很多操作都是对同一个对象进行加锁，就会把锁的同步范围扩展到整个操作序列之外。</p><p><strong>偏向锁</strong>：当线程访问同步块获取锁时，会在对象头和栈帧中的锁记录里存储偏向锁的线程 ID，之后这个线程再次进入同步块时都不需要 CAS 来加锁和解锁了，偏向锁会永远偏向第一个获得锁的线程，如果后续没有其他线程获得过这个锁，持有锁的线程就永远不需要进行同步，反之，当有其他线程竞争偏向锁时，持有偏向锁的线程就会释放偏向锁。可以用过设置 - XX:+UseBiasedLocking 开启偏向锁。</p><p><strong>轻量级锁</strong>：JVM 的对象的对象头中包含有一些锁的标志位，代码进入同步块的时候，JVM 将会使用 CAS 方式来尝试获取锁，如果更新成功则会把对象头中的状态位标记为轻量级锁，如果更新失败，当前线程就尝试自旋来获得锁。整个锁升级的过程非常复杂，我尽力去除一些无用的环节，简单来描述整个升级的机制。简单点说，偏向锁就是通过对象头的偏向线程 ID 来对比，甚至都不需要 CAS 了，而轻量级锁主要就是通过 CAS 修改对象头锁记录和自旋来实现，重量级锁则是除了拥有锁的线程其他全部阻塞。</p><p><img data-src="image-20240401111401274.png" alt=""></p><h2 id="cas"><a class="anchor" href="#cas">#</a> CAS</h2><ul><li>CAS (compare and swap) 可以理解成一种乐观的自旋锁的机制，使用他时不锁住对象，达到加锁的目的。（乐观锁 和 并发原子类也是利用 CAS 工具实现的）</li></ul><p><img data-src="https://img-blog.csdnimg.cn/20200917191510311.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDU1MjIxNQ==,size_16,color_FFFFFF,t_70#pic_center" alt=""></p><h3 id="重试机制"><a class="anchor" href="#重试机制">#</a> 重试机制</h3><p>有文章说，CAS 操作失败后会一直重试直到成功，这种说法很不严谨。</p><p>第一，CAS 本身并未实现失败后的处理机制，它只负责返回成功或失败的布尔值，后续由调用者自行处理。只不过我们最常用的处理方式是重试而已。</p><p>第二，这句话很容易理解错，被理解成重新比较并交换。实际上失败的时候，原值已经被修改，如果不更改期望值，再怎么比较都会失败。而新值同样需要修改。</p><p>所以正确的方法是，使用一个死循环进行 CAS 操作，成功了就结束循环返回，失败了就重新从内存读取值和计算新值，再调用 CAS。看下 AtomicInteger 的源码就什么都懂了：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> incrementAndGet <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token keyword">int</span> current <span class="token operator">=</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token keyword">int</span> next <span class="token operator">=</span> current <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>            <span class="token keyword">return</span> next<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><strong>值得注意的是， CAS 只是保证了操作的原子性，并不保证变量的可见性，因此变量需要加上 volatile 关键字。</strong></p><h2 id="aqs"><a class="anchor" href="#aqs">#</a> AQS</h2><p>AQS (AbstractQueuedSynchronizer) 是一种 JAVA 底层实现线程管理的机制，主要用途为并发工具类，提供管理线程（创建，等待，唤醒，销毁）等操作的工具类</p><ul><li>AQS 是一个用来构建锁和同步器的框架，使用 AQS 能简单且高效地构造出应用广泛的大量的同步器，比如我们提到的 ReentrantLock，Semaphore，其他的诸如 ReentrantReadWriteLock，SynchronousQueue，FutureTask 等等皆是基于 AQS 的。当然，我们自己也能利用 AQS 非常轻松容易地构造出符合我们自己需求的同步器。</li><li>AQS 核心思想是，如果被请求的共享资源空闲，则将当前请求资源的线程设置为有效的工作线程，并且将共享资源设置为锁定状态。如果被请求的共享资源被占用，那么就需要一套线程阻塞等待以及被唤醒时锁分配的机制，这个机制 AQS 是用 CLH 队列锁实现的，即将暂时获取不到锁的线程加入到队列中。 CLH (Craig,Landin,and Hagersten) 队列是一个虚拟的双向队列 (虚拟的双向队列即不存在队列实例，仅存在结点之间的关联关系)。AQS 是将每条请求共享资源的线程封装成一个 CLH 锁队列的一个结点 (Node) 来实现锁的分配。 AQS 使用一个 int 成员变量来表示同步状态，通过内置的 FIFO 队列来完成获取资源线程的排队工作。AQS 使用 CAS 对该同步状态进行原子操作实现对其值的修改。</li></ul><figure class="highlight java"><figcaption data-lang="java"><span>title:AQSDemo</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AQSDemo</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> num<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>                lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>                        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>                        num <span class="token operator">+=</span> <span class="token number">1000</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"A 线程执行了1秒,num = "</span><span class="token operator">+</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>                    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>                <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>                    lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token string">"A"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>            <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="28"></td><td><pre>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>                lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>                    num <span class="token operator">+=</span> <span class="token number">500</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"B 线程执行了0.5秒,num = "</span><span class="token operator">+</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>                <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>                    lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token string">"B"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre></pre></td></tr><tr><td data-num="43"></td><td><pre>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>            <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="45"></td><td><pre>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>                lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>                    num <span class="token operator">+=</span> <span class="token number">100</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"C 线程执行了0.1秒,num = "</span><span class="token operator">+</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>                <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>                    lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token string">"C"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="60"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>重复执行会发现每次顺序不同（理论上，但我测试就是顺序的，可能执行太快了？），但都是要 1600ms（这个一定），而不是 start () 启动了多线程</p><h1 id="设计模式"><a class="anchor" href="#设计模式">#</a> 设计模式</h1><h1 id="数据结构"><a class="anchor" href="#数据结构">#</a> 数据结构</h1><h2 id="hashmap"><a class="anchor" href="#hashmap">#</a> HashMap</h2><p><strong>–》JDK 1.7</strong> ： Table 数组 + Entry 链表<br><strong>–》JDK1.8</strong> : Table 数组 + Entry 链表 / 红黑树</p><ul><li>为什么使用数组 + 链表？</li><li>用 LinkedList 代替数组可以吗？</li><li>既然是可以的，为什么不用反而用数组？</li></ul><h3 id="重要变量"><a class="anchor" href="#重要变量">#</a> 重要变量</h3><ul><li><code>DEFAULT_INITIAL_CAPACITY</code>  Table 数组的初始化长度：  <code>1 &lt;&lt; 4``2^4=16</code> （为什么要是 2 的 n 次方？）</li><li><code>MAXIMUM_CAPACITY</code>  Table 数组的最大长度：  <code>1&lt;&lt;30</code> <code>2^30=1073741824</code></li><li><code>DEFAULT_LOAD_FACTOR</code>  负载因子：默认值为 <code>0.75</code> 。 当元素的总个数 &gt; 当前数组的长度 * 负载因子。数组会进行扩容，扩容为原来的两倍（todo：为什么是两倍？）</li><li><code>TREEIFY_THRESHOLD</code>  链表树化阙值： 默认值为  <code>8</code>  。表示在一个 node（Table）节点下的值的个数大于 8 时候，会将链表转换成为红黑树。</li><li><code>UNTREEIFY_THRESHOLD</code>  红黑树链化阙值： 默认值为  <code>6</code>  。 表示在进行扩容期间，单个 Node 节点下的红黑树节点的个数小于 6 时候，会将红黑树转化成为链表。</li><li><code>MIN_TREEIFY_CAPACITY = 64</code>  最小树化阈值，当 Table 所有元素超过改值，才会进行树化（为了防止前期阶段频繁扩容和树化过程冲突）</li></ul><h3 id="实现原理"><a class="anchor" href="#实现原理">#</a> 实现原理</h3><p><img data-src="https://pic1.zhimg.com/80/v2-3e203e5dcf8c12e7ebf137c344615aa4_720w.webp" alt=""><br>HashMap 采⽤ Entry 数组来存储 key-value 对，每⼀个键值对组成了⼀个 Entry 实体 (实现 Map.Entry&lt; K ,V&gt; 这个接口，通过 entry 类可以构成一个单向链表 )，Entry 类实际上是⼀个单向的链表结 构，它具有 Next 指针，可以连接下⼀个 Entry 实体。 只是在 JDK1.8 中，链表⻓度⼤于 8 的时候，链表会转成红⿊树！</p><p><strong>第一问：</strong> 为什么使用链表 + 数组：</p><ul><li>要知道为什么使用链表首先需要知道 Hash 冲突是如何来的：</li><li>由于我们的数组的值是限制死的，我们在对 key 值进行散列取到下标以后，放入到数组中时，难免出现两个 key 值不同，但是却放入到下标相同的<strong>格子</strong>中，此时我们就可以使用链表来对其进行链式的存放。</li></ul><p><strong>第二问：</strong> ⽤ LinkedList 代替数组结构可以吗？<br>源码：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name">Entry</span><span class="token punctuation">[</span><span class="token punctuation">]</span> table<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Entry</span><span class="token punctuation">[</span>capacity<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>是否可以替换：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Entry</span><span class="token punctuation">></span></span> table<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Entry</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>可以的。</p><p><strong>第三问：</strong> 那既然可以使用进行替换处理，为什么有偏偏使用到数组呢？</p><ul><li>因为⽤数组效率最⾼！ 在 HashMap 中，定位节点的位置是利⽤元素的 key 的哈希值对数组⻓度取模得到。此时，我们已得到节点的位置。显然数组的查 找效率⽐ <code>LinkedList</code> ⼤（底层是链表结构）。</li><li>那 <code>ArrayList</code> ，底层也是数组，查找也快啊，为啥不⽤ ArrayList? 因为采⽤基本数组结构，扩容机制可以⾃⼰定义，HashMap 中数组扩容刚好是<strong> 2 的次幂</strong>，在做取模运算的效率⾼。 ⽽ ArrayList 的扩容机制是 1.5 倍扩容（这一点我相信学习过的都应该清楚），那 ArrayList 为什么是 1.5 倍扩容这就不在本⽂说明了。</li></ul><div class="note info no-icon"><p>ArrayList 初始化是 10, 通过 grow () 方法来进行扩容</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">grow</span><span class="token punctuation">(</span><span class="token keyword">int</span> minCapacity<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>     <span class="token comment">// 此处 minCapacity 为 10</span></pre></td></tr><tr><td data-num="2"></td><td><pre>        <span class="token comment">// overflow-conscious code</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token comment">// 旧容量就是原数组的长度</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token keyword">int</span> oldCapacity <span class="token operator">=</span> elementData<span class="token punctuation">.</span>length<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token comment">// 新容量等于旧容量加上旧容量右移一位，也就是 1.5 倍</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token keyword">int</span> newCapacity <span class="token operator">=</span> oldCapacity <span class="token operator">+</span> <span class="token punctuation">(</span>oldCapacity <span class="token operator">>></span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token comment">// 如果计算出的新容量 比 minCapacity 还小的话，就用 minCapacity 表示新容量</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>newCapacity <span class="token operator">-</span> minCapacity <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            newCapacity <span class="token operator">=</span> minCapacity<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token comment">// 如果计算出的新容量 比 MAX_ARRAY_SIZE 还大的话，就调用 hugeCapacity 计算新容量</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>newCapacity <span class="token operator">-</span> <span class="token constant">MAX_ARRAY_SIZE</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            newCapacity <span class="token operator">=</span> <span class="token function">hugeCapacity</span><span class="token punctuation">(</span>minCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token comment">// minCapacity is usually close to size, so this is a win:</span></pre></td></tr><tr><td data-num="14"></td><td><pre> </pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token comment">// 直接用 Arrays 这个工具类中的 copyof () 方法来进行数组复制</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        elementData <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">copyOf</span><span class="token punctuation">(</span>elementData<span class="token punctuation">,</span> newCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><code>int newCapacity = oldCapacity + (oldCapacity &gt;&gt; 1);</code> 所以扩容到原来的 1.5 倍，但为什么不扩容到 1.2 或者 2 倍呢，因为 1.2 扩容空间太小，而 2 倍则扩充的空间太大 ，所以权衡之下，源码采用扩容 1.5 倍的做法</p></div><p><strong>第四问：</strong> 为什么扩容是 2 的次幂？</p><ul><li>与 Hash 映射有关，通过与操作达到 <code>hashcode()</code> 的值映射到表长度区间 ( <code>[0, Table.length-1]</code> ) 内，此时与的对象是 <code>Table.length-1</code> ，因此，只有 Table 数组的长度为 2 的次方，才能最大程度的利用映射空间。</li></ul><p>扩展： HashMap 不支持并发操作，没有同步方法，于是衍生出了支持并发操作的 <code>ConcurrentHashMap</code> ，通过继承 <code>ReentrantLock</code> （JDK1.7 重入锁）/ <code>CAS</code> 和 <code>synchronized</code> (JDK1.8 内置锁) 来进行加锁（分段锁），每次需要加锁的操作锁住的是一个 segment，这样只要保证每个 Segment 是线程安全的，也就实现了全局的线程安全。相比 <code>SynchronizedMap</code> 更为精细，不会一🔒就锁了整个 Map，只锁要用到的 segment。</p><ul><li>ConcurrentHashMap 类中包含两个静态内部类 HashEntry 和 Segment。HashEntry 用来封装映射表的键 / 值对；Segment 用来充当锁的角色，每个 Segment 对象守护整个散列映射表的若干个桶。每个桶是由若干个 HashEntry 对象链接起来的链表。一个 ConcurrentHashMap 实例中包含由若干个 Segment 对象组成的数组。</li></ul><h3 id="其他问题安全-并发"><a class="anchor" href="#其他问题安全-并发">#</a> 其他问题（安全、并发）</h3><p><strong>第五问：</strong> HashMap 的线程为什么不安全？</p><p>HashMap 在 <code>jdk1.7</code> 中 使用 数组加链表的方式，并且在进行链表插入时候使用的是头结点插入的方法。<br><strong>注</strong> ：这里为什么使用 头插法的原因是我们若是在散列以后，判断得到值是一样的，使用头插法，不用每次进行遍历链表的长度。但是这样会有一个缺点，在进行扩容时候，会导致进入新数组时候出现倒序的情况，也会在多线程时候出现线程的不安全性。<br>但是对与  <code>jdk1.8</code>  而言，还是要进行阙值的判断，判断在什么时候进行红黑树和链表的转换。所以无论什么时候都要进行遍历，于是插入到尾部，防止出现扩容时候还会出现倒序情况。</p><p>所以当在多线程的使用场景中，<strong>尽量使用线程安全的 ConcurrentHashMap</strong>。至于 <code>Hashtable</code> 而言，使用效率太低。</p><p><strong>第五问：</strong> 1.7 中 HashMap 为什么有死循环的安全问题？<br>多线程并发头插法导致的。假设有两个线程，线程 1 和线程 2，两个线程进行 hashMap 的 put 操作，触发了扩容。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token function">transfer</span><span class="token punctuation">(</span><span class="token class-name">Entry</span><span class="token punctuation">[</span><span class="token punctuation">]</span> newTable<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>      <span class="token class-name">Entry</span><span class="token punctuation">[</span><span class="token punctuation">]</span> src <span class="token operator">=</span> table<span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre>      <span class="token keyword">int</span> newCapacity <span class="token operator">=</span> newTable<span class="token punctuation">.</span>length<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> src<span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="5"></td><td><pre>          <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> e <span class="token operator">=</span> src<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>           </pre></td></tr><tr><td data-num="6"></td><td><pre>          <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 两个线程都先进入 if</span></pre></td></tr><tr><td data-num="7"></td><td><pre>              src<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="8"></td><td><pre>              <span class="token keyword">do</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="9"></td><td><pre>                  <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> next <span class="token operator">=</span> e<span class="token punctuation">.</span>next<span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="10"></td><td><pre>                 <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token function">indexFor</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>hash<span class="token punctuation">,</span> newCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>                 e<span class="token punctuation">.</span>next <span class="token operator">=</span> newTable<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 线程 1 这里还没执行 停下</span></pre></td></tr><tr><td data-num="12"></td><td><pre>                 newTable<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="13"></td><td><pre>                 e <span class="token operator">=</span> next<span class="token punctuation">;</span>             </pre></td></tr><tr><td data-num="14"></td><td><pre>             <span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>         <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>     <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>线程 1 和线程 2 都进入 if，然后线程 1 没有拿到 cpu 的资源在上面代码注释的地方停下了。此时的变量指针如下图所示：<br><img data-src="https://img-blog.csdnimg.cn/20210113183932506.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvbmdzZW5saW4zNDE=,size_16,color_FFFFFF,t_70" alt=""><br>记住 线程 1 中 E 变量指向 a 结点，next 变量指向 b 结点。<br>下面是线程 2 拿到 cpu 的资源，执行结点转移<br><img data-src="https://img-blog.csdnimg.cn/20210113183945982.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvbmdzZW5saW4zNDE=,size_16,color_FFFFFF,t_70" alt=""></p><p><img data-src="https://img-blog.csdnimg.cn/20210113183959741.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvbmdzZW5saW4zNDE=,size_16,color_FFFFFF,t_70" alt=""></p><p><img data-src="https://img-blog.csdnimg.cn/20210113184049658.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvbmdzZW5saW4zNDE=,size_16,color_FFFFFF,t_70" alt=""></p><p>CPU 切换，线程 2 停下，又轮到线程 1<br>因为之前线程 1 中 E 变量指向的是 a 结点，next 变量指向的是 b 结点，所以如下图所示：<br><img data-src="https://img-blog.csdnimg.cn/20210113184106784.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvbmdzZW5saW4zNDE=,size_16,color_FFFFFF,t_70" alt=""></p><p>此时线程 1 执行第二个注释的后续代码，就造成了链表的死循环，结果如下：<br><img data-src="https://img-blog.csdnimg.cn/20210113184120471.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvbmdzZW5saW4zNDE=,size_16,color_FFFFFF,t_70" alt=""></p><p><strong>第六问：</strong> 为什么不一开始就使用红黑树，不是效率很高吗？</p><ul><li>因为红⿊树需要进⾏左旋，右旋，变⾊这些操作来保持平衡，⽽单链表不需要。</li><li>当元素⼩于 8 个当时候，此时做查询操作，链表结构已经能保证查询性能。 当元素⼤于 8 个的时候，此时需要红⿊树来加快查 询速度，但是新增节点的效率变慢了。<br>因此，如果⼀开始就⽤红⿊树结构，元素太少，新增效率⼜⽐较慢，⽆疑这是浪费性能的。</li></ul><p><strong>第七问：</strong> 什么时候退化为链表？</p><ul><li>为 6 的时候退转为链表。中间有个差值 7 可以防⽌链表和树之间频繁的转换。</li><li>假设⼀下，如果设计成链表个数超过 8 则链表转 换成树结构，链表个数⼩于 8 则树结构转换成链表， 如果⼀个 HashMap 不停的插⼊、删除元素，链表个数在 8 左右徘徊，就会 频繁的发⽣树转链表、链表转树，效率会很低。</li></ul><p><strong>第八问：</strong> key 可以是 null 吗，value 可以是 null 吗？</p><ul><li>当然都是可以的，但是对于 key 来说只能运行出现一个 key 值为 null，但是可以出现多个 value 值为 null</li></ul><p><strong>第九问：</strong> 一般用什么作为 key 值？</p><p>⼀般⽤ Integer、String 这种不可变类当 HashMap 当 key，⽽且 String 最为常⽤。</p><ul><li>因为字符串是不可变的，所以在它创建的时候 hashcode 就被缓存了，不需要重新计算。 这就使得字符串很适合作为 Map 中的键，字符串的处理速度要快过其它的键对象。 这就是 HashMap 中的键往往都使⽤字符串</li><li>因为获取对象的时候要⽤到 equals () 和 hashCode () ⽅法，那么键对象正确的重写这两个⽅法是⾮常重要的，这些类已 经很规范的覆写了 hashCode () 以及 equals () ⽅法</li></ul><h2 id="concurrenthashmap"><a class="anchor" href="#concurrenthashmap">#</a> ConcurrentHashMap</h2><blockquote><p>SynchronizedMap 和 ConcurrentHashMap 有什么区别？</p></blockquote><p>SynchronizedMap () 和 Hashtable 一样，实现上在调用 map 所有方法时，都对整个 map 进行同步。<br>而 ConcurrentHashMap 的实现却更加精细，它对 map 中的所有桶加了锁。所以，只要有一个线程访问 map，其他线程就无法进入 map，而如果一个线程在访问 ConcurrentHashMap 某个桶时，其他线程，仍然可以对 map 执行某些操作。所以，ConcurrentHashMap 在性能以及安全性方面，明显比 Collections.synchronizedMap () 更加有优势。同时，同步操作精确控制到桶，这样，即使在遍历 map 时，如果其他线程试图对 map 进行数据修改，也不会抛出 ConcurrentModificationException。</p><h2 id="红黑树"><a class="anchor" href="#红黑树">#</a> 红黑树</h2><p>太经典了，但每次都是一看就会，隔两天一想就忘...</p><h1 id="一些java机制"><a class="anchor" href="#一些java机制">#</a> 一些 Java 机制</h1><h2 id="fail-fast"><a class="anchor" href="#fail-fast">#</a> fail-fast</h2><p>fail-fast 机制是<strong> Java 集合</strong> (Collection) 中的一种<strong>错误机制</strong>。 在用迭代器遍历一个集合对象时，如果遍历过程中对集合对象的结构进行了修改（增加、删除），则会抛出<strong> Concurrent Modification Exception</strong>（并发修改异常）。</p><p>所以，在多线程环境下，是很容易抛出 Concurrent Modification Exception 的，比如线程 1 正在对集合进行遍历，此时线程 2 对集合进行修改（增加、删除）。但是，单线程就不会抛出吗？很明显，单线程也会有类似的情况，比如 main 线程在遍历时对集合进行修改（增加、删除、修改），那么 main 线程就会抛出 Concurrent Modification Exception 异常。</p><ol><li>如果非要在遍历的时候修改集合，那么建议用迭代器的 remove 等方法，而不是用集合的 remove 等方法。(老实遵守阿里巴巴 java 开发规范……)</li><li>如果是并发的环境，那还要对 Iterator 对象加锁；也可以直接使用 Collections.synchronizedList。</li><li>CopyOnWriteArrayList（采用 fail-safe）</li></ol><h2 id="fail-safe"><a class="anchor" href="#fail-safe">#</a> fail-safe</h2><p>ArrayList 使用 fail-fast 机制自然是因为它增强了数据的安全性。但在某些场景，我们可能想避免 fail-fast 机制抛出的异常，这时我们就要将 ArrayList 替换为使用 fail-safe 机制的 CopyOnWriteArrayList。</p><p>采用安全失败机制的集合容器，在 Iterator 的实现上没有设计抛出 ConcurrentModificationException 的代码段，从而避免了 fail-fast。</p><ul><li>CopyOnWriteArrayList 的核心就是写时复制</li></ul><p>简单理解就是，当我们往一个容器添加元素的时候，先将当前容器复制出一个新的容器，然后新的容器里添加元素，添加完元素之后，再将原容器的引用指向新的容器。这样做的好处是我们可以对 CopyOnWrite 容器进行并发的读，而不需要加锁，因为当前容器不会添加任何元素。所以 CopyOnWrite 容器也是一种读写分离的思想，读和写不同的容器。</p><ul><li>添加的时候是需要加锁的，否则多线程写的时候会复制出 N 个副本出来</li><li>读的时候不需要加锁，如果读的时候有多个线程正在向 ArrayList 添加数据，读还是会读到旧的数据，因为写的时候不会锁住旧的 ArrayList</li><li>适用于读多写少的并发场景。比如白名单，黑名单，商品类目的访问和更新场景。</li></ul><h1 id="面经汇总"><a class="anchor" href="#面经汇总">#</a> 面经汇总</h1><p><span class="exturl" data-url="aHR0cHM6Ly9qYXZhZ3VpZGUuY24vamF2YQ==">javaguide</span><br><span class="exturl" data-url="aHR0cHM6Ly93d3cubm93Y29kZXIuY29tL2Rpc2N1c3MvNTUxMDgzNjQ1NTUzOTU0ODE2">学习线路</span> 里面有文档整理</p><h2 id="java"><a class="anchor" href="#java">#</a> java</h2><ul><li><p><strong>java8 特性？</strong></p><ul><li>lambda 表达式，经常配合函数式接口使用，可以有效减少代码量</li></ul><figure class="highlight java"><figcaption data-lang="java"><span>title:lambdaDemo</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 方式 1：定义一个类 MyRunnable 实现 Runnable 接口，重写 run () 方法</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">MyRunnable</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"多线程程序启动了..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LambdaDemo</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token comment">// 实现类的方式实现需求</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token class-name">MyRunnable</span> my <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyRunnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token comment">// 创建 Thread 类的对象，把 MyRunnable 的对象作为构造参数传递</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token class-name">Thread</span> t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>my<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token comment">// 启动线程</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        t<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token comment">// 方式 2：匿名内部类的方式改进</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment">// 把实现类的名字给省略掉了，稍微方便点，但 `run` 这个方法名其实也有点冗余，因为 Runnable 里面就这么一个方法</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LambdaDemo</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token comment">// 匿名内部类的方式改进</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="26"></td><td><pre>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"多线程程序启动了..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>①、方法形式参数为空，说明调用方法时不需要传递参数  </pre></td></tr><tr><td data-num="33"></td><td><pre>②、方法返回值类型为<span class="token keyword">void</span>，说明方法执行没有结果返回  </pre></td></tr><tr><td data-num="34"></td><td><pre>③、方法体中的内容，是我们具体要做的事情</pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token comment">// 方式 3：Lambda 表达式的方式改进</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LambdaDemo</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token comment">//Lambda 表达式改进</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"多线程程序启动了..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>①、<span class="token punctuation">(</span><span class="token punctuation">)</span>：里面没有内容，可以看成是方法形式参数为空  </pre></td></tr><tr><td data-num="46"></td><td><pre>②、<span class="token operator">-></span>：用箭头指向后面要做的事情  </pre></td></tr><tr><td data-num="47"></td><td><pre>③、<span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span>：包含一段代码，我们称之为代码块，可以看成是方法体中的内容</pre></td></tr><tr><td data-num="48"></td><td><pre></pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token operator">-</span> <span class="token class-name">Lambda</span>表达式的使用前提  </pre></td></tr><tr><td data-num="50"></td><td><pre>    ①、有一个接口  </pre></td></tr><tr><td data-num="51"></td><td><pre>    ②、接口中有且仅有一个抽象方法</pre></td></tr></table></figure><ul><li>函数式接口：如果一个接口里面只有一个方法，那么这就是一个函数式接口，对于函数式接口，我们可以通过 lambda 表达式或者方法引用来进行快速的实现，而不必新建一个 class 去继承或者写一个匿名内部类<ul><li>接口中只能有一个接口方法</li><li>可以有静态方法和默认方法</li><li>使用  <code>@FunctionalInterface</code>  标记</li><li>默认方法可以被覆写</li></ul></li><li>默认方法，意思是说，我们在写一个接口时可以通过  <code>default</code>  关键字为其中的方法提供默认的实现方案，使得实现类就算不覆写这个方法也没有关系：</li><li>Stream API，我们可以把一个集合转换为流，在这个流上做各种操作，比如查找、排序、过滤等等</li><li>新的 Date Time API，因为 java 中同时存在  <code>java.util.Date</code>  和  <code>java.sql.Date</code>  两个时间类，很容易让人迷惑，而且这两个包里的内容也存在诸多问题，因此 java8 中新增了  <code>java.time</code>  这个包来把所有时间类的 API 一网打尽</li><li>Optional 类，很好的解决了  <code>NullPointerException</code>  的问题，避免源码被各种空检查污染，使源码更加简洁和更加容易阅读</li></ul><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 假设有一个对象 obj , 你不知道它是不是为空的，但是你想用它的方法，可以这么玩 </span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> canUseObj <span class="token operator">=</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span> canUseObj<span class="token punctuation">.</span><span class="token function">ifPresent</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 如果 obj 不为空，则可以使用 obj 的方法，这里做个简单输出</span></pre></td></tr></table></figure></li><li><p>如果把项目做成分布式的大型项目，有哪些地方需要优化</p><ul><li>代码（SQL 语句）优化</li></ul></li><li><p><strong>面对海量请求的时候如何保证请求能够快速响应？</strong></p><ul><li>负载均衡</li><li>redis 缓存</li><li>提高服务器性能</li><li>优化流程（服务器尽量执行读操作）</li><li>主从复制、读写分离</li><li>监控调优</li></ul></li><li><p><strong>如果监控到了某个 api 某个时刻有请求有响应时间异常，该怎么去解决和分析？</strong></p><ul><li>保存上下文，使得能复现场景，因为也可能是网络波动等，但如果是代码问题可能有以下几个方面<ul><li>线程池满了</li><li>死锁</li><li>超时时间过段</li><li>服务 OOM</li></ul></li><li>debug，连接测试环境的数据库，调试某个 API 接口的业务逻辑</li></ul></li><li><p><strong>分布式如何做到负载均衡？</strong></p><ul><li><strong>请求分发：</strong> 负载均衡器（Load Balancer）接收到来自客户端的请求，然后将请求分发给一组服务器节点</li><li><strong>负载计算：</strong> 负载均衡器会根据各个服务器节点的负载情况，计算出最适合处理该请求的服务器</li><li><strong>请求转发：</strong> 负载均衡器将请求转发给选择出的服务器节点进行处理</li><li><strong>响应处理：</strong> 服务器节点处理请求后，将响应返回给客户端</li><li>算法：随机、轮询、最小连接、加权、ip 哈希、动态（权重、最少相应）</li></ul></li><li><p><strong>在电脑上面 ping 某个域名，会有哪些步骤？</strong></p><ul><li>ping 是基于  <code>ICMP</code>  协议工作的</li><li>主机查找本地系统 Hosts 文件的 DNS 缓存，如果存在该域名对应的 IP，则获取 IP，跳转到第 8 步；如果不存在，则继续</li><li>主机向本网络路由器发起请求，查找路由 DNS 缓存，如果存在该域名对于的 IP，则获取 IP，如果不存在，则继续<ul><li>向本地 ISP（互联网提供商）的 DNS 服务器发起请求，查找 DNS 服务器的缓存，如果存在该域名对应的 IP，如果不存在，则继续</li><li>向根域名服务器发起请求，根域名服务器告诉本地服务器，下一次应查询的顶级域名服务器 dns.com 的 IP 地址</li><li>向顶级域名服务器 dns.com 进行查询，顶级域名服务器 dns.com 告诉本地域名服务器，下一步应查询的权限服务器 dns.abc.com 的 IP 地址</li><li>向权限域名服务器 dns.abc.com 进行查询，权限域名服务器 dns.abc.com 告诉本地域名服务器，所查询的主机的 IP 地址</li></ul></li><li>查询到该域名对应的 IP 地址告诉给主机</li><li>主机通过子网掩码判断该 IP 地址是本网段还是跨网段，若跨网段（子网掩码比对）：先查看本地 ARP 高速缓存，查看表中是否有本网络路由器（网关）的 MAC 地址，没有则利用 ARP 请求分组（广播）<ul><li>主机将 ICMP 报文封装成 IP 数据报，IP 数据报的源地址为主机的 IP 地址，目的地址是域名对应的 IP 地址</li><li>主机将 IP 数据报封装成 MAC 帧，MAC 帧的源地址为主机的 MAC 地址，目的地址是路由器的 MAC 地址</li><li>路由器接收到 ICMP 报文之后，发现 MAC 帧的目的地址是自己，IP 地址是主机想要访问的 IP 地址，则将 MAC 帧的源地址改为自己的 MAC 地址，目的地址改为本网段另一个路由的 MAC 地址（也要通过 ARP 协议获取），转发下去...</li><li>直到最后一个路由根据 ARP 协议，找到了主机想要访问的 IP 地址对应的主机的 MAC 地址，然后将 ICMP 报文封装成 MAC 帧发送给该域名主机。<br><img data-src="https://cdn.xiaolincoding.com//mysql/other/c1019a8be584b27c4fc8b8abda9d3cf1.png" alt=""></li></ul></li><li>一个 ARP 包，源 IP 是自己的，目的 IP 是 B 的，源 MAC 是自己的，目的 MAC 是广播的。然后这个请求包在内网中被广播，当其他机器接收到这个包时，用目的 IP 和自己的 IP 进行比较，不是的话就丢弃。B 接到时，发现 IP 与自己的一样，就应答这个包的请求，把自己的 MAC 发送给 A</li></ul></li><li><p><strong>路由器收到一个包是怎么转发出去的，修改了哪些值和字段？</strong></p><ul><li>源 MAC 地址、目标 MAC 地址</li></ul></li><li><p><strong>对阿里云的服务了解的咋样，和其他的一些竞品有什么区别之类的？</strong></p><ul><li>阿里云的电商行业解决方案在国内无出其右，场景丰富，方案完善；其次是政务云方便，杭州城市大脑就是最好的证明（这几年貌似也只有这一个代表作）；最后是金融和工业互联网，阿里云虽说有布局，但生态相对不够完善，提供细分解决方案还不错，但整体解决方案相对不足。 稳定和安全</li><li>腾讯云脱胎于之前的 QQ 事业群，并长期存在于该事业群之下，开始并未得到重视，但随着云计算的发展及行业曙光的出现，腾讯云正在加速布局，也取得了一定的成绩。 性价比</li><li>百度云的优势无疑是人工智能，特别是在自动驾驶方面的人工智能；至于在其他方面的优势，百度目前还未体现出来，但百度是比较重视技术的，所以需要时间</li></ul></li><li><p><strong>面向对象特征， 开闭原则？</strong></p><ul><li>继承、封装、多态性（方法重载 overload 实现的是编译时的多态性（也称为前绑定），而方法重写 override 实现的是运行时的多态性（也称为后绑定））、抽象</li><li>五大原则：单一职责原则（每一个类的职责越单一，越专注最好，低耦合和高内聚）、开放封闭原则（开放扩展、封闭修改，如继承）、LisKov 替换原则（子类必须可以替换其父类，反之不成立，面向接口编程）、依赖倒置原则（高层模块不依赖低层模块、顶层只需调用这些抽象接口，底层只需实现这些抽象接口。消除了顶层和底层的直接依赖）、接口隔离原则（使用多个小而专的接口，不用大而广的接口）</li></ul></li><li><p>碰到 bug 怎么定位</p></li><li><p><strong>跟踪技术（动态追踪技术？）</strong></p><ul><li>曾经的 JSP 作为可以写 html 和 java 共存的语言， 会被转换为 java 代码 -&gt; 字节码 -&gt;class 文件 -&gt;servlet 处理，被 JVM 部署后，只需要刷新页面就能看到修改代码后的效果，这是现在的前后端分离框架如 Spring 等做不到的，通过创建一个新的 ClassLoader 实例，来加载新编译的 Servlet 类</li><li>问题本质上是动态改变内存中已存在对象的行为的问题，对于非私有的方法，会有个存储对象行为的这个公共的地方，这个方法区域是在虚拟机启动时创建的，在所有 Java 虚拟机线程之间共享，并且在逻辑上是堆区域的一部分。它存储每个类的结构，例如运行时常量池、字段和方法数据以及方法和构造函数的代码。</li><li>有没有办法加载一个已经加载过的类呢？如果有的话，我们就能修改字节码中目标方法所在的区域，然后重新加载这个类，这样方法区中的对象行为（方法）就被改变了，而且不改变对象的属性，也不影响已经存在对象的状态，那么就可以搞定这个问题了。</li><li><code>java.lang.instrument.Instrumentation</code></li></ul></li><li><p><strong>java 内存泄漏？</strong></p><ul><li><p>静态集合类引起内存泄漏</p><ul><li>使用 HashMap、Vector 等集合时，最容易出现内存泄露，这些静态变量的生命周期和应用程序一致，则容器中的对象在程序结束之前将不能被释放，从而造成内存泄漏，简单而言，长生命周期的对象持有短生命周期对象的引用，尽管短生命周期的对象不再使用，但是因为长生命周期对象持有它的引用而导致不能被回收。</li></ul><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">static</span> <span class="token class-name">Vector</span> vector <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">1000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token class-name">Object</span> object <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>vector <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>object <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><ul><li>如上述情况，如果仅仅释放引用本身（object = null），那么 Vector 仍然引用该对象，所以这个对象对 GC 来说是不可回收的。如果对象加入到 Vector 后，还必须从 Vector 中删除，最简单的方法就是将 Vector 对象设置为 null</li><li><strong>解决办法</strong>：静态引用时注意应用对象置空或者少用静态引用</li></ul></li><li><p>资源未关闭或释放导致内存泄露</p><ul><li>创建或者打开一个流或者是新建一个网络连接的时候，JVM 都会为这些资源类分配内存做缓存，常见的资源类有网络连接，数据库连接以及 IO 流。如果忘记关闭这些资源，会阻塞内存，从而导致 GC 无法进行清理</li><li><strong>解决办法</strong>：在 finally 中加上关闭，防止出现异常未正常释放资源</li></ul></li><li><p>不正确的 equals () 和 hashCode ()</p><ul><li>在 HashMap 和 HashSet 这种集合中，常常用到 equal () 和 hashCode () 来比较对象，如果重写不合理，将会成为潜在的内存泄露问题。</li></ul><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	</pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token keyword">private</span> <span class="token class-name">Integer</span> id<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token keyword">private</span> <span class="token class-name">Integer</span> age<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre> </pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token keyword">public</span> <span class="token class-name">ThreadTest</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">,</span><span class="token class-name">String</span> name<span class="token punctuation">,</span><span class="token class-name">Integer</span> age<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>		<span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>		<span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>		<span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>		<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ThreadTest</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>		<span class="token class-name">ThreadTest</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadTest</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">"xiaoming"</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>		<span class="token class-name">ThreadTest</span> t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadTest</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">"xiaoming"</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>		<span class="token class-name">ThreadTest</span> t3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadTest</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">"xiaoming"</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>	 </pre></td></tr><tr><td data-num="19"></td><td><pre>		  map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>t1 <span class="token punctuation">,</span> <span class="token string">"xiaoming"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>		  map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>t2<span class="token punctuation">,</span> <span class="token string">"xiaoming"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>		  map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>t3 <span class="token punctuation">,</span> <span class="token string">"xiaoming"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>	 </pre></td></tr><tr><td data-num="23"></td><td><pre>		  <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"运行结果："</span><span class="token operator">+</span>map<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>	<span class="token comment">// 输出是 3</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><ul><li>上述代码的 ThreadTest 类并没有重写 equals 和 hashCode 方法，因此在执行 put 操作时，Map 会认为每次创建的对象都是新的对象，从而导致内存不断的增长，会导致内存泄漏的可能。</li><li><strong>解决方法</strong>：重写</li></ul></li><li><p>重写了 finalize () 的类</p><ul><li>使用 finalize () 方法会存在潜在的内存泄露问题，每当类的 finalize () 方法被重写时，该类的对象不会立即被垃圾回收。相反，GC 将它们排队等待最后确定，在以后的某个时间点进行回收。</li></ul></li><li><p>使用 ThreadLocal 造成内存泄露</p><ul><li>一旦线程不在存在，ThreadLocal 就应该被垃圾收集，而现在线程的创建都是使用线程池，线程池有线程重用的功能，因此线程就不会被垃圾回收器回收。所以使用到 ThreadLocal 来保留线程池中线程的变量副本时，ThreadLocal 没有显示的删除时，就会一直保留在内存中，不会被垃圾回收。</li><li><strong>解决方法</strong>：不使用 ThreadLocal 时，调用 remove () 方法，该方法删除了此变量的当前线程值。不要使用 ThreadLocal.set (null)，它只是查找与当前线程关联的 Map 并将键值对设置为当前线程为 null。</li></ul></li></ul></li><li><p><strong>java GC 算法</strong></p><ul><li>见 JVM 中<a href="#%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E7%AE%97%E6%B3%95">垃圾回收算法</a>小节</li></ul></li><li><p>CMS</p></li><li><p><strong>mybatis 中 $ 和 #区别</strong></p><ul><li>都是从 xml 动态解析参数的语法，最大的区别则是 <code>#&#123;&#125;</code> 方式能够很大程度防止 sql 注入 (安全)， <code>$&#123;&#125;</code> 方式无法防止 Sql 注入</li><li><code>#&#123;&#125;</code> 将传入的数据都当成一个字符串，会对自动传入的数据加一个双引号。如果 sql 语句中只有一个参数，此时参数名称可以随意定义</li><li><code>$&#123;&#125;</code> 将传入的数据直接显示生成在 sql 中， <code>$&#123;value&#125;</code> 中 <code>value</code> 值有限制只能写对应的 value 值不能随便写，因为 <code>$&#123;&#125;</code> 不会自动进行 jdbc 类型转换</li><li>在 <code>JDBC</code> 能使用占位符的地方，最好优先使用 <code>#&#123;&#125;</code> ，在 <code>JDBC</code> 不支持使用占位符的地方，就只能使用 <code>$&#123;&#125;</code> ，典型情况就是动态参数（字段名、表名、map 的 key 必须用 <code>$&#123;&#125;</code> ，因为不能加上 “” 引号）</li></ul></li><li><p><strong>mysql 事务隔离级别</strong></p><ul><li>读未提交：在读未提交隔离级别下，事务 A 可以读取到事务 B 修改过但未提交的数据。可能发生<strong>脏读、不可重复读和幻读</strong>问题，一般很少使用此隔离级别。就是啥问题都会有，然后随着隔离级别的提高，依次解决。</li><li>读已提交：在读已提交隔离级别下，事务 B 只能在事务 A 修改过并且已提交后才能读取到事务 B 修改的数据。读已提交隔离级别解决了脏读的问题，但可能发生不可重复读和幻读问题，一般很少使用此隔离级别。</li><li>可重复读：在可重复读隔离级别下，事务 B 只能在事务 A 修改过数据并提交后，自己也提交事务后，才能读取到事务 B 修改的数据。可重复读隔离级别解决了脏读和不可重复读的问题，但可能发生幻读问题。<ul><li>为什么上了写锁（写操作），别的事务还可以读操作？因为 InnoDB 有 MVCC 机制（多版本并发控制），可以使用快照读，而不会被阻塞。</li></ul></li><li>可串行化：各种问题（脏读、不可重复读、幻读）都不会发生，通过加锁实现（读锁和写锁）。</li><li><strong>幻读</strong>：是存不存在的问题。A 事务 select 某记录是否存在，结果为不存在，准备插入此记录，但执行 insert 时发现此记录已存在，无法插入，此时就发生了幻读。产生这样的原因是因为有另一个事务往表中插入了数据</li><li><strong>不可重复读</strong>：说的是变没变化的问题，原来是 A, 现在却变为了 B, 则为不可重复读</li><li><strong>脏读</strong>：就是一个事务读到另一个事务没有提交的数据。事务 A 修改了一个数据，但未提交，事务 B 读到了事务 A 未提交的更新结果，事务 B 读到的就是脏数据</li></ul></li><li><p><strong>mysql 锁有哪些，该怎么锁行</strong></p><ul><li><p>全局锁</p><ul><li>全局锁主要应用于做<strong>全库逻辑备份</strong>，这样在备份数据库期间，不会因为数据或表结构的更新，而出现备份文件的数据与预期的不一样。</li><li>会影响业务，怎么解决？如果数据库的引擎支持的事务支持<strong>可重复读的隔离级别</strong>，那么在备份数据库之前先开启事务，会先创建 Read View，然后整个事务执行期间都在用这个 Read View，而且由于 MVCC 的支持，备份期间业务依然可以对数据进行更新操作。因为在可重复读的隔离级别下，即使其他事务更新了表的数据，也不会影响备份数据库时的 Read View。这就是事务四大特性中的隔离性，这样备份期间备份的数据一直是在开启事务时的数据。InnoDB 存储引擎默认的事务隔离级别正是可重复读，因此可以采用这种方式来备份数据库。</li></ul><pre><code class="language-mysql">flush tables with read lock
unlock tables
</code></pre></li><li><p>表级锁</p><ul><li>表锁<ul><li>表锁除了会限制别的线程的读写外，也会限制本线程接下来的读写操作。也就是说如果本线程对学生表加了「共享表锁」，那么本线程接下来如果要对学生表执行写操作的语句，是会被阻塞的，当然其他线程对学生表进行写操作时也会被阻塞，直到锁被释放</li><li>不过尽量避免在使用 InnoDB 引擎的表使用表锁，因为表锁的颗粒度太大，会影响并发性能，<strong>InnoDB 牛逼的地方在于实现了颗粒度更细的行级锁</strong></li></ul></li><li>元数据锁（MDL）<ul><li>不需要显示的使用 MDL，因为当我们对数据库表进行操作时，会自动给这个表加上 MDL：对一张表进行 CRUD 操作时，加的是 <strong>MDL 读锁</strong>；对一张表做结构变更操作的时候，加的是 <strong>MDL 写锁</strong>；</li><li>当有线程在执行 select 语句（ 加 MDL 读锁）的期间，如果有其他线程要更改该表的结构（ 申请 MDL 写锁），那么将会被阻塞，直到执行完 select 语句（ 释放 MDL 读锁）</li><li>反之，当有线程对表结构进行变更（ 加 MDL 写锁）的期间，如果有其他线程执行了 CRUD 操作（ 申请 MDL 读锁），那么就会被阻塞，直到表结构变更完成（ 释放 MDL 写锁）</li><li>MDL 是在事务提交后才会释放，这意味着<strong>事务执行期间，MDL 是一直持有的</strong>。如果有 A 开启事务，进行了 select，此时读锁。B 开事务也读，再加读锁（共享锁）没事。C 若写，由于有了读锁，只能阻塞。后续还有 DEF... 读操作，也会阻塞。因为申请 MDL 锁的操作会形成一个队列，队列中<strong>写锁获取优先级高于读锁</strong>，一旦出现 MDL 写锁等待，会阻塞后续该表的所有 CRUD 操作</li></ul></li><li>意向锁<ul><li>当执行插入、更新、删除操作 / 读取，需要先对表加上「意向独占锁 / 共享锁」。也就是某行加锁的时候，innoDB 会自动加个表级别意向锁，比如 A 要 7 行改数据，除了 7 行的排他锁，还有意向独占锁。B 要改 8 行，也会给表加个意向独占锁，意向锁之间兼容，7.8 都有各自的排他锁，和两个意向表锁，此时来了个别的表锁，就会看到意向锁，从而阻塞等待，而非遍历全表找有没哪行加了锁</li></ul></li><li>AUTO-INC 锁<ul><li><code>AUTO_INCREMENT</code> 的主键自增就是通过该锁实现的，<strong>不是在一个事务提交后才释放，而是在执行完插入语句后就会立即释放</strong>。也就是插入语句会排队执行，上一个插入没完成时有 AUTO-INC 锁。有一定性能影响，5.1.22 后有一个清凉所<strong>给 <code>AUTO_INCREMENT</code> 字段赋值一个自增的值，就把这个轻量级锁释放了</strong>，而不需要等待整个插入语句执行完后才释放锁.<ul><li>但主从复制会有问题，主库很即时赋值，但 binlog 日志会将不同 session 的语句合并后一起执行，导致顺序可能不同。解决：binlog 日志格式要设置为 row，这样在 binlog 里面记录的是主库分配的自增值，到备库执行的时候，主库的自增值是什么，从库的自增值就是什么</li></ul></li></ul></li></ul></li><li><p>行级锁（InnoDB 引擎是支持行级锁的，而 MyISAM 引擎并不支持行级锁）</p><ul><li>普通的 select 语句是不会对记录加锁的，因为它属于快照读。如果要在查询时对记录加行锁，可以使用下面这两个方式，这种查询会加锁的语句称为<strong>锁定读</strong>。</li><li>上面这两条语句必须在一个事务中，<strong>因为当事务提交了，锁就会被释放</strong></li><li>共享锁（S 锁）满足读读共享，读写互斥。独占锁（X 锁）满足写写互斥、读写互斥</li><li>Record Lock 称为记录锁，锁住的是一条记录。而且记录锁是有 S 锁和 X 锁之分的</li><li>Gap Lock 称为间隙锁，只存在于可重复读隔离级别，目的是为了解决可重复读隔离级别下幻读的现象</li><li>next-key lock 是包含间隙锁 + 记录锁的，如果一个事务获取了 X 型的 next-key lock，那么另外一个事务在获取相同范围的 X 型的 next-key lock 时，是会被阻塞的</li></ul></li></ul><pre><code class="language-mysql">//对读取的记录加共享锁
select ... lock in share mode;
//对读取的记录加独占锁
select ... for update;
</code></pre></li><li><p><strong>乐观锁悲观锁实现方式？</strong></p><ul><li><strong>悲观锁（Pessimistic Lock）：</strong> 就是很悲观，每次去拿数据的时候都认为别人会修改。所以每次在拿数据的时候都会上锁。这样别人想拿数据就被挡住，直到悲观锁被释放，悲观锁中的共享资源每次只给一个线程使用，其它线程阻塞，用完后再把资源转让给其它线程。数据库中的行锁，表锁，读锁（共享锁），写锁（排他锁），以及 syncronized 实现的锁均为悲观锁</li><li><strong>乐观锁（Optimistic Lock）：</strong> 就是很乐观，每次去拿数据的时候都认为别人不会修改。所以不会上锁，但是如果想要更新数据，则会在更新前检查在读取至更新这段时间别人有没有修改过这个数据。如果修改过，则重新读取，再次尝试更新，循环上述步骤直到更新成功，乐观锁适用于多读的应用类型，这样可以提高吞吐量。一般的实现乐观锁的方式就是记录数据版本（version）或者是时间戳来实现，不过使用版本记录是最常用的。</li></ul></li><li><p><strong>mysql innerjoin 有什么作用？</strong></p><ul><li>用于将两个或多个表中的记录根据某个条件进行匹配，并返回匹配的记录</li><li>join 等同于 inner join（显性）等同于 where（隐性）。没有本质区别，结果也一样。但是！隐性连接随着数据库语言的规范和发展，已经逐渐被淘汰，比较新的数据库语言基本上已经抛弃了隐性连接，全部采用显性连接了。</li></ul></li><li><p><strong>如何优化 mysql 语句？</strong></p><ul><li>避免返回多余的行（where 精准定位）和列（指定列名而不是 *）</li><li>若插入数据过多，考虑批量插入。</li><li>查询一条或者最大 / 最小一条记录，建议使用 limit 1</li><li>尽量避免在字段开头模糊查询，会导致数据库引擎放弃索引进行全表扫描</li><li>尽量避免使用 in 和 not in，会导致引擎走全表扫描。如果是连续数值，可以用 between 代替；如果是子查询，可以用 exists 代替</li><li>尽量避免使用 or，会导致数据库引擎放弃索引进行全表扫描。可以用 union 代替 or</li><li>尽量避免进行 null 值的判断，会导致数据库引擎放弃索引进行全表扫描。可以给字段添加默认值 0，对 0 值进行判断</li><li>尽量避免在 where 条件中等号的左侧进行表达式、函数操作，会导致数据库引擎放弃索引进行全表扫描。 在等号右侧计算</li><li>order by 条件要与 where 中条件一致，否则 order by 不会利用索引进行排序。 <code>SELECT * FROM t order by age;</code> 不走索引， <code>SELECT * FROM t where age &gt; 0 order by age;</code> 走索引</li></ul></li><li><p><strong>redis 缓存更新策略？</strong><br><a href="/2024/03/22/%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE%E4%BC%98%E5%8C%96/" title="该文的1.6小节">该文的1.6小节</a></p></li><li><p><strong>redis 数据类型？</strong></p><ul><li>字符串、哈希、列表、集合和有序集合（ZSet）。</li></ul></li><li><p><strong>zset 底层</strong></p><ul><li>每个元素都会关联一个 double 类型的分数 score 为成员排序，内部使用 hashmap 和跳跃表实现存储和有序，HaspMap 存放成员到 score 的映射，而跳跃表存放所有的成员，使用跳表实现比较高的查询效率可以实现优先级队列需求。</li></ul></li><li><p><strong>跳表工作原理</strong></p><ul><li>跳表在动态查找过程中使用了一种非严格的平衡机制来让插入和删除都更加便利和快捷，这种非严格平衡是基于概率的，而不是平衡树的严格平衡</li><li>在有序链表中插入和删除都比较简单，搜索时无法依靠下标只能遍历，但是明明知道要走两步可以到达目的地，偏偏只能一步步走，这就是痛点。<strong>中间层</strong></li><li>加入要搜索值为 55 的节点，则先在上层进行搜索，由 16 跳到 38，在 38 的下一跳将到达 72，因此向下降一级继续类似的搜索，则找到 55。</li><li><img data-src="https://pic4.zhimg.com/80/v2-fefc4bea0c7ee756401ad9c918613a13_720w.webp" alt=""></li><li>基于偶数节点增加索引并且只有两层的情况下，最高层的节点数是 n/2，整体来看搜索的复杂度降低为 O (n/2)，并不要小看这个 1/2 的系数，看到这里会想 增加索引层数到 k，那么复杂度将指数降低为 O (n/2^k)。但只有在该层，有同样层数的节点，才有用，比如一个节点 1000 层，其他还在 10 层以内，就没有意义。</li><li><strong>如何确定最高索引层数 m 呢？</strong><ul><li>如果一个链表有 n 个结点，如果每两个结点取出一个结点建立索引，那么第一级索引的结点数是 n/2，第二级索引的结点数是 n/4，以此类推第 m 级索引的结点数为 n/(2^m)，前面说过最高层结点数为 2，因此存在关系：</li><li><img data-src="https://pic4.zhimg.com/80/v2-4f541c4d76714c82905cc3cf4d99085b_720w.webp" alt=""></li><li>redis 中用的随机层数... 有个概率公式：节点层数恰好等于 K 的概率为 p^(k-1)(1-p)</li></ul></li></ul></li><li><p><strong>spring 代理如何实现的？</strong></p><ul><li>静态代理，就是对接口的实现从而实现功能增强，当接口中的功能增加了或修改了，会影响到众多的实现类，都需要修改，工作量会增大，影响比较大。</li><li>动态代理：JDK Proxy 和 CGLIB，jdk 只能代理接口，如果项目没有接口用 CGLIB；另外 Spring AOP 只能实现对方法的增强。当你修改了接口中的方法时，不会影响代理类。在程序的执行过程中，使用 jdk 机制，创建代理类对象，并动态的指定要代理目标类。</li></ul></li></ul><figure class="highlight java"><figcaption data-lang="java"><span>title:JDKProxy</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">-</span> <span class="token number">1.</span>创建接口，定义目标类要完成的功能</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token operator">-</span> <span class="token number">2.</span>创建目标类实现接口</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token operator">-</span> <span class="token number">3.</span>创建<span class="token class-name">InvocationHandler</span>接口实现类，在invoke方法中完成代理类的功能</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token operator">-</span> <span class="token number">4.</span>使用<span class="token class-name">Proxy</span>类的静态方法，创建代理对象，并把返回值转为接口类型</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">InvocationHandler</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Method</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Proxy</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StudentProxyDTJdk</span> <span class="token keyword">implements</span> <span class="token class-name">InvocationHandler</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment">// 被代理的接口</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">Object</span> target<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setStudent</span><span class="token punctuation">(</span><span class="token class-name">Object</span> target<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>target <span class="token operator">=</span> target<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token comment">// 生成得到代理类 & lt; 类加载器（加载到那个位置），代理类的接口，代理处理程序实现类，也就是此类 this></span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>target<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInterfaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span> proxy<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token class-name">Object</span> result<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"study"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            result <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>            <span class="token function">openBook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            <span class="token function">lectures</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>            <span class="token function">classOver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"homework"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>            result <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>            <span class="token function">proDoHomework</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>            <span class="token class-name">DoHomework</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>            <span class="token class-name">HomeworkOver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token keyword">return</span> result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">openBook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"学生打开书本预习。。。。"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lectures</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"学生听老师讲课，做笔记，完成课堂练习。。。。"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">classOver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"学生上课结束，收拾书包，带走垃圾。。"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">proDoHomework</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"学生准备做家庭作业，复习今天课堂所学得的知识。。"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token class-name">DoHomework</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"学生打开作业本，写作业、检查改错、预习。。"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token class-name">HomeworkOver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"学生完成家庭作业，收拾书本。。。"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="54"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="55"></td><td><pre></pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="57"></td><td><pre>    <span class="token class-name">StudentImpl</span> student<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">StudentImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="58"></td><td><pre>	<span class="token class-name">StudentProxyDTJdk</span> proxyJdk <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StudentProxyDTJdk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="59"></td><td><pre>	proxyJdk<span class="token punctuation">.</span><span class="token function">setStudent</span><span class="token punctuation">(</span>student<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="60"></td><td><pre>	<span class="token class-name">Student</span> proxy <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Student</span><span class="token punctuation">)</span> proxyJdk<span class="token punctuation">.</span><span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="61"></td><td><pre>	proxy<span class="token punctuation">.</span><span class="token function">study</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="62"></td><td><pre>	proxy<span class="token punctuation">.</span><span class="token function">homework</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight java"><figcaption data-lang="java"><span>title:Cglib</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">-</span> <span class="token number">1</span>）o表示增强的对象，即实现这个接口类的一个对象；</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token operator">-</span> <span class="token number">2</span>）method表示要被拦截的方法；</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token operator">-</span> <span class="token number">3</span>）objects表示要被拦截方法的参数；</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token operator">-</span> <span class="token number">4</span>）methodproxy表示要触发父类的方法对象</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cglib<span class="token punctuation">.</span>proxy<span class="token punctuation">.</span></span><span class="token class-name">MethodInterceptor</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cglib<span class="token punctuation">.</span>proxy<span class="token punctuation">.</span></span><span class="token class-name">MethodProxy</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Method</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StudentProxyDTCglib</span> <span class="token keyword">implements</span> <span class="token class-name">MethodInterceptor</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">intercept</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> objects<span class="token punctuation">,</span> <span class="token class-name">MethodProxy</span> methodProxy<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token class-name">Object</span> result<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"study"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            result <span class="token operator">=</span> methodProxy<span class="token punctuation">.</span><span class="token function">invokeSuper</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> objects<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            <span class="token function">openBook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token function">lectures</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token function">classOver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"homework"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>            result <span class="token operator">=</span> methodProxy<span class="token punctuation">.</span><span class="token function">invokeSuper</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> objects<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token function">proDoHomework</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>            <span class="token class-name">DoHomework</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            <span class="token class-name">HomeworkOver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token keyword">return</span> result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">openBook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"学生打开书本预习。。。。"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lectures</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"学生听老师讲课，做笔记，完成课堂练习。。。。"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">classOver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"学生上课结束，收拾书包，带走垃圾。。"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">proDoHomework</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"学生准备做家庭作业，复习今天课堂所学得的知识。。"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token class-name">DoHomework</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"学生打开作业本，写作业、检查改错、预习。。"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token class-name">HomeworkOver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"学生完成家庭作业，收拾书本。。。"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="47"></td><td><pre>	<span class="token class-name">StudentProxyDTCglib</span> cglibProxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StudentProxyDTCglib</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>	<span class="token class-name">Enhancer</span> enhancer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Enhancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>	<span class="token comment">// 设置代理目标</span></pre></td></tr><tr><td data-num="50"></td><td><pre>	enhancer<span class="token punctuation">.</span><span class="token function">setSuperclass</span><span class="token punctuation">(</span><span class="token class-name">StudentImpl</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>	<span class="token comment">// 设置单一回调对象，在调用中拦截对目标方法的调用</span></pre></td></tr><tr><td data-num="52"></td><td><pre>	enhancer<span class="token punctuation">.</span><span class="token function">setCallback</span><span class="token punctuation">(</span>cglibProxy<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>	<span class="token comment">// 设置类加载器</span></pre></td></tr><tr><td data-num="54"></td><td><pre>	enhancer<span class="token punctuation">.</span><span class="token function">setClassLoader</span><span class="token punctuation">(</span><span class="token class-name">StudentImpl</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>	<span class="token class-name">Student</span> student <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Student</span><span class="token punctuation">)</span> enhancer<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>	student<span class="token punctuation">.</span><span class="token function">study</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>	student<span class="token punctuation">.</span><span class="token function">homework</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>Enhancer 是一个非常重要的类，它允许为非接口类型创建一个 JAVA 代理，Enhancer 动态的创建给定类的子类并且拦截代理类的所有的方法，和 JDK 动态代理不一样的是不管是接口还是类它都能正常工作。</p><ul><li><p><strong>反射</strong></p><ul><li>反射让我们在程序运行的时候能够查看到类的信息，获取并调用类的任意方法和属性。像 <code>Student stu = new Student; Class c = stu.getClass();</code> <code>Class.forName(className)</code> <code>Class c3 = Student.class;</code></li><li>在 Java 的 java.lang.reflect 中有三个类：Field、Method、Constructor 分别来描述类的域【也就是变量】，方法和构造器。</li><li>最常用就是辅助动态代理的实现，事先并不知道代理类是什么，代理类是在运行时才生成的。</li><li>java.lang.Class 是访问类型元数据的接口，也是实现反射的关键数据。通过 Class 提供的接口，可以访问一个类型的方法、字段等信息。</li><li>Java 的反射是 加载到 jvm 中的.class 文件来进行操作的。.class 文件中包含 java 类的所有信息，当你不知道某个类具体信息时，可以使用反射获取 class</li></ul></li><li><p><strong>AOP 的原理</strong></p><ul><li>就是基于上面说的动态代理，对于是否为实现了接口的类，而采用 JDK/CGLIB。而代理又用到了反射。</li></ul></li><li><p><strong>spring 的设计模式有哪些？</strong></p><ul><li><strong>工厂设计模式</strong>（简单工厂和工厂方法）：Spring 使用工厂模式可以通过 BeanFactory 或 ApplicationContext 创建 bean 对象<ul><li>BeanFactory ：延迟注入 (使用到某个 bean 的时候才会注入), 相比于 BeanFactory 来说会占用更少的内存，程序启动速度更快。</li><li>ApplicationContext ：容器启动的时候，不管你用没用到，一次性创建所有 bean 。BeanFactory 仅提供了最基本的依赖注入支持，ApplicationContext 扩展了 BeanFactory , 除了有 BeanFactory 的功能还有额外更多功能，所以一般开发人员使用 ApplicationContext 会更多。</li></ul></li><li><strong>单例设计模式</strong>：Spring 中 bean 的默认作用域就是 singleton。<ul><li>除了 singleton 作用域，Spring bean 还有下面几种作用域：prototype （多例，每次都生成）、request（每次 HTTP 请求生成一个，仅在该次请求内有效）、session（每一次 HTTP 请求都会产生一个新的 bean，该 bean 仅在当前 HTTP session 内有效）、global-session： 全局 session 作用域，仅仅在基于 portlet 的 web 应用中才有意义，Spring5 已经没有了</li></ul></li><li><strong>代理设计模式</strong>：Spring AOP 就是基于动态代理的</li><li><strong>模板方法设计模式</strong>：模板方法模式是一种行为设计模式，它定义一个操作中的算法的骨架，而将一些步骤延迟到子类中。<ul><li>通过继承实现父类方法？</li></ul></li><li><strong>观察者设计模式</strong>：它表示的是一种对象与对象之间具有依赖关系，当一个对象发生改变时，这个对象锁依赖的对象也会做出反应。<figure class="highlight java"><figcaption data-lang="java"><span>title:观察者模式</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">1.</span> 定义一个事件<span class="token operator">:</span> 实现一个继承自 <span class="token class-name">ApplicationEvent</span>，并且写相应的构造函数；</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">2.</span> 定义一个事件监听者：实现 <span class="token class-name">ApplicationListener</span> 接口，重写 <span class="token function">onApplicationEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 方法；</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">3.</span> 使用事件发布者发布消息<span class="token operator">:</span> 可以通过 <span class="token class-name">ApplicationEventPublisher</span> 的 <span class="token function">publishEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 方法发布消息。</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">// 定义一个事件，继承自 ApplicationEvent 并且写相应的构造函数  </span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DemoEvent</span> <span class="token keyword">extends</span> <span class="token class-name">ApplicationEvent</span><span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> message<span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">DemoEvent</span><span class="token punctuation">(</span><span class="token class-name">Object</span> source<span class="token punctuation">,</span><span class="token class-name">String</span> message<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token keyword">super</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>message <span class="token operator">=</span> message<span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="14"></td><td><pre>         <span class="token keyword">return</span> message<span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="15"></td><td><pre>          <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment">// 定义一个事件监听者，实现 ApplicationListener 接口，重写 onApplicationEvent () 方法；  </span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token annotation punctuation">@Component</span>  </pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DemoListener</span> <span class="token keyword">implements</span> <span class="token class-name">ApplicationListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DemoEvent</span><span class="token punctuation">></span></span><span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token comment">// 使用 onApplicationEvent 接收消息  </span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token annotation punctuation">@Override</span>  </pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onApplicationEvent</span><span class="token punctuation">(</span><span class="token class-name">DemoEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token class-name">String</span> msg <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"接收到的信息是："</span><span class="token operator">+</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token comment">// 发布事件，可以通过 ApplicationEventPublisher  的 publishEvent () 方法发布消息。  </span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token annotation punctuation">@Component</span>  </pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DemoPublisher</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token annotation punctuation">@Autowired</span>  </pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token class-name">ApplicationContext</span> applicationContext<span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">publish</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token comment">// 发布事件  </span></pre></td></tr><tr><td data-num="33"></td><td><pre>        applicationContext<span class="token punctuation">.</span><span class="token function">publishEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DemoEvent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure></li><li><strong>适配器设计模式</strong>：又叫包装器 (Wrapper) 模式，适配器设计模式将一个接口转换成客户希望的另一个接口，适配器模式使得接口不兼容的那些类可以一起工作</li><li><strong>装饰者设计模式</strong>：装饰者设计模式可以动态地给对象增加些额外的属性或行为。如 DataSource 切换不同的数据库和数据源</li><li><strong>策略设计模式</strong>：Spring 框架的资源访问接口就是基于策略设计模式实现的。</li></ul></li><li><p><strong>举一个适配器模式的例子</strong></p><ul><li>类适配：(目标用接口实现）就好比有适配者类 A，目标抽象类接口 B，适配器类 C 实现 B 又继承 A。此时实现 B 中的方法，又可以 <code>super.Amethod()</code> 实现 A 中的方法。客户端实际用的是 C</li><li>对象适配：（目标用抽象类实现）就是 C 中实例一个 A，同时继承 B，实现 B 中方法是调用实例 A 的方法 <code>A.Amethod()</code> ，从而封装适配。客户端用的也是 C</li></ul></li><li><p><strong>线程池的创建方式和主要参数</strong></p><ul><li>见线程章节的<a href="#%E7%BA%BF%E7%A8%8B%E6%B1%A0">线程池</a>。ExecutorService 要手动往里添加线程（本质上是一种异步执行机制，它能够在后台执行任务），ThreadPoolExecutor（是前者的具体实现）后台会管理好对应的线程，直接添加要执行的方法</li></ul></li></ul><figure class="highlight java"><figcaption data-lang="java"><span>title:Pool</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> pool <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token comment">//1 提供指定线程数量的线程池</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token class-name">ExecutorService</span> service <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token comment">//2 执行指定的线程操作，需要实现 Runnable 接口或者 Callable 接口实现类的对象</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        thread thread1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        thread0 thread2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">thread0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token comment">//3 将实例化的对象作为参数 执行 service.execute ();</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        service<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>thread1<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        service<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>thread2<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token comment">//service.submit (); 适用于 callable</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>service<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token class-name">ThreadPoolExecutor</span> service1<span class="token operator">=</span><span class="token punctuation">(</span><span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">)</span>service<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        service1<span class="token punctuation">.</span><span class="token function">setCorePoolSize</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token comment">//4 关闭线程池</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        service<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>		<span class="token comment">// 直接使用 ThreadPoolExecutor</span></pre></td></tr><tr><td data-num="20"></td><td><pre>		<span class="token class-name">ThreadPoolExecutor</span> pool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">60L</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token comment">// 任务 1</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        pool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"--helloWorld_001--"</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token comment">// 任务 2</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        pool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"--helloWorld_002--"</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><ul><li><p><strong>索引失效有哪些情况？</strong></p><ul><li>数据量过大，导致索引无法全部存储在内存中，需要从磁盘中读取数据，这样会导致查询速度变慢。</li><li>数据库表中的数据频繁更新，导致索引失效。比如删除或者更新某条数据时，索引可能需要重新构建。</li><li>数据库表中的数据分布不均匀，导致索引失效。比如某些数据重复出现的次数很多，而其他数据只有很少的出现次数，这种情况下索引就会失效。</li><li>数据库表中的<strong>数据类型不匹配</strong>，导致索引失效。比如将字符串类型的数据存储在数值型的字段中，会导致索引失效。</li><li>数据库表中的数据存在<strong>大量的 NULL 值</strong>，导致索引失效。因为 NULL 值无法作为索引字段。</li><li>查询条件（where）中使用了<strong>函数、操作符或者表达式</strong>，导致索引失效。比如使用 LIKE 关键字模糊查询、使用 <strong>OR</strong> 连接多个查询条件（除非 or 的每个列都有索引）等。</li><li>数据库表中存在大量的重复数据，导致索引失效。这种情况下，查询时需要扫描大量的重复数据，导致查询速度变慢。</li></ul></li><li><p>r<strong>edis 可以做什么？</strong></p><ul><li>缓存：提高数据访问速度和响应速度，减少数据库压力，应对高并发</li><li>队列：Redis 支持列表数据类型，可以将消息存储在列表中，并且支持阻塞式操作，可以实现消息队列的等待和通知机制</li><li>分布式锁：Redis 可以作为一种分布式锁的存储层，通过缓存锁信息和锁状态，实现分布式锁和并发控制</li><li>计数器</li><li>轻量级数据库</li></ul></li><li><p><strong>什么是缓存穿透，如何解决？</strong></p><ul><li>如果有大量的请求传入的商品 id，在缓存中和数据库中都不存在（数据库有就是缓存击穿），这些请求不就每次都会穿透过缓存，而直接访问数据库了</li><li>可以选择过滤器（id 是否在数据库而 放行），但又会有过滤器同步问题。另一个取巧就是不存在的商品 id 访问时也缓存一个不存在缓存，下次在遇到就直接拒绝</li></ul></li><li><p>线程池参数，工作流程，拒绝策略</p><ul><li>见线程章节的线程池<a href="#%E6%8B%92%E7%BB%9D%E7%AD%96%E7%95%A5">小节</a></li></ul></li><li><p>场景题：如何构建一个高并发的系统</p></li></ul><hr><p>腾讯 CSIG</p><ul><li><p>实习期间做了什么项目东西？有没有遇到过什么比较难的问题？自己参与的比较深，可以解决工作中的问题？</p><ul><li>没有，想下项目里难以实现的。</li></ul></li><li><p>redis 缓存用到的是什么数据结构？有序集合的底层原理实现？</p><ul><li>字符串、哈希、列表、集合和有序集合（ZSet）。<span class="exturl" data-url="aHR0cHM6Ly9zZWdtZW50ZmF1bHQuY29tL2EvMTE5MDAwMDA0MjIyNDE4MSNpdGVtLTI=">参考</span></li><li>hash 一个 score、跳层</li></ul></li><li><p><strong>Java 中的锁有哪几种？分别是什么实现方式？</strong></p><ul><li>Synchronized（不公平）</li><li>ReentrantLock 重入锁 （可公平可不公平）： <code>Lock lock = new ReentrantLock(); lock.lock(); try&#123;&#125;catch&#123;&#125;finally &#123;lock.unlock();&#125;</code></li><li>ReadWriteLock 读写锁（不公平）：ReadWriteLock 也是一个接口，提供了 readLock 和 writeLock 两种锁的操作机制，一个资源可以被多个线程同时读，或者被一个线程写，但是不能同时存在读和写线程。 <code>lock.writeLock().lock();lock.writeLock().unlock();</code> <code>lock.readLock().lock();lock.readLock().unlock();</code></li><li>公平锁会按照时间的先后顺序来给予锁，不公平锁在等待队列随机挑选一个来给予锁</li></ul></li><li><p><strong>Java IO 中的阻塞式 IO 和非阻塞式 IO 的区别和联系？</strong></p><ul><li>阻塞式 IO 与同步 I/O 模型相似，它也需要应用程序等待 I/O 操作完成。如 <code>FileInputStream</code></li><li>非阻塞 I/O 模型允许应用程序发起 I/O 操作后继续执行其他任务，而不必等待操作完成。如 <code>SocketChannel</code> 在等待连接完成时可以执行其他任务，而不被阻塞</li></ul></li><li><p><strong>聊聊 Java 中的反射机制？并且在 Spring 中是如何进行反射相关操作的？</strong></p><ul><li>指程序可以获得自己的属性和方法。java 中，只要知道类的名字，就可以通过反射机制获取类的所有属性以及方法</li><li>Spring IOC 就是靠工厂模式 + 反射。从单纯的返回一个 new 的传入名称的类（每增添，都要新写名称判断），换成从 <code>Class.forName(objectname).newInstance()</code> 反射获取。</li></ul></li><li><p>Java 集合 ArrayList 和 LinkedList 的区别联系？哪个查找元素的速度快一点？</p><ul><li>ArrayList 是实现了基于动态数据的数据结构，LinkedList 是基于链表结构实现。</li><li>都是 List 接口的实现类，这两个类都是对 List 进行操作。都定义了如 add (E)、get (int)、remove (int)、set (E) 等基本的 List 操作</li></ul></li><li><p>JMM，java 内存模型 （问得很深，回答不全）</p></li><li><p>MySQL 索引失效问题以及解决方案？</p><ul><li>上面有一部分，解决方案就是不用那些有问题的操作... 更高深的不知道了</li><li>从数据库角度再记录下</li><li>不满足<strong>最左</strong>前缀（如有索引【a，b，c】，查询【b，c】的条件，则不会走索引，但【a，c 可以】）</li><li>范围查询<strong>之后</strong>的索引字段，会失效，但本身用来范围查询的那个索引字段依然有效（如 a，b&gt;10，c。b 走，c 不走）</li><li>对索引字段做运算，使用函数等都会导致索引失效。</li><li>隐式类型转换（索引字段为字符串类型，由于在查询时，没有对字符串加<strong>单引号</strong>，MySQL 的查询优化器，会自动的进行类型转换，造成索引失效。）</li><li>避免使用 select * 。无法使用覆盖索引（如果一个索引包含了（或覆盖了）满足查询语句中字段与条件的数据就叫做覆盖索引），消耗更多的 CPU 和 IO 以网络带宽资源。</li><li>or 分割的条件。如果 or 前的条件中的列有索引，而后面的列中没有索引，那么涉及的索引都不会被用到。</li><li>以 % 开头的 Like 模糊查询</li><li>order by 导致索引失效。在基于 <code>order by</code> 和 <code>limit</code> 进行使用时，是否走索引涉及到数据库版本。主键使用 <code>order by</code> 时，可以正常走索引。</li></ul></li><li><p><strong>MySQL 索引用的是什么数据结构？聚集和非聚集索引</strong></p><ul><li>哈希结构，B + 树结构，R 树结构。其中 R 树结构用于空间索引，不常见</li><li><strong>二叉查找树</strong>（任何节点的左子节点的键值都小于当前节点的键值，右子节点的键值都大于当前节点的键值）-&gt;<strong> 平衡二叉树</strong>（查找树基础上每个节点的左右子树的高度差不能超过 1）-&gt;<strong>B 树</strong>（单个节点可以存储多个键值和数据的平衡树）-&gt;<strong>B + 树</strong>（B + 树非叶子节点上是不存储数据的，仅存储键值，数据都在叶子节点），如 3 层 B + 树可以存储 1000×1000×1000=10 亿个数据。一般根节点是常驻内存的，所以一般我们查找 10 亿数据，只需要 2 次磁盘 IO。</li><li><strong>聚集索引</strong>：以 innodb 作为存储引擎的表，表中的数据都会有一个主键，即使你不创建主键，系统也会帮你创建一个隐式的主键。这是因为 innodb 是把数据存放在 B + 树中的，而 B + 树的键值就是主键，在 B + 树的叶子节点中存储了行数据，可以直接在聚集索引中查找到想要的数据。这种以主键作为 B + 树索引的键值而构建的 B + 树索引，我们称之为聚集索引。</li><li><strong>非聚集索引</strong>：以主键以外的列值作为键值构建的 B + 树索引，我们称之为非聚集索引。区别在于非聚集索引的叶子节点不存储表中的数据，而是存储该列对应的主键，想要查找数据我们还需要根据主键再去聚集索引中进行查找，这个再根据聚集索引查找数据的过程，我们称为<strong>回表</strong>。</li></ul></li><li><p>MySQL 数据库服务器飙升，会是什么原因造成的？</p><ul><li>服务器硬件问题</li><li>内存溢出</li><li>业务高并发<ul><li>数据库对象设计不合理</li><li>触发器导致</li><li>表索引设计不合理</li><li>数据库锁导致，如行锁冲突、行锁等待、锁超时、死锁等</li><li>系统架构没有缓存中间件</li><li>读写分离配置不合理</li><li>OLTP 系统承载了 OLAP 的业务需求</li><li>未合理升级改造为集群环境</li><li>未配置异构数据分析系统</li><li>MySQL 系统参数设置不合理</li><li>SQL 问题导致，如 group by、order by、join 等，这些很大程度影响 SQL 执行效率，从而占用大量的系统资源</li></ul></li></ul></li></ul><ol><li>确定 CPU 使用率飙升的原因:<ul><li>使用 top 或 htop 命令査看系统的 CPU 使用率，并找出占用 CPU 高的进程。</li><li>使用 MySQL 的内置工具如 SHOW PROCESSLIST 命令，查看 MySQL 中当前运行的查询和连接会</li></ul></li><li>优化数据库查询:<ul><li>使用 <code>EXPLAIN</code> 命令分析慢查询，检査是否存在索引缺失、全表扫描等问题。0 优化查询语句，确保合适的索引被使用。</li><li>使用合适的查询缓存和查询缓存失效处理策略</li></ul></li><li>优化数据库配置:<ul><li>检查 my.cnf 配置文件，合理配置数据库参数</li><li>调整 innodb_buffer_pool_size 参数，以确保适当的内存分配给 InnoDB 存储引擎</li><li>根据系统资源情况，调整 max_connections 参数控制并发连接数。</li></ul></li></ol><ul><li>缓存中的生产问题（缓存击穿、穿透、雪崩问题，原因、解决方式）<ul><li>击穿：热点的 key 失效了，导致大并发集中打在数据库上。热点的 key 可以设置永不过期的 key。使用互斥锁。如果缓存失效的情况，只有拿到锁才可以查询数据库，并且及时写回 redis</li><li>穿透：key 不存在 Redis 中时，大量请求去数据库查询。把无效的 Key 存进 Redis 中；使用布隆过滤器</li><li>雪崩：大规模的 key 失效。熔断机制。当流量到达一定的阈值时，就直接返回 “系统拥挤” 之类的提示，防止过多的请求打在数据库上；提高数据库的容灾能力，可以使用分库分表，读写分离的策略；为了防止 Redis 宕机导致缓存雪崩的问题，可以搭建 Redis 集群，提高 Redis 的容灾性</li></ul></li></ul><hr><p>阿里云</p><ul><li><p>重载与重写区别</p><ul><li><strong>在子类中把父类本身有的方法</strong>重新写一遍，方法名，参数列表，返回类型（除过子类中方法的返回类型是父类中返回类型的子类）必须相同。要注意<strong>子类函数的访问修饰权限不能少于父类的</strong>，不能抛出新的检查异常或者比被重写方法申明更加宽泛的检查型异常</li><li>同名的方法如果有不同的参数列表（<strong>参数类型不同、参数个数不同甚至是参数顺序不同</strong>）则视为重载。同时，重载对返回类型没有要求，可以相同也可以不同，但<strong>不能通过返回类型是否相同来判断重载</strong></li><li>方法的重载和重写都是实现多态的方式，区别在于前者实现的是编译时的多态性，而后者实现的是运行时的多态性。</li></ul></li><li><p>java 基本数据类型</p><ul><li>六种数字类型（四个整数型，两个浮点型），一种字符类型，还有一种布尔型。</li><li><strong>byte</strong> 8、<strong>short</strong> 16、<strong>int</strong> 32、<strong>long</strong> 64、<strong>double</strong> 64、<strong>float</strong> 32、<strong>boolean</strong>、<strong>char</strong></li><li>相对于 C++ 中的 long long，java 中用于操作大数的类主要有俩种 第一个是 BigInteger，代表大整数。第二个是 BigDecimal，代表大浮点数。</li></ul></li><li><p>封装类和基本类型的区别</p><ul><li>基本数据类型是值传递，封装类是引用传递</li><li>基本数据类型是存放在栈中的，而封装类是存放于堆中的</li><li>基本数据类型初始值如:int=0, 而封装类 Integer=null</li><li>集合中添加的元素一定是封装类引用数据类型</li><li>声明基本数据类型不需要实例化可直接赋值，而封装类必须申请一个存储空间实例化才可赋值</li></ul></li><li><p>聊聊 string、string buffer 和 string builder 的区别</p><ul><li>String 类是 Java 中最基本的字符串类，用于表示不可变的字符序列。一旦创建，内容就不能被修改。对 String 对象进行修改操作时（如拼接、替换等），实际上都会创建一个新的 String 对象</li><li>StringBuffer 类是为了解决 String 类在处理大量字符串操作时的性能问题而设计的。与 String 不同，StringBuffer 是可变的，即其内容可以在创建后进行修改。StringBuffer 内部使用了一个字符数组来存储字符串内容。StringBuffer 是线程安全的。它内部的许多方法都是同步的，这意味着在多线程环境下，多个线程可以同时访问和修改同一个 StringBuffer 对象而不会导致数据不一致的问题。然而，这种线程安全性是以牺牲一定性能为代价的。（synchronized 修饰）</li><li>StringBuilder 类是 StringBuffer 的一个简化版本，它同样用于处理可变字符串。与 StringBuffer 的主要区别在于，StringBuilder 不是线程安全的</li></ul></li><li><p>java 接口，抽象类，集合类的区别</p><ul><li><p>类可以实例化对象，而抽象类不能实例化对象。抽象类除了不能实例化对象之外，类的其他功能仍然存在，成员变量、成员方法和构造方法的访问方式和普通类一样。因为抽象类<strong>不能实例化对象</strong>，所以<strong>抽象类必须被继承，才能被使用。</strong></p></li><li><p>一个类只能继承一个抽象类，而一个类却可以实现多个接口。接口和类属于不同的概念，类是描述对象的属性和方法，接口是包含类要实现的方法。除非实现接口的类是抽象类，否则该类要定义接口中的所有方法。<strong>接口无法被实例化，但是可以被实现</strong>。</p></li><li><p><img data-src="https://www.runoob.com/wp-content/uploads/2014/01/java-coll-2020-11-16.png" alt=""></p></li><li><p>mysql 的单表最多多少记录</p><ul><li>有说法单表数据量超过 500 万行时就要进行分表分库，已经超过 2000 万行时 MySQL 的性能就会急剧下降</li><li>如果主键设置了 int，那就是 2^31，但除了主键和存储空间本质上不会有别的限制增添数据</li><li>是索引深度吗？<ul><li>MySQL 中页面偏移占 4 个字节，在非叶子节点的时候实际上是 8+4=12 个字节，12 个字节表示一个页面的映射关系。MySQL 默认是 16K 的页面，抛开它的配置 header，大概就是 15K，因此，非叶子节点的索引页面可放 15*1024/12=1280 条数据，按照每行 1K 计算，每个叶子节点可以存 15 条数据。同理，三层就是 15*1280*1280=24576000 条数据。只有数据量达到 24576000 条时，深度才会增加为 4</li></ul></li><li>IO? 之前机械硬盘的 IOPS 在 100 左右，而现在普遍使用的 SSD 的 IOPS 已经过万，之前的内存最大几十 G，现在服务器内存最大可达到 TB 级。也不是</li><li>是 SMO 无法并发吗？<ul><li>InnoDB 引擎使用的是索引组织表，它是通过索引来组织数据的，而它采用 B+tree 作为索引的数据结构。B+Tree 操作非原子，所以当一个线程做结构调整（SMO，Struction-Modification-Operation）时一般会涉及多个节点的改动。SMO 动作过程中，此时若有另一个线程进来可能会访问到错误的 B+Tree 结构，InnoDB 为了解决这个问题采用了乐观锁和悲观锁的并发控制协议。</li><li>方式一，先采用乐观锁的方式尝试进行修改：对根节点加 S 锁（shared lock，叫共享锁，也称读锁），依次对非叶子节点加 S 锁。如果<strong>叶子节点的修改不会引起 B+Tree 结构变动</strong>，如分裂、合并等操作，那么只需要对叶子节点进行加 X 锁（exclusive lock，叫排他锁，也称为写锁）即可完成修改。</li><li>方式二，采用悲观锁的方式：如果对叶子结点的修改会触发 SMO，那么会采用悲观锁的方式。采用悲观锁，需要重新遍历 B+Tree，对根节点加全局 SX 锁（SX 锁是行锁），然后从根节点到叶子节点可能修改的节点加 X 锁。<strong>在整个 SMO 过程中，根节点始终持有 SX 锁（SX 锁表示有意向修改这个保护的范围，SX 锁与 SX 锁、X 锁冲突，与 S 锁不冲突），此时其他的 SMO 则需要等待</strong>。</li><li>因此，InnoDB 对于简单的主键查询比较快，因为数据都存储在叶子节点中，但对于数据量大且改操作比较多的 TP 型业务，并发会有很严重的瓶颈问题。</li><li><strong>改进：</strong> B-Link Tree。1. 中间节点增加 link 指针，指向右兄弟节点；2. 每个节点内增加字段 high key，存储该节点中最大的 key 值。</li></ul></li></ul></li></ul></li><li><p>单个数据库怎么分库分表</p><ul><li>垂直拆分： 根据业务的维度，将原本一个库中的表拆分多个表，每个库中表与原有的结构不同</li><li>水平拆分： 根据分片算法，将一个库拆分成多个库，每个库依旧保留原有的结构</li></ul></li><li><p>分库分表存在什么问题</p><ul><li>联合查询困难：联合查询不仅困难，而且可以说是不可能，因为两个相关联的表可能会分布在不同的数据库，不同的服务器中</li><li>需要支持事务：分库分表后，就需要支持分布式事务了。数据库本身为我们提供了事务管理功能，但是分库分表之后就不适用了。如果我们自己编程协调事务，代码方面就又开始了麻烦</li><li>跨库 join 困难：分库分表后表之间的关联操作将受到限制，我们无法 join 位于不同分库的表，也无法 join 分表粒度不同的表， 结果原本一次查询能够完成的业务，可能需要多次查询才能完成。 我们可以使用全局表，所有库都拷贝一份</li><li>结果合并麻烦：比如我们购买了商品，订单表可能进行了拆分等等，此时结果合并就比较困难。</li></ul></li><li><p>分库分表分的不均匀怎么办</p><ul><li>负载均衡</li></ul></li><li><p>主从复制会引入什么问题</p><ul><li>写操作拓展起来比较困难，因为要保证多个主库的数据一致性</li><li>复制延时：意思是同步带来的时间消耗</li><li>锁表率上升：读写分离，命中率少，锁表的概率提升</li><li>表变大，缓存率下降：此时缓存率一旦下降，带来的就是时间上的消耗</li><li>随着用户量的增加、访问量的增加、数据量的增加依然会带来大量的问题，那就要考虑换一种解决思路：分库分表</li></ul></li><li><p>聊一聊数据打散不同表的底层的表落到不同的库的策略（有点忘了具体问题）</p></li><li><p>分库分表的主键 id 怎么保证唯一 id（答了数据库自增 ID 和分段式 ID 生成器，然后面试官开始深入）</p><ul><li>UUID 是一种通用唯一识别码，是<strong>全球唯一的</strong>，不会重复，所以可以作为唯一主键使用，而且本机生成不耗费资源，目的是用于分布式环境中唯一生成标志码，是由 32 个 16 进制数组成.</li><li>Redis 生成 ID，主要利用 Redis 是单线程的，所以也可以用来生成唯一 ID。当使用的是 Redis 集群的时候，比如集群中有 5 台 Redis，初始化每台 Redis 的值为 1,2,3,4,5，设置步长为 5，并且确定一个不随机的负载均衡策略，能够保证有序，唯一</li><li>每个 Id 前面加上机器号 ，如果有 3 个机器，初始化值分别设置为 1，2，3，然后步长设置为 3，每次新 ID 生成都是上一个 ID（同一个机器）+3。保证 ID 唯一性。</li><li>雪花算法，ID 按照时间在单机上是递增的。但不能保证全局递增，但肯定不一样。</li></ul></li><li><p>就是说有一堆，java 文件，这一个方法把里面的需要导入的类找出来，可能存在链式引用，A 依赖 B，B 依赖 C 这种。</p><ul><li>读取文件，找环处理</li></ul></li><li><p>Spring 循环依赖怎么解决的？</p><ul><li>三级缓存，加载 A 的时候，先中介环节缓存工厂，发现依赖 B，B 也到了 A 的这一步发现 A，又加载 A 发现已经有了该缓存，<s>那就先实现一个并给 B 和</s> 看图吧<ul><li>singletonObjects 一级缓存，用于保存实例化、注入、初始化完成的 bean 实例</li><li>earlySingletonObjects 二级缓存，用于保存实例化完成的 bean 实例</li><li>singletonFactories 三级缓存，用于保存 bean 创建工厂，以便于后面扩展有机会创建代理对象</li></ul></li><li><img data-src="https://ask.qcloudimg.com/http-save/8024638/b75c8ke07m.png" alt=""></li></ul></li><li></li></ul><hr><h2 id="mysql"><a class="anchor" href="#mysql">#</a> Mysql</h2><p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NhbGN1bHVzc3RpbGwvYXJ0aWNsZS9kZXRhaWxzLzEzNjc4MDQ2Mg==">https://blog.csdn.net/calculusstill/article/details/136780462</span></p><h2 id="项目"><a class="anchor" href="#项目">#</a> 项目</h2><ul><li><p>优惠卷秒杀的逻辑</p><ul><li>聊聊乐观锁。数据库层面的 update？<ul><li>将更新和查询统一在一条 SQL 语句中，也就是 Compare and Swap，CAS；版本号控制（查询版本号是否一致）；</li></ul></li><li><strong>分布式锁</strong>：<ul><li><em>基于数据库</em>实现分布式锁<ul><li><strong>记录锁</strong>，建立一个锁表，通过往锁表中插入数据 (到唯一索引，再次插入，没删除前就会失败) 的方式，来进行相应的同步操作。服务器是分布式的，公共资源（数据库不是）</li><li><strong>排他锁</strong>（悲观锁），如：在查询语句后面增加 <code>for update</code></li><li><strong>版本号</strong>（乐观锁）</li></ul></li><li><em>基于缓存（Redis 等）</em> 实现分布式锁<ul><li>加锁：执行 setnx，若成功再执行 expire 添加过期时间</li><li>解锁：执行 delete 命令</li><li>实现简单，相比数据库和分布式系统的实现，该方案最轻，性能最好。setnx 和 expire 分 2 步执行，非原子操作；若 setnx 执行成功，但 expire 执行失败，就可能出现死锁。delete 命令存在误删除非当前线程持有的锁的可能。不支持阻塞等待、不可重入</li><li>或者用 lua 脚本实现。Lua 脚本能够保证原子性的主要原因还是 Redis 采用了单线程执行模型。也就是说，当 Redis 执行 Lua 脚本时，Redis 会把 Lua 脚本作为一个整体并把它当作一个任务加入到一个队列中，然后单线程按照队列的顺序依次执行这些任务，在执行过程中 Lua 脚本是不会被其他命令或请求打断，因此可以保证每个任务的执行都是原子性的。</li></ul></li><li><em>基于 Zookeeper</em> 实现分布式锁（临时顺序节点的特性）<ul><li>假设现在有一个客户端 A，需要加锁，那么就在 &quot;/Lock&quot; 路径下创建一个临时顺序节点。然后获取 &quot;/Lock&quot; 下的节点列表，判断自己的序号是否是最小的，如果是最小的序号，则加锁成功！</li><li><img data-src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/7/15/17353229075ad04f~tplv-t2oaga2asx-zoom-in-crop-mark:1512:0:0:0.awebp" alt=""></li><li>现在又有另一个客户端，客户端 B 需要加锁，那么也是在 &quot;/Lock&quot; 路径下创建临时顺序节点。依然获取 &quot;/Lock&quot; 下的节点列表，判断自己的节点序号是否最小的。发现不是最小的，加锁失败，接着对自己的上一个节点进行监听。</li><li><img data-src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/7/15/173532ccde8ed6b4~tplv-t2oaga2asx-zoom-in-crop-mark:1512:0:0:0.awebp" alt=""></li><li>怎么释放锁呢，其实就是把临时节点删除。假设客户端 A 释放锁，把节点 01 删除了。那就会触发节点 02 的监听事件，客户端就再次获取节点列表，然后判断自己是否是最小的序号，如果是最小序号则加锁。</li><li><img data-src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/7/16/1735337578204cc5~tplv-t2oaga2asx-zoom-in-crop-mark:1512:0:0:0.awebp" alt=""></li><li>如果多个客户端其实也是一样，一上来就会创建一个临时节点，然后开始判断自己是否是最小的序号，如果不是就监听上一个节点，形成一种排队的机制。也就形成了锁的效果，保证了多台服务器只有一台执行。<strong>假设其中有一个客户端宕机了，根据临时节点的特点，ZooKeeper 会自动删除对应的临时节点</strong>，相当于自动释放了锁</li></ul></li></ul></li></ul></li><li><p>接口的幂等性是怎么做的？（意思就是 post 请求带着：一个用户 id，一个优惠卷 id。发送多次请求，如何保证只有一个成功）</p><ul><li>状态判断法：redis 缓存订单消息，并且每次会检查</li><li>业务判断发：表中增加唯一字段，同一用户，同一商品有个唯一标识</li></ul></li></ul><p>关注和点赞：<br>说说你的数据结构怎么设计的？我关注的人和关注我的人怎么设计的？<br>redis 里面有设置过期时间吗？<br>z 那种大 v，粉丝数量应该很多，这种热 key + 大 key 你是怎么处理的？分表知道吗？<br>rabbitmq 进行异步处理？那我假如关注一个人之后，马上要给他发消息怎么办（场景：互关才能发消息），你怎么保证这个即时性</p><p>博客加载：（自己做了个串行加载改并行：thread pool+future）<br>线程池的参数怎么设计的，核心线程数 2n（n=cpu 核心数）？但是你多个 tomcat 请求共用一个线程池啊......tomcat 线程池都有几百个线程了，2n 肯定不行<br>future 类异步获取加载结果，如果等待时间很长怎么办？一直阻塞吗？</p><p>登录：<br>简述你的登录逻辑<br>双重拦截器是什么<br>为什么要用 thread local，thread local 底层你懂吗？会出现什么问题？内存泄漏知道吗？怎么解决的<br>redis：<br>自定义布隆过滤器解决缓存穿透？布隆过滤器满了怎么办？布隆过滤器的数据怎么迁移？从一个小的变成一个更大的布隆过滤器可以吗？<br>延迟双删说一下，更新成功但是第二次删除失败了怎么办<br>为什么用 redisson？redisson 底层原理你懂吗？看门狗机制具体怎么实现的？redisson 如何解决主节点宕机问题（setnx 进入 master，但是宕机，slave 节点还没有收到写命令）<br>zookeeper 实现分布式锁知道吗？</p><div class="tags"><a href="/tags/JAVA/" rel="tag"><i class="ic i-tag"></i> JAVA</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">Edited on</span> <time title="Modified: 2024-04-13 21:42:51" itemprop="dateModified" datetime="2024-04-13T21:42:51+08:00">2024-04-13</time></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> Donate</button><p>Give me a cup of [coffee]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/images/wechatpay.jpg" alt="ZY WeChat Pay"><p>WeChat Pay</p></div></div></div><div id="copyright"><ul><li class="author"><strong>Post author: </strong>ZY <i class="ic i-at"><em>@</em></i>世界上只有一种真正的英雄主义，就是认清了生活的真相后还依然热爱它</li><li class="link"><strong>Post link: </strong><a href="https://zyakmd.github.io/2024/03/21/Java%E7%AC%94%E8%AE%B0/" title="Java笔记">https://zyakmd.github.io/2024/03/21/Java笔记/</a></li><li class="license"><strong>Copyright Notice: </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</a> unless stating additionally.</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2024/03/20/spring%E5%A4%8D%E4%B9%A0/MyBatis%20Plus/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;t.mwm.moe&#x2F;fj?692461" title="MyBatis Plus"><span class="type">Previous Post</span> <span class="category"><i class="ic i-flag"></i> spring复习</span><h3>MyBatis Plus</h3></a></div><div class="item right"><a href="/2024/03/22/%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE%E4%BC%98%E5%8C%96/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;t.mwm.moe&#x2F;fj?258316" title="商城项目优化"><span class="type">Next Post</span> <span class="category"><i class="ic i-flag"></i></span><h3>商城项目优化</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="Contents"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#jvm"><span class="toc-number">1.</span> <span class="toc-text">JVM</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B"><span class="toc-number">1.1.</span> <span class="toc-text">执行过程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%97%E8%8A%82%E7%A0%81"><span class="toc-number">1.2.</span> <span class="toc-text">字节码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E4%B8%8E%E8%A7%A3%E9%87%8A"><span class="toc-number">1.2.1.</span> <span class="toc-text">编译与解释</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="toc-number">1.3.</span> <span class="toc-text">类加载器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A0%E8%BD%BD"><span class="toc-number">1.3.1.</span> <span class="toc-text">加载</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9E%E6%8E%A5"><span class="toc-number">1.3.2.</span> <span class="toc-text">连接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">1.3.3.</span> <span class="toc-text">初始化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%B8%E8%BD%BD"><span class="toc-number">1.3.4.</span> <span class="toc-text">卸载</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A0%E8%BD%BD%E9%A1%BA%E5%BA%8F"><span class="toc-number">1.3.5.</span> <span class="toc-text">加载顺序</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E6%97%B6%E6%95%B0%E6%8D%AE%E5%8C%BA"><span class="toc-number">1.4.</span> <span class="toc-text">运行时数据区</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E5%8C%BA"><span class="toc-number">1.4.1.</span> <span class="toc-text">方法区</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%A0%88%E5%92%8C%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%A0%86"><span class="toc-number">1.4.2.</span> <span class="toc-text">虚拟机栈和虚拟机堆</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%88"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">栈</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A0%86"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">堆</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8C%BA%E5%88%AB"><span class="toc-number">1.4.2.3.</span> <span class="toc-text">区别</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E6%96%B9%E6%B3%95%E6%A0%88"><span class="toc-number">1.4.3.</span> <span class="toc-text">本地方法栈</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E5%8C%BA-2"><span class="toc-number">1.4.4.</span> <span class="toc-text">方法区</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E6%97%B6%E5%B8%B8%E9%87%8F%E6%B1%A0"><span class="toc-number">1.4.5.</span> <span class="toc-text">运行时常量池</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%B8%B8%E9%87%8F%E6%B1%A0"><span class="toc-number">1.4.6.</span> <span class="toc-text">字符串常量池</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#hotspot%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%A1%88%E4%BE%8B"><span class="toc-number">1.4.7.</span> <span class="toc-text">HotSpot 虚拟机案例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%88%9B%E5%BB%BA"><span class="toc-number">1.4.7.1.</span> <span class="toc-text">对象的创建</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80"><span class="toc-number">1.4.7.2.</span> <span class="toc-text">对象的内存布局</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%B9%E8%B1%A1%E7%9A%84%E8%AE%BF%E9%97%AE%E5%AE%9A%E4%BD%8D"><span class="toc-number">1.4.7.3.</span> <span class="toc-text">对象的访问定位</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8F%A5%E6%9F%84"><span class="toc-number">1.4.7.3.1.</span> <span class="toc-text">句柄</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%9B%B4%E6%8E%A5%E6%8C%87%E9%92%88"><span class="toc-number">1.4.7.3.2.</span> <span class="toc-text">直接指针</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E7%AE%97%E6%B3%95"><span class="toc-number">1.5.</span> <span class="toc-text">垃圾回收算法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%87%E8%AE%B0%E6%B8%85%E9%99%A4%E7%AE%97%E6%B3%95"><span class="toc-number">1.5.1.</span> <span class="toc-text">标记清除算法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%8D%E5%88%B6%E7%AE%97%E6%B3%95"><span class="toc-number">1.5.2.</span> <span class="toc-text">复制算法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%87%E8%AE%B0%E6%95%B4%E7%90%86%E7%AE%97%E6%B3%95"><span class="toc-number">1.5.3.</span> <span class="toc-text">标记整理算法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E4%BB%A3%E6%94%B6%E9%9B%86%E7%AE%97%E6%B3%95"><span class="toc-number">1.5.4.</span> <span class="toc-text">分代收集算法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E4%BC%98"><span class="toc-number">1.6.</span> <span class="toc-text">调优</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#juc"><span class="toc-number">2.</span> <span class="toc-text">JUC</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B"><span class="toc-number">3.</span> <span class="toc-text">线程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8A%B6%E6%80%81%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-number">3.1.</span> <span class="toc-text">状态 &#x2F; 生命周期</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%96%B9%E6%B3%95"><span class="toc-number">3.2.</span> <span class="toc-text">创建方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%A7%E6%89%BFthread%E7%B1%BB"><span class="toc-number">3.2.1.</span> <span class="toc-text">继承 Thread 类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8C%BF%E5%90%8D%E5%88%9B%E5%BB%BAthread%E7%B1%BB%E5%AD%90%E7%B1%BB"><span class="toc-number">3.2.1.1.</span> <span class="toc-text">匿名创建 Thread 类子类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#thread%E4%B8%AD%E7%9A%84%E5%B8%B8%E7%94%A8%E6%96%B9%E6%B3%95"><span class="toc-number">3.2.1.2.</span> <span class="toc-text">Thread 中的常用方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E7%9A%84%E4%BC%98%E5%85%88%E7%BA%A7"><span class="toc-number">3.2.1.3.</span> <span class="toc-text">线程的优先级</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8A%A2%E7%A5%A8%E6%A1%88%E4%BE%8B"><span class="toc-number">3.2.1.4.</span> <span class="toc-text">抢票案例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0runnable%E6%8E%A5%E5%8F%A3"><span class="toc-number">3.2.2.</span> <span class="toc-text">实现 Runnable 接口</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%87%87%E7%94%A8%E5%8C%BF%E5%90%8D%E5%86%85%E9%83%A8%E7%B1%BB%E5%88%9B%E5%BB%BA"><span class="toc-number">3.2.2.1.</span> <span class="toc-text">采用匿名内部类创建：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0callable%E6%8E%A5%E5%8F%A3"><span class="toc-number">3.2.3.</span> <span class="toc-text">实现 Callable 接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#runnable%E5%92%8Ccallable%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">3.2.4.</span> <span class="toc-text">Runnable 和 Callable 的区别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#future"><span class="toc-number">3.2.5.</span> <span class="toc-text">Future</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="toc-number">3.2.6.</span> <span class="toc-text">线程池</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%8D%E7%94%A8%E5%8F%8A%E5%8E%9F%E7%90%86"><span class="toc-number">3.2.6.1.</span> <span class="toc-text">复用及原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8B%92%E7%BB%9D%E7%AD%96%E7%95%A5"><span class="toc-number">3.2.6.2.</span> <span class="toc-text">拒绝策略</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98"><span class="toc-number">3.3.</span> <span class="toc-text">安全问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#synchronized"><span class="toc-number">3.3.1.</span> <span class="toc-text">synchronized</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BB%BC%E5%90%88%E6%A1%88%E4%BE%8B"><span class="toc-number">3.4.</span> <span class="toc-text">多线程综合案例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B9%B0%E7%A5%A8"><span class="toc-number">3.4.1.</span> <span class="toc-text">买票</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%A1%E5%8F%B7%E7%81%AF%E6%B3%95%E9%80%9A%E8%BF%87%E6%A0%87%E5%BF%97%E4%B8%BA%E8%A7%A3%E5%86%B3"><span class="toc-number">3.4.2.</span> <span class="toc-text">信号灯法，通过标志为解决</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A0%E9%94%81%E8%A7%A3%E5%86%B3%E5%B9%B6%E5%8F%91"><span class="toc-number">3.4.3.</span> <span class="toc-text">加锁解决并发</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%94%81"><span class="toc-number">4.</span> <span class="toc-text">锁</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#cas"><span class="toc-number">4.1.</span> <span class="toc-text">CAS</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E8%AF%95%E6%9C%BA%E5%88%B6"><span class="toc-number">4.1.1.</span> <span class="toc-text">重试机制</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#aqs"><span class="toc-number">4.2.</span> <span class="toc-text">AQS</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F"><span class="toc-number">5.</span> <span class="toc-text">设计模式</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-number">6.</span> <span class="toc-text">数据结构</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#hashmap"><span class="toc-number">6.1.</span> <span class="toc-text">HashMap</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E8%A6%81%E5%8F%98%E9%87%8F"><span class="toc-number">6.1.1.</span> <span class="toc-text">重要变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-number">6.1.2.</span> <span class="toc-text">实现原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E9%97%AE%E9%A2%98%E5%AE%89%E5%85%A8-%E5%B9%B6%E5%8F%91"><span class="toc-number">6.1.3.</span> <span class="toc-text">其他问题（安全、并发）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#concurrenthashmap"><span class="toc-number">6.2.</span> <span class="toc-text">ConcurrentHashMap</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BA%A2%E9%BB%91%E6%A0%91"><span class="toc-number">6.3.</span> <span class="toc-text">红黑树</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E4%BA%9Bjava%E6%9C%BA%E5%88%B6"><span class="toc-number">7.</span> <span class="toc-text">一些 Java 机制</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#fail-fast"><span class="toc-number">7.1.</span> <span class="toc-text">fail-fast</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#fail-safe"><span class="toc-number">7.2.</span> <span class="toc-text">fail-safe</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%9D%A2%E7%BB%8F%E6%B1%87%E6%80%BB"><span class="toc-number">8.</span> <span class="toc-text">面经汇总</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#java"><span class="toc-number">8.1.</span> <span class="toc-text">java</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mysql"><span class="toc-number">8.2.</span> <span class="toc-text">Mysql</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE"><span class="toc-number">8.3.</span> <span class="toc-text">项目</span></a></li></ol></li></ol></div><div class="related panel pjax" data-title="Related"></div><div class="overview panel" data-title="Overview"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="ZY" data-src="/images/avatar.jpg"><p class="name" itemprop="name">ZY</p><div class="description" itemprop="description">行到水穷处，坐看云起时</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">15</span> <span class="name">posts</span></a></div><div class="item categories"><a href="/categories/"><span class="count">2</span> <span class="name">categories</span></a></div><div class="item tags"><a href="/tags/"><span class="count">3</span> <span class="name">tags</span></a></div></nav><div class="social"><a href="https://github.com/zyakmd" title="https:&#x2F;&#x2F;github.com&#x2F;zyakmd" class="item github" rel="noopener" target="_blank"><i class="ic i-github"></i></a></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>Home</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>Posts</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>Archives</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>Categories</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>Tags</a></li></ul></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/2024/03/20/spring%E5%A4%8D%E4%B9%A0/MyBatis%20Plus/" rel="prev" title="Previous Post"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/2024/03/22/%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE%E4%BC%98%E5%8C%96/" rel="next" title="Next Post"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>Random Posts</h2><ul><li class="item"><div class="breadcrumb"></div><span><a href="/2024/03/29/Docker/" title="Docker">Docker</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/spring%E5%A4%8D%E4%B9%A0/" title="In spring复习">spring复习</a></div><span><a href="/2024/03/20/spring%E5%A4%8D%E4%B9%A0/MyBatis%20Plus/" title="MyBatis Plus">MyBatis Plus</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/2024/03/13/MySQL/" title="MySQL">MySQL</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/spring%E5%A4%8D%E4%B9%A0/" title="In spring复习">spring复习</a></div><span><a href="/2024/03/15/spring%E5%A4%8D%E4%B9%A0/Spring%20MVC/" title="Spring MVC">Spring MVC</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/hexo%E4%BD%BF%E7%94%A8/" title="In hexo使用">hexo使用</a></div><span><a href="/2024/03/06/hexo%E4%BD%BF%E7%94%A8/hexo+github/" title="hexo + github 博客搭建">hexo + github 博客搭建</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/hexo%E4%BD%BF%E7%94%A8/" title="In hexo使用">hexo使用</a></div><span><a href="/2024/03/09/hexo%E4%BD%BF%E7%94%A8/%E7%95%8C%E9%9D%A2%E7%9B%B8%E5%85%B3/" title="界面相关">界面相关</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/2024/04/01/RPC%E9%A1%B9%E7%9B%AE/" title="RPC项目">RPC项目</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/spring%E5%A4%8D%E4%B9%A0/" title="In spring复习">spring复习</a></div><span><a href="/2024/03/11/spring%E5%A4%8D%E4%B9%A0/Spring%20framework/" title="Spring framework">Spring framework</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/2024/03/22/%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE%E4%BC%98%E5%8C%96/" title="商城项目优化">商城项目优化</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/hexo%E4%BD%BF%E7%94%A8/" title="In hexo使用">hexo使用</a></div><span><a href="/2024/03/07/hexo%E4%BD%BF%E7%94%A8/%E7%BD%91%E7%AB%99%E6%A0%B7%E5%BC%8F/" title="网站样式">网站样式</a></span></li></ul></div></div><div class="status"><div class="copyright">&copy; 2023 – <span itemprop="copyrightYear">2024</span> <span class="with-love"><i class="ic i-"></i> </span><span class="author" itemprop="copyrightHolder">ZY @ ZY Blog</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="Symbols count total">485k words</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="Reading time total">7:21</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"2024/03/21/Java笔记/",favicon:{show:"（●´3｀●）Goooood",hide:"(´Д｀)Booooom"},search:{placeholder:"Search for Posts",empty:"We didn't find any results for the search: ${query}",stats:"${hits} results found in ${time} ms"},valine:!0,fancybox:!0,copyright:'Copied to clipboard successfully! <br> All articles in this blog are licensed under <i class="ic i-creative-commons"></i>BY-NC-SA.',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,debug:!1,model:{jsonPath:"/live2dw/assets/hijiki.model.json"},display:{position:"left",width:150,height:300},mobile:{show:!0},log:!1})</script></body></html><!-- rebuild by hrmmi -->