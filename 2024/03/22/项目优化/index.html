<!-- build time:Thu May 23 2024 20:05:58 GMT+0800 (中国标准时间) --><!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><link rel="alternate" type="application/rss+xml" title="世界上只有一种真正的英雄主义，就是认清了生活的真相后还依然热爱它" href="https://zyakmd.github.io/rss.xml"><link rel="alternate" type="application/atom+xml" title="世界上只有一种真正的英雄主义，就是认清了生活的真相后还依然热爱它" href="https://zyakmd.github.io/atom.xml"><link rel="alternate" type="application/json" title="世界上只有一种真正的英雄主义，就是认清了生活的真相后还依然热爱它" href="https://zyakmd.github.io/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="JAVA,Mysql"><link rel="canonical" href="https://zyakmd.github.io/2024/03/22/%E9%A1%B9%E7%9B%AE%E4%BC%98%E5%8C%96/"><title>项目优化 | ZY Blog = 世界上只有一种真正的英雄主义，就是认清了生活的真相后还依然热爱它</title><meta name="generator" content="Hexo 5.4.2"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">项目优化</h1><div class="meta"><span class="item" title="Created: 2024-03-22 17:02:14"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">Posted on</span> <time itemprop="dateCreated datePublished" datetime="2024-03-22T17:02:14+08:00">2024-03-22</time> </span><span class="item" title="Symbols count in article"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">Symbols count in article</span> <span>50k</span> <span class="text">words</span> </span><span class="item" title="Reading time"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">Reading time</span> <span>45 mins.</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="Toggle navigation bar"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">ZY Blog</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://t.mwm.moe/fj?801374"></li><li class="item" data-background-image="https://t.mwm.moe/fj?38952"></li><li class="item" data-background-image="https://t.mwm.moe/fj?92505"></li><li class="item" data-background-image="https://t.mwm.moe/fj?446788"></li><li class="item" data-background-image="https://t.mwm.moe/fj?134531"></li><li class="item" data-background-image="https://t.mwm.moe/fj?783768"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">Home</a></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="en"><link itemprop="mainEntityOfPage" href="https://zyakmd.github.io/2024/03/22/%E9%A1%B9%E7%9B%AE%E4%BC%98%E5%8C%96/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="ZY"><meta itemprop="description" content=", 行到水穷处，坐看云起时"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="世界上只有一种真正的英雄主义，就是认清了生活的真相后还依然热爱它"></span><div class="body md" itemprop="articleBody"><p>最近的一次 java 项目还是本科，几年了，主从和 Nginx 有用过，虽然也忘了。但肯定不够，要躺板板的。补充学一下 Redis 和 RocketMQ 和复习之前的。</p><h1 id="redis-springcache"><a class="anchor" href="#redis-springcache">#</a> Redis + SpringCache</h1><h2 id="安装"><a class="anchor" href="#安装">#</a> 安装</h2><p>没啥好说的，双端安装，教程很多，其中 linux 下需要 gcc 环境</p><h2 id="服务运行"><a class="anchor" href="#服务运行">#</a> 服务运行</h2><h3 id="启停"><a class="anchor" href="#启停">#</a> 启停</h3><ul><li>进入到 <code>/src</code> 目录下，执行 <code>redis-server</code> 即可启动服务，默认端口号为 <code>6379</code></li></ul><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 进入到根目录  </span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token builtin class-name">cd</span> /usr/local/redis根目录/src  </pre></td></tr><tr><td data-num="3"></td><td><pre>  </pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 执行 redis-server  </span></pre></td></tr><tr><td data-num="5"></td><td><pre>./redis-server</pre></td></tr></table></figure><ul><li><code>ps aux | grep redis</code> 查看当前进程 PID</li><li><code>kill -9 PID</code> 关闭</li><li>或者执行<br><code>redis-cli shutdown</code><br>有密码则要先登录再 shutdown <code>redis-cli -p &lt;password&gt; shutdown</code> ，虽然会提示直接这样用密码不安全哈哈</li></ul><h3 id="后台运行"><a class="anchor" href="#后台运行">#</a> 后台运行</h3><ul><li>进入到 redis 根目录下，修改配置 redis.conf 文件</li></ul><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 进入到 redis 根目录下  </span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token builtin class-name">cd</span> /usr/local/redis根目录  </pre></td></tr><tr><td data-num="3"></td><td><pre>  </pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 修改配置文件  </span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token function">vim</span> redis.conf</pre></td></tr></table></figure><ul><li>找到 <code>daemonize on</code> 字段，将其修改为 <code>daemonize yes</code></li><li>在 redis 根目录以 redis.conf 作为配置文件在后台运行</li></ul><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token builtin class-name">cd</span> src/redis-server </pre></td></tr><tr><td data-num="2"></td><td><pre>./redis.conf</pre></td></tr></table></figure><ul><li>或者 tmux 开后台终端也好用</li></ul><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 虚拟环境（免断网掉线，后台运行） &#123;创建、进入、杀死、切换、重命名、显示所有&#125;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>tmux new <span class="token parameter variable">-t</span> <span class="token operator">&lt;</span>name<span class="token operator">></span></pre></td></tr><tr><td data-num="3"></td><td><pre>tmux a <span class="token parameter variable">-t</span> <span class="token operator">&lt;</span>name<span class="token operator">></span></pre></td></tr><tr><td data-num="4"></td><td><pre>tmux kill-session <span class="token parameter variable">-t</span> <span class="token operator">&lt;</span>session-name<span class="token operator">></span></pre></td></tr><tr><td data-num="5"></td><td><pre>tmux switch <span class="token parameter variable">-t</span> <span class="token operator">&lt;</span>session-name<span class="token operator">></span></pre></td></tr><tr><td data-num="6"></td><td><pre>tmux rename-session <span class="token parameter variable">-t</span> <span class="token number">0</span> <span class="token operator">&lt;</span>new-name<span class="token operator">></span></pre></td></tr><tr><td data-num="7"></td><td><pre>tmux <span class="token function">ls</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment"># 退出 (非终止)，在里面 Ctrl+b  按 d</span></pre></td></tr></table></figure><h3 id="密码校验"><a class="anchor" href="#密码校验">#</a> 密码校验</h3><ul><li>还是修改 redis.conf 配置文件，找到 <code>requirepass</code> 这行 (vim 里 / 查找内容)，将其注释去掉，并在后面写上自己的密码</li><li>然后杀掉原进程再重新启动</li></ul><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 重新启动  </span></pre></td></tr><tr><td data-num="2"></td><td><pre>src/redis-server ./redis.conf   </pre></td></tr><tr><td data-num="3"></td><td><pre>  </pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 登录时同时进行认证  </span></pre></td></tr><tr><td data-num="5"></td><td><pre>src/redis-cli <span class="token parameter variable">-h</span> localhost <span class="token parameter variable">-p</span> <span class="token number">6379</span> <span class="token parameter variable">-a</span> <span class="token operator">&lt;</span>password<span class="token operator">></span></pre></td></tr></table></figure><ul><li>修改完毕之后重启服务</li></ul><h3 id="远程连接"><a class="anchor" href="#远程连接">#</a> 远程连接</h3><ul><li>还是修改 redis.conf 配置文件，找到 <code>bind 127.0.0.1</code> 这行，把这行注释掉</li><li>之后设置防火墙，开启 6379 端口</li></ul><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 开启 6379 端口  </span></pre></td></tr><tr><td data-num="2"></td><td><pre>firewall-cmd <span class="token parameter variable">--zone</span><span class="token operator">=</span>public --add-port<span class="token operator">=</span><span class="token number">6379</span>/tcp <span class="token parameter variable">--permanent</span>  </pre></td></tr><tr><td data-num="3"></td><td><pre>  </pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 设置立即生效  </span></pre></td></tr><tr><td data-num="5"></td><td><pre>firewall-cmd <span class="token parameter variable">--reload</span>  </pre></td></tr><tr><td data-num="6"></td><td><pre>  </pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># 查看开放的端口  </span></pre></td></tr><tr><td data-num="8"></td><td><pre>firewall-cmd <span class="token parameter variable">--zone</span><span class="token operator">=</span>public --list-ports</pre></td></tr></table></figure><ul><li>服务器对应的接口要打开，像阿里云在 esc 控制台要手动添加开放端口</li><li>最后在 Windows 的 redis 根目录下，按住 Shift + 右键打开 PowerShell 窗口，连接 Linux 的 Redis<br><code>.\redis-cli.ext -h 服务器地址 -p 6379 -a &lt;password&gt;</code></li></ul><p>懒得开控制台的话用 redis desktop，<span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0phY2FDYW8vYXJ0aWNsZS9kZXRhaWxzLzEwNjA4ODE0OA==">使用参考</span></p><h3 id="报错"><a class="anchor" href="#报错">#</a> 报错</h3><p>启动的时候遇到了</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>WARNING overcommit_memory is <span class="token builtin class-name">set</span> to <span class="token number">0</span><span class="token operator">!</span> Background save may fail</pre></td></tr><tr><td data-num="2"></td><td><pre>under low memory condition. To fix this issue <span class="token function">add</span> ‘vm.overcommit_memory <span class="token operator">=</span> <span class="token number">1</span>’ to <span class="token operator">></span> <span class="token operator">></span> <span class="token operator">></span> /etc/sysctl.conf and <span class="token keyword">then</span> <span class="token function">reboot</span> or run the <span class="token builtin class-name">command</span> ‘sysctl <span class="token assign-left variable">vm.overcommit_memory</span><span class="token operator">=</span><span class="token number">1</span>’ <span class="token operator">></span> <span class="token keyword">for</span> this to take effect.</pre></td></tr></table></figure><p>需要进行内存设置（服务器配置太拉的要？）<br><code>echo 1 &gt; /proc/sys/vm/overcommit_memory</code> 即可</p><div class="note info no-icon"><ul><li>0， 表示内核将检查是否有足够的可用内存供应用进程使用；如果有足够的可用内存，内存申请允许；否则，内存申请失败，并把错误返回给应用进程</li><li>1，表示内核允许分配所有的物理内存，而不管当前的内存状态如何</li><li>2， 表示内核允许分配超过所有物理内存和交换空间总和的内存</li></ul></div><h2 id="java中使用"><a class="anchor" href="#java中使用">#</a> Java 中使用</h2><ul><li>Redis 的 Java 客户端有很多，官方推荐的有三种<ul><li><code>Jedis</code></li><li><code>Lettuce</code></li><li><code>Redisson</code></li></ul></li><li>Spring 对 Redis 客户端进行了整合，提供了 SpringDataRedis，在 Spring Boot 项目中还提供了对应的 Starter，即 <code>spring-boot-starter-data-redis</code></li></ul><h3 id="jedis"><a class="anchor" href="#jedis">#</a> Jedis</h3><ul><li>使用 Jedis 的步骤<ol><li>获取连接</li><li>执行操作</li><li>关闭连接</li></ol></li><li>在此之前我们需要导入一下 Jedis 的 maven 坐标</li></ul><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>  </pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>redis.clients<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>  </pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>jedis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>  </pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.8.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>  </pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><ul><li>编写测试类</li></ul><figure class="highlight java"><figcaption data-lang="java"><span>title:RedisTestApplicationTests</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@SpringBootTest</span>  </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">RedisTestApplicationTests</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="3"></td><td><pre>  </pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token annotation punctuation">@Test</span>  </pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">void</span> <span class="token function">contextLoads</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token comment">//1. 获取连接  </span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token class-name">Jedis</span> jedis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jedis</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">6379</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token comment">//2. 执行具体操作  </span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token comment">//key、value set 到 redis 中</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        jedis<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"Hades"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>		<span class="token comment">//hashset: 对于某些不定项操作可以利用哈希扩展</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        jedis<span class="token punctuation">.</span><span class="token function">hset</span><span class="token punctuation">(</span><span class="token string">"stu"</span><span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"Jerry"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="14"></td><td><pre>        jedis<span class="token punctuation">.</span><span class="token function">hset</span><span class="token punctuation">(</span><span class="token string">"stu"</span><span class="token punctuation">,</span> <span class="token string">"age"</span><span class="token punctuation">,</span> <span class="token string">"18"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="15"></td><td><pre>        jedis<span class="token punctuation">.</span><span class="token function">hset</span><span class="token punctuation">(</span><span class="token string">"stu"</span><span class="token punctuation">,</span> <span class="token string">"num"</span><span class="token punctuation">,</span> <span class="token string">"4204000400"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="16"></td><td><pre>  </pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> map <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">hgetAll</span><span class="token punctuation">(</span><span class="token string">"stu"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> keySet <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> key <span class="token operator">:</span> keySet<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="20"></td><td><pre>            <span class="token class-name">String</span> value <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>key <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token class-name">String</span> name <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token comment">//3. 关闭连接  </span></pre></td></tr><tr><td data-num="26"></td><td><pre>        jedis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="28"></td><td><pre>  </pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>另外两个类似，导入坐标，获取链接，使用各自的接口函数</p><h3 id="spring-data-redis"><a class="anchor" href="#spring-data-redis">#</a> Spring Data Redis</h3><ul><li>SpringBoot 项目中，可以使用 SpringDataRedis 来简化 Redis（常用）</li><li>Spring Data Redis 中提供了一个高度封装的类：RedisTemplate，针对 jedis 客户端中大量 api 进行了归类封装，将同一类型操作封装为 operation 接口，具体分类如下：<ul><li>ValueOperations：简单 K-V 操作</li><li>SetOperations：set 类型数据操作</li><li>ZSetOperations：zset 类型数据操作</li><li>HashOperations：针对 map 类型的数据操作</li><li>ListOperations：针对 list 类型的数据操作</li></ul></li></ul><blockquote><ol><li>使用 SpringDataRedis，我们首先需要导入它的 maven 坐标</li></ol></blockquote><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">&lt;!--Spring Boot-redis 的依赖包 --></span>  </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>  </pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>  </pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>  </pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><blockquote><ol start="2"><li>重新设置一下序列化器，防止出现乱码，在 config 包下创建 <code>RedisConfig</code> 配置类</li></ol></blockquote><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Configuration</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisConfig</span> <span class="token keyword">extends</span> <span class="token class-name">CachingConfigurerSupport</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token annotation punctuation">@Bean</span>  </pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> <span class="token function">redisTemplate</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span> connectionFactory<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="5"></td><td><pre>  </pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> redisTemplate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="7"></td><td><pre>  </pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token comment">// 默认的 Key 序列化器为：JdkSerializationRedisSerializer  </span></pre></td></tr><tr><td data-num="9"></td><td><pre>        redisTemplate<span class="token punctuation">.</span><span class="token function">setKeySerializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="10"></td><td><pre>        redisTemplate<span class="token punctuation">.</span><span class="token function">setHashKeySerializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="11"></td><td><pre>  </pre></td></tr><tr><td data-num="12"></td><td><pre>        redisTemplate<span class="token punctuation">.</span><span class="token function">setConnectionFactory</span><span class="token punctuation">(</span>connectionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="13"></td><td><pre>  </pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#125;</span>```</pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token operator">></span><span class="token number">3.</span> 配置一下连接redis的相关配置</pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>```yml</pre></td></tr><tr><td data-num="21"></td><td><pre>spring<span class="token operator">:</span>  </pre></td></tr><tr><td data-num="22"></td><td><pre>  redis<span class="token operator">:</span>  </pre></td></tr><tr><td data-num="23"></td><td><pre>    host<span class="token operator">:</span> localhost  </pre></td></tr><tr><td data-num="24"></td><td><pre>    port<span class="token operator">:</span> <span class="token number">6379</span>  </pre></td></tr><tr><td data-num="25"></td><td><pre>    #password<span class="token operator">:</span> root  </pre></td></tr><tr><td data-num="26"></td><td><pre>    database<span class="token operator">:</span> <span class="token number">0</span> #操作的是<span class="token number">0</span>号数据库  </pre></td></tr><tr><td data-num="27"></td><td><pre>    jedis<span class="token operator">:</span>  </pre></td></tr><tr><td data-num="28"></td><td><pre>      #<span class="token class-name">Redis</span>连接池配置  </pre></td></tr><tr><td data-num="29"></td><td><pre>      pool<span class="token operator">:</span>  </pre></td></tr><tr><td data-num="30"></td><td><pre>        max<span class="token operator">-</span>active<span class="token operator">:</span> <span class="token number">8</span> #最大连接数  </pre></td></tr><tr><td data-num="31"></td><td><pre>        max<span class="token operator">-</span>wait<span class="token operator">:</span> <span class="token number">1</span>ms #连接池最大阻塞等待时间  </pre></td></tr><tr><td data-num="32"></td><td><pre>        max<span class="token operator">-</span>idle<span class="token operator">:</span> <span class="token number">4</span> #连接池中的最大空闲连接  </pre></td></tr><tr><td data-num="33"></td><td><pre>        min<span class="token operator">-</span>idle<span class="token operator">:</span> <span class="token number">0</span> #连接池中的最小空闲连接</pre></td></tr></table></figure><blockquote><ol start="4"><li>使用</li></ol></blockquote><ul><li><code>String</code> 类型数据操作</li></ul><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Test</span>  </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">void</span> <span class="token function">stringTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token comment">// 获取对象  </span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token class-name">ValueOperations</span> valueOperations <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment">// 设置 name 为 Hades  </span></pre></td></tr><tr><td data-num="6"></td><td><pre>    valueOperations<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span><span class="token string">"Hades"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token class-name">String</span> name <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> valueOperations<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token comment">// 设置 age 为 9527，有效时间 10 秒  </span></pre></td></tr><tr><td data-num="10"></td><td><pre>    valueOperations<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"age"</span><span class="token punctuation">,</span> <span class="token string">"9527"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token class-name">String</span> age <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> valueOperations<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"age"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token comment">// 如果不存在，则设置 name 为 Kyle  </span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token class-name">Boolean</span> aBoolean <span class="token operator">=</span> valueOperations<span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"Kyle"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>aBoolean<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#125;</span>```</pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>输出结果如下，由于name已经存在，故<span class="token class-name">Kyle</span>设置失败，最后返回<span class="token boolean">false</span>，<span class="token number">10</span>秒过后，我们再去redis中get name，则输出`nil`，表示不存在</pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token operator">-</span> `<span class="token class-name">Hash</span>`类型数据操作</pre></td></tr><tr><td data-num="21"></td><td><pre>```java</pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token annotation punctuation">@Test</span>  </pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token keyword">void</span> <span class="token function">hashTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token class-name">HashOperations</span> hashOperations <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="25"></td><td><pre>    hashOperations<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"4204000400"</span><span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"Hades"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="26"></td><td><pre>    hashOperations<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"4204000400"</span><span class="token punctuation">,</span> <span class="token string">"age"</span><span class="token punctuation">,</span> <span class="token string">"18"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="27"></td><td><pre>    hashOperations<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"4204000400"</span><span class="token punctuation">,</span> <span class="token string">"hobby"</span><span class="token punctuation">,</span> <span class="token string">"Apex"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token comment">// 获取 map 集合  </span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> map <span class="token operator">=</span> hashOperations<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span><span class="token string">"4204000400"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> keySet <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> hashKey <span class="token operator">:</span> keySet<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>hashKey <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>hashKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"$$$$$$$$$$$$$$$"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token comment">// 只获取 keys  </span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> keys <span class="token operator">=</span> hashOperations<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token string">"4204000400"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> key <span class="token operator">:</span> keys<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"$$$$$$$$$$$$$$$"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token comment">// 只获取 values  </span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> values <span class="token operator">=</span> hashOperations<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token string">"4204000400"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> value <span class="token operator">:</span> values<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>输出结果如下</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>name:Hades  </pre></td></tr><tr><td data-num="2"></td><td><pre>age:18  </pre></td></tr><tr><td data-num="3"></td><td><pre>hobby:Apex  </pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token variable">$$</span><span class="token variable">$$</span><span class="token variable">$$</span><span class="token variable">$$</span><span class="token variable">$$</span><span class="token variable">$$</span><span class="token variable">$$</span>$  </pre></td></tr><tr><td data-num="5"></td><td><pre>name  </pre></td></tr><tr><td data-num="6"></td><td><pre>age  </pre></td></tr><tr><td data-num="7"></td><td><pre>hobby  </pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token variable">$$</span><span class="token variable">$$</span><span class="token variable">$$</span><span class="token variable">$$</span><span class="token variable">$$</span><span class="token variable">$$</span><span class="token variable">$$</span>$  </pre></td></tr><tr><td data-num="9"></td><td><pre>Hades  </pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token number">18</span>  </pre></td></tr><tr><td data-num="11"></td><td><pre>Apex</pre></td></tr></table></figure><ul><li><code>List</code> 类型数据操作</li></ul><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Test</span>  </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">void</span> <span class="token function">listTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token class-name">ListOperations</span> listOperations <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">// 存数据  </span></pre></td></tr><tr><td data-num="5"></td><td><pre>    listOperations<span class="token punctuation">.</span><span class="token function">leftPush</span><span class="token punctuation">(</span><span class="token string">"testData"</span><span class="token punctuation">,</span> <span class="token string">"A"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="6"></td><td><pre>    listOperations<span class="token punctuation">.</span><span class="token function">leftPushAll</span><span class="token punctuation">(</span><span class="token string">"testData"</span><span class="token punctuation">,</span> <span class="token string">"B"</span><span class="token punctuation">,</span> <span class="token string">"C"</span><span class="token punctuation">,</span> <span class="token string">"D"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> testDatas <span class="token operator">=</span> listOperations<span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token string">"testData"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">// 遍历  </span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> tableData <span class="token operator">:</span> testDatas<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>tableData <span class="token operator">+</span> <span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token comment">// 获取当前 list 长度，用于遍历  </span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token class-name">Long</span> size <span class="token operator">=</span> listOperations<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token string">"testData"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">int</span> value <span class="token operator">=</span> size<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token comment">// 遍历输出并删除  </span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> value<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>listOperations<span class="token punctuation">.</span><span class="token function">leftPop</span><span class="token punctuation">(</span><span class="token string">"testData"</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token comment">// 最后输出一下当前 list 长度  </span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>listOperations<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token string">"testData"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>输出结果如下</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>D C B A  </pre></td></tr><tr><td data-num="2"></td><td><pre>D C B A  </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">0</span></pre></td></tr></table></figure><ul><li><code>Set</code> 类型数据操作</li></ul><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Test</span>  </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">void</span> <span class="token function">setTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token class-name">SetOperations</span> setOperations <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">// 存数据，这里存了两个 a  </span></pre></td></tr><tr><td data-num="5"></td><td><pre>    setOperations<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"tmp"</span><span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">,</span> <span class="token string">"b"</span><span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">,</span> <span class="token string">"d"</span><span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="6"></td><td><pre>    遍历输出  </pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> tmpData <span class="token operator">=</span> setOperations<span class="token punctuation">.</span><span class="token function">members</span><span class="token punctuation">(</span><span class="token string">"tmp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> value <span class="token operator">:</span> tmpData<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>value <span class="token operator">+</span> <span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"$$$$$$$$$$$$$$$$$$$"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token comment">// 删除 bc  </span></pre></td></tr><tr><td data-num="14"></td><td><pre>    setOperations<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">"tmp"</span><span class="token punctuation">,</span> <span class="token string">"b"</span><span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token comment">// 再次遍历输出  </span></pre></td></tr><tr><td data-num="16"></td><td><pre>    tmpData <span class="token operator">=</span> setOperations<span class="token punctuation">.</span><span class="token function">members</span><span class="token punctuation">(</span><span class="token string">"tmp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> value <span class="token operator">:</span> tmpData<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>value <span class="token operator">+</span> <span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>输出结果如下，符合预期</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>d b c a  </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token variable">$$</span><span class="token variable">$$</span><span class="token variable">$$</span><span class="token variable">$$</span><span class="token variable">$$</span><span class="token variable">$$</span><span class="token variable">$$</span><span class="token variable">$$</span><span class="token variable">$$</span>$  </pre></td></tr><tr><td data-num="3"></td><td><pre>d a</pre></td></tr></table></figure><ul><li>通用的数据类型操作</li></ul><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Test</span>  </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">void</span> <span class="token function">commonTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token comment">// 查看所有 key  </span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> keys <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> key <span class="token operator">:</span> keys<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">// 查看是否存在指定 key  </span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"$$$$$$$$$$$$$$$$$$$$$$$$$"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>redisTemplate<span class="token punctuation">.</span><span class="token function">hasKey</span><span class="token punctuation">(</span><span class="token string">"Random"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"$$$$$$$$$$$$$$$$$$$$$$$$$"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token comment">// 删除指定 key，并再次查看  </span></pre></td></tr><tr><td data-num="13"></td><td><pre>    redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">"myZset"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="14"></td><td><pre>    keys <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> key <span class="token operator">:</span> keys<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"$$$$$$$$$$$$$$$$$$$$$$$$$"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token comment">// 输出指定 key 的类型  </span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>redisTemplate<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token string">"tmp"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>tmp  </pre></td></tr><tr><td data-num="2"></td><td><pre>name  </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">4204000400</span>  </pre></td></tr><tr><td data-num="4"></td><td><pre>stu  </pre></td></tr><tr><td data-num="5"></td><td><pre>myData  </pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token variable">$$</span><span class="token variable">$$</span><span class="token variable">$$</span><span class="token variable">$$</span><span class="token variable">$$</span><span class="token variable">$$</span><span class="token variable">$$</span><span class="token variable">$$</span><span class="token variable">$$</span><span class="token variable">$$</span><span class="token variable">$$</span><span class="token variable">$$</span>$  </pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token boolean">false</span>  </pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token variable">$$</span><span class="token variable">$$</span><span class="token variable">$$</span><span class="token variable">$$</span><span class="token variable">$$</span><span class="token variable">$$</span><span class="token variable">$$</span><span class="token variable">$$</span><span class="token variable">$$</span><span class="token variable">$$</span><span class="token variable">$$</span><span class="token variable">$$</span>$  </pre></td></tr><tr><td data-num="9"></td><td><pre>tmp  </pre></td></tr><tr><td data-num="10"></td><td><pre>name  </pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token number">4204000400</span>  </pre></td></tr><tr><td data-num="12"></td><td><pre>stu  </pre></td></tr><tr><td data-num="13"></td><td><pre>myData  </pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token variable">$$</span><span class="token variable">$$</span><span class="token variable">$$</span><span class="token variable">$$</span><span class="token variable">$$</span><span class="token variable">$$</span><span class="token variable">$$</span><span class="token variable">$$</span><span class="token variable">$$</span><span class="token variable">$$</span><span class="token variable">$$</span><span class="token variable">$$</span>$  </pre></td></tr><tr><td data-num="15"></td><td><pre>SET</pre></td></tr></table></figure><h2 id="简单案例"><a class="anchor" href="#简单案例">#</a> 简单案例</h2><blockquote><p>导入 SpringDataRedis 的 maven 坐标</p></blockquote><p>使用 SpringDataRedis</p><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>  </pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>  </pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>  </pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><blockquote><p>配置文件</p></blockquote><ul><li>配置连接 redis 的数据，我这里配置的是我的云服务器上装的 Redis</li></ul><figure class="highlight yml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">spring</span><span class="token punctuation">:</span>  </pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token key atrule">redis</span><span class="token punctuation">:</span>  </pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token key atrule">host</span><span class="token punctuation">:</span> localhost  <span class="token comment"># 或者服务器上的</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6379</span>  </pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment">#password: root  </span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token key atrule">database</span><span class="token punctuation">:</span> <span class="token number">0</span> <span class="token comment">#操作的是 0 号数据库  </span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token key atrule">jedis</span><span class="token punctuation">:</span>  </pre></td></tr><tr><td data-num="8"></td><td><pre>      <span class="token comment">#Redis 连接池配置  </span></pre></td></tr><tr><td data-num="9"></td><td><pre>      <span class="token key atrule">pool</span><span class="token punctuation">:</span>  </pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token key atrule">max-active</span><span class="token punctuation">:</span> <span class="token number">8</span> <span class="token comment">#最大连接数  </span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token key atrule">max-wait</span><span class="token punctuation">:</span> 1ms <span class="token comment">#连接池最大阻塞等待时间  </span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token key atrule">max-idle</span><span class="token punctuation">:</span> <span class="token number">4</span> <span class="token comment">#连接池中的最大空闲连接  </span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token key atrule">min-idle</span><span class="token punctuation">:</span> <span class="token number">0</span> <span class="token comment">#连接池中的最小空闲连接</span></pre></td></tr></table></figure><blockquote><p>配置类</p></blockquote><ul><li>配置一下序列化器，方便我们在图形化界面中查看我们存入的数据，在 config 包下新建 RedisConfig 类</li><li>但是也可以不配置 RedisConfig，而是直接用 <code>SpringRedisConfig</code> ，它的默认序列化器就是 <code>StringRedisSerializer</code></li></ul><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Configuration</span>  </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisConfig</span> <span class="token keyword">extends</span> <span class="token class-name">CachingConfigurerSupport</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token annotation punctuation">@Bean</span>  </pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> <span class="token function">redisTemplate</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span> connectionFactory<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> redisTemplate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token comment">// 默认 key 序列化器为：JdkSerializationRedisSerializer  </span></pre></td></tr><tr><td data-num="7"></td><td><pre>        redisTemplate<span class="token punctuation">.</span><span class="token function">setKeySerializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="8"></td><td><pre>        redisTemplate<span class="token punctuation">.</span><span class="token function">setConnectionFactory</span><span class="token punctuation">(</span>connectionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>测试</p></blockquote><p>在测试类中测试，再次读取时有持久化的对象。但用 redis desktop 修改的数据无法反序列化回来，爷晕晕</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>zy</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="2"></td><td><pre>  </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>jupiter<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Test</span></span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">SpringBootTest</span></span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">RedisTemplate</span></span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">ValueOperations</span></span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span></span><span class="token class-name">GenericJackson2JsonRedisSerializer</span></span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span></span><span class="token class-name">RedisSerializer</span></span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span></span><span class="token class-name">StringRedisSerializer</span></span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="11"></td><td><pre>  </pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span></span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="13"></td><td><pre>  </pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token annotation punctuation">@SpringBootTest</span>  </pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">TestApplicationTests</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token annotation punctuation">@Autowired</span>  </pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token annotation punctuation">@Test</span>  </pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">void</span> <span class="token function">stringTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token comment">// 获取对象  </span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token class-name">ValueOperations</span> valueOperations <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token comment">// 设置 name 为 Hades  </span></pre></td></tr><tr><td data-num="25"></td><td><pre>        valueOperations<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span><span class="token string">"ZYK"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token class-name">String</span> name <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> valueOperations<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token comment">// 设置 age 为 9527，有效时间 10 秒  </span></pre></td></tr><tr><td data-num="29"></td><td><pre>        valueOperations<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"age"</span><span class="token punctuation">,</span> <span class="token string">"9527"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token class-name">String</span> age <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> valueOperations<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"age"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token comment">// 如果不存在，则设置 name 为 Kyle  </span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token class-name">Boolean</span> aBoolean <span class="token operator">=</span> valueOperations<span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"111"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>aBoolean<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>		<span class="token comment">// 注释掉上面除 valueOperations，再次测试读取数据</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span>valueOperations<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="39"></td><td><pre>  </pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>开发中能做什么呢？</p><ul><li>缓存短信<ul><li>替换掉 session，避免服务器的开销，因为还要存用户 id 之类的</li></ul></li><li>缓存商品信息<ul><li>比如用户的购物车里的，或者历史订单，这种显示固定内容的，避免反复查询</li><li>但要注意在其他 update、save、delete 等业务逻辑时要删除对应的 redis 数据，让其在执行查询业务的时候重新加载</li></ul></li><li>能放图片吗？<ul><li>能，基于 base64 编解码</li><li>&quot;字符串类型是 Redis 中最基本的数据类型，它能存储任何形式的字符串，包括二进制数据。你可以用其存储用户的邮箱、JSON 化的对象甚至是一张图片&quot;</li></ul></li></ul><h2 id="结合spring-cache"><a class="anchor" href="#结合spring-cache">#</a> 结合 spring cache</h2><ul><li>SpringCache 是一个框架，实现了基本注解的缓存功能，只需要简单的添加一个注解，就能实现缓存功能</li><li>SpringCache 提供了一层抽象，底层可以切换不同的 cache 实现，具体就是通过 CacheManager 接口来统一不同的缓存技术</li><li>针对不同的缓存技术，需要实现不同的 CacheManager</li></ul><table><thead><tr><th>CacheManger</th><th>描述</th></tr></thead><tbody><tr><td>EhCacheCacheManager</td><td>使用 EhCache 作为缓存技术</td></tr><tr><td>GuavaCacheManager</td><td>使用 Googke 的 GuavaCache 作为缓存技术</td></tr><tr><td>RedisCacheManager</td><td>使用 Redis 作为缓存技术</td></tr></tbody></table><h3 id="常用注解"><a class="anchor" href="#常用注解">#</a> 常用注解</h3><table><thead><tr><th>注解</th><th>说明</th></tr></thead><tbody><tr><td>@EnableCaching</td><td>开启缓存注解功能</td></tr><tr><td>@Cacheable</td><td>在方法执行前 spring 先查看缓存中是否有数据。如果有数据，则直接返回缓存数据；若没有数据，调用方法并将方法返回值放到缓存中</td></tr><tr><td>@CachePut</td><td>将方法的返回值放到缓存中</td></tr><tr><td>@CacheEvict</td><td>将一条或者多条数据从缓存中删除</td></tr></tbody></table><p><code>@Cacheable</code> 的作用主要针对方法配置，能够根据方法的请求参数对其结果进行缓存，其主要参数说明如下</p><table><thead><tr><th>注解</th><th>说明 &lt;img width=300/&gt;</th><th>举例</th></tr></thead><tbody><tr><td>value</td><td>缓存的名称，在 spring 配置文件中定义，必须指定至少一个</td><td>例如:@Cacheable (value=“mycache”) 或者 @Cacheable (value=(“cache7”, “cache2”]</td></tr><tr><td>key</td><td>缓存的 key，可以为空，如果指定要按照 SpEL 表达式编写，如果不指定，则缺省按照方法的所有参数进行组合</td><td>例如:@Cacheable (value=“testcache”,key=“#userName”)</td></tr><tr><td>condition</td><td>缓存的条件，可以为空，使用 SpEL 编写，返回 true 或者 false，只有为 true 才进行缓存</td><td>例如:@Cacheable (value=“testcache”,condition=“#userName.length ()&gt;2”)</td></tr></tbody></table><p><code>@CachEvict</code> 的作用主要针对方法配置，能够根据一定的条件对缓存进行清空</p><table><thead><tr><th>注解</th><th>说明 &lt;img width=300/&gt;</th><th>举例</th></tr></thead><tbody><tr><td>value</td><td>缓存的名称，在 spring 配置文件中定义，必须指定至少一个</td><td>例如:@Cacheable (value=“mycache”) 或者 @Cacheable (value={“cache1”, “cache2”]</td></tr><tr><td>key</td><td>缓存的 key，可以为空，如果指定要按照 SpEL 表达式编写，如果不指定，则缺省按照方法的所有参数进行组合</td><td>例如:@Cacheable (value=“testcache”,key=“#userName”)</td></tr><tr><td>condition</td><td>缓存的条件，可以为空，使用 SpEL 编写，返回 true 或者 false，只有为 true 才进行缓存</td><td>例如:@Cacheable (value=“testcache”,condition=“#userName.length ()&gt;2”)</td></tr><tr><td>allEntries</td><td>是否清空所有缓存内容，缺省为 false，如果指定为 true，则方法调用后将立即清空所有缓存</td><td>例如:@CachEvict (value=“testcache”,allEntries=true)</td></tr><tr><td>beforelnvocation</td><td>是否在方法执行前就清空，缺省为 false，如果指定为 true，则在方法还没有执行的时候就清空缓存，缺省情况下，如果方法执行抛出异常，则不会清空缓存</td><td>例如:@CachEvict (value=“testcache”, beforelnvocation=true)</td></tr></tbody></table><h3 id="使用"><a class="anchor" href="#使用">#</a> 使用</h3><blockquote><p>导入坐标</p></blockquote><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>  </pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>  </pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>  </pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>  </pre></td></tr><tr><td data-num="5"></td><td><pre>  </pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>  </pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>  </pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-cache<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>  </pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><blockquote><p>配置 application.yml</p></blockquote><figure class="highlight yml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">spring</span><span class="token punctuation">:</span>  </pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token key atrule">redis</span><span class="token punctuation">:</span>  </pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token key atrule">host</span><span class="token punctuation">:</span> 101.XXX.XXX.160 <span class="token comment"># 本地 localhost 或者 开启了 redis 的服务器的 ip  </span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token comment"># redis 服务设置的密码，不是服务器密码噢 </span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6379</span>  </pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token key atrule">database</span><span class="token punctuation">:</span> <span class="token number">0</span>  </pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">cache</span><span class="token punctuation">:</span>  </pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token key atrule">redis</span><span class="token punctuation">:</span>  </pre></td></tr><tr><td data-num="9"></td><td><pre>      <span class="token key atrule">time-to-live</span><span class="token punctuation">:</span> <span class="token number">3600000</span> <span class="token comment">#设置存活时间为一小时，如果不设置，则一直存活</span></pre></td></tr></table></figure><blockquote><p>application 添加 <code>@EnableCaching</code> 注解</p></blockquote><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Slf4j</span>  </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@SpringBootApplication</span>  </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token annotation punctuation">@ServletComponentScan</span>  </pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token annotation punctuation">@EnableTransactionManagement</span>  </pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token annotation punctuation">@EnableCaching</span>  <span class="token comment">// 开启缓存注解功能  </span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReggieApplication</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">ReggieApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="9"></td><td><pre>        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"项目 启动!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>方法处（多为处理查询请求）添加相应的注解</p></blockquote><p><code>@Cacheale</code> ，功能是：</p><ul><li>在方法执行前，Spring 先查看缓存中是否有数据；如果有数据，则直接返回缓存数据；若没有数据，调用方法并将方法返回值放到缓存中</li></ul><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/list"</span><span class="token punctuation">)</span>  </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@Cacheable</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"setmealCache"</span><span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token string">"#setmeal.categoryId + '_' + #setmeal.status"</span><span class="token punctuation">)</span>  </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Setmeal</span><span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token class-name">Setmeal</span> setmeal<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">// 条件构造器  </span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Setmeal</span><span class="token punctuation">></span></span> queryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">// 添加条件  </span></pre></td></tr><tr><td data-num="7"></td><td><pre>    queryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span>setmeal<span class="token punctuation">.</span><span class="token function">getCategoryId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">Setmeal</span><span class="token operator">::</span><span class="token function">getCategoryId</span><span class="token punctuation">,</span> setmeal<span class="token punctuation">.</span><span class="token function">getCategoryId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="8"></td><td><pre>    queryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span>setmeal<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">Setmeal</span><span class="token operator">::</span><span class="token function">getStatus</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token comment">// 排序  </span></pre></td></tr><tr><td data-num="10"></td><td><pre>    queryWrapper<span class="token punctuation">.</span><span class="token function">orderByDesc</span><span class="token punctuation">(</span><span class="token class-name">Setmeal</span><span class="token operator">::</span><span class="token function">getUpdateTime</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Setmeal</span><span class="token punctuation">></span></span> setmealList <span class="token operator">=</span> setmealService<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span>queryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>setmealList<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><code>@CacheEvict</code> 该注解的功能是：</p><ul><li>将一条或者多条数据从缓存中删除</li></ul><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@PostMapping</span>  </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// 设置 allEntries 为 true，清空缓存名称为 setmealCache 的所有缓存  </span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token annotation punctuation">@CacheEvict</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"setmealCache"</span><span class="token punctuation">,</span> allEntries <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>  </pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">SetmealDto</span> setmealDto<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="5"></td><td><pre>    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"套餐信息：&#123;&#125;"</span><span class="token punctuation">,</span> setmealDto<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="6"></td><td><pre>    setmealService<span class="token punctuation">.</span><span class="token function">saveWithDish</span><span class="token punctuation">(</span>setmealDto<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token string">"套餐添加成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><div class="note warning no-icon"><ul><li>要缓存的 JAVA 对象必须实现 <code>Serializable</code> 接口，因为 Spring 会先将对象序列化再存入 Redis，将缓存实体类继承 <code>Serializable</code></li><li>所以对于请求方法中返回的数据其封装类要添加 <code>implements Serializable</code></li><li>一般数据类都要这么写：</li></ul><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Data</span>  </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">&#125;</span></pre></td></tr></table></figure></div><h2 id="redis原理"><a class="anchor" href="#redis原理">#</a> redis 原理</h2><p>Redis 的 Java 客户端很多，官方推荐的有三种：Jedis、Lettuce、Redisson。Spring 对 Redis 客户端进行了整合，提供了 Spring Data Redis，在 Spring Boot 项目中还提供了对应的 Starter，即<strong> spring-boot-starter-data-redis</strong></p><p><strong>响应快速</strong>、 操作都是<strong>原子</strong>的，满足需要<strong>高并发、锁</strong>等业务。key 就是 string，value 支持 6 种数据类型：字符串 string、哈希 hash、列表 list（任务队列）、集合 set、可排序集合和基数</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 查看所有键值命令</span></pre></td></tr><tr><td data-num="2"></td><td><pre>keys * </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># vim 里面查找，i 插入，n 跳转到下一个，：wq 保存并退出，u 撤销一次修改，ps -ef 打印进程 | grep 查找 redis</span></pre></td></tr><tr><td data-num="4"></td><td><pre>/内容</pre></td></tr><tr><td data-num="5"></td><td><pre>-----------------------------------------------------------------linux</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># 开启</span></pre></td></tr><tr><td data-num="7"></td><td><pre>./redis-service</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment"># 连接</span></pre></td></tr><tr><td data-num="9"></td><td><pre>./redis-cli</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># 退出</span></pre></td></tr><tr><td data-num="11"></td><td><pre>redis-cli <span class="token parameter variable">-h</span> 你的IP地址 <span class="token parameter variable">-p</span> 你的redis端口号 <span class="token parameter variable">-a</span> 密码 shutdown，就可以退出了</pre></td></tr><tr><td data-num="12"></td><td><pre>----------------------------------------------------------------windows</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment"># 直接双击对应的服务 / 客户端就行</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment"># 默认没有密码校验、配置里可以选择 requispass</span></pre></td></tr></table></figure><h3 id="操作"><a class="anchor" href="#操作">#</a> 操作</h3><p>nil 相当于 null<br><img data-src="image-20240412200951427.png" alt=""></p><p>hash<br><img data-src="image-20240412201018703.png" alt=""></p><p><img data-src="image-20240412201105162.png" alt=""></p><p>spring Data Redis 中提供了一个高度封装的类：RedisTemplate，针对 iedis 客户端中大量 api 进行了归类封装，将同一类型操作封装为 operation 接口，具体分类如下:</p><ul><li>ValueOperations: 简单 K-V 操作</li><li>SetOperations: set 类型数据操作</li><li>ZSetOperations: zset 类型数据操作</li><li>HashOperations: 针对 map 类型的数据操作</li><li>ListOperations: 针对 list 类型的数据操作</li></ul><h3 id="原理"><a class="anchor" href="#原理">#</a> 原理</h3><p>缓存管理、持久化、哨兵和高可用、集群工作<br><strong>持久化方案</strong></p><blockquote><p>主节点不但负责数据读写，还负责把写命令同步给从节点。写命令发送过程是<em>异步完成</em>，主节点自身处理完写命令后直接返回给客户端，并不等待从节点复制完成</p></blockquote><p>RDB 模式：redis 中的 set 操作，在规定的周期内执行了指定的次数时，redis 会自动的将内存中的数据持久化到硬盘中。并且后缀名为.rdb。</p><ul><li>优点：使用单独子进程来进行持久化，主进程不会进行任何 IO 操作，保证了 redis 的高性能</li><li>缺点: RDB 是间隔一段时间进行持久化，如果持久化之间 redis 发生故障，会发生数据丢失。所以这种方式更适合数据要求不严谨的时候</li></ul><p>AOF 模式：Append-only file，将 “操作 + 数据” 以格式化指令的方式追加到操作日志文件的尾部，在 append 操作返回后 (已经写入到文件或者即将写入)，才进行实际的数据变更，“日志文件” 保存了历史所有的操作过程</p><p><img data-src="image-20240412201254575.png" alt=""></p><p><img data-src="image-20240412201310334.png" alt=""></p><p>集群分配，hash 映射，按性能分配映射多少，然后由主从保障不会掉线<br><img data-src="image-20240412201321516.png" alt=""></p><p><img data-src="image-20240412201351451.png" alt=""></p><h3 id="更新策略"><a class="anchor" href="#更新策略">#</a> 更新策略</h3><ol><li><p>内存淘汰策略<br>Redis 是一个基于内存的缓存系统，当内存空间不足时，就需要对一部分缓存数据进行淘汰，以释放内存空间给新的数据使用。Redis 提供了多种内存淘汰策略，如 LRU（最近最少使用）、LFU（最不常用）等。这些策略根据数据的访问频率或最近的使用时间决定哪些数据会被优先淘汰。例如，LRU 策略会优先淘汰最近很少使用的数据，以保留最常用的数据。</p></li><li><p>超时剔除策略<br>Redis 提供了设置缓存数据的过期时间，当缓存数据过期时，Redis 会自动将其删除。这种策略可以根据数据的有效期来进行缓存更新，当数据过期后，下一次访问时会触发缓存更新的逻辑，并从数据源中重新获取最新的数据。通过设置合适的过期时间，可以兼顾缓存的实时性和数据源的压力，但一旦数据过期，客户端可能会面临较长的等待时间。</p></li><li><p>主动更新策略<br>主动更新策略通过应用程序主动触发更新缓存的操作。这种策略通常在数据源发生变化时进行，如数据库更新、消息队列的消息到达等。应用程序接收到数据变更的事件后，可以先更新数据源，然后再强制更新缓存，以使得缓存和数据源保持一致。这种策略可以实现缓存的即时性，但需要合理地触发更新操作，以免频繁地更新缓存导致系统性能下降。</p></li></ol><p>总的来说：在实际应用场景中，可以根据业务需求和性能要求选择合适的缓存更新策略。内存淘汰策略适用于内存紧张的情况，超时剔除策略适用于对实时性要求较低的场景，主动更新策略适用于需要保持缓存数据和数据源一致性的场景。根据具体情况综合使用这些策略，可以优化系统性能、提高数据的访问效率。</p><ol start="4"><li><strong>删除缓存还是更新缓存？</strong></li></ol><ul><li>更新缓存：每次更新数据库都更新缓存，无效写操作较多</li><li>删除缓存：更新数据库时让缓存失效，查询时再更新缓存<br>假设我们每次操作数据库后，都操作缓存，但是中间如果没有人查询，那么这个更新动作实际上只有最后一次生效，中间的更新动作意义并不大，我们可以把缓存删除，等待再次查询时，将缓存中的数据加载出来</li></ul><ol start="5"><li><strong>如何保证缓存与数据库的操作的同时成功或失败？</strong></li></ol><ul><li>单体系统，将缓存与数据库操作放在一个事务</li><li>分布式系统，利用 TCC 等分布式事务方案</li></ul><ol start="6"><li><strong>先操作缓存还是先操作数据库？</strong><br>我们应当是先操作数据库，再删除缓存，原因在于，如果你选择先删除缓存，再操作数据库，在两个线程并发来访问时，假设线程 1 先来，他先把缓存删了，此时线程 2 过来，他查询缓存数据并不存在，此时他写入缓存，当他写入缓存后，线程 1 再执行更新动作时，实际上写入的就是旧的数据，新的数据被旧数据覆盖了。</li></ol><h3 id="淘汰"><a class="anchor" href="#淘汰">#</a> 淘汰</h3><p><strong>如果我们设置一批 key 只能存活 1 小时，那么 1 小时之后，redis 是怎么对这批数据进行删除的？</strong><br>答案：定期删数 + 惰性删除</p><ol><li><p>定期删除<br>指的是 redis 默认是每隔 100ms 就随机抽取一些设置了过期时间的 key，检查其是否过期，如果过期就删除。注意，这里可不是每隔 100ms 就遍历所有的设置过期时间的 key，那样就是一场性能上的灾难。实际上 redis 是每隔 100ms 随机抽取一些 key 来检查和删除的。</p></li><li><p>惰性删除<br>定期删除的问题是可能会导致很多过期 key 到了时间并没有被删除掉，那怎么办？所以还有惰性删除，也就是在查询某个 key 的时候，redis 会检查一下这个 key 如果设置了过期时间并且是否过期了，如果过期了就会在此时删除。<br>通过定期删除和惰性删除两种方式结合，保证过期的 key 一定会被删除</p></li></ol><ul><li>定期删除是为了节省内存</li><li>惰性删除是为了保证过期性</li></ul><p><strong>如果定期没删除，也没有查询，这样会导致大量过期的 key 堆积在内存里怎么办？</strong><br>答案：内存淘汰机制</p><ul><li>allkeys-lru：当内存不足以容纳新写入数据时，在键空间中，移除最近最少使用的 key。</li><li>volatile-lru：当内存不足以容纳新写入数据时，在设置了过期时间的键空间中，移除最近最少使用的 key。<br>上面都是基于<strong> LRU</strong> 算法：Least Recently Used，即<strong>最近最少使用</strong>，是一种常用的页面置换算法，选择最近最久未使用的页面予以淘汰。该算法赋予每个页面一个访问字段，用来记录一个页面自上次被访问以来所经历的时间 t，当须淘汰一个页面时，选择现有页面中其 t 值最大的，即最近最少使用的页面予以淘汰。</li></ul><p>还有<strong>随机</strong>和<strong> LFU</strong>（least frequently used (LFU) page-replacement algorithm）。即最<strong>不经常使用页置换算法</strong>，要求在页置换时置换引用计数最小的页，因为经常使用的页应该有一个较大的引用次数。但是有些页在开始时使用次数很多，但以后就不再使用，这类页将会长时间留在内存中，因此可以将引用计数寄存器定时右移一位，形成指数衰减的平均使用次数。</p><h3 id="qa"><a class="anchor" href="#qa">#</a> QA</h3><p><strong>为什么 redis cluster 至少需要 3 个主节点？</strong><br>因为故障检测时没有哨兵，需要超过半数的主节点都主观下线，该故障节点才会被视为客观下线。两个主节点，如果挂了一个，那么只剩一个无法达到超过半数的条件。这与哨兵模式不同，因为两个哨兵不一定会挂。</p><p><strong>复制数据延迟</strong><br>会有个延迟监听的外部监控程序</p><ol><li>监控程序会定期检查主从结点的复制偏移量 (6.3.6 的 info replication 那个图的两个值), 差值就是主从结点延迟的字节量</li><li>当延迟字节量过高的时候，比如说超过 10MB, 监控程序就会出发报警通知客户端从节点延迟过高。可以采用 Zookeeper 的监听机制实现客户端通知</li><li>客户端收到从节点延迟过高的通知之后，修改读命令路径到主节点或者其他从节点身上，当延迟恢复之后，再次通知客户端恢复从节点的读命令</li></ol><h1 id="mysql主从复制"><a class="anchor" href="#mysql主从复制">#</a> MySQL 主从复制</h1><ul><li><p>MySQL 主从复制是一个异步的复制过程，底层是基于 Mysql 数据库自带的二进制日志功能。就是一台或多台 NysQL 数据库（slave，即从库）从另一台 MySQL 数据库 (master，即主库）进行日志的复制然后再解析日志并应用到自身，最终实现从库的数据和主库的数据保持一致。MySQL 主从复制是 MySQL 数据库自带功能，无需借助第三方工具。</p></li><li><p>MySQL 复制过程分成三步:</p><ol><li><code>master</code> 将改变记录到二进制日志 ( <code>binary log</code> )</li><li><code>slave</code> 将 <code>master</code> 的 <code>binary log</code> 拷贝到它的中继日志 ( <code>relay log</code> )</li><li><code>slave</code> 重做中继日志中的事件，将改变应用到自己的数据库中</li></ol></li></ul><p><img data-src="image-20240326180113088.png" alt=""><br>更细的说应该是三个线程： <code>master（binlog dump thread）、slave（I/O thread 、SQL thread）</code> ，Master 一条线程和 Slave 中的两条线程。</p><ol><li><code>master（binlog dump thread）</code> 主要负责 Master 库中有数据更新的时候，会按照 <code>binlog</code> 格式，将更新的事件类型写入到主库的 <code>binlog</code> 文件中。</li><li>并且，Master 会创建 <code>log dump</code> 线程通知 Slave 主库中存在数据更新，这就是为什么主库的 binlog 日志一定要开启的原因。</li><li><code>I/O thread</code> 线程在 Slave 中创建，该线程用于请求 Master，Master 会返回 binlog 的名称以及当前数据更新的位置、binlog 文件位置的副本。</li><li>然后，将 <code>binlog</code> 保存在 <strong>「relay log（中继日志）」</strong> 中，中继日志也是记录数据更新的信息。</li><li>SQL 线程也是在 Slave 中创建的，当 Slave 检测到中继日志有更新，就会将更新的内容同步到 Slave 数据库中，这样就保证了主从的数据的同步。</li></ol><h2 id="配置"><a class="anchor" href="#配置">#</a> 配置</h2><h3 id="主库"><a class="anchor" href="#主库">#</a> 主库</h3><p>在配置文件 <code>/etc/my.cnf</code> 中</p><ul><li>找到 <code>[mysqld]</code> ，在下面插入两行</li></ul><blockquote><p>log_bin=mysql-bin #[必须] 启用二进制日志<br>server-id=1 #[必须] 服务器唯一 ID, 只需要确保其 id 是唯一的就好<br>binlog-do-db=sjk1_sjk2_sjk3 # 设置要复制的库，多个库用_连接</p></blockquote><ul><li>重启服务 <code>systemctl restart mysqld</code></li><li>连接数据库，执行 <code>grant replication slave on *.* to 'zy'@'%' identified by '123456';</code><ul><li>上面的 SQL 的作用是创建一个用户 <code>zy</code> , 密码为 <code>123456</code> ，并且给 <code>zy</code> 用户授予 <code>replication slave</code> 权限，用于建立复制时所需要用到的用户权限，也就是 <code>slave</code> 必须被 <code>master</code> 授权具有该权限的用户，才能通过该用户复制，这是因为主库和从库之间需要互相通信，处于安全考虑，只有通过验证的从库才能从主库中读取二进制数据</li></ul></li><li><code>show master status;</code> 打印状态，主要是 File 和 Position 的值</li></ul><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>+------------------+----------+--------------+------------------+-------------------+  </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token operator">|</span> File             <span class="token operator">|</span> Position <span class="token operator">|</span> Binlog_Do_DB <span class="token operator">|</span> Binlog_Ignore_DB <span class="token operator">|</span> Executed_Gtid_Set <span class="token operator">|</span>  </pre></td></tr><tr><td data-num="3"></td><td><pre>+------------------+----------+--------------+------------------+-------------------+  </pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token operator">|</span> mysql-bin.000005 <span class="token operator">|</span>      <span class="token number">154</span> <span class="token operator">|</span>              <span class="token operator">|</span>                  <span class="token operator">|</span>                   <span class="token operator">|</span>  </pre></td></tr><tr><td data-num="5"></td><td><pre>+------------------+----------+--------------+------------------+-------------------+</pre></td></tr></table></figure><h3 id="从库"><a class="anchor" href="#从库">#</a> 从库</h3><ul><li>同样的在配置文件插入 id， <code>server-id=2</code> ，与主库不同</li><li>重启后连接 MySQL 控制台<pre><code class="language-SQL">change master to master_host='ip',master_user='zy',master_password='123456',master_log_file='mysql-bin.000005',master_log_pos=154;  # 配置
</code></pre></li></ul><p>sstart slave; # 开启<br>```</p><ul><li>查询从库状态 <code>show slave status;</code> ，这 2 个选项对应则成功</li></ul><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>Slave_IO_Running: Yes  </pre></td></tr><tr><td data-num="2"></td><td><pre>Slave_SQL_Running: Yes</pre></td></tr></table></figure><h2 id="结合sharding-jdbc"><a class="anchor" href="#结合sharding-jdbc">#</a> 结合 Sharding-JDBC</h2><ul><li>Sharding-JDBC 定位为轻量级的 JAVA 框架，在 JAVA 的 JDBC 层提供额外的服务，它使得客户端直连数据库，以 jar 包形式提供服务，无需额外部署和依赖，可理解为增强版的 JDBC 驱动，完全兼容 JDBC 和各种 ORM 框架</li><li>使用 Sharding-JDBC 可以在程序中轻松的实现数据库读写分离<ul><li>适用于任何基于 JDBC 的 ORM 框架</li><li>支持任何第三方的数据库连接池</li><li>支持任意实现 JDBC 规范的数据库</li></ul></li><li>使用 Sharding-JDBC 框架的步骤<ol><li>导入对应的 maven 坐标</li><li>在配置文件中配置读写分离规则</li><li>在配置文件中配置允许 bean 定义覆盖配置项</li></ol></li></ul><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>  </pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.shardingsphere<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>  </pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>sharding-jdbc-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>  </pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>4.0.0-RC1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>  </pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><figure class="highlight yml"><figcaption data-lang="YAML"><span>title:application.yml</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">spring</span><span class="token punctuation">:</span>  </pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token key atrule">shardingsphere</span><span class="token punctuation">:</span>  </pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token key atrule">datasource</span><span class="token punctuation">:</span>  </pre></td></tr><tr><td data-num="4"></td><td><pre>      <span class="token key atrule">names</span><span class="token punctuation">:</span>  </pre></td></tr><tr><td data-num="5"></td><td><pre>        master<span class="token punctuation">,</span>slave  </pre></td></tr><tr><td data-num="6"></td><td><pre>      <span class="token key atrule">master</span><span class="token punctuation">:</span>  </pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token key atrule">type</span><span class="token punctuation">:</span> com.alibaba.druid.pool.DruidDataSource  </pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.cj.jdbc.Driver  </pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>3306/springboot_work</pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token key atrule">username</span><span class="token punctuation">:</span> root  </pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token number">123456</span>  </pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token key atrule">slave</span><span class="token punctuation">:</span>  </pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token key atrule">type</span><span class="token punctuation">:</span> com.alibaba.druid.pool.DruidDataSource  </pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.cj.jdbc.Driver  </pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//47.115.211.251<span class="token punctuation">:</span>3306/test</pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token key atrule">username</span><span class="token punctuation">:</span> root  </pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token number">123456</span>  </pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token key atrule">masterslave</span><span class="token punctuation">:</span>  </pre></td></tr><tr><td data-num="19"></td><td><pre>      <span class="token comment">## 读写分离配置 </span></pre></td></tr><tr><td data-num="20"></td><td><pre>      <span class="token key atrule">load-balance-algorithm-type</span><span class="token punctuation">:</span> round_robin  </pre></td></tr><tr><td data-num="21"></td><td><pre>      <span class="token comment">## 最终的数据源名称  </span></pre></td></tr><tr><td data-num="22"></td><td><pre>      <span class="token key atrule">name</span><span class="token punctuation">:</span> dataSource</pre></td></tr><tr><td data-num="23"></td><td><pre>      <span class="token comment">## 主库数据源名称  </span></pre></td></tr><tr><td data-num="24"></td><td><pre>      <span class="token key atrule">master-data-source-name</span><span class="token punctuation">:</span> master  </pre></td></tr><tr><td data-num="25"></td><td><pre>      <span class="token comment">## 从库数据源名称列表，多个逗号分隔  </span></pre></td></tr><tr><td data-num="26"></td><td><pre>      <span class="token key atrule">slave-data-source-names</span><span class="token punctuation">:</span> slave</pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token key atrule">props</span><span class="token punctuation">:</span>  </pre></td></tr><tr><td data-num="28"></td><td><pre>      <span class="token key atrule">sql</span><span class="token punctuation">:</span>  </pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token key atrule">show</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment">#开启 SQL 显示，默认 false  </span></pre></td></tr><tr><td data-num="30"></td><td><pre>  <span class="token key atrule">main</span><span class="token punctuation">:</span>  </pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token key atrule">allow-bean-definition-overriding</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr></table></figure><h1 id="njinx"><a class="anchor" href="#njinx">#</a> Njinx</h1><p>Nginx 是一款轻量级的<em> web 服务器 / 反向代理服务器</em>及电子邮件 (IMAP/POP3) 代理服务器。其特点是占有<strong>内存少，并发能力强</strong>，事实上 nginx 的并发能力在同类型的网页服务器中表现较好，中国大陆使用 nginx 的网站有：百度、京东、新浪、网易、腾讯、淘宝等。</p><p>下载安装类似 redis，下载、解压，然后 make</p><h2 id="目录结构"><a class="anchor" href="#目录结构">#</a> 目录结构</h2><ul><li>重点目录 / 文件:<ul><li>conf/nginx.conf<ul><li>nginx 配置文件</li></ul></li><li>html<ul><li>存放静态文件 (html、css、Js 等)</li></ul></li><li>logs<ul><li>日志目录，存放日志文件</li></ul></li><li>sbin/nginx<ul><li>二进制文件，用于启动、停止 Nginx 服务</li></ul></li></ul></li><li>文件目录树状图如下</li></ul><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token builtin class-name">.</span>  </pre></td></tr><tr><td data-num="2"></td><td><pre>├── conf                        <span class="token operator">&lt;</span>-- Nginx配置  </pre></td></tr><tr><td data-num="3"></td><td><pre>│   ├── fastcgi.conf  </pre></td></tr><tr><td data-num="4"></td><td><pre>│   ├── fastcgi.conf.default  </pre></td></tr><tr><td data-num="5"></td><td><pre>│   ├── fastcgi_params  </pre></td></tr><tr><td data-num="6"></td><td><pre>│   ├── fastcgi_params.default  </pre></td></tr><tr><td data-num="7"></td><td><pre>│   ├── koi-utf  </pre></td></tr><tr><td data-num="8"></td><td><pre>│   ├── koi-win  </pre></td></tr><tr><td data-num="9"></td><td><pre>│   ├── mime.types  </pre></td></tr><tr><td data-num="10"></td><td><pre>│   ├── mime.types.default  </pre></td></tr><tr><td data-num="11"></td><td><pre>│   ├── nginx.conf              <span class="token operator">&lt;</span>-- 主要的配置文件 </pre></td></tr><tr><td data-num="12"></td><td><pre>│   ├── nginx.conf.default  </pre></td></tr><tr><td data-num="13"></td><td><pre>│   ├── scgi_params  </pre></td></tr><tr><td data-num="14"></td><td><pre>│   ├── scgi_params.default  </pre></td></tr><tr><td data-num="15"></td><td><pre>│   ├── uwsgi_params  </pre></td></tr><tr><td data-num="16"></td><td><pre>│   ├── uwsgi_params.default  </pre></td></tr><tr><td data-num="17"></td><td><pre>│   └── win-utf  </pre></td></tr><tr><td data-num="18"></td><td><pre>├── html                        <span class="token operator">&lt;</span>-- 存放静态文件，部署项目就要将静态文件放在这</pre></td></tr><tr><td data-num="19"></td><td><pre>│   ├── 50x.html          </pre></td></tr><tr><td data-num="20"></td><td><pre>│   └── index.html              <span class="token operator">&lt;</span>-- 提供的默认的页面  </pre></td></tr><tr><td data-num="21"></td><td><pre>├── logs                        <span class="token operator">&lt;</span>-- 日志目录，新装的Nginx，所以还没有日志文件  </pre></td></tr><tr><td data-num="22"></td><td><pre>└── sbin                          </pre></td></tr><tr><td data-num="23"></td><td><pre>└── nginx                       <span class="token operator">&lt;</span>-- 这个文件也经常操作</pre></td></tr></table></figure><h2 id="nginxconf"><a class="anchor" href="#nginxconf">#</a> nginx.conf</h2><ul><li>Nginx 配置文件 (conf/nginx.conf) 整体分为三部分<ul><li>全局块 和 Nginx 运行相关的全局配置</li><li>events 块 和网络连接相关的配置</li><li>http 块 代理、缓存、日志记录、虚拟主机配置<ul><li>http 全局块</li><li>Server 块<ul><li>Server 全局块</li><li>location 块</li></ul></li></ul></li></ul></li></ul><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 工作进程的数量</span></pre></td></tr><tr><td data-num="2"></td><td><pre>worker_processes  <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>events <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    worker_connections  <span class="token number">1024</span><span class="token punctuation">;</span> <span class="token comment"># 每个工作进程连接数</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>http <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    include       mime.types<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    default_type  application/octet-stream<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token comment"># 日志格式</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    log_format  access  <span class="token string">'$remote_addr - $remote_user [$time_local] $host "$request" '</span></pre></td></tr><tr><td data-num="13"></td><td><pre>                  <span class="token string">'$status $body_bytes_sent "$http_referer" '</span></pre></td></tr><tr><td data-num="14"></td><td><pre>                  <span class="token string">'"$http_user_agent" "$http_x_forwarded_for" "$clientip"'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    access_log  /srv/log/nginx/access.log  access<span class="token punctuation">;</span> <span class="token comment"># 日志输出目录</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token function">gzip</span>  on<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    sendfile  on<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token comment"># 链接超时时间，自动断开</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    keepalive_timeout  <span class="token number">60</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token comment"># 虚拟主机</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    server <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        listen       <span class="token number">8080</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        server_name  localhost<span class="token punctuation">;</span> <span class="token comment"># 浏览器访问域名</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>        charset utf-8<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        access_log  logs/localhost.access.log  access<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token comment"># 路由</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        location / <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>            root   www<span class="token punctuation">;</span> <span class="token comment"># 访问根目录</span></pre></td></tr><tr><td data-num="33"></td><td><pre>            index  index.html index.htm<span class="token punctuation">;</span> <span class="token comment"># 入口文件</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token comment"># 引入其他的配置文件</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    include servers/*<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>复制代码</pre></td></tr></table></figure><h2 id="nginx命令"><a class="anchor" href="#nginx命令">#</a> Nginx 命令</h2><ul><li><p>查看版本</p><ul><li>进入 sbin 目录，输入 <code>./nginx -v</code></li></ul></li><li><p>检查配置文件正确性</p><ul><li>进入 sbin 目录，输入 <code>./nginx -t</code> ，如果有错误会报错，而且也会记日志</li></ul></li></ul><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>nginx: the configuration <span class="token function">file</span> /usr/local/nginx/conf/nginx.conf syntax is ok  <span class="token operator">&lt;</span>brnginx: configuration <span class="token function">file</span> /usr/local/nginx/conf/nginx.conf <span class="token builtin class-name">test</span> is successful</pre></td></tr></table></figure><ul><li><p>启动和停止</p><ul><li>进入 sbin 目录，输入 <code>./nginx</code> ，启动完成后查看进程</li><li>如果想停止 Nginx 服务，输入 <code>./nginx -s stop</code> ，停止服务后再次</li><li><code>ps aux | grep nginx</code> 查看进程</li></ul></li><li><p>重新加载配置文件</p><ul><li>当修改 Nginx 配置文件后，需要重新加载才能生效，可以使用下面命令重新加载配置文件： <code>./nginx -s reload</code> 。</li></ul></li><li><p>上面的所有命令，都需要我们在 sbin 目录下才能运行，比较麻烦，所以我们可以将 Nginx 的二进制文件配置到环境变量中，这样无论我们在哪个目录下，都能使用上面的命令</p><ul><li>使用 <code>vim /etc/profile</code> 命令打开配置文件，添加后保存并退出</li></ul><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># PATH=$JAVA_HOME/bin:$PATH  </span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span>/usr/local/nginx/sbin:<span class="token variable">$JAVA_HOME</span>/bin:<span class="token environment constant">$PATH</span></pre></td></tr></table></figure><ul><li>之后重新加载系统配置文件，使用 <code>source /etc/profile</code> 命令，然后我们在任意位置输入 <code>nginx</code> 即可启动服务， <code>nginx -s stop</code> 即可停止服务</li></ul></li><li><p>查看自己 IP，启动服务后，浏览器输入 ip 地址就可以访问 Nginx 的默认页面</p><ul><li><code>ip addr</code></li></ul></li></ul><h2 id="资源代理"><a class="anchor" href="#资源代理">#</a> 资源代理</h2><p>静态资源复制到 njinx/html/ 下，在 nginx.conf 的 http {...}/https 中</p><pre><code class="language-conf">server &#123;  
    listen 82;  # 监听端口
    server_name ip1;   # 服务器名称


	# 路由 
	location / &#123; 
		root www; # 访问根目录 
		index index.html index.htm; # 入口文件 
		proxy_pass http://ip2  # 要代理的
	&#125;
&#125;
</code></pre><p>也就是访问 ip1 的 82，实际访问到了 ip2<br>也可以针对不同的资源 <code>192.168.17.129:9001/edu/</code> 和 <code>192.168.17.129:9001/vod/</code> 下的资源被分别代理到了 <code>http://127.0.0.1:8080</code> 和 <code>http://127.0.0.1:8081</code></p><pre><code class="language-conf">server &#123;
	 listen       9001;
	 server_name  192.168.17.129;
	
	 location ~ /edu/ &#123;
	  proxy_pass  http://127.0.0.1:8080
	 &#125;
	
	 location ~ /vod/ &#123;
	  proxy_pass  http://127.0.0.1:8081
	 &#125;
&#125;
</code></pre><h2 id="负载均衡"><a class="anchor" href="#负载均衡">#</a> 负载均衡</h2><p>即是多个被代理的放在 <code>upstream name &#123;&#125;</code> 中。 <code>sever</code> 的 <code>proxy_pass</code> 是前面的 name</p><pre><code class="language-conf">upstream targetServer&#123;  
    server 192.168.238.132;  
    server 101.XXX.XXX.160;  
&#125;  
server &#123;  
    listen       82;  
    server_name  localhost;  
  
    location / &#123;  
        proxy_pass http://targetServer;  
    &#125;  
&#125;
</code></pre><p>此时默认轮询。加权，ip 哈希，热备份示意：</p><pre><code class="language-conf">upstream mysvr &#123; 
    server 127.0.0.1:7878 weight=1;
    server 192.168.10.121:3333 weight=2;
&#125;

upstream mysvr &#123; 
    server 127.0.0.1:7878; 
    server 192.168.10.121:3333;
    ip_hash;
&#125;

upstream mysvr &#123; 
    server 127.0.0.1:7878; 
    server 192.168.10.121:3333 backup;  #热备     
&#125;
</code></pre><p>还有其他策略和配置，见官方文档</p><h1 id="秒杀问题redis缓存-锁-mq"><a class="anchor" href="#秒杀问题redis缓存-锁-mq">#</a> 秒杀问题（redis 缓存、锁、mq）</h1><p>可以涉及到这些<img data-src="https://picx.zhimg.com/80/v2-21812d2c30bafd44844c02903d823c35_720w.webp?source=1def8aca" alt=""></p><h2 id="后端设计"><a class="anchor" href="#后端设计">#</a> 后端设计</h2><p>对于使用优惠劵秒杀下单，或者说下单逻辑本应如此，那就是先修改数据库，再生成订单，并且绑定成事务执行。<br><img data-src="https://img-blog.csdnimg.cn/img_convert/56311f396cdc472e1a012638b23ba1a2.png" alt=""><br>也就是这套逻辑需要写在一起</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@Transactional</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">seckillVoucher</span><span class="token punctuation">(</span><span class="token class-name">Long</span> voucherId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token doc-comment comment">/**</span></pre></td></tr><tr><td data-num="5"></td><td><pre>     * 秒杀基本实现一：</pre></td></tr><tr><td data-num="6"></td><td><pre>     *  1.查询优惠卷</pre></td></tr><tr><td data-num="7"></td><td><pre>     *  2.判断秒杀是否开始</pre></td></tr><tr><td data-num="8"></td><td><pre>     *  3.判断是否结束</pre></td></tr><tr><td data-num="9"></td><td><pre>     *  4.判断库存是否充足</pre></td></tr><tr><td data-num="10"></td><td><pre>     *  5.扣减库存</pre></td></tr><tr><td data-num="11"></td><td><pre>     *  6.创建订单</pre></td></tr><tr><td data-num="12"></td><td><pre>     */</pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token class-name">SeckillVoucher</span> voucher <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getBeginTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAfter</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token comment">// 尚未开始</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"秒杀尚未开始!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isBefore</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"秒杀已经结束!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"库存不足！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token keyword">boolean</span> success <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="29"></td><td><pre>            <span class="token punctuation">.</span><span class="token function">setSql</span><span class="token punctuation">(</span><span class="token string">"stock = stock - 1"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="30"></td><td><pre>            <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"voucher_id"</span><span class="token punctuation">,</span> voucherId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"库存不足！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token class-name">VoucherOrder</span> voucherOrder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VoucherOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token keyword">long</span> orderId <span class="token operator">=</span> redisIdWorker<span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token string">"order"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    voucherOrder<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    voucherOrder<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre></pre></td></tr><tr><td data-num="43"></td><td><pre>    voucherOrder<span class="token punctuation">.</span><span class="token function">setVoucherId</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token function">save</span><span class="token punctuation">(</span>voucherOrder<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="超卖问题"><a class="anchor" href="#超卖问题">#</a> 超卖问题</h2><p>当多线程没实现数据安全的时候就会<br><img data-src="https://img-blog.csdnimg.cn/img_convert/ddbf205ace647e4424aeab0dd012bcb1.png" alt=""></p><h3 id="redis-缓存"><a class="anchor" href="#redis-缓存">#</a> redis 缓存</h3><p>redisson?<span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTU5NjY5Ny9hcnRpY2xlL2RldGFpbHMvMTIzNTUwNzQ4">https://blog.csdn.net/weixin_51596697/article/details/123550748</span></p><ul><li><p>在系统初始化时，将商品的库存数量加载到 Redis 缓存中；</p></li><li><p>接收到秒杀请求时，在 Redis 中进行预减库存，当 Redis 中的库存不足时，直接返回秒杀失败，否则继续进行第 3 步</p><ul><li><code>if(redisClient.incrby(productId, -1)&lt;0) &#123;return 0;&#125;</code> redis 的 incrby 是原子操作</li><li>但高并发场景中，有多个请求同时扣减库存，大多数请求的 incrby 操作之后，结果都会小于 0。出现负数，不会超卖，但负值太大的话，万一要回退库存时，就会导致库存不准。</li></ul></li><li><p>将请求放入异步队列中，返回正在排队中；</p></li><li><p>服务端异步队列将请求出队，出队成功的请求可以生成秒杀订单，减少数据库库存，返回秒杀订单详情。</p></li><li><p>当后台订单创建成功之后可以通过 websocket 向用户发送一个秒杀成功通知。前端以此来判断是否秒杀成功，秒杀成功则进入秒杀订单详情，否则秒杀失败。</p></li><li><p>初始缓存包含：商品 id、商品名称、规格属性、库存等信息，同时数据库中也要有相关信息，毕竟缓存并不完全可靠。</p></li></ul><p><img data-src="https://picx.zhimg.com/80/v2-289ab91d8390caaf29362452a4c7ceac_720w.webp?source=1def8aca" alt=""></p><ul><li>然而可能存在<em><strong>缓存击穿</strong></em>的问题，高并发压力依旧给到了数据库就寄了。这就需要加锁，最好使用分布式锁。<br><img data-src="https://pic1.zhimg.com/80/v2-5a3e62d649dd8ccc5f33585c8e225824_720w.webp?source=1def8aca" alt=""><br>当然，针对这种情况，最好在项目启动之前，先把缓存进行预热。即事先把所有的商品，同步到缓存中，这样商品基本都能直接从缓存中获取到，就不会出现缓存击穿的问题了。</li></ul><p>是不是上面加锁这一步可以不需要了？</p><p>表面上看起来，确实可以不需要。但如果缓存中设置的过期时间不对，缓存提前过期了，或者缓存被不小心删除了，如果不加速同样可能出现缓存击穿。<br>其实这里加锁，相当于买了一份保险。</p><ul><li>如果有大量的请求传入的商品 id，在缓存中和数据库中都不存在，这些请求不就每次都会穿透过缓存，而直接访问数据库了，也就是<em><strong>缓存穿透</strong></em><br>可以选择过滤器（id 是否在数据库而 放行），但又会有过滤器同步问题。另一个取巧就是不存在的商品 id 访问时也缓存一个不存在缓存，下次在遇到就直接拒绝</li></ul><p>上面回退问题可以用 lua 脚本，是能够保证原子性的，它跟 redis 一起配合使用，能够完美解决上面的问题。有段非常经典的代码：</p><figure class="highlight lua"><figcaption data-lang="lua"></figcaption><table><tr><td data-num="1"></td><td><pre>StringBuilder lua <span class="token operator">=</span> new <span class="token function">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre>lua<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"if (redis.call('exists', KEYS[1]) == 1) then"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre>lua<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">" local stock = tonumber(redis.call('get', KEYS[1]));"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="4"></td><td><pre>lua<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">" if (stock == -1) then"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="5"></td><td><pre>lua<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">" return 1;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="6"></td><td><pre>lua<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">" end;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="7"></td><td><pre>lua<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">" if (stock > 0) then"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="8"></td><td><pre>lua<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">" redis.call('incrby', KEYS[1], -1);"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="9"></td><td><pre>lua<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">" return stock;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="10"></td><td><pre>lua<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">" end;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="11"></td><td><pre>lua<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">" return 0;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="12"></td><td><pre>lua<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"end;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="13"></td><td><pre>lua<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"return -1;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><ol><li>先判断商品 id 是否存在，如果不存在则直接返回。</li><li>获取该商品 id 的库存，判断库存如果是 - 1，则直接返回，表示不限制库存。</li><li>如果库存大于 0，则扣减库存。</li><li>如果库存等于 0，是直接返回，表示库存不足。</li></ol><h3 id="乐观锁"><a class="anchor" href="#乐观锁">#</a> （乐观）锁</h3><p>为了效率，优先选乐观锁<br><img data-src="https://img-blog.csdnimg.cn/img_convert/4ca790f297672c18649f97f24d93f4e5.png" alt=""><br>基于数据库本身，要做的是调整 SQL 语句，比如原本的查询操作和更新操作不是原子性的两个操作，逻辑先后来说是：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">int</span> stock <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">getStockById</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span>stock <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token keyword">int</span> count <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">updateStock</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token keyword">if</span><span class="token punctuation">(</span>count <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token function">addOrder</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>调整为条件更新：</p><pre><code class="language-SQL">update product set stock=stock-1 where id=product and stock &gt; 0;
</code></pre><h4 id="版本号实现"><a class="anchor" href="#版本号实现">#</a> 版本号实现</h4><p>每当数据做一次修改，版本号加 1, 所以判断一个数据有没有被修改过就看它的版本有没有变化过<br><img data-src="https://img-blog.csdnimg.cn/img_convert/bce6265bfd80eed0d0dadca7930856ee.png" alt=""></p><h4 id="cas实现"><a class="anchor" href="#cas实现">#</a> CAS 实现</h4><p>Compare and Swap，即比较再交换。</p><p>也就是不再判断库存有没有被修改过了，每次都去比较看库存是否大于 0<br><img data-src="https://img-blog.csdnimg.cn/img_convert/f2aec4af75f0aacfbf3a9afa08964d72.png" alt=""></p><p>乐观锁参考代码：</p><figure class="highlight java"><figcaption data-lang="java"><span>title:look</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@Transactional</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">seckillVoucher</span><span class="token punctuation">(</span><span class="token class-name">Long</span> voucherId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token doc-comment comment">/**</span></pre></td></tr><tr><td data-num="5"></td><td><pre>     * 秒杀基本实现二：</pre></td></tr><tr><td data-num="6"></td><td><pre>     *  1.查询优惠卷</pre></td></tr><tr><td data-num="7"></td><td><pre>     *  2.判断秒杀是否开始</pre></td></tr><tr><td data-num="8"></td><td><pre>     *  3.判断是否结束</pre></td></tr><tr><td data-num="9"></td><td><pre>     *  4.判断库存是否充足</pre></td></tr><tr><td data-num="10"></td><td><pre>     *  5.扣减库存（乐观锁解决超卖问题）</pre></td></tr><tr><td data-num="11"></td><td><pre>     *  6.创建订单</pre></td></tr><tr><td data-num="12"></td><td><pre>     */</pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token class-name">SeckillVoucher</span> voucher <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getBeginTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAfter</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token comment">// 尚未开始</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"秒杀尚未开始!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isBefore</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"秒杀已经结束!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"库存不足！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token keyword">boolean</span> success <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="29"></td><td><pre>            <span class="token punctuation">.</span><span class="token function">setSql</span><span class="token punctuation">(</span><span class="token string">"stock = stock - 1"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="30"></td><td><pre>            <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"voucher_id"</span><span class="token punctuation">,</span> voucherId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">gt</span><span class="token punctuation">(</span><span class="token string">"stock"</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="31"></td><td><pre>            <span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"库存不足！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token class-name">VoucherOrder</span> voucherOrder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VoucherOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token keyword">long</span> orderId <span class="token operator">=</span> redisIdWorker<span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token string">"order"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    voucherOrder<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    voucherOrder<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre></pre></td></tr><tr><td data-num="44"></td><td><pre>    voucherOrder<span class="token punctuation">.</span><span class="token function">setVoucherId</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token function">save</span><span class="token punctuation">(</span>voucherOrder<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="分布式锁"><a class="anchor" href="#分布式锁">#</a> 分布式锁</h4><p>集群下的线程并发安全问题：加锁的原理就是在 <code>JVM内部维护了一个锁监视器</code> ，如果是集群模式下的话那就是多个 JVM，悲观锁就失效了</p><ul><li>利用分布式锁，保证同一时刻只有一个线程进行读库存 --- 修改库存操作。</li></ul><p>缺点：同一个商品多用户同时下单的时候，会基于分布式锁串行化处理，导致没法同时处理同一个商品的大量下单的请求，并发处理能力较弱。</p><p><img data-src="https://img-blog.csdnimg.cn/img_convert/9c77127f28cf3db4c4fc9ab34855ccee.png" alt=""></p><h3 id="mq异步处理"><a class="anchor" href="#mq异步处理">#</a> mq 异步处理</h3><p><span class="exturl" data-url="aHR0cHM6Ly93d3cuemhpaHUuY29tL3F1ZXN0aW9uLzQwMjI0NjkyNi9hbnN3ZXIvMjQ1MzM1MjA1OQ==">参考</span><br>下单、秒杀、支付中，下单和支付功能实际并发量很小，真正并发量大的是秒杀功能。<br>所以，我们在设计秒杀系统时，有必要把下单和支付功能从秒杀的主流程中拆分出来，特别是下单功能要做成 mq) 异步处理的。而支付功能，比如支付宝支付，是业务场景本身保证的异步。</p><p>要注意：</p><h4 id="消息丢失问题"><a class="anchor" href="#消息丢失问题">#</a> 消息丢失问题</h4><p>秒杀成功了，往 mq 发送下单消息的时候，有可能会失败。原因有很多，比如：网络问题、broker 挂了、mq 服务端磁盘问题等。这些情况，都可能会造成消息丢失。</p><p>加 表 + 重试<br><img data-src="https://picx.zhimg.com/80/v2-441957d6ee6fb1fe545312c13adeac78_720w.webp?source=1def8aca" alt=""><br>发送 mq 消息之前，先把该条消息写入消息发送表，初始状态是待处理，然后再发送 mq 消息。消费者消费消息时，处理完业务逻辑之后，再回调生产者的一个接口，修改消息状态为已处理。<br>重试可以定时任务，job 每隔一段时间去查询消息发送表中状态为待处理的数据，然后重新发送 mq 消息。</p><p>消息丢失属于比较常见的问题。一般有生产端丢失、MQ 服务丢失、消费端丢失等三种情况。针对各种情况应对方式也不一样。</p><ol><li><p>生产端丢失的解决方案主要有</p><ul><li>开启 confirm 模式，生产者收到 MQ 发回的 confirm 确认之后，再进行消息删除，否则消息重推。</li><li>生产者端消息保存的数据库，由后台定时程序异步推送，收到 confirm 确认则认为成功，否则消息重推，重推多次均未成功，则认为发送失败。</li></ul></li><li><p>MQ 服务丢失则主要是开启消息持久化，让消息及时保存到磁盘。</p></li><li><p>消费端消息丢失则关闭自动 ack 确认，消息消费成功后手动发送 ack 确认。消息消费失败，则重新消费。</p></li></ol><h5 id="rocketmq如何保证消息不丢失"><a class="anchor" href="#rocketmq如何保证消息不丢失">#</a> Rocketmq 如何保证消息不丢失</h5><p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21lc2VyODgvYXJ0aWNsZS9kZXRhaWxzLzEwODA2MjU4Mw==">参考</span><br><img data-src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly91cGxvYWQtaW1hZ2VzLmppYW5zaHUuaW8vdXBsb2FkX2ltYWdlcy8yMjQyMTgyOS01ODhiNjNiYTM5ZTc3YjQ2LnBuZw?x-oss-process=image/format,png" alt=""><br>我们将消息的整体处理阶段分为 3 个阶段进行分析：</p><ul><li>Producer 发送消息阶段</li><li>Broker 处理消息阶段</li><li>Consumer 消费消息阶段</li></ul><h6 id="producer发送消息阶段"><a class="anchor" href="#producer发送消息阶段">#</a> Producer 发送消息阶段</h6><p>发送消息阶段涉及到 Producer 到 broker 的网络通信，因此丢失消息的几率一定会有，那 RocketMQ 在此阶段用了哪些手段保证消息不丢失了（或者说降低丢失的可能性）。</p><blockquote><p>手段一：提供 SYNC 的发送消息方式，等待 broker 处理结果。</p></blockquote><p>RocketMQ 提供了 3 种发送消息方式，分别是：</p><ul><li>同步发送：Producer 向 broker 发送消息，阻塞当前线程等待 broker 响应 发送结果。</li><li>异步发送：Producer 首先构建一个向 broker 发送消息的任务，把该任务提交给线程池，等执行完该任务时，回调用户自定义的回调函数，执行处理结果。</li><li>Oneway 发送：Oneway 方式只负责发送请求，不等待应答，Producer 只负责把请求发出去，而不处理响应结果。</li></ul><p>我们在调用 producer.send 方法时，不指定回调方法，则默认采用同步发送消息的方式，这也是丢失几率最小的一种发送方式。</p><blockquote><p>手段二：发送消息如果失败或者超时，则重新发送（<span class="exturl" data-url="aHR0cHM6Ly9kYW5kZWxpb25jbG91ZC5jbi9hcnRpY2xlL2RldGFpbHMvMTYxMzM4OTE2NjU5NzYwMzMzMA==">RocketMQ Producer 重试机制</span>）。</p></blockquote><ul><li>发送重试源码如下，本质其实就是一个 for 循环，当发送消息发生异常的时候重新循环发送。默认重试 2 次，重试次数可以通过 producer 指定。</li></ul><blockquote><p>手段三：broker 提供多 master 模式，即使某台 broker 宕机了，保证消息可以投递到另外一台正常的 broker 上。</p></blockquote><ul><li>如果 broker 只有一个节点，则 broker 宕机了，即使 producer 有重试机制，也没用，因此利用多主模式，当某台 broker 宕机了，换一台 broker 进行投递。</li></ul><p>总结</p><ul><li>producer 消息发送方式虽然有 3 种，但为了减小丢失消息的可能性尽量采用同步的发送方式，同步等待发送结果，利用<strong>同步发送 + 重试机制 + 多个 master 节点</strong>，尽可能减小消息丢失的可能性。</li></ul><h6 id="broker处理消息阶段"><a class="anchor" href="#broker处理消息阶段">#</a> Broker 处理消息阶段</h6><blockquote><p>手段四：提供同步刷盘的策略</p></blockquote><p><code>FlushDiskType (SYNC_FLUSH, //同步刷盘 ASYNC_FLUSH//异步刷盘（默认）)</code><br>当消息投递到 broker 之后，会先存到 page cache，然后根据 broker 设置的刷盘策略是否立即刷盘，也就是如果刷盘策略为异步，broker 并不会等待消息落盘就会返回 producer 成功，也就是说当 broker 所在的服务器突然宕机，则会丢失部分页的消息。</p><blockquote><p>手段五：提供主从模式，同时主从支持<strong>同步双写</strong></p></blockquote><p>即使 broker 设置了同步刷盘，如果主 broker 磁盘损坏，也是会导致消息丢失。 因此可以给 broker 指定 slave，同时设置 master 为 SYNC_MASTER，然后将 slave 设置为同步刷盘策略。</p><p>此模式下，producer 每发送一条消息，都会等消息投递到 master 和 slave 都落盘成功了，broker 才会当作消息投递成功，保证休息不丢失。</p><p>总结</p><ul><li>在 broker 端，消息丢失的可能性主要在于刷盘策略和同步机制</li><li>RocketMQ 默认 broker 的刷盘策略为异步刷盘，如果有主从，同步策略也默认的是异步同步，这样子可以提高 broker 处理消息的效率，但是会有丢失的可能性。因此可以通过同步刷盘策略 + 同步 slave 策略 + 主从的方式解决丢失消息的可能。</li></ul><h6 id="consumer消费消息阶段"><a class="anchor" href="#consumer消费消息阶段">#</a> Consumer 消费消息阶段</h6><blockquote><p>手段六：consumer 默认提供的是 At least Once 机制</p></blockquote><p>从 producer 投递消息到 broker，即使前面这些过程保证了消息正常持久化，但如果 consumer 消费消息没有消费到也不能理解为消息绝对的可靠。因此 RockerMQ 默认提供了 At least Once 机制保证消息可靠消费。</p><p><strong>何为 At least Once？</strong></p><p>Consumer 先 pull 消息到本地，消费完成后，才向服务器返回 ack。</p><p>通常消费消息的 ack 机制一般分为两种思路：</p><ul><li>先提交后消费</li><li>先消费，消费成功后再提交</li></ul><p>思路一可以解决重复消费的问题但是会丢失消息，因此 Rocketmq 默认实现的是思路二，由各自 consumer 业务方保证幂等来解决重复消费问题。</p><blockquote><p>手段七：消费消息重试机制</p></blockquote><p>当消费消息失败了，如果不提供重试消息的能力，则也不能算完全的可靠消费，因此 RocketMQ 本身提供了重新消费消息的能力。</p><p>总结</p><ul><li>consumer 端要保证消费消息的可靠性，主要通过 At least Once + 消费重试机制保证。</li></ul><h4 id="重复消费问题"><a class="anchor" href="#重复消费问题">#</a> 重复消费问题</h4><p>本来消费者消费消息时，在 ack 应答的时候，如果网络超时，本身就可能会消费重复的消息。加上消息发送者增加了重试机制，会导致消费者重复消息的概率增大。</p><p>增加消息处理表<br><img data-src="https://picx.zhimg.com/80/v2-14693f27d2ed657bd9c027bd1f79eb44_720w.webp?source=1def8aca" alt=""></p><p>消费者读到消息之后，先判断一下消息处理表，是否存在该消息，如果存在，表示是重复消费，则直接返回。如果不存在，则进行下单操作，接着将该消息写入消息处理表中，再返回。</p><p>有个比较关键的点是：下单和写消息处理表，要放在同一个事务中，保证原子操作。</p><h5 id="rocketmq如何保证消息不被重复消费"><a class="anchor" href="#rocketmq如何保证消息不被重复消费">#</a> Rocketmq 如何保证消息不被重复消费</h5><p>首先，比如 RabbitMQ、RocketMQ、Kafka，都有可能会出现消息重复消费的问题，正常。因为这问题通常不是 MQ 自己保证的，是由我们开发来保证的。挑一个 Kafka 来举个例子，说说怎么重复消费吧。</p><p>Kafka 实际上有个 offset 的概念，就是每个消息写进去，都有一个 offset，代表消息的序号，然后 consumer 消费了数据之后，每隔一段时间（定时定期），会把自己消费过的消息的 offset 提交一下，表示 “我已经消费过了，下次我要是重启啥的，你就让我继续从上次消费到的 offset 来继续消费吧”。</p><p>但是凡事总有意外，比如我们之前生产经常遇到的，就是你有时候重启系统，看你怎么重启了，如果碰到点着急的，直接 kill 进程了，再重启。这会导致 consumer 有些消息处理了，但是没来得及提交 offset，尴尬了。重启之后，少数消息会再次消费一次。</p><p>有这么个场景。数据 1/2/3 依次进入 kafka，kafka 会给这三条数据每条分配一个 offset，代表这条数据的序号，我们就假设分配的 offset 依次是 152/153/154。消费者从 kafka 去消费的时候，也是按照这个顺序去消费。假如当消费者消费了 offset=153 的这条数据，刚准备去提交 offset 到 zookeeper，此时消费者进程被重启了。那么此时消费过的数据 1/2 的 offset 并没有提交，kafka 也就不知道你已经消费了 offset=153 这条数据。那么重启之后，消费者会找 kafka 说，嘿，哥儿们，你给我接着把上次我消费到的那个地方后面的数据继续给我传递过来。由于之前的 offset 没有提交成功，那么数据 1/2 会再次传过来，如果此时消费者没有去重的话，那么就会导致重复消费。</p><blockquote><p>关键在于保证<strong>幂等性</strong>。一个执行操作，无论执行多少次，产生的效果和返回的结果都是一样的</p></blockquote><p>其实还是得结合业务来思考，我这里给几个思路：</p><p>比如你拿个数据要写库，你先根据主键查一下，如果这数据都有了，你就别插入了，update 一下好吧。</p><p>比如你是写 Redis，那没问题了，反正每次都是 set，天然幂等性。</p><p>比如你不是上面两个场景，那做的稍微复杂一点，你需要让生产者发送每条数据的时候，里面加一个全局唯一的 id，类似订单 id 之类的东西，然后你这里消费到了之后，先根据这个 id 去比如 Redis 里查一下，之前消费过吗？如果没有消费过，你就处理，然后这个 id 写 Redis（上面的表也是类似的思想）。如果消费过了，那你就别处理了，保证别重复处理相同的消息即可。</p><p>比如基于数据库的唯一键来保证重复数据不会重复插入多条。因为有唯一键约束了，重复数据插入只会报错，不会导致数据库中出现脏数据。</p><p>大致基于这两个角度出发</p><ul><li>状态判断法：消费者消费数据后把消费数据记录在 redis 中，下次消费时先到 redis 中查看是否存在该消息，存在则表示消息已经消费过，直接丢弃消息。</li><li>业务判断法：通常数据消费后都需要插入到数据库中，使用数据库的唯一性约束防止重复消费。每次消费直接尝试插入数据，如果提示唯一性字段重复，则直接丢失消息。一般都是通过这个业务判断的方法就可以简单高效地避免消息的重复处理了</li></ul><h4 id="垃圾消息问题"><a class="anchor" href="#垃圾消息问题">#</a> 垃圾消息问题</h4><p>如果出现了消息消费失败的情况。比如：由于某些原因，消息消费者下单一直失败，一直不能回调状态变更接口，这样 job 会不停的重试发消息。最后，会产生大量的垃圾消息。<br><img data-src="https://picx.zhimg.com/80/v2-a22df75b85cb518ae528d181431825e8_720w.webp?source=1def8aca" alt=""><br>每次在 job 重试时，需要先判断一下消息发送表中该消息的发送次数是否达到最大限制，如果达到了，则直接返回并清理。如果没有达到，则将次数加 1，然后发送消息。</p><p>这样如果出现异常，只会产生少量的垃圾消息，不会影响到正常的业务</p><h4 id="延迟消费问题"><a class="anchor" href="#延迟消费问题">#</a> 延迟消费问题</h4><p>通常情况下，如果用户秒杀成功了，下单之后，在 15 分钟之内还未完成支付的话，该订单会被自动取消，回退库存。<br>那么，在 15 分钟内未完成支付，订单被自动取消的功能，要如何实现呢？<br>我们首先想到的可能是 job，因为它比较简单。<br>但 job 有个问题，需要每隔一段时间处理一次，实时性不太好。</p><p>还有更好的方案？<br>答：使用延迟队列。<br><img data-src="https://picx.zhimg.com/80/v2-39934c1b3c74dfdf48a5a1b41c2d511e_720w.webp?source=1def8aca" alt=""><br>下单时消息生产者会先生成订单，此时状态为待支付，然后会向延迟队列中发一条消息。达到了延迟时间，消息消费者读取消息之后，会查询该订单的状态是否为待支付。如果是待支付状态，则会更新订单状态为取消状态。如果不是待支付状态，说明该订单已经支付过了，则直接返回。</p><p>还有个关键点，用户完成支付之后，会修改订单状态为已支付。<br>下单时消息生产者会先生成订单，此时状态为待支付，然后会向延迟队列中发一条消息。达到了延迟时间，消息消费者读取消息之后，会查询该订单的状态是否为待支付。如果是待支付状态，则会更新订单状态为取消状态。如果不是待支付状态，说明该订单已经支付过了，则直接返回。</p><h3 id="事务"><a class="anchor" href="#事务">#</a> 事务</h3><p>最简单想到和实现，但每次查询都需要竞争同一把锁，接口性能急剧下降，增加服务器压力</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre>	<span class="token keyword">int</span> stock <span class="token operator">=</span> redisClient<span class="token punctuation">.</span><span class="token function">queryStock</span><span class="token punctuation">(</span>productId<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token keyword">if</span><span class="token punctuation">(</span>stock <span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="4"></td><td><pre>		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="6"></td><td><pre>	redisClient<span class="token punctuation">.</span><span class="token function">incrby</span><span class="token punctuation">(</span>productId<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="7"></td><td><pre>	redisClient<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>productId<span class="token punctuation">,</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="少卖问题"><a class="anchor" href="#少卖问题">#</a> 少卖问题</h2><p>少卖可能出现的原因有</p><ol><li>redis 预扣减库存成功，但是执行真正的下单逻辑失败了，且库存没有回滚；</li><li>用户订单提交成功了，但是超时没有支付，且超时后活动已结束或者超时后没有回滚库存；</li><li>用户排队成功了，但是排队下单请求消息发送到 MQ 失败了，或者 MQ 消息丢了，或者消费者弄丢了数据。</li></ol><h3 id="解决方案"><a class="anchor" href="#解决方案">#</a> 解决方案</h3><ol><li>异步下单失败后，要即时回滚 redis 中的 sku 库存</li><li>缩短支付时间，或者修改秒杀流程：先支付再确认订单；超时未支付后即时回滚 redis 中的 sku 库存</li><li>解决 MQ 消息丢失问题（见 mq 异步处理中的<a href="#%E6%B6%88%E6%81%AF%E4%B8%A2%E5%A4%B1%E9%97%AE%E9%A2%98">小节</a>）</li></ol><h1 id="mq"><a class="anchor" href="#mq">#</a> MQ</h1><h2 id="常见的消息队列"><a class="anchor" href="#常见的消息队列">#</a> 常见的消息队列</h2><h3 id="activemq"><a class="anchor" href="#activemq">#</a> ActiveMQ</h3><p><strong>优点</strong></p><ul><li>单机吞吐量：万级</li><li>topic 数量都吞吐量的影响：</li><li>时效性：ms 级</li><li>可用性：高，基于主从架构实现高可用性</li><li>消息可靠性：有较低的概率丢失数据</li><li>功能支持：MQ 领域的功能极其完备</li></ul><p><strong>缺点:</strong></p><ul><li>官方社区现在对 ActiveMQ 5.x 维护越来越少，较少在大规模吞吐的场景中使用。</li></ul><h3 id="kafka"><a class="anchor" href="#kafka">#</a> Kafka</h3><p>号称大数据的杀手锏，谈到大数据领域内的消息传输，则绕不开 Kafka，这款为大数据而生的消息中间件，以其百万级 TPS 的吞吐量名声大噪，迅速成为大数据领域的宠儿，在数据采集、传输、存储的过程中发挥着举足轻重的作用。</p><p>Apache Kafka 它最初由 LinkedIn 公司基于独特的设计实现为一个分布式的提交日志系统 (a distributed commit log)，之后成为 Apache 项目的一部分。</p><p>目前已经被 LinkedIn，Uber, Twitter, Netflix 等大公司所采纳。</p><p><strong>优点</strong></p><ul><li>性能卓越，单机写入 TPS 约在百万条 / 秒，最大的优点，就是吞吐量高。</li><li>时效性：ms 级</li><li>可用性：非常高，kafka 是分布式的，一个数据多个副本，少数机器宕机，不会丢失数据，不会导致不可用</li><li>消费者采用 Pull 方式获取消息，消息有序，通过控制能够保证所有消息被消费且仅被消费一次；</li><li>有优秀的第三方 Kafka Web 管理界面 Kafka-Manager；</li><li>在日志领域比较成熟，被多家公司和多个开源项目使用；</li><li>功能支持：功能较为简单，主要支持简单的 MQ 功能，在大数据领域的实时计算以及日志采集被大规模使用</li></ul><p><strong>缺点：</strong></p><ol><li>Kafka 单机超过 64 个队列 / 分区，Load 会发生明显的飙高现象，队列越多，load 越高，发送消息响应时间变长</li><li>使用短轮询方式，实时性取决于轮询间隔时间；</li><li>消费失败不支持重试；</li><li>支持消息顺序，但是一台代理宕机后，就会产生消息乱序；</li><li>社区更新较慢；</li></ol><h3 id="rabbitmq"><a class="anchor" href="#rabbitmq">#</a> RabbitMQ</h3><p>RabbitMQ 2007 年发布，是一个在 AMQP (高级消息队列协议) 基础上完成的，可复用的企业消息系统，是当前最主流的消息中间件之一。</p><p><strong>优点</strong>：</p><ol><li><p>由于 erlang 语言的特性，mq 性能较好，高并发；</p></li><li><p>吞吐量到万级，MQ 功能比较完备</p></li><li><p>健壮、稳定、易用、跨平台、支持多种语言、文档齐全；</p></li><li><p>开源提供的管理界面非常棒，用起来很好用</p></li><li><p>社区活跃度高；</p></li></ol><p><strong>缺点：</strong></p><ol><li>erlang 开发，很难去看懂源码，基本职能依赖于开源社区的快速维护和修复 bug，不利于做二次开发和维护。</li><li>RabbitMQ 确实吞吐量会低一些，这是因为他做的实现机制比较重。</li><li>需要学习比较复杂的接口和协议，学习和维护成本较高。</li></ol><h3 id="rocketmq"><a class="anchor" href="#rocketmq">#</a> RocketMQ</h3><p>RocketMQ 出自 阿里公司的开源产品，用 Java 语言实现，在设计时参考了 Kafka，并做出了自己的一些改进。</p><p>RocketMQ 在阿里集团被广泛应用在订单，交易，充值，流计算，消息推送，日志流式处理，binglog 分发等场景。</p><p><strong>优点：</strong></p><ol><li>单机吞吐量：十万级</li><li>可用性：非常高，分布式架构</li><li>消息可靠性：经过参数优化配置，消息可以做到 0 丢失</li><li>功能支持：MQ 功能较为完善，还是分布式的，扩展性好</li><li>支持 10 亿级别的消息堆积，不会因为堆积导致性能下降</li><li>源码是 java，我们可以自己阅读源码，定制自己公司的 MQ，可以掌控</li></ol><p><strong>缺点：</strong></p><ol><li>支持的客户端语言不多，目前是 java 及 c++，其中 c++ 不成熟；</li><li>社区活跃度一般</li><li>没有在 mq 核心中去实现 JMS 等接口，有些系统要迁移需要修改大量代码</li></ol><h2 id="选择"><a class="anchor" href="#选择">#</a> 选择</h2><p><strong>1.Kafka</strong><br>Kafka 主要特点是基于 Pull 的模式来处理消息消费，追求高吞吐量，一开始的目的就是用于日志收集和传输，适合产生大量数据的互联网服务的数据收集业务。</p><p>大型公司建议可以选用，如果有日志采集功能，肯定是首选 kafka 了。</p><p><strong>2.RocketMQ</strong></p><p>天生为金融互联网领域而生，对于可靠性要求很高的场景，尤其是电商里面的订单扣款，以及业务削峰，在大量交易涌入时，后端可能无法及时处理的情况。</p><p>RoketMQ 在稳定性上可能更值得信赖，这些业务场景在阿里双 11 已经经历了多次考验，如果你的业务有上述并发场景，建议可以选择 RocketMQ。</p><p><strong>3.RabbitMQ</strong></p><p>RabbitMQ : 结合 erlang 语言本身的并发优势，性能较好，社区活跃度也比较高，但是不利于做二次开发和维护。不过，RabbitMQ 的社区十分活跃，可以解决开发过程中遇到的 bug。</p><p>如果你的数据量没有那么大，小公司优先选择功能比较完备的 RabbitMQ。</p><h2 id="为什么用rocketmq"><a class="anchor" href="#为什么用rocketmq">#</a> 为什么用 RocketMQ？</h2><p>从功能上来说，Kafka 不支持广播、延时、事务、消息轨迹，以及顺序消息时，如果一台 Broker 宕机后，会产生消息乱序，不支持基于 Broker 的 Tag 消息过滤，网上说当 Kafka 分区多的时候，性能会下降。从语言上来说， Kafka 使用 Java 和 Scala，针对一些框架原理查看以及二开不便利。</p><p>从使用场景 Kafka 更侧重于通过流处理引擎实现<strong>实时数据流处理</strong>，在大数据流处理和实时数据分析方面使用较多（高并发、日志处理）。 RocketMQ 的设计更注重实现<strong>高可用和多功能</strong>的消息服务，在国内较多公司应用较为广泛。</p><p>综合比对，Kafka 的优势在于性能高，而 RocketMQ 的功能和业务场景更贴合国内公司，所以使用也较多。</p><p>Kafka 可以广播，新版本也开始支持事务性消息，只是不支持<strong>延时</strong>。</p><p>这么问主要是问他们的主要区别的，Kafka 在数据吞吐上是远超 rocketmq 的，但是它的 topic 很多的情况下，性能又远低于 rocketmq。基于这种情况 kafka 多用于处理海量的日志，历史数据等体量庞大的数据集合体，这样在个体数据庞大的情况下使用的 topic 点更少；rocketmq 有着更加严谨的检查和规则，所以它更适合分散式的短消息和小数据，这也得于它的 topic 算法和规划，即使有成千上万个 topic 点，性能下降并不多。</p><h2 id="深入rocketmq"><a class="anchor" href="#深入rocketmq">#</a> 深入 RocketMQ</h2><p><img data-src="https://img-blog.csdnimg.cn/img_convert/010d6da2edd0764240381793eb56466c.png" alt=""></p><p>RocketMQ 分布式集群是在 Broker 中引入了主从框架，通过 Master 和 Slave 的配合达到高可用性（brokerId 的值为 0 表明这个 Brocker 是 Master，大于 0 表明这个 Brocker 是 Slave，还有 BrokerRole 参数）。监督管理它们的 Server，有点像 Redis 的哨兵机制？</p><ul><li><p>Master 角色的 Brocker 支持读和写，Slave 角色的 Brocker 仅支持读</p><ul><li>也即是 Producer 只能和 Master 角色的 Broker 连接写入消息</li><li>而 Consumer 可以连接 Master 角色的 Brocker, 也可以连接 Slave 觉得的 Brocker 来读取消息</li></ul></li><li><p>消息消费高可用</p><ul><li>在 Consumer 的配置文件中，并不需要设置是从 Master 读还是从 Slave 读</li><li>当 Master 不可用或者繁忙的时候，Consumer 会被自动切换从 Slave 读</li></ul></li><li><p>消息发送高可用</p></li><li><p>消息的主从复制</p><ul><li>如果一个 Brocker 组有 Master 和 Slave，消息需要从 Master 复制到 Slave 上，有同步和异步两种方式</li><li>同步复制方式等 Master 和 Slave 均写 成功后反馈给客户端写成功状态。在同步复制方式下，如果 Master 出现故障，Slave 上有全部的备份数据，容易恢复，但是同步复制会增大数据写入迟缓，降低系统吞吐量。</li><li>异步复制方式是只要 Master 写成功 即可反馈给客户端写成功状态。在异步复制方式下，系统拥有较低的延迟和较高的吞吐量，但是如果 Master 出了故障，有些数据因为没有被写入 Slave，有可能会丢失</li><li>通过 BrockerRole 参数：ASYNC_MASTER，SYNC_MASTER，SLAVE 设置</li></ul></li></ul><p>更多参数</p><ul><li><p>Topic（主题）：Topic 是消息的分类，在 RocketMQ 中，生产者将消息发送到特定的 Topic，消费者则从特定的 Topic 中订阅消息。一个 Topic 可以有多个生产者和消费者，它们可以并行地发送和接收消息。</p></li><li><p>Queue（队列）：Queue 是消息的存储结构，每个 Topic 下面会有多个 Queue。RocketMQ 会将同一个 Topic 下的消息平均分配到各个 Queue 中，这样可以提高消息的并发处理能力。消费者从 Queue 中拉取并消费消息。</p></li><li><p>其中 queue 就是来源于数据结构的 FIFO 队列。而 Topic 是个抽象的概念，每个 Topic 底层对应 N 个 queue，而数据也真实存在 queue 上的</p></li><li><p>在 RocketMQ 中，如果你想要保证一个消息只被一个 Consumer 消费，你可以使用 RocketMQ 的消费者组（Consumer Group）的概念。</p><ul><li>消费者组是一组共享同一个消息队列的消费者，它们可以并行地消费消息，但是同一个消息只会被组中的一个消费者消费。RocketMQ 会保证同一个消费者组中的消费者不会消费到重复的消息。</li></ul></li><li><p>每个 Broker 可以存储多个 Topic 的消息，每个 Topic 的消息也可以分片存储于不同的 Broker。MessageQueue 用于存储消息的物理地址，每个 Topic 中的消息地址存储于多个 MessageQueue 中。ConsumerGroup 由多个 Consumer 实例构成。</p></li></ul><p>整体流程：<br><img data-src="image-20240329203230897.png" alt=""></p><div class="note warning no-icon"><p>问：RocketMQ 一个消费组内订阅同一个主题不同的 TAG 为什么会丢消息？<br>答：<strong>和消息队列负载机制有关</strong></p><ul><li>在 RocketMQ 中使用集群模式消费时，同一个消费组中的多个消费者共同完成主题中的队列的消费，即一个消费者只会分配到其中某几个队列，并且同一时间，一个队列只会分配给一个消费者<br><img data-src="https://pic1.zhimg.com/80/v2-df9f806108165dcd05cc537c4ad94a04_720w.webp" alt=""></li><li>其问题的核心关键是，同一个 tag 会分布在不同的队列中，但消费者 C1 分配到的队列为 q0,q1，q0,q1 中有 taga 和 tagb 的消息，但 tagb 的消息会被消费者 C1 过滤，但这部分消息却不会被 C2 消费，造成了消息丢失。<br><mark><strong>所以在 RocketMQ 中，一个消费组内的所有消费这，其订阅关系必须保持一致。</strong></mark></li></ul></div><h2 id="实现案例rocketmqspringboot"><a class="anchor" href="#实现案例rocketmqspringboot">#</a> 实现案例（RocketMQ+Springboot）</h2><p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2NzM3ODAzL2FydGljbGUvZGV0YWlscy8xMTIyNjEzNTI=">参考</span> 、<span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQyMzQ3NjE2L2FydGljbGUvZGV0YWlscy8xMTk5MzA0ODM=">RabbitMQ 参考</span></p><h3 id="五种工作模式"><a class="anchor" href="#五种工作模式">#</a> 五种工作模式</h3><p>五种工作模式是一种迭代关系：</p><ol><li>比如简单模式是一对一</li><li>那我有两个甚至多个消费者怎么办，这就有了工作队列模式一对多</li><li>现在我觉得消费者太多，队列太少不够用，于是就引进多个队列，对应不同的消费者，这就有了发布订阅模式</li><li>现在我只想给其中一个消费者的消息队列发消息，其他的不发怎么办，于是就是有 Routing 路由模式</li><li>但是问题又来了，我现在想要某一种的消息类型都发到某个队列中去，路由模式一一对应太严苛了，怎么办？就有了通配符 (主题) 模式。</li></ol><h3 id="第零步环境设置"><a class="anchor" href="#第零步环境设置">#</a> 第零步：环境设置</h3><p>安装略过，在 win 上测试了下<br>在 bin 目录下，启动 nameserver：<br><code>start mqnamesrv.cmd</code><br>启动 broker 并指定 nameserver<br><code>start mqbroker.cmd -n 127.0.0.1:9876 autoCreateTopicEnable=true</code><br>关闭则是<br><code>mqshutdown namesrv</code> 和 <code>mqshutdown broker</code></p><div class="note info no-icon"><p>tips：错误：找不到或无法加载主类</p><ul><li>编辑 runbroker.cmd</li><li><code>set CLASSPATH=.;%BASE_DIR%conf;%CLASSPATH%</code> 给 <strong>%CLASSPATH%</strong> 加上 英文换引号，如下：</li><li><code>set CLASSPATH=.;%BASE_DIR%conf;&quot;%CLASSPATH%&quot;</code></li></ul></div><p>都成功如图所示：<br><img data-src="image-20240327203621083.png" alt=""><br>测试：<br>启动消费者</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token builtin class-name">set</span> <span class="token assign-left variable">NAMESRV_ADDR</span><span class="token operator">=</span>localhost:9876  </pre></td></tr><tr><td data-num="2"></td><td><pre>tools.cmd org.apache.rocketmq.example.quickstart.Consumer</pre></td></tr></table></figure><p>启动生产者</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token builtin class-name">set</span> <span class="token assign-left variable">NAMESRV_ADDR</span><span class="token operator">=</span>localhost:9876  </pre></td></tr><tr><td data-num="2"></td><td><pre>tools.cmd org.apache.rocketmq.example.quickstart.Producer</pre></td></tr></table></figure><p>当生产者启动之后，会发送 1000 个消息，然后自动推出，当退出结束时会返回 true。同时消费者接受到消息则成功</p><h3 id="第一步引入maven依赖和配置"><a class="anchor" href="#第一步引入maven依赖和配置">#</a> 第一步：引入 maven 依赖和配置</h3><p>在 pom.xml 中加入以下依赖（这里用的 2.0.4 版本，不算太老，完全够用，新的 2.x 版本在事务消息那块代码有小小改动）</p><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.rocketmq<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>rocketmq-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.0.4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">&lt;!-- 还有其它需要的 jar 包自由引入（注：fastjson 不要使用低于 1.2.60 版本，会有安全漏洞） --></span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>fastjson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.2.62<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment">&lt;!--        @Slf4j 的 --></span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><p>在 application.yml 中添加以下配置</p><figure class="highlight yml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">rocketmq</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token key atrule">name-server</span><span class="token punctuation">:</span> ip<span class="token punctuation">:</span>port <span class="token comment"># MQ 服务的 host 地址</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token key atrule">producer</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token key atrule">group</span><span class="token punctuation">:</span> Pro_Group <span class="token comment"># 必须指定 group</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token key atrule">send-message-timeout</span><span class="token punctuation">:</span> <span class="token number">3000</span> <span class="token comment"># 消息发送超时时长，默认 3s</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token key atrule">retry-times-when-send-failed</span><span class="token punctuation">:</span> <span class="token number">3</span> <span class="token comment"># 同步发送消息失败重试次数，默认 2</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token key atrule">retry-times-when-send-async-failed</span><span class="token punctuation">:</span> <span class="token number">3</span> <span class="token comment"># 异步发送消息失败重试次数，默认 2</span></pre></td></tr></table></figure><h3 id="第二步编写生产者"><a class="anchor" href="#第二步编写生产者">#</a> 第二步：编写生产者</h3><p>新建 MQProducerService 类</p><figure class="highlight java"><figcaption data-lang="java"><span>title:MQProducerService</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Slf4j</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@Component</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MQProducerService</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;rocketmq.producer.send-message-timeout&#125;"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">Integer</span> messageTimeOut<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>	<span class="token comment">// 建议正常规模项目统一用一个 TOPIC</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> topic <span class="token operator">=</span> <span class="token string">"RLT_TEST_TOPIC"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    </pre></td></tr><tr><td data-num="11"></td><td><pre>	<span class="token comment">// 直接注入使用，用于发送消息到 broker 服务器</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token annotation punctuation">@Autowired</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">RocketMQTemplate</span> rocketMQTemplate<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>	<span class="token doc-comment comment">/**</span></pre></td></tr><tr><td data-num="16"></td><td><pre>     * 普通发送（这里的参数对象User可以随意定义，可以发送个对象，也可以是字符串等）</pre></td></tr><tr><td data-num="17"></td><td><pre>     */</pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        rocketMQTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span>topic <span class="token operator">+</span> <span class="token string">":tag1"</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment">//        rocketMQTemplate.send (topic + ":tag1", MessageBuilder.withPayload (user).build ()); // 等价于上面一行</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token doc-comment comment">/**</span></pre></td></tr><tr><td data-num="24"></td><td><pre>     * 发送同步消息（阻塞当前线程，等待broker响应发送结果，这样不太容易丢失消息）</pre></td></tr><tr><td data-num="25"></td><td><pre>     * （msgBody也可以是对象，sendResult为返回的发送结果）</pre></td></tr><tr><td data-num="26"></td><td><pre>     */</pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">SendResult</span> <span class="token function">sendMsg</span><span class="token punctuation">(</span><span class="token class-name">String</span> msgBody<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token class-name">SendResult</span> sendResult <span class="token operator">=</span> rocketMQTemplate<span class="token punctuation">.</span><span class="token function">syncSend</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> <span class="token class-name">MessageBuilder</span><span class="token punctuation">.</span><span class="token function">withPayload</span><span class="token punctuation">(</span>msgBody<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"【sendMsg】sendResult=&#123;&#125;"</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>sendResult<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token keyword">return</span> sendResult<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>	<span class="token doc-comment comment">/**</span></pre></td></tr><tr><td data-num="34"></td><td><pre>     * 发送异步消息（通过线程池执行发送到broker的消息任务，执行完后回调：在SendCallback中可处理相关成功失败时的逻辑）</pre></td></tr><tr><td data-num="35"></td><td><pre>     * （适合对响应时间敏感的业务场景）</pre></td></tr><tr><td data-num="36"></td><td><pre>     */</pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendAsyncMsg</span><span class="token punctuation">(</span><span class="token class-name">String</span> msgBody<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        rocketMQTemplate<span class="token punctuation">.</span><span class="token function">asyncSend</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> <span class="token class-name">MessageBuilder</span><span class="token punctuation">.</span><span class="token function">withPayload</span><span class="token punctuation">(</span>msgBody<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SendCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>            <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="40"></td><td><pre>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onSuccess</span><span class="token punctuation">(</span><span class="token class-name">SendResult</span> sendResult<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>                <span class="token comment">// 处理消息发送成功逻辑</span></pre></td></tr><tr><td data-num="42"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>            <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="44"></td><td><pre>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onException</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>                <span class="token comment">// 处理消息发送异常逻辑</span></pre></td></tr><tr><td data-num="46"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>    </pre></td></tr><tr><td data-num="50"></td><td><pre>	<span class="token doc-comment comment">/**</span></pre></td></tr><tr><td data-num="51"></td><td><pre>     * 发送延时消息（上面的发送同步消息，delayLevel的值就为0，因为不延时）</pre></td></tr><tr><td data-num="52"></td><td><pre>     * 在start版本中 延时消息一共分为18个等级分别为：1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h</pre></td></tr><tr><td data-num="53"></td><td><pre>     */</pre></td></tr><tr><td data-num="54"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendDelayMsg</span><span class="token punctuation">(</span><span class="token class-name">String</span> msgBody<span class="token punctuation">,</span> <span class="token keyword">int</span> delayLevel<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>        rocketMQTemplate<span class="token punctuation">.</span><span class="token function">syncSend</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> <span class="token class-name">MessageBuilder</span><span class="token punctuation">.</span><span class="token function">withPayload</span><span class="token punctuation">(</span>msgBody<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> messageTimeOut<span class="token punctuation">,</span> delayLevel<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="57"></td><td><pre></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token doc-comment comment">/**</span></pre></td></tr><tr><td data-num="59"></td><td><pre>     * 发送单向消息（只负责发送消息，不等待应答，不关心发送结果，如日志）</pre></td></tr><tr><td data-num="60"></td><td><pre>     */</pre></td></tr><tr><td data-num="61"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendOneWayMsg</span><span class="token punctuation">(</span><span class="token class-name">String</span> msgBody<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>        rocketMQTemplate<span class="token punctuation">.</span><span class="token function">sendOneWay</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> <span class="token class-name">MessageBuilder</span><span class="token punctuation">.</span><span class="token function">withPayload</span><span class="token punctuation">(</span>msgBody<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>    </pre></td></tr><tr><td data-num="65"></td><td><pre>	<span class="token doc-comment comment">/**</span></pre></td></tr><tr><td data-num="66"></td><td><pre>     * 发送带tag的消息，直接在topic后面加上":tag"</pre></td></tr><tr><td data-num="67"></td><td><pre>     */</pre></td></tr><tr><td data-num="68"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">SendResult</span> <span class="token function">sendTagMsg</span><span class="token punctuation">(</span><span class="token class-name">String</span> msgBody<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>        <span class="token keyword">return</span> rocketMQTemplate<span class="token punctuation">.</span><span class="token function">syncSend</span><span class="token punctuation">(</span>topic <span class="token operator">+</span> <span class="token string">":tag2"</span><span class="token punctuation">,</span> <span class="token class-name">MessageBuilder</span><span class="token punctuation">.</span><span class="token function">withPayload</span><span class="token punctuation">(</span>msgBody<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>    </pre></td></tr><tr><td data-num="72"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><ul><li>上面写的这几个消息发送方法， 第一个方法和最后一个方法的参数 topic 和其它的不一样，其实这是 rocketmq 和 springboot 整合后设置 Tag 的方式（Tag：用于区分过滤同一主题下的不同业务类型的消息，非常实用）, 在项目里往 mq 写入消息时，最好每条消息都带上 tag，用于消费时根据业务过滤</li></ul><p>在 rocketmq-spring-boot-starter 中，Tag 的设置方式： 在 topic 后面加上 “:tagName”，源码中是以 “:” 进行分割的，前面的是 topic，后面的就是 tag：<br><img data-src="https://img-blog.csdnimg.cn/20210106163141447.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2NzM3ODAz,size_16,color_FFFFFF,t_70#pic_center" alt=""></p><h3 id="第三步编写消费者"><a class="anchor" href="#第三步编写消费者">#</a> 第三步：编写消费者</h3><p>新建 MQConsumerService 类（本案例以上面生产者中第一个和最后一个加了 tag 的消息进行消费）</p><figure class="highlight java"><figcaption data-lang="java"><span>title:MQConsumerService</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Slf4j</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@Component</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MQConsumerService</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment">//topic 需要和生产者的 topic 一致，consumerGroup 属性是必须指定的，内容可以随意</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">//selectorExpression 的意思指的就是 tag，默认为 “*”，不设置的话会监听所有消息</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token annotation punctuation">@Service</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token annotation punctuation">@RocketMQMessageListener</span><span class="token punctuation">(</span>topic <span class="token operator">=</span> <span class="token string">"RLT_TEST_TOPIC"</span><span class="token punctuation">,</span> selectorExpression <span class="token operator">=</span> <span class="token string">"tag1"</span><span class="token punctuation">,</span> consumerGroup <span class="token operator">=</span> <span class="token string">"Con_Group_One"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConsumerSend</span> <span class="token keyword">implements</span> <span class="token class-name">RocketMQListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token comment">// 监听到消息就会执行此方法</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"监听到消息：user=&#123;&#125;"</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token comment">// 注意：这个 ConsumerSend2 和上面 ConsumerSend 在没有添加 tag 做区分时，不能共存，</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token comment">// 不然生产者发送一条消息，这两个都会去消费，如果类型不同会有一个报错，所以实际运用中最好加上 tag，写这只是让你看知道就行</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token comment">// 不设置 selectorExpression 就是都接受，所以测试的时候和上面同时响应了</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token annotation punctuation">@Service</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token annotation punctuation">@RocketMQMessageListener</span><span class="token punctuation">(</span>topic <span class="token operator">=</span> <span class="token string">"RLT_TEST_TOPIC"</span><span class="token punctuation">,</span> consumerGroup <span class="token operator">=</span> <span class="token string">"Con_Group_Two"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConsumerSend2</span> <span class="token keyword">implements</span> <span class="token class-name">RocketMQListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token class-name">String</span> str<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"监听到消息：str=&#123;&#125;"</span><span class="token punctuation">,</span> str<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>	<span class="token comment">// MessageExt：是一个消息接收通配符，不管发送的是 String 还是对象，都可接收，当然也可以像上面明确指定类型（我建议还是指定类型较方便）</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token annotation punctuation">@Service</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token annotation punctuation">@RocketMQMessageListener</span><span class="token punctuation">(</span>topic <span class="token operator">=</span> <span class="token string">"RLT_TEST_TOPIC"</span><span class="token punctuation">,</span> selectorExpression <span class="token operator">=</span> <span class="token string">"tag2"</span><span class="token punctuation">,</span> consumerGroup <span class="token operator">=</span> <span class="token string">"Con_Group_Three"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Consumer</span> <span class="token keyword">implements</span> <span class="token class-name">RocketMQListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageExt</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token class-name">MessageExt</span> messageExt<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body <span class="token operator">=</span> messageExt<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>            <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"监听到消息：msg=&#123;&#125;"</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="第四步测试"><a class="anchor" href="#第四步测试">#</a> 第四步：测试</h3><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@RestController</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/rocketmq"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RocketMQController</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token annotation punctuation">@Autowired</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">MQProducerService</span> mqProducerService<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/send"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>	    <span class="token comment">// 正好有个随便测的一个自己的 User 数据表</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">></span></span> queryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="12"></td><td><pre>		queryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token operator">::</span><span class="token function">getPhone</span><span class="token punctuation">,</span> <span class="token string">"zy@qq.com"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>		<span class="token class-name">User</span> user <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">getOne</span><span class="token punctuation">(</span>queryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>		<span class="token comment">// 核心在于发送了这个信息</span></pre></td></tr><tr><td data-num="15"></td><td><pre>		mqProducerService<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    </pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/sendTag"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SendResult</span><span class="token punctuation">></span></span> <span class="token function">sendTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token class-name">SendResult</span> sendResult <span class="token operator">=</span> mqProducerService<span class="token punctuation">.</span><span class="token function">sendTagMsg</span><span class="token punctuation">(</span><span class="token string">"带有tag的字符消息"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>sendResult<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>用 Postman 测试 <code>http://localhost/rocketmq/send</code> ， <code>http://localhost/rocketmq/sendTag</code><br><img data-src="image-20240327212233987.png" alt=""><br><img data-src="image-20240327212427240.png" alt=""></p><h2 id="redis的mq"><a class="anchor" href="#redis的mq">#</a> redis 的 MQ</h2><p>Redis 提供了三种不同的方式来实现消息队列：</p><ul><li>list 结构：基于 List 结构模拟消息队列</li><li>PubSub：基本的点对点消息模型</li><li>Stream：比较完善的消息队列模型</li></ul><h3 id="基于list实现消息队列"><a class="anchor" href="#基于list实现消息队列">#</a> 基于 List 实现消息队列</h3><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># lpush 命令在 l1 队列中放入两个元素</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> LPUSH l1 element1 element2</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">2</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># brpop 命令在 l1 队列右侧取出第一个元素，等待时间 20s</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> BRPOP l1 <span class="token number">20</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"l1"</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"element1"</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># brpop 命令在 l1 队列右侧取出第二个元素，等待时间 20s</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> BRPOP l1 <span class="token number">20</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"l1"</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"element2"</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment"># brpop 命令在 l1 队列右侧取出第三个元素，等待时间 20s，元素被取完，命令处于阻塞状态</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> BRPOP l1 <span class="token number">20</span></pre></td></tr></table></figure><p>优点：</p><ul><li>利用 Redis 存储，不受限于 JVM 内存上限</li><li>基于 Redis 的持久化机制，数据安全性有保证</li><li>可以满足消息有序性</li><li></li></ul><p>缺点：</p><ul><li>无法避免消息丢失</li><li><strong>只支持单消费者</strong></li></ul><p><mark>更多面向搜索引擎，用了 RocketMQ，没用这个，大概知道下</mark></p><h1 id="改头换面"><a class="anchor" href="#改头换面">#</a> 改头换面</h1><p>如果有面试官真看博客的话 —— 我能咋办捏，都是这些项目拼凑的，同质化严重</p><p>校园在线跳蚤平台<br>项目介绍：本平台项目实现了用户登录注册管理，发布商品及评论，点赞收藏及系统通知功能，实现了高并发的订单管理。<br>相关技术：【SpringBoot，Mybatis Plus，MySQL，Redis，RocketMQ，Nginx】</p><ul><li>项目构建在 SpringBoot 框架上，实现了统一的异常处理，日志记录</li><li>利用 Redis 实现高频数据缓存，提高并发访问能力，解决缓存穿透、缓存击穿问题</li><li>利用 Redis 实现了订单全局唯一 id 功能，通过乐观锁实现库存扣减，利用分布式锁实现了一人一单</li><li>利用自定义注解 + 拦截器的方式实现用户登录鉴权以及登录状态缓存功能</li><li>利用 RocketMQ 进行流量削峰，实现了点赞，关注，收藏等通知的异步处理</li><li>利用 Nginx 对 IP 进行哈希映射 + 轮询实现负载均衡，尽量保证会话保持又不会不均匀负载</li></ul><h2 id="拦截器自定义注解"><a class="anchor" href="#拦截器自定义注解">#</a> 拦截器 + 自定义注解</h2><p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80OTczNjk1OS9hcnRpY2xlL2RldGFpbHMvMTA3ODQzMTc5">拦截器 + 自定义注解</span></p><h3 id="拦截器"><a class="anchor" href="#拦截器">#</a> 拦截器</h3><p>可以自定义拦截类 (继承 <code>HandlerInterceptorAdapter</code> ) 在 <code>preHandle</code> 中重写拦截逻辑，并在 <code>WebMvcConfigurer</code> 重写 <code>addInterceptors</code> 添加</p><figure class="highlight java"><figcaption data-lang="java"><span>title:LoginInterceptor</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">PrintWriter</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletRequest</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletResponse</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">ModelAndView</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>handler<span class="token punctuation">.</span></span><span class="token class-name">HandlerInterceptorAdapter</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre> </pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token doc-comment comment">/**</span></pre></td></tr><tr><td data-num="8"></td><td><pre> * 登录拦截器（判断用户是否登录）</pre></td></tr><tr><td data-num="9"></td><td><pre> */</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginInterceptor</span> <span class="token keyword">extends</span> <span class="token class-name">HandlerInterceptorAdapter</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre> </pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token comment">// 从 session 中获取用户对象（该对象在用户登录的时候存于 session 中）</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token class-name">Object</span> object <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token class-name">SessionKey</span><span class="token punctuation">.</span><span class="token constant">USER_OBJECT</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token comment">// 用户未登录，则返回 false, 拦截该请求</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>object <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            <span class="token class-name">PrintWriter</span> printWriter <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>            printWriter<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"请登录"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token comment">// 用户已登录，则返回 true, 放行该请求</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre> </pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterCompletion</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="29"></td><td><pre>            <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">,</span> <span class="token class-name">Exception</span> ex<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="30"></td><td><pre>            <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token comment">// TODO Auto-generated method stub</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">afterCompletion</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="34"></td><td><pre> </pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterConcurrentHandlingStarted</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="37"></td><td><pre>            <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token comment">// TODO Auto-generated method stub</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">afterConcurrentHandlingStarted</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="41"></td><td><pre> </pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">postHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="44"></td><td><pre>            <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="45"></td><td><pre>            <span class="token class-name">ModelAndView</span> modelAndView<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token comment">// TODO Auto-generated method stub</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">postHandle</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> modelAndView<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="49"></td><td><pre> </pre></td></tr><tr><td data-num="50"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight java"><figcaption data-lang="java"><span>title:WebMvcConfigurer</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">InterceptorRegistry</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">WebMvcConfigurer</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Resource</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token annotation punctuation">@Configuration</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InterceptorConfig</span>  <span class="token keyword">implements</span> <span class="token class-name">WebMvcConfigurer</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token annotation punctuation">@Resource</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token class-name">TokenInterceptor</span> tokenInterceptor<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addInterceptors</span><span class="token punctuation">(</span><span class="token class-name">InterceptorRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token comment">// 设置所有的路径都要进行拦截，除了 /test/login</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        registry<span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span><span class="token class-name">LoginInterceptor</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addPathPatterns</span><span class="token punctuation">(</span><span class="token string">"/**"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">excludePathPatterns</span><span class="token punctuation">(</span><span class="token string">"/test/login"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>或者实现 Filter 中 的 doFilter，并使用 <code>@WebFilter</code> 注解会自动解析</p><figure class="highlight java"><figcaption data-lang="java"><span>title:LoginCheckFilter</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@WebFilter</span><span class="token punctuation">(</span>filterName <span class="token operator">=</span> <span class="token string">"LoginCheckFilter"</span><span class="token punctuation">,</span> urlPatterns <span class="token operator">=</span> <span class="token string">"/*"</span><span class="token punctuation">)</span>  </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@Slf4j</span>  </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginCheckFilter</span> <span class="token keyword">implements</span> <span class="token class-name">Filter</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="4"></td><td><pre>  </pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment">// 路径匹配  </span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">AntPathMatcher</span> <span class="token constant">PATH_MATCHER</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AntPathMatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="7"></td><td><pre>  </pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token annotation punctuation">@Override</span>  </pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> servletRequest<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> servletResponse<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> filterChain<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token comment">// 强转  </span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token class-name">HttpServletRequest</span> request <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> servletRequest<span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token class-name">HttpServletResponse</span> response <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">)</span> servletResponse<span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="13"></td><td><pre>  </pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token comment">//1. 获取本次请求的 URI  </span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token class-name">String</span> requestURI <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getRequestURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="16"></td><td><pre>        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"拦截到请求：&#123;&#125;"</span><span class="token punctuation">,</span>requestURI<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="17"></td><td><pre>  </pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token comment">// 定义不需要处理的请求  </span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> urls <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="20"></td><td><pre>                <span class="token string">"/employee/login"</span><span class="token punctuation">,</span>  </pre></td></tr><tr><td data-num="21"></td><td><pre>                <span class="token string">"/employee/logout"</span><span class="token punctuation">,</span>  </pre></td></tr><tr><td data-num="22"></td><td><pre>                <span class="token string">"/backend/**"</span><span class="token punctuation">,</span>  </pre></td></tr><tr><td data-num="23"></td><td><pre>                <span class="token string">"/front/**"</span><span class="token punctuation">,</span>  </pre></td></tr><tr><td data-num="24"></td><td><pre>                <span class="token string">"/common/**"</span><span class="token punctuation">,</span>  </pre></td></tr><tr><td data-num="25"></td><td><pre>                <span class="token comment">// 对用户登陆操作放行  </span></pre></td></tr><tr><td data-num="26"></td><td><pre>                <span class="token string">"/user/login"</span><span class="token punctuation">,</span>  </pre></td></tr><tr><td data-num="27"></td><td><pre>                <span class="token string">"/user/sendMsg"</span><span class="token punctuation">,</span>  </pre></td></tr><tr><td data-num="28"></td><td><pre>                <span class="token string">"/rocketmq/*"</span>  </pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="30"></td><td><pre>  </pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token comment">//2. 判断本次请求是否需要处理  </span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token keyword">boolean</span> check <span class="token operator">=</span> <span class="token function">check</span><span class="token punctuation">(</span>urls<span class="token punctuation">,</span> requestURI<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="33"></td><td><pre>  </pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token comment">//3. 如果不需要处理，则直接放行  </span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>check<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="36"></td><td><pre>            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"本次请求：&#123;&#125;，不需要处理"</span><span class="token punctuation">,</span>requestURI<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="37"></td><td><pre>            filterChain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="38"></td><td><pre>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="39"></td><td><pre>  </pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token comment">//4. 判断登录状态，如果已登录，则直接放行  </span></pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token comment">// 管理员后台登录  </span></pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">"employee"</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="43"></td><td><pre>            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"用户已登录，id为&#123;&#125;"</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">"employee"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="44"></td><td><pre>            <span class="token comment">// 在这里获取一下线程 id  </span></pre></td></tr><tr><td data-num="45"></td><td><pre>            <span class="token keyword">long</span> id <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="46"></td><td><pre>            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"doFilter的线程id为：&#123;&#125;"</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="47"></td><td><pre>            <span class="token comment">// 根据 session 来获取之前我们存的 id 值  </span></pre></td></tr><tr><td data-num="48"></td><td><pre>            <span class="token class-name">Long</span> empId <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">)</span> request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">"employee"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="49"></td><td><pre>            <span class="token comment">// 使用 BaseContext 封装 id  </span></pre></td></tr><tr><td data-num="50"></td><td><pre>            <span class="token class-name">BaseContext</span><span class="token punctuation">.</span><span class="token function">setCurrentId</span><span class="token punctuation">(</span>empId<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="51"></td><td><pre>            filterChain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="52"></td><td><pre>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="53"></td><td><pre>  </pre></td></tr><tr><td data-num="54"></td><td><pre>        <span class="token comment">// 用户前台登录  </span></pre></td></tr><tr><td data-num="55"></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="56"></td><td><pre>            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"用户已登录，用户id为：&#123;&#125;"</span><span class="token punctuation">,</span>request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="57"></td><td><pre>            <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">)</span>request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="58"></td><td><pre>            <span class="token class-name">BaseContext</span><span class="token punctuation">.</span><span class="token function">setCurrentId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="59"></td><td><pre>            filterChain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="60"></td><td><pre>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="61"></td><td><pre>  </pre></td></tr><tr><td data-num="62"></td><td><pre>        <span class="token comment">//5. 如果未登录则返回未登录结果，通过输出流方式向客户端页面响应数据  </span></pre></td></tr><tr><td data-num="63"></td><td><pre>        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"用户未登录"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="64"></td><td><pre>        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"用户id&#123;&#125;"</span><span class="token punctuation">,</span>request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">"employee"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="65"></td><td><pre>        response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span><span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"NOTLOGIN"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="66"></td><td><pre>  </pre></td></tr><tr><td data-num="67"></td><td><pre>    <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="68"></td><td><pre>  </pre></td></tr><tr><td data-num="69"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">check</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> urls<span class="token punctuation">,</span> <span class="token class-name">String</span> requestURI<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="70"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> url <span class="token operator">:</span> urls<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="71"></td><td><pre>            <span class="token keyword">boolean</span> match <span class="token operator">=</span> <span class="token constant">PATH_MATCHER</span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> requestURI<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="72"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>match<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="73"></td><td><pre>                <span class="token comment">// 匹配  </span></pre></td></tr><tr><td data-num="74"></td><td><pre>                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="75"></td><td><pre>            <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="76"></td><td><pre>        <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="77"></td><td><pre>        <span class="token comment">// 不匹配  </span></pre></td></tr><tr><td data-num="78"></td><td><pre>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="79"></td><td><pre>    <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="80"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="自定义注解"><a class="anchor" href="#自定义注解">#</a> 自定义注解</h3><p>注解的本质是一个 interface 接口，注解接口默认继承了 java.lang.annotation.Annotation 接口<br>以设定一个只允许管理员权限处理为例：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">METHOD</span><span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">TYPE</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token comment">// 注解的范围是类、接口、枚举的方法上</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span><span class="token comment">// 被虚拟机保存，可用反射机制读取</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">OnlyAdmin</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在对应 Controller 方法上加上即可触发</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token doc-comment comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 删除博客文章</pre></td></tr><tr><td data-num="3"></td><td><pre> */</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token annotation punctuation">@OnlyAdmin</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/delete"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token annotation punctuation">@ResponseBody</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">Resp</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token keyword">long</span> id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>	bokeService<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>	<span class="token keyword">return</span> <span class="token class-name">Resp</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>更改 preHandle，添加是否有该注解的判断</p><figure class="highlight java"><figcaption data-lang="java"><span>title:LoginInterceptor</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">PrintWriter</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Date</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletRequest</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletResponse</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>method<span class="token punctuation">.</span></span><span class="token class-name">HandlerMethod</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">ModelAndView</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>handler<span class="token punctuation">.</span></span><span class="token class-name">HandlerInterceptorAdapter</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre> </pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token doc-comment comment">/**</span></pre></td></tr><tr><td data-num="10"></td><td><pre> * 登录拦截器</pre></td></tr><tr><td data-num="11"></td><td><pre> */</pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginInterceptor</span> <span class="token keyword">extends</span> <span class="token class-name">HandlerInterceptorAdapter</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre> </pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token comment">// 从 session 中获取用户对象（该对象在用户登录的时候存于 session 中）</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token class-name">Object</span> object <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token class-name">SessionKey</span><span class="token punctuation">.</span><span class="token constant">USER_OBJECT</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token comment">// 用户未登录，则以游客身份登录</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>object <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>            user<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            user<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"游客"</span> <span class="token operator">+</span> <span class="token class-name">DateTool</span><span class="token punctuation">.</span><span class="token function">formatDateTimeSecond</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>            request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token class-name">SessionKey</span><span class="token punctuation">.</span><span class="token constant">USER_OBJECT</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token comment">// 请求的方法是否有注解</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token keyword">boolean</span> haveAnnotataion <span class="token operator">=</span> handler<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span><span class="token class-name">HandlerMethod</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>haveAnnotataion<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>            <span class="token comment">// 检测是否有 @OnlyAdmin 注解</span></pre></td></tr><tr><td data-num="30"></td><td><pre>            <span class="token class-name">OnlyAdmin</span> oa <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">HandlerMethod</span><span class="token punctuation">)</span>handler<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethodAnnotation</span><span class="token punctuation">(</span><span class="token class-name">OnlyAdmin</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>oa <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>                <span class="token comment">// 如果有 @OnlyAdmin 则表明该方法只允许管理员删除</span></pre></td></tr><tr><td data-num="33"></td><td><pre>                <span class="token class-name">Object</span> user <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token class-name">SessionKey</span><span class="token punctuation">.</span><span class="token constant">USER_OBJECT</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">)</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">longValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1L</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 这里假设以 ID 为 1 为管理员</span></pre></td></tr><tr><td data-num="35"></td><td><pre>                    response<span class="token punctuation">.</span><span class="token function">setCharacterEncoding</span><span class="token punctuation">(</span><span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>                    response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">"text/json;charset=utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>                    <span class="token class-name">PrintWriter</span> pw <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>                    pw<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>                    pw<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"&#123;\"msg\":\"你未有该权限\"&#125;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token comment">// 用户已登录，则返回 true, 放行该请求</span></pre></td></tr><tr><td data-num="45"></td><td><pre>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="47"></td><td><pre> </pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterCompletion</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="50"></td><td><pre>            <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">,</span> <span class="token class-name">Exception</span> ex<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="51"></td><td><pre>            <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>        <span class="token comment">// TODO Auto-generated method stub</span></pre></td></tr><tr><td data-num="53"></td><td><pre>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">afterCompletion</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="55"></td><td><pre> </pre></td></tr><tr><td data-num="56"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="57"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterConcurrentHandlingStarted</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="58"></td><td><pre>            <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>        <span class="token comment">// TODO Auto-generated method stub</span></pre></td></tr><tr><td data-num="60"></td><td><pre>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">afterConcurrentHandlingStarted</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="62"></td><td><pre> </pre></td></tr><tr><td data-num="63"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="64"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">postHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="65"></td><td><pre>            <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="66"></td><td><pre>            <span class="token class-name">ModelAndView</span> modelAndView<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>        <span class="token comment">// TODO Auto-generated method stub</span></pre></td></tr><tr><td data-num="68"></td><td><pre>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">postHandle</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> modelAndView<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="70"></td><td><pre> </pre></td></tr><tr><td data-num="71"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="rocketmq通知的异步处理"><a class="anchor" href="#rocketmq通知的异步处理">#</a> RocketMQ 通知的异步处理</h2><p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81ODQ4MjMxMS9hcnRpY2xlL2RldGFpbHMvMTM0NzAxMDA3P3V0bV9tZWRpdW09ZGlzdHJpYnV0ZS5wY19yZWxldmFudC5ub25lLXRhc2stYmxvZy0yfmRlZmF1bHR+YmFpZHVqc19iYWlkdWxhbmRpbmd3b3JkfmRlZmF1bHQtMC0xMzQ3MDEwMDctYmxvZy0xMzAxOTg4OTkuMjM1JTVFdjQzJTVFcGNfYmxvZ19ib3R0b21fcmVsZXZhbmNlX2Jhc2U3JmFtcDtzcG09MTAwMS4yMTAxLjMwMDEuNDI0Mi4xJmFtcDt1dG1fcmVsZXZhbnRfaW5kZXg9Mw==">参考</span></p><p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzE4OTQ4MzU5L2FydGljbGUvZGV0YWlscy8xMzAxOTg4OTkjOn46dGV4dD0lRTUlQkUlODUlRTYlQjYlODglRTglQjQlQjklRUYlQkMlOUElRTYlQjYlODglRTYlODElQUYlRTglQTIlQUIlRTUlOEYlOTElRTklODAlODElRTUlODglQjAlRTYlOUMlOEQlRTUlOEElQTElRTclQUIlQUYlRUYlQkMlOEMlRTUlQUYlQjklRTYlQjYlODglRTglQjQlQjklRTglODAlODUlRTUlOEYlQUYlRTglQTclODElRUYlQkMlOEMlRTclQUQlODklRTUlQkUlODUlRTYlQjYlODglRTglQjQlQjklRTglODAlODUlRTYlQjYlODglRTglQjQlQjklRTclOUElODQlRTclOEElQjYlRTYlODAlODElRTMlODAlODIlMjAlRTYlQjYlODglRTglQjQlQjklRTQlQjglQUQlRUYlQkMlOUElRTYlQjYlODglRTYlODElQUYlRTglQTIlQUIlRTYlQjYlODglRTglQjQlQjklRTglODAlODUlRTglOEUlQjclRTUlOEYlOTYlRUYlQkMlOEMlRTUlQjklQjYlRTYlOEMlODklRTclODUlQTclRTYlQjYlODglRTglQjQlQjklRTglODAlODUlRTYlOUMlQUMlRTUlOUMlQjAlRTclOUElODQlRTQlQjglOUElRTUlOEElQTElRTklODAlQkIlRTglQkUlOTElRTglQkYlOUIlRTglQTElOEMlRTUlQTQlODQlRTclOTAlODYlRTclOUElODQlRTglQkYlODclRTclQTglOEIlRTMlODAlODIlMjAlRTYlQUQlQTQlRTYlOTclQjYlRTYlOUMlOEQlRTUlOEElQTElRTclQUIlQUYlRTQlQkMlOUElRTclQUQlODklRTUlQkUlODUlRTYlQjYlODglRTglQjQlQjklRTglODAlODUlRTUlQUUlOEMlRTYlODglOTAlRTYlQjYlODglRTglQjQlQjklRTUlQjklQjYlRTYlOEYlOTAlRTQlQkElQTQlRTYlQjYlODglRTglQjQlQjklRTclQkIlOTMlRTYlOUUlOUMlRUYlQkMlOEMlRTUlQTYlODIlRTYlOUUlOUMlRTQlQjglODAlRTUlQUUlOUElRTYlOTclQjYlRTklOTclQjQlRTUlOTAlOEUlRTYlQjIlQTElRTYlOUMlODklRTYlOTQlQjYlRTUlODglQjAlRTYlQjYlODglRTglQjQlQjklRTglODAlODUlRTclOUElODQlRTUlOTMlOEQlRTUlQkElOTQlRUYlQkMlOENBcGFjaGUlMjBSb2NrZXRNUSVFNCVCQyU5QSVFNSVBRiVCOSVFNiVCNiU4OCVFNiU4MSVBRiVFOCVCRiU5QiVFOCVBMSU4QyVFOSU4NyU4RCVFOCVBRiU5NSVFNSVBNCU4NCVFNyU5MCU4NiVFMyU4MCU4MiwlRTUlODUlQjclRTQlQkQlOTMlRTQlQkYlQTElRTYlODElQUYlRUYlQkMlOEMlRTglQUYlQjclRTUlOEYlODIlRTglQTclODElRTYlQjYlODglRTglQjQlQjklRTklODclOEQlRTglQUYlOTUlRTMlODAlODIlMjAlRTYlQjYlODglRTglQjQlQjklRTYlOEYlOTAlRTQlQkElQTQlRUYlQkMlOUElRTYlQjYlODglRTglQjQlQjklRTglODAlODUlRTUlQUUlOEMlRTYlODglOTAlRTYlQjYlODglRTglQjQlQjklRTUlQTQlODQlRTclOTAlODYlRUYlQkMlOEMlRTUlQjklQjYlRTUlOTAlOTElRTYlOUMlOEQlRTUlOEElQTElRTclQUIlQUYlRTYlOEYlOTAlRTQlQkElQTQlRTYlQjYlODglRTglQjQlQjklRTclQkIlOTMlRTYlOUUlOUMlRUYlQkMlOEMlRTYlOUMlOEQlRTUlOEElQTElRTclQUIlQUYlRTYlQTAlODclRTglQUUlQjAlRTUlQkQlOTMlRTUlODklOEQlRTYlQjYlODglRTYlODElQUYlRTUlQjclQjIlRTclQkIlOEYlRTglQTIlQUIlRTUlQTQlODQlRTclOTAlODYlRUYlQkMlODglRTUlOEMlODUlRTYlOEIlQUMlRTYlQjYlODglRTglQjQlQjklRTYlODglOTAlRTUlOEElOUYlRTUlOTIlOEMlRTUlQTQlQjElRTglQjQlQTUlRUYlQkMlODklRTMlODAlODIlMjBBcGFjaGUlMjBSb2NrZXRNUSVFOSVCQiU5OCVFOCVBRSVBNCVFNiU5NCVBRiVFNiU4QyU4MSVFNCVCRiU5RCVFNyU5NSU5OSVFNiU4OSU4MCVFNiU5QyU4OSVFNiVCNiU4OCVFNiU4MSVBRiVFRiVCQyU4QyVFNiVBRCVBNCVFNiU5NyVCNiVFNiVCNiU4OCVFNiU4MSVBRiVFNiU5NSVCMCVFNiU4RCVBRSVFNSVCOSVCNiVFNCVCOCU4RCVFNCVCQyU5QSVFNyVBQiU4QiVFNSU4RCVCMyVFOCVBMiVBQiVFNSU4OCVBMCVFOSU5OSVBNCVFRiVCQyU4QyVFNSU4RiVBQSVFNiU5OCVBRiVFOSU4MCVCQiVFOCVCRSU5MSVFNiVBMCU4NyVFOCVBRSVCMCVFNSVCNyVCMiVFNiVCNiU4OCVFOCVCNCVCOSVFMyU4MCU4MiUyMCVFNiVCNiU4OCVFNiU4MSVBRiVFNSU5QyVBOCVFNCVCRiU5RCVFNSVBRCU5OCVFNiU5NyVCNiVFOSU5NyVCNCVFNSU4OCVCMCVFNiU5QyU5RiVFNiU4OCU5NiVFNSVBRCU5OCVFNSU4MiVBOCVFNyVBOSVCQSVFOSU5NyVCNCVFNCVCOCU4RCVFOCVCNiVCMyVFOCVBMiVBQiVFNSU4OCVBMCVFOSU5OSVBNCVFNSU4OSU4RCVFRiVCQyU4QyVFNiVCNiU4OCVFOCVCNCVCOSVFOCU4MCU4NSVFNCVCQiU4RCVFNyU4NCVCNiVFNSU4RiVBRiVFNCVCQiVBNSVFNSU5QiU5RSVFNiVCQSVBRiVFNiVCNiU4OCVFNiU4MSVBRiVFOSU4NyU4RCVFNiU5NiVCMCVFNiVCNiU4OCVFOCVCNCVCOSVFMyU4MCU4Mg==">参考</span></p><h2 id="ip哈希"><a class="anchor" href="#ip哈希">#</a> IP 哈希</h2><p><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8xOTE1MzQwMzE=">参考</span></p><h1 id="项目细节深挖"><a class="anchor" href="#项目细节深挖">#</a> 项目细节深挖</h1><ol><li><p><strong>订单全局唯一 ID 功能</strong>：利用 Redis 可以很方便地实现订单全局唯一 ID 功能，可以使用 Redis 的原子性操作（如 INCR 命令）来生成全局唯一的订单 ID。</p></li><li><p><strong>乐观锁实现库存扣减</strong>：乐观锁可以用于保证并发环境下的数据一致性，确保库存扣减操作的原子性和一致性。在扣减库存时，需要先查询当前库存数量，然后进行扣减操作，并在更新库存时检查库存是否充足。如果在查询和更新之间库存发生了变化，则说明其他线程已经修改了库存，此时扣减操作可能会失败，需要进行重试或者放弃。</p></li><li><p><strong>分布式锁实现一人一单</strong>：分布式锁可以用于保证一人一单的原则，防止重复下单。在用户下单时，可以先获取分布式锁，然后再生成订单。获取锁成功则可以继续下单，获取锁失败则表示已经有其他线程在处理订单，此时需要等待或者返回错误信息。</p></li><li><p>Mybatis 中不能重载函数（同名），意味着 xml 中有两个 id 相同的语句。查询单个和查询多个应该合并</p></li></ol><h1 id="具体优化问题"><a class="anchor" href="#具体优化问题">#</a> 具体优化问题</h1><p>索引解决不了的：</p><ol><li>大量的分页查询对于 mysql 始终要从前开始一页页查询，大量的操作会有很多无用的操作，给定一个查询 id，和一页大小，转为范围查询<ol><li>条件查询、跳页、主键雪花等页没什么办法：轻量级搜索引擎，存热数据。冷数据就解决不了了</li><li>针对客户端的一般限制可浏览的页数，避免太多的页数导致 offset 过大，或者用其他的数据库存数据</li></ol></li><li>单纯的大量数据，不改动的前提下，提高查询响应速度。首先是本质上定位问题，10 亿，也才 4 层 B + 树，也只多一次随机 io。但 MySQL 的机制是先查询 buff pool（默认 128m），才走索引，加载页。数据量多了后因为页大小固定 16k，数据分散，pool 被占满后就会有频繁的内存交换。（是走随机 io 和走缓存的差距）。临时解决方案就是提高 pool 缓存区大小 / 加大线程池最大线程数。最终就是分库分表、分布式数据库。</li></ol><p>高可用、高并发、高性能</p><div class="tags"><a href="/tags/JAVA/" rel="tag"><i class="ic i-tag"></i> JAVA</a> <a href="/tags/Mysql/" rel="tag"><i class="ic i-tag"></i> Mysql</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">Edited on</span> <time title="Modified: 2024-05-21 16:21:15" itemprop="dateModified" datetime="2024-05-21T16:21:15+08:00">2024-05-21</time></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> Donate</button><p>Give me a cup of [coffee]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/images/wechatpay.jpg" alt="ZY WeChat Pay"><p>WeChat Pay</p></div></div></div><div id="copyright"><ul><li class="author"><strong>Post author: </strong>ZY <i class="ic i-at"><em>@</em></i>世界上只有一种真正的英雄主义，就是认清了生活的真相后还依然热爱它</li><li class="link"><strong>Post link: </strong><a href="https://zyakmd.github.io/2024/03/22/%E9%A1%B9%E7%9B%AE%E4%BC%98%E5%8C%96/" title="项目优化">https://zyakmd.github.io/2024/03/22/项目优化/</a></li><li class="license"><strong>Copyright Notice: </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</a> unless stating additionally.</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2024/03/21/Java%E7%AC%94%E8%AE%B0/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;t.mwm.moe&#x2F;fj?393091" title="Java笔记"><span class="type">Previous Post</span> <span class="category"><i class="ic i-flag"></i></span><h3>Java笔记</h3></a></div><div class="item right"><a href="/2024/03/29/Docker/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;t.mwm.moe&#x2F;fj?938420" title="Docker"><span class="type">Next Post</span> <span class="category"><i class="ic i-flag"></i></span><h3>Docker</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="Contents"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#redis-springcache"><span class="toc-number">1.</span> <span class="toc-text">Redis + SpringCache</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85"><span class="toc-number">1.1.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E8%BF%90%E8%A1%8C"><span class="toc-number">1.2.</span> <span class="toc-text">服务运行</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%81%9C"><span class="toc-number">1.2.1.</span> <span class="toc-text">启停</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8E%E5%8F%B0%E8%BF%90%E8%A1%8C"><span class="toc-number">1.2.2.</span> <span class="toc-text">后台运行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%86%E7%A0%81%E6%A0%A1%E9%AA%8C"><span class="toc-number">1.2.3.</span> <span class="toc-text">密码校验</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9C%E7%A8%8B%E8%BF%9E%E6%8E%A5"><span class="toc-number">1.2.4.</span> <span class="toc-text">远程连接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%A5%E9%94%99"><span class="toc-number">1.2.5.</span> <span class="toc-text">报错</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#java%E4%B8%AD%E4%BD%BF%E7%94%A8"><span class="toc-number">1.3.</span> <span class="toc-text">Java 中使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#jedis"><span class="toc-number">1.3.1.</span> <span class="toc-text">Jedis</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#spring-data-redis"><span class="toc-number">1.3.2.</span> <span class="toc-text">Spring Data Redis</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E6%A1%88%E4%BE%8B"><span class="toc-number">1.4.</span> <span class="toc-text">简单案例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%93%E5%90%88spring-cache"><span class="toc-number">1.5.</span> <span class="toc-text">结合 spring cache</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E6%B3%A8%E8%A7%A3"><span class="toc-number">1.5.1.</span> <span class="toc-text">常用注解</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8"><span class="toc-number">1.5.2.</span> <span class="toc-text">使用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#redis%E5%8E%9F%E7%90%86"><span class="toc-number">1.6.</span> <span class="toc-text">redis 原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C"><span class="toc-number">1.6.1.</span> <span class="toc-text">操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">1.6.2.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%E7%AD%96%E7%95%A5"><span class="toc-number">1.6.3.</span> <span class="toc-text">更新策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%98%E6%B1%B0"><span class="toc-number">1.6.4.</span> <span class="toc-text">淘汰</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#qa"><span class="toc-number">1.6.5.</span> <span class="toc-text">QA</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#mysql%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="toc-number">2.</span> <span class="toc-text">MySQL 主从复制</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE"><span class="toc-number">2.1.</span> <span class="toc-text">配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E5%BA%93"><span class="toc-number">2.1.1.</span> <span class="toc-text">主库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8E%E5%BA%93"><span class="toc-number">2.1.2.</span> <span class="toc-text">从库</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%93%E5%90%88sharding-jdbc"><span class="toc-number">2.2.</span> <span class="toc-text">结合 Sharding-JDBC</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#njinx"><span class="toc-number">3.</span> <span class="toc-text">Njinx</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"><span class="toc-number">3.1.</span> <span class="toc-text">目录结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nginxconf"><span class="toc-number">3.2.</span> <span class="toc-text">nginx.conf</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nginx%E5%91%BD%E4%BB%A4"><span class="toc-number">3.3.</span> <span class="toc-text">Nginx 命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E4%BB%A3%E7%90%86"><span class="toc-number">3.4.</span> <span class="toc-text">资源代理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">3.5.</span> <span class="toc-text">负载均衡</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%A7%92%E6%9D%80%E9%97%AE%E9%A2%98redis%E7%BC%93%E5%AD%98-%E9%94%81-mq"><span class="toc-number">4.</span> <span class="toc-text">秒杀问题（redis 缓存、锁、mq）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8E%E7%AB%AF%E8%AE%BE%E8%AE%A1"><span class="toc-number">4.1.</span> <span class="toc-text">后端设计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B6%85%E5%8D%96%E9%97%AE%E9%A2%98"><span class="toc-number">4.2.</span> <span class="toc-text">超卖问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#redis-%E7%BC%93%E5%AD%98"><span class="toc-number">4.2.1.</span> <span class="toc-text">redis 缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B9%90%E8%A7%82%E9%94%81"><span class="toc-number">4.2.2.</span> <span class="toc-text">（乐观）锁</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%89%88%E6%9C%AC%E5%8F%B7%E5%AE%9E%E7%8E%B0"><span class="toc-number">4.2.2.1.</span> <span class="toc-text">版本号实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#cas%E5%AE%9E%E7%8E%B0"><span class="toc-number">4.2.2.2.</span> <span class="toc-text">CAS 实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81"><span class="toc-number">4.2.2.3.</span> <span class="toc-text">分布式锁</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mq%E5%BC%82%E6%AD%A5%E5%A4%84%E7%90%86"><span class="toc-number">4.2.3.</span> <span class="toc-text">mq 异步处理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E4%B8%A2%E5%A4%B1%E9%97%AE%E9%A2%98"><span class="toc-number">4.2.3.1.</span> <span class="toc-text">消息丢失问题</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#rocketmq%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E6%B6%88%E6%81%AF%E4%B8%8D%E4%B8%A2%E5%A4%B1"><span class="toc-number">4.2.3.1.1.</span> <span class="toc-text">Rocketmq 如何保证消息不丢失</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#producer%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF%E9%98%B6%E6%AE%B5"><span class="toc-number">4.2.3.1.1.1.</span> <span class="toc-text">Producer 发送消息阶段</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#broker%E5%A4%84%E7%90%86%E6%B6%88%E6%81%AF%E9%98%B6%E6%AE%B5"><span class="toc-number">4.2.3.1.1.2.</span> <span class="toc-text">Broker 处理消息阶段</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#consumer%E6%B6%88%E8%B4%B9%E6%B6%88%E6%81%AF%E9%98%B6%E6%AE%B5"><span class="toc-number">4.2.3.1.1.3.</span> <span class="toc-text">Consumer 消费消息阶段</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%87%8D%E5%A4%8D%E6%B6%88%E8%B4%B9%E9%97%AE%E9%A2%98"><span class="toc-number">4.2.3.2.</span> <span class="toc-text">重复消费问题</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#rocketmq%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E6%B6%88%E6%81%AF%E4%B8%8D%E8%A2%AB%E9%87%8D%E5%A4%8D%E6%B6%88%E8%B4%B9"><span class="toc-number">4.2.3.2.1.</span> <span class="toc-text">Rocketmq 如何保证消息不被重复消费</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9E%83%E5%9C%BE%E6%B6%88%E6%81%AF%E9%97%AE%E9%A2%98"><span class="toc-number">4.2.3.3.</span> <span class="toc-text">垃圾消息问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BB%B6%E8%BF%9F%E6%B6%88%E8%B4%B9%E9%97%AE%E9%A2%98"><span class="toc-number">4.2.3.4.</span> <span class="toc-text">延迟消费问题</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1"><span class="toc-number">4.2.4.</span> <span class="toc-text">事务</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%91%E5%8D%96%E9%97%AE%E9%A2%98"><span class="toc-number">4.3.</span> <span class="toc-text">少卖问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">4.3.1.</span> <span class="toc-text">解决方案</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#mq"><span class="toc-number">5.</span> <span class="toc-text">MQ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E7%9A%84%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="toc-number">5.1.</span> <span class="toc-text">常见的消息队列</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#activemq"><span class="toc-number">5.1.1.</span> <span class="toc-text">ActiveMQ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kafka"><span class="toc-number">5.1.2.</span> <span class="toc-text">Kafka</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rabbitmq"><span class="toc-number">5.1.3.</span> <span class="toc-text">RabbitMQ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rocketmq"><span class="toc-number">5.1.4.</span> <span class="toc-text">RocketMQ</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%89%E6%8B%A9"><span class="toc-number">5.2.</span> <span class="toc-text">选择</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E7%94%A8rocketmq"><span class="toc-number">5.3.</span> <span class="toc-text">为什么用 RocketMQ？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B7%B1%E5%85%A5rocketmq"><span class="toc-number">5.4.</span> <span class="toc-text">深入 RocketMQ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%A1%88%E4%BE%8Brocketmqspringboot"><span class="toc-number">5.5.</span> <span class="toc-text">实现案例（RocketMQ+Springboot）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%94%E7%A7%8D%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F"><span class="toc-number">5.5.1.</span> <span class="toc-text">五种工作模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E9%9B%B6%E6%AD%A5%E7%8E%AF%E5%A2%83%E8%AE%BE%E7%BD%AE"><span class="toc-number">5.5.2.</span> <span class="toc-text">第零步：环境设置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E6%AD%A5%E5%BC%95%E5%85%A5maven%E4%BE%9D%E8%B5%96%E5%92%8C%E9%85%8D%E7%BD%AE"><span class="toc-number">5.5.3.</span> <span class="toc-text">第一步：引入 maven 依赖和配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E6%AD%A5%E7%BC%96%E5%86%99%E7%94%9F%E4%BA%A7%E8%80%85"><span class="toc-number">5.5.4.</span> <span class="toc-text">第二步：编写生产者</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E6%AD%A5%E7%BC%96%E5%86%99%E6%B6%88%E8%B4%B9%E8%80%85"><span class="toc-number">5.5.5.</span> <span class="toc-text">第三步：编写消费者</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E5%9B%9B%E6%AD%A5%E6%B5%8B%E8%AF%95"><span class="toc-number">5.5.6.</span> <span class="toc-text">第四步：测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#redis%E7%9A%84mq"><span class="toc-number">5.6.</span> <span class="toc-text">redis 的 MQ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8Elist%E5%AE%9E%E7%8E%B0%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="toc-number">5.6.1.</span> <span class="toc-text">基于 List 实现消息队列</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%94%B9%E5%A4%B4%E6%8D%A2%E9%9D%A2"><span class="toc-number">6.</span> <span class="toc-text">改头换面</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8B%A6%E6%88%AA%E5%99%A8%E8%87%AA%E5%AE%9A%E4%B9%89%E6%B3%A8%E8%A7%A3"><span class="toc-number">6.1.</span> <span class="toc-text">拦截器 + 自定义注解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="toc-number">6.1.1.</span> <span class="toc-text">拦截器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%B3%A8%E8%A7%A3"><span class="toc-number">6.1.2.</span> <span class="toc-text">自定义注解</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rocketmq%E9%80%9A%E7%9F%A5%E7%9A%84%E5%BC%82%E6%AD%A5%E5%A4%84%E7%90%86"><span class="toc-number">6.2.</span> <span class="toc-text">RocketMQ 通知的异步处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ip%E5%93%88%E5%B8%8C"><span class="toc-number">6.3.</span> <span class="toc-text">IP 哈希</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E7%BB%86%E8%8A%82%E6%B7%B1%E6%8C%96"><span class="toc-number">7.</span> <span class="toc-text">项目细节深挖</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E4%BC%98%E5%8C%96%E9%97%AE%E9%A2%98"><span class="toc-number">8.</span> <span class="toc-text">具体优化问题</span></a></li></ol></div><div class="related panel pjax" data-title="Related"></div><div class="overview panel" data-title="Overview"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="ZY" data-src="/images/avatar.jpg"><p class="name" itemprop="name">ZY</p><div class="description" itemprop="description">行到水穷处，坐看云起时</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">20</span> <span class="name">posts</span></a></div><div class="item categories"><a href="/categories/"><span class="count">4</span> <span class="name">categories</span></a></div><div class="item tags"><a href="/tags/"><span class="count">5</span> <span class="name">tags</span></a></div></nav><div class="social"><a href="https://github.com/zyakmd" title="https:&#x2F;&#x2F;github.com&#x2F;zyakmd" class="item github" rel="noopener" target="_blank"><i class="ic i-github"></i></a></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>Home</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>Posts</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>Archives</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>Categories</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>Tags</a></li></ul></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/2024/03/21/Java%E7%AC%94%E8%AE%B0/" rel="prev" title="Previous Post"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/2024/03/29/Docker/" rel="next" title="Next Post"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>Random Posts</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/spring%E5%A4%8D%E4%B9%A0/" title="In spring复习">spring复习</a></div><span><a href="/2024/03/19/spring%E5%A4%8D%E4%B9%A0/SpringBoot/" title="SpringBoot">SpringBoot</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/2024/05/09/%E8%99%9A%E6%8B%9F%E4%B8%96%E7%95%8Ctricks/Windows%E7%9B%B8%E5%85%B3/" title="Windows相关">Windows相关</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/hexo%E4%BD%BF%E7%94%A8/" title="In hexo使用">hexo使用</a></div><span><a href="/2024/03/07/hexo%E4%BD%BF%E7%94%A8/%E7%BD%91%E7%AB%99%E6%A0%B7%E5%BC%8F/" title="网站样式">网站样式</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/2024/05/08/%E9%80%9F%E8%A7%88/" title="速览">速览</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/spring%E5%A4%8D%E4%B9%A0/" title="In spring复习">spring复习</a></div><span><a href="/2024/03/11/spring%E5%A4%8D%E4%B9%A0/Spring%20framework/" title="Spring framework">Spring framework</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/2024/03/21/Java%E7%AC%94%E8%AE%B0/" title="Java笔记">Java笔记</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/2024/03/13/MySQL/" title="MySQL">MySQL</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/spring%E5%A4%8D%E4%B9%A0/" title="In spring复习">spring复习</a></div><span><a href="/2024/03/20/spring%E5%A4%8D%E4%B9%A0/MyBatis%20Plus/" title="MyBatis Plus">MyBatis Plus</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/hexo%E4%BD%BF%E7%94%A8/" title="In hexo使用">hexo使用</a></div><span><a href="/2024/03/09/hexo%E4%BD%BF%E7%94%A8/%E7%95%8C%E9%9D%A2%E7%9B%B8%E5%85%B3/" title="界面相关">界面相关</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/spring%E5%A4%8D%E4%B9%A0/" title="In spring复习">spring复习</a></div><span><a href="/2024/03/18/spring%E5%A4%8D%E4%B9%A0/Maven/" title="Maven">Maven</a></span></li></ul></div></div><div class="status"><div class="copyright">&copy; 2023 – <span itemprop="copyrightYear">2024</span> <span class="with-love"><i class="ic i-"></i> </span><span class="author" itemprop="copyrightHolder">ZY @ ZY Blog</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="Symbols count total">549k words</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="Reading time total">8:19</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"2024/03/22/项目优化/",favicon:{show:"（●´3｀●）Goooood",hide:"(´Д｀)Booooom"},search:{placeholder:"Search for Posts",empty:"We didn't find any results for the search: ${query}",stats:"${hits} results found in ${time} ms"},valine:!0,fancybox:!0,copyright:'Copied to clipboard successfully! <br> All articles in this blog are licensed under <i class="ic i-creative-commons"></i>BY-NC-SA.',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"left","width":150,"height":300},"mobile":{"show":true},"log":false});</script></body></html><!-- rebuild by hrmmi -->