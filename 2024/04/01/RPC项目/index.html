<!-- build time:Thu Apr 11 2024 23:57:56 GMT+0800 (中国标准时间) --><!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><link rel="alternate" type="application/rss+xml" title="世界上只有一种真正的英雄主义，就是认清了生活的真相后还依然热爱它" href="https://zyakmd.github.io/rss.xml"><link rel="alternate" type="application/atom+xml" title="世界上只有一种真正的英雄主义，就是认清了生活的真相后还依然热爱它" href="https://zyakmd.github.io/atom.xml"><link rel="alternate" type="application/json" title="世界上只有一种真正的英雄主义，就是认清了生活的真相后还依然热爱它" href="https://zyakmd.github.io/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><link rel="canonical" href="https://zyakmd.github.io/2024/04/01/RPC%E9%A1%B9%E7%9B%AE/"><title>RPC项目 | ZY Blog = 世界上只有一种真正的英雄主义，就是认清了生活的真相后还依然热爱它</title><meta name="generator" content="Hexo 5.4.2"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">RPC项目</h1><div class="meta"><span class="item" title="Created: 2024-04-01 18:08:06"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">Posted on</span> <time itemprop="dateCreated datePublished" datetime="2024-04-01T18:08:06+08:00">2024-04-01</time> </span><span class="item" title="Symbols count in article"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">Symbols count in article</span> <span>36k</span> <span class="text">words</span> </span><span class="item" title="Reading time"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">Reading time</span> <span>32 mins.</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="Toggle navigation bar"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">ZY Blog</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://t.mwm.moe/fj?606076"></li><li class="item" data-background-image="https://t.mwm.moe/fj?824066"></li><li class="item" data-background-image="https://t.mwm.moe/fj?358316"></li><li class="item" data-background-image="https://t.mwm.moe/fj?879098"></li><li class="item" data-background-image="https://t.mwm.moe/fj?504427"></li><li class="item" data-background-image="https://t.mwm.moe/fj?835166"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">Home</a></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="en"><link itemprop="mainEntityOfPage" href="https://zyakmd.github.io/2024/04/01/RPC%E9%A1%B9%E7%9B%AE/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="ZY"><meta itemprop="description" content=", 行到水穷处，坐看云起时"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="世界上只有一种真正的英雄主义，就是认清了生活的真相后还依然热爱它"></span><div class="body md" itemprop="articleBody"><p>一个 Spring 项目现在根本不够了，太卷了，哎，放平心态持之以恒的卷吧，再学个 RPC。</p><h1 id="概念"><a class="anchor" href="#概念">#</a> 概念</h1><p>RPC（Remote Procedure Call）远程过程调用协议，一种通过网络从远程计算机上请求服务，而不需要了解底层网络技术的协议。RPC 它假定某些协议的存在，例如 TPC/UDP 等，为通信程序之间携带信息数据。在 OSI 网络七层模型中，RPC 跨越了传输层和应用层，RPC 使得开发，包括网络分布式多程序在内的应用程序更加容易。</p><p>过程是什么？ 过程就是业务处理、计算任务，更直白的说，就是程序，就是想调用本地方法一样调用远程的过程。可以让客户端直接调用服务端方法就像调用本地方法一样简单的框架，比如 Dubbo、Motan、gRPC 这些。 如果需要和 HTTP 协议打交道，解析和封装 HTTP 请求和响应。这类框架并不能算是 “RPC 框架”，比如 Feign。</p><p><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8zNjUyODE4OQ==">入门参考</span><br><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8yMDA2NTY3NjQ=">实现参考 1</span><br><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3ZpZWdvMTk5OS93eHktcnBj">实现参考 2</span></p><p>一个最简单的 RPC 框架使用示意图如下图所示：<br><img data-src="https://github.com/viego1999/wxy-rpc/raw/master/images/%E7%AE%80%E5%8D%95RPC%E6%9E%B6%E6%9E%84%E5%9B%BE.png" alt=""></p><p>RPC 框架一般必须包含三个组件，分别是<strong>客户端、服务端</strong>以及<strong>注册中心</strong>，一次完整的 RPC 调用流程一般为：</p><ol><li>服务端启动服务后，将他提供的服务列表发布到注册中心（服务注册）；</li><li>客户端会向注册中心订阅相关的服务地址（服务订阅）；</li><li>客户端通常会利用本地代理模块 Proxy 向服务端发起远程过程调用，Proxy 负责将调用的方法、参数等数据转化为网络字节流；</li><li>客户端从服务列表中根据负载均衡策略选择一个服务地址，并将数据通过网络发送给服务端；</li><li>服务端得到数据后，调用对应的服务，然后将结果通过网络返回给客户端。</li></ol><h1 id="和mq的区别"><a class="anchor" href="#和mq的区别">#</a> 和 MQ 的区别</h1><hr><p>主要使用场景的区别，如下：<br>MQ 适用于 消息上游 与 下游 解耦，不关注下游执行结果，异步；<br>RPC 适用于 消息上游 关注下游执行结果，同步；</p><p>解释下 同步和异步：<br><strong>同步</strong>是指所有的操作都做完，才返回给用户。 <strong>异步</strong>是指 将用户请求放入消息队列，并反馈给用户，然后程序再去执行操作。</p><p><strong>同步</strong>就相当于是 当客户端发送请求给服务端，在等待服务端响应的请求时，客户端不做其他的事情。当服务端做完了才返回到客户端。这样的话客户端需要一直等待。用户使用起来会有不友好。</p><p><strong>异步</strong>就是，当客户端发送给服务端请求时，在等待服务端响应的时候，客户端可以做其他的事情，这样节约了时间，提高了效率。</p><hr><p>话是这么摘过来的，但<a href="#RPC%E8%B0%83%E7%94%A8%E6%96%B9%E5%BC%8F">该小节</a>也有 RPC 异步的操作，感觉不是这么靠这个分开。MQ 更解耦一些。通过消息队列能处理更多的请求，之前自己阿里服务器开了个 RocketMQ 确实响应要几秒，适合大量非即时的需求，小量即时的 RPC 应该更适合？但耦合度高，这种维护不知道怎么说，还是得了解企业用的架构，只学两个 demo 感触不深</p><h1 id="框架思路"><a class="anchor" href="#框架思路">#</a> 框架思路</h1><p>一般情况下， RPC 框架不仅要提供服务发现功能，还要提供负载均衡、容错等功能，这样的 RPC 框架才算真正合格的</p><p>简单说一下设计一个最基本的 RPC 框架的思路：</p><p><img data-src="https://pic4.zhimg.com/80/v2-4986c5136b9926338257b3acb137626f_720w.webp" alt=""></p><ol><li><strong>注册中心</strong> ：注册中心首先是要有的，推荐使用 Zookeeper。注册中心负责服务地址的注册与查找，相当于目录服务。服务端启动的时候将服务名称及其对应的地址 (ip+port) 注册到注册中心，服务消费端根据服务名称找到对应的服务地址。有了服务地址之后，服务消费端就可以通过网络请求服务端了。</li><li><strong>网络传输</strong> ：既然要调用远程的方法就要发请求，请求中至少要包含你调用的类名、方法名以及相关参数吧！推荐基于 NIO 的 Netty 框架。</li><li><strong>序列化</strong> ：既然涉及到网络传输就一定涉及到序列化，你不可能直接使用 JDK 自带的序列化吧！JDK 自带的序列化效率低并且有安全漏洞。 所以，你还要考虑使用哪种序列化协议，比较常用的有 hession2、kyro、protostuff。</li><li><strong>动态代理</strong> ： 另外，动态代理也是需要的。因为 RPC 的主要目的就是让我们调用远程方法像调用本地方法一样简单，使用动态代理可以屏蔽远程方法调用的细节比如网络传输。也就是说当你调用远程方法的时候，实际会通过代理对象来传输网络请求，不然的话，怎么可能直接就调用到远程方法呢？</li><li><strong>负载均衡</strong> ：负载均衡也是需要的。为啥？举个例子我们的系统中的某个服务的访问量特别大，我们将这个服务部署在了多台服务器上，当客户端发起请求的时候，多台服务器都可以处理这个请求。那么，如何正确选择处理该请求的服务器就很关键。假如，你就要一台服务器来处理该服务的请求，那该服务部署在多台服务器的意义就不复存在了。负载均衡就是为了避免单个服务器响应同一请求，容易造成服务器宕机、崩溃等问题，我们从负载均衡的这四个字就能明显感受到它的意义。</li></ol><h1 id="目标和内容"><a class="anchor" href="#目标和内容">#</a> 目标和内容</h1><p>实现基于 Netty + Zookeeper + SpringBoot 实现的自定义 RPC 框架。同时引入其他通信协议，有 Http、Socket 等，注册中心引入了 Zookeeper、Nacos、Eureka 等。基于 JMH 压测在 10000 并发量下的吞吐量在 29300 上下。</p><ul class="task-list"><li class="task-list-item"><input type="checkbox" id="cbx_0" disabled><label for="cbx_0">实现基于 Netty/Socket/Http 三种方式进行网路通信</label></li><li class="task-list-item"><input type="checkbox" id="cbx_1" disabled><label for="cbx_1">自定义消息协议，编解码器</label></li><li class="task-list-item"><input type="checkbox" id="cbx_2" disabled><label for="cbx_2">五种序列化算法（JDK、JSON、HESSIAN、KRYO、PROTOSTUFF）</label></li><li class="task-list-item"><input type="checkbox" id="cbx_3" disabled><label for="cbx_3">三种负载均衡算法（RoundRobin、Random、ConsistentHash）</label></li><li class="task-list-item"><input type="checkbox" id="cbx_4" disabled><label for="cbx_4">两种动态代理（JDK、CGLIB）</label></li><li class="task-list-item"><input type="checkbox" id="cbx_5" disabled><label for="cbx_5">基于 Zookeeper 的服务注册与发现，增加服务本地缓存与监听</label></li><li class="task-list-item"><input type="checkbox" id="cbx_6" disabled><label for="cbx_6">集成 Spring，自定义注解提供 RPC 组件扫描、服务注册、服务消费</label></li><li class="task-list-item"><input type="checkbox" id="cbx_7" disabled><label for="cbx_7">集成 SpringBoot，完成自动配置</label></li><li class="task-list-item"><input type="checkbox" id="cbx_8" disabled><label for="cbx_8">增加 Netty 心跳机制，复用 Channel 连接</label></li><li class="task-list-item"><input type="checkbox" id="cbx_9" disabled><label for="cbx_9">实现自定义 SPI 机制</label></li><li class="task-list-item"><input type="checkbox" id="cbx_10" disabled><label for="cbx_10">10000 个线程同时发起 RPC 调用的吞吐量在 29300 上下</label></li></ul><h1 id="依赖知识"><a class="anchor" href="#依赖知识">#</a> 依赖知识</h1><h2 id="zookeeper"><a class="anchor" href="#zookeeper">#</a> ZooKeeper</h2><p>ZooKeeper 是一个分布式的，开放源码的分布式应用程序协同服务。ZooKeeper 的设计目标是将那些复杂且容易出错的分布式一致性服务封装起来，构成一个高效可靠的原语集，并以一系列简单易用的接口提供给用户使用。</p><h3 id="功能"><a class="anchor" href="#功能">#</a> 功能</h3><ul><li>配置管理（configuration management）：如果我们做普通的 Java 应用，一般配置项就是一个本地的配置文件，如果是微服务系统，各个独立服务都要使用集中化的配置管理，这个时候就需要 ZooKeeper。需要的时候<strong>直接拉取</strong>，这样可以大大节约维护的成本。</li><li>DNS 服务</li><li>集群管理：zookeeper 作为注册中心，管理服务提供方的 ip 地址端口号 url 信息，并在服务消费方请求需要时发送给服务消费方，<mark>RPC 就是用这个</mark></li><li>各种分布式锁：在多个用户访问同一台主机上的应用程序数据时，可以通过加锁解决并发操作。但是如果有多台主机相同的应用程序要访问同一数据时，这个时候在一台主机上加锁是不能解决另一台主机的并发问题的 ，这个时候就需要分布式锁解决这类问题。可以抽象理解分布式锁像是从所有主机中抽取出来的一把锁，或者是有一把总锁对所有主机都有效。</li></ul><h2 id="测试连接"><a class="anchor" href="#测试连接">#</a> 测试连接</h2><p>安装就随意找教程了</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Before</span>  </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">before</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token comment">// 参数 1  --> zk server 服务 ip 地址：端口号  </span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">// 参数 2 -->  会话超时时间  </span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment">// 参数 3  --> 连接超时时间  </span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">// 参数 4  --> 序列化方式  </span></pre></td></tr><tr><td data-num="7"></td><td><pre>    zkClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZkClient</span><span class="token punctuation">(</span><span class="token string">"47.115.211.251:2181"</span><span class="token punctuation">,</span> <span class="token number">60000</span> <span class="token operator">*</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">60000</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SerializableSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="9"></td><td><pre>  </pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">private</span> <span class="token class-name">ZkClient</span> zkClient<span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="11"></td><td><pre>  </pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token annotation punctuation">@Test</span>  </pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span>  <span class="token function">test01</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>zkClient<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="16"></td><td><pre>  </pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token annotation punctuation">@After</span>  </pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">after</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="19"></td><td><pre>  </pre></td></tr><tr><td data-num="20"></td><td><pre>    zkClient<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>服务器上 start 启动后可以监听到</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>log4j:WARN Please initialize the log4j system properly.</pre></td></tr><tr><td data-num="2"></td><td><pre>log4j:WARN See http://logging.apache.org/log4j/1.2/faq.html<span class="token comment">#noconfig for more info.</span></pre></td></tr><tr><td data-num="3"></td><td><pre>org.I0Itec.zkclient.ZkClient@150c158 <span class="token comment"># 有了就成功</span></pre></td></tr></table></figure><h2 id="netty"><a class="anchor" href="#netty">#</a> Netty</h2><ol><li>Netty 是一个基于 <strong>NIO</strong> 的 client-server (客户端服务器) 框架，使用它可以快速简单地开发网络应用程序。</li><li>Netty 极大地简化并优化了 TCP 和 UDP 套接字服务器等网络编程，并且性能以及安全性等很多方面都要更好。</li><li>Netty <strong>支持多种协议</strong> 如 FTP，SMTP，HTTP 以及各种二进制和基于文本的传统协议。本文所要写的 HTTP Server 就得益于 Netty 对 HTTP 协议（超文本传输协议）的支持。</li></ol><p>首先要明确的是 Netty 主要用来做<strong>网络通信</strong> 。</p><ol><li><strong>实现框架的网络通信模块</strong> ： Netty 几乎满足任何场景的网络通信需求，因此，框架的网络通信模块可以基于 Netty 来做。拿 RPC 框架来说！ 我们在分布式系统中，不同服务节点之间经常需要相互调用，这个时候就需要 RPC 框架了。不同服务指点的通信是如何做的呢？那就可以使用 Netty 来做了！比如我调用另外一个节点的方法的话，至少是要让对方知道我调用的是哪个类中的哪个方法以及相关参数吧！</li><li><strong>实现一个自己的 HTTP 服务器</strong> ：通过 Netty ，我们可以很方便地使用少量代码实现一个简单的 HTTP 服务器。Netty 自带了编解码器和消息聚合器，为我们开发节省了很多事！</li><li><strong>实现一个即时通讯系统</strong> ： 使用 Netty 我们可以实现一个可以聊天类似微信的即时通讯系统，这方面的开源项目还蛮多的，可以自行去 Github 找一找。</li><li><strong>实现消息推送系统</strong> ：市面上有很多消息推送系统都是基于 Netty 来做的。</li><li>......</li></ol><h1 id="消息协议-编解码"><a class="anchor" href="#消息协议-编解码">#</a> 消息协议、编解码</h1><h2 id="消息协议"><a class="anchor" href="#消息协议">#</a> 消息协议</h2><p>客户端在向服务端发起调用之前，需要考虑采用何种方式将调用信息进行编码，并传输到服务端。出于对性能的考量，通信协议应该越简单越好，这样可以减少编解码的性能损耗。</p><p>大部分主流 RPC 框架会选择 TCP、HTTP 协议，出名的 gRPC 框架使用的则是 HTTP2。TCP、HTTP、HTTP2 都是稳定可靠的，但其实使用 UDP 协议也是可以的，具体看业务使用的场景。成熟的 RPC 框架如阿里开源的 Dubbo 支持各种协议。</p><h3 id="自定义协议"><a class="anchor" href="#自定义协议">#</a> 自定义协议</h3><p>自定义协议的要素：</p><ul><li>魔数，用来在第一时间判定是否是无效数据包<ul><li><strong>快速</strong> 识别字节流是否是程序能够处理的，能处理才进行后面的 <strong>耗时</strong> 业务操作，如果不能处理，尽快执行失败，断开连接等操作。</li></ul></li><li>版本号，可以支持协议的升级</li><li>序列化算法，消息正文到底采用哪种序列化反序列化方式，可以由此扩展，例如：json、protobuf、hessian、jdk、kryo</li><li>指令类型，是登录、注册、单聊、群聊... 跟业务相关</li><li>请求序号，为了双工通信，提供异步能力，通过这个请求 ID 将响应关联起来，也可以通过请求 ID 做链路追踪。</li><li>正文长度，标注传输数据内容的长度，用于判断是否是一个完整的数据包</li><li>消息正文，主要传递的消息内容</li></ul><p>简单的通信协议设计（之后默认用这个展开）</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>---------------------------------------------------------------------</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token operator">|</span> 魔数 <span class="token punctuation">(</span>4byte<span class="token punctuation">)</span> <span class="token operator">|</span> 版本号 <span class="token punctuation">(</span>1byte<span class="token punctuation">)</span>  <span class="token operator">|</span> 序列化算法 <span class="token punctuation">(</span>1byte<span class="token punctuation">)</span> <span class="token operator">|</span> 消息类型 <span class="token punctuation">(</span>1byte<span class="token punctuation">)</span> <span class="token operator">|</span></pre></td></tr><tr><td data-num="3"></td><td><pre>-------------------------------------------------------------------</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token operator">|</span>    状态类型 <span class="token punctuation">(</span>1byte<span class="token punctuation">)</span>  <span class="token operator">|</span>    消息序列号 <span class="token punctuation">(</span>4byte<span class="token punctuation">)</span>   <span class="token operator">|</span>    消息长度 <span class="token punctuation">(</span>4byte<span class="token punctuation">)</span>   <span class="token operator">|</span></pre></td></tr><tr><td data-num="5"></td><td><pre>---------------------------------------------------------------------</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token operator">|</span>                        消息内容 <span class="token punctuation">(</span>不固定<span class="token punctuation">)</span>                             <span class="token operator">|</span></pre></td></tr><tr><td data-num="7"></td><td><pre>---------------------------------------------------------------------</pre></td></tr></table></figure><h2 id="编解码"><a class="anchor" href="#编解码">#</a> 编解码</h2><p>在 netty 中我们需要传递各种类型的消息，这些 message 可以是字符串，可以是数组，也可以是自定义的对象。不同的对象之间可能需要互相转换，这样就需要一个可以自由进行转换的转换器，为了统一编码规则和方便用户的扩展，netty 提供了一套消息之间进行转换的框架： <code>io.netty.handler.codec.MessageToMessageCodec</code> ，这个类是一个用于动态编 / 解码消息的编解码器，这可以看作是 <code>MessageToMessageDecoder</code>  和  <code>MessageToMessageEncoder</code>  的组合。这个类中有两个方法， <code>encode()</code>  就是将输入的  <code>RpcMessage</code>  编码成  <code>ByteBuf</code>  ， <code>decode()</code>  就是将  <code>ByteBuf</code>  解码成  <code>RpcMessage</code> ，编码为出站操作，解码为入站操作。</p><h3 id="netty源码"><a class="anchor" href="#netty源码">#</a> netty 源码</h3><p>稍微深入了解下源码<br>netty 为消息和消息之间的转换提供了三个类，这三个类都是抽象类，分别是 MessageToMessageDecoder,MessageToMessageEncoder 和 MessageToMessageCodec。</p><ul><li>MessageToMessageEncoder 继承自 ChannelOutboundHandlerAdapter，负责向 channel 中写消息</li><li>MessageToMessageDecoder 继承自 ChannelInboundHandlerAdapter，负责从 channel 中读取消息</li><li>MessageToMessageCodec 继承自 ChannelDuplexHandler，它是一个双向的 handler，可以从 channel 中读取消息，也可以向 channel 中写入消息</li></ul><p>先看一下消息的编码器 MessageToMessageEncoder，编码器中最重要的方法就是 write, 看下 write 的实现：</p><figure class="highlight java"><figcaption data-lang="java"><span>title:MessageToMessageEncoder.write</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	<span class="token class-name">CodecOutputList</span> out <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">acceptOutboundMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>			out <span class="token operator">=</span> <span class="token class-name">CodecOutputList</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>			<span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>			<span class="token class-name">I</span> cast <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">I</span><span class="token punctuation">)</span> msg<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>			<span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>				<span class="token function">encode</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> cast<span class="token punctuation">,</span> out<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>			<span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>				<span class="token class-name">ReferenceCountUtil</span><span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span>cast<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>			<span class="token keyword">if</span> <span class="token punctuation">(</span>out<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>				<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">EncoderException</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="16"></td><td><pre>						<span class="token class-name">StringUtil</span><span class="token punctuation">.</span><span class="token function">simpleClassName</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" must produce at least one message."</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>		<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>			ctx<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>	<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">EncoderException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>		<span class="token keyword">throw</span> e<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>	<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>		<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">EncoderException</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>	<span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>		<span class="token keyword">if</span> <span class="token punctuation">(</span>out <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>			<span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>				<span class="token keyword">final</span> <span class="token keyword">int</span> sizeMinusOne <span class="token operator">=</span> out<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>				<span class="token keyword">if</span> <span class="token punctuation">(</span>sizeMinusOne <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>					ctx<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>out<span class="token punctuation">.</span><span class="token function">getUnsafe</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>				<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>sizeMinusOne <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>					<span class="token keyword">if</span> <span class="token punctuation">(</span>promise <span class="token operator">==</span> ctx<span class="token punctuation">.</span><span class="token function">voidPromise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>						<span class="token function">writeVoidPromise</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> out<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>					<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>						<span class="token function">writePromiseCombiner</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> out<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>					<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>				<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>			<span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>				out<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>write 方法接受一个需要转换的原始对象 msg，和一个表示 channel 读写进度的 ChannelPromise。首先会对 msg 进行一个类型判断，这个判断方法是在 acceptOutboundMessage 中实现的。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">acceptOutboundMessage</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	<span class="token keyword">return</span> matcher<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这里的 matcher 是一个 TypeParameterMatcher 对象，它是一个在 MessageToMessageEncoder 构造函数中初始化的属性：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">protected</span> <span class="token class-name">MessageToMessageEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	matcher <span class="token operator">=</span> <span class="token class-name">TypeParameterMatcher</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token class-name">MessageToMessageEncoder</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">"I"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这里的 I 就是要匹配的 msg 类型。</p><p>如果不匹配，则继续调用 <code>ctx.write(msg, promise);</code> 将消息不做任何转换的写入到 channel 中，供下一个 handler 调用。</p><p>如果匹配成功，则会调用核心的 encode 方法: <code>encode(ctx, cast, out);</code></p><p>注意，encode 方法在 MessageToMessageEncoder 中是一个抽象方法，需要用户在继承类中自行扩展。</p><p>encode 方法实际上是将 msg 对象转换成为要转换的对象，然后添加到 out 中。这个 out 是一个 list 对象，具体而言是一个 CodecOutputList 对象，作为一个 list，out 是一个可以存储多个对象的列表。</p><p>那么 out 是什么时候写入到 channel 中去的呢？</p><ul><li>在 write 方法中最后有一个 finally 代码块，在这个代码块中，会将 out 写入到 channel 里面。</li></ul><p>和 encoder 对应的就是 decoder 了，MessageToMessageDecoder 的逻辑和 MessageToMessageEncoder 差不多。</p><p>除了也需要判断读取的消息类型，decoder 中重要的方法是 channelRead 方法，我们看下它的实现：</p><figure class="highlight java"><figcaption data-lang="java"><span>title:MessageToMessageDecoder.channelRead</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelRead</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	<span class="token class-name">CodecOutputList</span> out <span class="token operator">=</span> <span class="token class-name">CodecOutputList</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">acceptInboundMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>			<span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>			<span class="token class-name">I</span> cast <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">I</span><span class="token punctuation">)</span> msg<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>			<span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>				<span class="token function">decode</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> cast<span class="token punctuation">,</span> out<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>			<span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>				<span class="token class-name">ReferenceCountUtil</span><span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span>cast<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>		<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>			out<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>	<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">DecoderException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>		<span class="token keyword">throw</span> e<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>	<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>		<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">DecoderException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>	<span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>		<span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>			<span class="token keyword">int</span> size <span class="token operator">=</span> out<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>			<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>				ctx<span class="token punctuation">.</span><span class="token function">fireChannelRead</span><span class="token punctuation">(</span>out<span class="token punctuation">.</span><span class="token function">getUnsafe</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>		<span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>			out<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在 finally 代码块中将 out 中的对象一个个取出来，调用 ctx.fireChannelRead 进行读取。</p><p>结合两者有 MessageToMessageCodec，也是我们需要继承并重写其 encoder 和 decoder 操作的</p><figure class="highlight java"><figcaption data-lang="java"><span>title:MessageToMessageCodec</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">MessageToMessageCodec</span><span class="token generics"><span class="token punctuation">&lt;</span>INBOUND_IN<span class="token punctuation">,</span> OUTBOUND_IN<span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">ChannelDuplexHandler</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">MessageToMessageEncoder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> encoder<span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">MessageToMessageDecoder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> decoder<span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">TypeParameterMatcher</span> inboundMsgMatcher<span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">TypeParameterMatcher</span> outboundMsgMatcher<span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="6"></td><td><pre>  </pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">protected</span> <span class="token class-name">MessageToMessageCodec</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>encoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NamelessClass_2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>decoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NamelessClass_1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>inboundMsgMatcher <span class="token operator">=</span> <span class="token class-name">TypeParameterMatcher</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token class-name">MessageToMessageCodec</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">"INBOUND_IN"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>outboundMsgMatcher <span class="token operator">=</span> <span class="token class-name">TypeParameterMatcher</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token class-name">MessageToMessageCodec</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">"OUTBOUND_IN"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="13"></td><td><pre>  </pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">protected</span> <span class="token class-name">MessageToMessageCodec</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> INBOUND_IN<span class="token punctuation">></span></span> inboundMessageType<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> OUTBOUND_IN<span class="token punctuation">></span></span> outboundMessageType<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token keyword">class</span> <span class="token class-name">NamelessClass_2</span> <span class="token keyword">extends</span> <span class="token class-name">MessageToMessageEncoder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token class-name">NamelessClass_2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="18"></td><td><pre>  </pre></td></tr><tr><td data-num="19"></td><td><pre>            <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">acceptOutboundMessage</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="20"></td><td><pre>                <span class="token keyword">return</span> <span class="token class-name">MessageToMessageCodec</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">acceptOutboundMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="22"></td><td><pre>  </pre></td></tr><tr><td data-num="23"></td><td><pre>            <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">encode</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="24"></td><td><pre>                <span class="token class-name">MessageToMessageCodec</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> out<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="25"></td><td><pre>            <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="27"></td><td><pre>  </pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>encoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NamelessClass_2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="29"></td><td><pre>  </pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token keyword">class</span> <span class="token class-name">NamelessClass_1</span> <span class="token keyword">extends</span> <span class="token class-name">MessageToMessageDecoder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="31"></td><td><pre>            <span class="token class-name">NamelessClass_1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="32"></td><td><pre>            <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="33"></td><td><pre>  </pre></td></tr><tr><td data-num="34"></td><td><pre>            <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">acceptInboundMessage</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="35"></td><td><pre>                <span class="token keyword">return</span> <span class="token class-name">MessageToMessageCodec</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">acceptInboundMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="36"></td><td><pre>            <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="37"></td><td><pre>  </pre></td></tr><tr><td data-num="38"></td><td><pre>            <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">decode</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="39"></td><td><pre>                <span class="token class-name">MessageToMessageCodec</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> out<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="40"></td><td><pre>            <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="42"></td><td><pre>  </pre></td></tr><tr><td data-num="43"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>decoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NamelessClass_1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>inboundMsgMatcher <span class="token operator">=</span> <span class="token class-name">TypeParameterMatcher</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>inboundMessageType<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="45"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>outboundMsgMatcher <span class="token operator">=</span> <span class="token class-name">TypeParameterMatcher</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>outboundMessageType<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="47"></td><td><pre>  </pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelRead</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="49"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>decoder<span class="token punctuation">.</span><span class="token function">channelRead</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="51"></td><td><pre>  </pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="53"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>encoder<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="54"></td><td><pre>    <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="55"></td><td><pre>  </pre></td></tr><tr><td data-num="56"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">acceptInboundMessage</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="57"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>inboundMsgMatcher<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="59"></td><td><pre>  </pre></td></tr><tr><td data-num="60"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">acceptOutboundMessage</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="61"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>outboundMsgMatcher<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="62"></td><td><pre>    <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="63"></td><td><pre>  </pre></td></tr><tr><td data-num="64"></td><td><pre>    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">encode</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> var1<span class="token punctuation">,</span> <span class="token class-name">OUTBOUND_IN</span> var2<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> var3<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="65"></td><td><pre>  </pre></td></tr><tr><td data-num="66"></td><td><pre>    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">decode</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> var1<span class="token punctuation">,</span> <span class="token class-name">INBOUND_IN</span> var2<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> var3<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="67"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><ul><li>定义了两个 TypeParameterMatcher，分别用来过滤 inboundMsg 和 outboundMsg</li><li>分别实现了 channelRead 和 write 方法，用来读写消息</li><li>里面的 decoder 和 encoder 实际上就是前面讲到的 MessageToMessageDecoder 和 MessageToMessageEncoder</li><li>要处理的就是 Override <code>decoder</code> 和 <code>encoder</code></li></ul><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 编码器为出站处理，将自定义的消息协议类 & lt; 如后面要实现的 RpcMessage> 编码为 ByteBuf 对象</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@Override</span>  </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">encode</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">RpcMessage</span> msg<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token class-name">ByteBuf</span> buf <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token comment">// 通过 buff 将 RpcMessage 中的信息转码</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token comment">// 传递给 out，后面封装好的操作还不了解</span></pre></td></tr><tr><td data-num="8"></td><td><pre>	out<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment">// 解码器为入站处理，将 ByteBuf 对象解码成 RpcMessage 对象  </span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token annotation punctuation">@Override</span>  </pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">decode</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">ByteBuf</span> msg<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>	<span class="token comment">// 将 buff 转码回原来的信息</span></pre></td></tr><tr><td data-num="16"></td><td><pre>	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="17"></td><td><pre>	<span class="token comment">// 再将这些信息封装回自定义的消息协议类</span></pre></td></tr><tr><td data-num="18"></td><td><pre>	<span class="token class-name">RpcMessage</span> protocol <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RpcMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="20"></td><td><pre>	<span class="token comment">// 传递到下一个处理器  </span></pre></td></tr><tr><td data-num="21"></td><td><pre>	out<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>protocol<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><ul><li><code>ByteBuf</code> 是 netty 的 Server 与 Client 之间通信的数据传输载体 (Netty 的数据容器)，它提供了一个 byte 数组 (byte []) 的抽象视图，既解决了 JDK API 的局限性，又为网络应用程序的开发者提供了更好的 API</li></ul><h3 id="自定义实现"><a class="anchor" href="#自定义实现">#</a> 自定义实现</h3><p>暂用参考的，等全部梳理完，自己搭个再替换掉</p><figure class="highlight java"><figcaption data-lang="java"><span>title:SharableRpcMessageCodec</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>wxy<span class="token punctuation">.</span>rpc<span class="token punctuation">.</span>core<span class="token punctuation">.</span>codec</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="2"></td><td><pre>  </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>wxy<span class="token punctuation">.</span>rpc<span class="token punctuation">.</span>core<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">RpcRequest</span></span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>wxy<span class="token punctuation">.</span>rpc<span class="token punctuation">.</span>core<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">RpcResponse</span></span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>wxy<span class="token punctuation">.</span>rpc<span class="token punctuation">.</span>core<span class="token punctuation">.</span>constant<span class="token punctuation">.</span></span><span class="token class-name">ProtocolConstants</span></span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>wxy<span class="token punctuation">.</span>rpc<span class="token punctuation">.</span>core<span class="token punctuation">.</span>enums<span class="token punctuation">.</span></span><span class="token class-name">MessageType</span></span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>wxy<span class="token punctuation">.</span>rpc<span class="token punctuation">.</span>core<span class="token punctuation">.</span>enums<span class="token punctuation">.</span></span><span class="token class-name">SerializationType</span></span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>wxy<span class="token punctuation">.</span>rpc<span class="token punctuation">.</span>core<span class="token punctuation">.</span>protocol<span class="token punctuation">.</span></span><span class="token class-name">MessageHeader</span></span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>wxy<span class="token punctuation">.</span>rpc<span class="token punctuation">.</span>core<span class="token punctuation">.</span>protocol<span class="token punctuation">.</span></span><span class="token class-name">RpcMessage</span></span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>wxy<span class="token punctuation">.</span>rpc<span class="token punctuation">.</span>core<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span></span><span class="token class-name">Serialization</span></span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>wxy<span class="token punctuation">.</span>rpc<span class="token punctuation">.</span>core<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span></span><span class="token class-name">SerializationFactory</span></span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>buffer<span class="token punctuation">.</span></span><span class="token class-name">ByteBuf</span></span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>channel<span class="token punctuation">.</span></span><span class="token class-name">ChannelHandler</span><span class="token punctuation">.</span><span class="token class-name">Sharable</span></span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>channel<span class="token punctuation">.</span></span><span class="token class-name">ChannelHandlerContext</span></span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>handler<span class="token punctuation">.</span>codec<span class="token punctuation">.</span></span><span class="token class-name">MessageToMessageCodec</span></span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="16"></td><td><pre>  </pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Arrays</span></span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="19"></td><td><pre>  </pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token doc-comment comment">/**  </span></pre></td></tr><tr><td data-num="21"></td><td><pre> * 可共享的 Rpc 消息编码解码器，使用此编解码器必须配合 <span class="token punctuation">&#123;</span>RpcFrameDecoder<span class="token punctuation">&#125;</span> 进行使用，  </pre></td></tr><tr><td data-num="22"></td><td><pre> * 以保证得到完整的数据包。不同于 <span class="token punctuation">&#123;</span><span class="token keyword">@link</span> <span class="token reference"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>handler<span class="token punctuation">.</span>codec<span class="token punctuation">.</span></span><span class="token class-name">ByteToMessageCodec</span></span><span class="token punctuation">&#125;</span> 的编解码器，共享编解码器无需  </pre></td></tr><tr><td data-num="23"></td><td><pre> * 保存 ByteBuf 的状态信息。  </pre></td></tr><tr><td data-num="24"></td><td><pre> */<span class="token annotation punctuation">@Sharable</span>  </pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SharableRpcMessageCodec</span> <span class="token keyword">extends</span> <span class="token class-name">MessageToMessageCodec</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ByteBuf</span><span class="token punctuation">,</span> <span class="token class-name">RpcMessage</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="26"></td><td><pre>  </pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token comment">// 编码器为出站处理，将 RpcMessage 编码为 ByteBuf 对象  </span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token annotation punctuation">@Override</span>  </pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">encode</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">RpcMessage</span> msg<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token class-name">ByteBuf</span> buf <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token class-name">MessageHeader</span> header <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token comment">// 4 字节 魔数  </span></pre></td></tr><tr><td data-num="33"></td><td><pre>        buf<span class="token punctuation">.</span><span class="token function">writeBytes</span><span class="token punctuation">(</span>header<span class="token punctuation">.</span><span class="token function">getMagicNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token comment">// 1 字节 版本号  </span></pre></td></tr><tr><td data-num="35"></td><td><pre>        buf<span class="token punctuation">.</span><span class="token function">writeByte</span><span class="token punctuation">(</span>header<span class="token punctuation">.</span><span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token comment">// 1 字节 序列化算法  </span></pre></td></tr><tr><td data-num="37"></td><td><pre>        buf<span class="token punctuation">.</span><span class="token function">writeByte</span><span class="token punctuation">(</span>header<span class="token punctuation">.</span><span class="token function">getSerializerType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token comment">// 1 字节 消息类型  </span></pre></td></tr><tr><td data-num="39"></td><td><pre>        buf<span class="token punctuation">.</span><span class="token function">writeByte</span><span class="token punctuation">(</span>header<span class="token punctuation">.</span><span class="token function">getMessageType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token comment">// 1 字节 消息状态  </span></pre></td></tr><tr><td data-num="41"></td><td><pre>        buf<span class="token punctuation">.</span><span class="token function">writeByte</span><span class="token punctuation">(</span>header<span class="token punctuation">.</span><span class="token function">getMessageStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token comment">// 4 字节 消息序列号  </span></pre></td></tr><tr><td data-num="43"></td><td><pre>        buf<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span>header<span class="token punctuation">.</span><span class="token function">getSequenceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="44"></td><td><pre>  </pre></td></tr><tr><td data-num="45"></td><td><pre>        <span class="token comment">// 取出消息体  </span></pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token class-name">Object</span> body <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token comment">// 获取序列化算法  </span></pre></td></tr><tr><td data-num="48"></td><td><pre>        <span class="token class-name">Serialization</span> serialization <span class="token operator">=</span> <span class="token class-name">SerializationFactory</span>  </pre></td></tr><tr><td data-num="49"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">getSerialization</span><span class="token punctuation">(</span><span class="token class-name">SerializationType</span><span class="token punctuation">.</span><span class="token function">parseByType</span><span class="token punctuation">(</span>header<span class="token punctuation">.</span><span class="token function">getSerializerType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="50"></td><td><pre>        <span class="token comment">// 进行序列化  </span></pre></td></tr><tr><td data-num="51"></td><td><pre>        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> serialization<span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="52"></td><td><pre>        <span class="token comment">// 设置消息体长度  </span></pre></td></tr><tr><td data-num="53"></td><td><pre>        header<span class="token punctuation">.</span><span class="token function">setLength</span><span class="token punctuation">(</span>bytes<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="54"></td><td><pre>  </pre></td></tr><tr><td data-num="55"></td><td><pre>        <span class="token comment">// 4 字节 消息内容长度  </span></pre></td></tr><tr><td data-num="56"></td><td><pre>        buf<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span>header<span class="token punctuation">.</span><span class="token function">getLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="57"></td><td><pre>  </pre></td></tr><tr><td data-num="58"></td><td><pre>        <span class="token comment">// 不固定字节 消息内容字节数组  </span></pre></td></tr><tr><td data-num="59"></td><td><pre>        buf<span class="token punctuation">.</span><span class="token function">writeBytes</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="60"></td><td><pre>  </pre></td></tr><tr><td data-num="61"></td><td><pre>        <span class="token comment">// 传递到下一个出站处理器  </span></pre></td></tr><tr><td data-num="62"></td><td><pre>        out<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="63"></td><td><pre>    <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="64"></td><td><pre>  </pre></td></tr><tr><td data-num="65"></td><td><pre>    <span class="token comment">// 解码器为入站处理，将 ByteBuf 对象解码成 RpcMessage 对象  </span></pre></td></tr><tr><td data-num="66"></td><td><pre>    <span class="token annotation punctuation">@Override</span>  </pre></td></tr><tr><td data-num="67"></td><td><pre>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">decode</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">ByteBuf</span> msg<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="68"></td><td><pre>        <span class="token comment">// 4 字节 魔数  </span></pre></td></tr><tr><td data-num="69"></td><td><pre>        <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token class-name">ProtocolConstants</span><span class="token punctuation">.</span><span class="token constant">MAGIC_NUM</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="70"></td><td><pre>        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> magicNum <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span>len<span class="token punctuation">]</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="71"></td><td><pre>        msg<span class="token punctuation">.</span><span class="token function">readBytes</span><span class="token punctuation">(</span>magicNum<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="72"></td><td><pre>        <span class="token comment">// 判断魔数是否正确，不正确表示非协议请求，不进行处理  </span></pre></td></tr><tr><td data-num="73"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="74"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>magicNum<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token class-name">ProtocolConstants</span><span class="token punctuation">.</span><span class="token constant">MAGIC_NUM</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="75"></td><td><pre>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Unknown magic code: "</span> <span class="token operator">+</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>magicNum<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="76"></td><td><pre>            <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="77"></td><td><pre>        <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="78"></td><td><pre>  </pre></td></tr><tr><td data-num="79"></td><td><pre>        <span class="token comment">// 1 字节 版本号  </span></pre></td></tr><tr><td data-num="80"></td><td><pre>        <span class="token keyword">byte</span> version <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">readByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="81"></td><td><pre>        <span class="token comment">// 检查版本号是否一致  </span></pre></td></tr><tr><td data-num="82"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>version <span class="token operator">!=</span> <span class="token class-name">ProtocolConstants</span><span class="token punctuation">.</span><span class="token constant">VERSION</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="83"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"The version isn't compatible "</span> <span class="token operator">+</span> version<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="84"></td><td><pre>        <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="85"></td><td><pre>  </pre></td></tr><tr><td data-num="86"></td><td><pre>        <span class="token comment">// 1 字节 序列化算法  </span></pre></td></tr><tr><td data-num="87"></td><td><pre>        <span class="token keyword">byte</span> serializeType <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">readByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="88"></td><td><pre>        <span class="token comment">// 1 字节 消息类型  </span></pre></td></tr><tr><td data-num="89"></td><td><pre>        <span class="token keyword">byte</span> messageType <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">readByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="90"></td><td><pre>        <span class="token comment">// 1 字节 消息状态  </span></pre></td></tr><tr><td data-num="91"></td><td><pre>        <span class="token keyword">byte</span> messageStatus <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">readByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="92"></td><td><pre>        <span class="token comment">// 4 字节 消息序列号  </span></pre></td></tr><tr><td data-num="93"></td><td><pre>        <span class="token keyword">int</span> sequenceId <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="94"></td><td><pre>        <span class="token comment">// 4 字节 长度  </span></pre></td></tr><tr><td data-num="95"></td><td><pre>        <span class="token keyword">int</span> length <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="96"></td><td><pre>  </pre></td></tr><tr><td data-num="97"></td><td><pre>        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="98"></td><td><pre>        msg<span class="token punctuation">.</span><span class="token function">readBytes</span><span class="token punctuation">(</span>bytes<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="99"></td><td><pre>  </pre></td></tr><tr><td data-num="100"></td><td><pre>        <span class="token comment">// 构建协议头部信息  </span></pre></td></tr><tr><td data-num="101"></td><td><pre>        <span class="token class-name">MessageHeader</span> header <span class="token operator">=</span> <span class="token class-name">MessageHeader</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  </pre></td></tr><tr><td data-num="102"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">magicNum</span><span class="token punctuation">(</span>magicNum<span class="token punctuation">)</span>  </pre></td></tr><tr><td data-num="103"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">version</span><span class="token punctuation">(</span>version<span class="token punctuation">)</span>  </pre></td></tr><tr><td data-num="104"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">serializerType</span><span class="token punctuation">(</span>serializeType<span class="token punctuation">)</span>  </pre></td></tr><tr><td data-num="105"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">messageType</span><span class="token punctuation">(</span>messageType<span class="token punctuation">)</span>  </pre></td></tr><tr><td data-num="106"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">sequenceId</span><span class="token punctuation">(</span>sequenceId<span class="token punctuation">)</span>  </pre></td></tr><tr><td data-num="107"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">messageStatus</span><span class="token punctuation">(</span>messageStatus<span class="token punctuation">)</span>  </pre></td></tr><tr><td data-num="108"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="109"></td><td><pre>  </pre></td></tr><tr><td data-num="110"></td><td><pre>        <span class="token comment">// 获取反序列化算法  </span></pre></td></tr><tr><td data-num="111"></td><td><pre>        <span class="token class-name">Serialization</span> serialization <span class="token operator">=</span> <span class="token class-name">SerializationFactory</span>  </pre></td></tr><tr><td data-num="112"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">getSerialization</span><span class="token punctuation">(</span><span class="token class-name">SerializationType</span><span class="token punctuation">.</span><span class="token function">parseByType</span><span class="token punctuation">(</span>serializeType<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="113"></td><td><pre>        <span class="token comment">// 获取消息枚举类型  </span></pre></td></tr><tr><td data-num="114"></td><td><pre>        <span class="token class-name">MessageType</span> type <span class="token operator">=</span> <span class="token class-name">MessageType</span><span class="token punctuation">.</span><span class="token function">parseByType</span><span class="token punctuation">(</span>messageType<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="115"></td><td><pre>        <span class="token class-name">RpcMessage</span> protocol <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RpcMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="116"></td><td><pre>        protocol<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span>header<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="117"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> <span class="token class-name">MessageType</span><span class="token punctuation">.</span><span class="token constant">REQUEST</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="118"></td><td><pre>            <span class="token comment">// 进行反序列化  </span></pre></td></tr><tr><td data-num="119"></td><td><pre>            <span class="token class-name">RpcRequest</span> request <span class="token operator">=</span> serialization<span class="token punctuation">.</span><span class="token function">deserialize</span><span class="token punctuation">(</span><span class="token class-name">RpcRequest</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="120"></td><td><pre>            protocol<span class="token punctuation">.</span><span class="token function">setBody</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="121"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> <span class="token class-name">MessageType</span><span class="token punctuation">.</span><span class="token constant">RESPONSE</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="122"></td><td><pre>            <span class="token comment">// 进行反序列化  </span></pre></td></tr><tr><td data-num="123"></td><td><pre>            <span class="token class-name">RpcResponse</span> response <span class="token operator">=</span> serialization<span class="token punctuation">.</span><span class="token function">deserialize</span><span class="token punctuation">(</span><span class="token class-name">RpcResponse</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="124"></td><td><pre>            protocol<span class="token punctuation">.</span><span class="token function">setBody</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="125"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> <span class="token class-name">MessageType</span><span class="token punctuation">.</span><span class="token constant">HEARTBEAT_REQUEST</span> <span class="token operator">||</span> type <span class="token operator">==</span> <span class="token class-name">MessageType</span><span class="token punctuation">.</span><span class="token constant">HEARTBEAT_RESPONSE</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="126"></td><td><pre>            <span class="token class-name">String</span> message <span class="token operator">=</span> serialization<span class="token punctuation">.</span><span class="token function">deserialize</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="127"></td><td><pre>            protocol<span class="token punctuation">.</span><span class="token function">setBody</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="128"></td><td><pre>        <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="129"></td><td><pre>        <span class="token comment">// 传递到下一个处理器  </span></pre></td></tr><tr><td data-num="130"></td><td><pre>        out<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="131"></td><td><pre>    <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="132"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="可能存在的问题"><a class="anchor" href="#可能存在的问题">#</a> 可能存在的问题</h3><blockquote><p>现象分析</p></blockquote><p><strong>粘包</strong></p><ul><li>现象，发送 abc def，接收 abcdef</li><li>原因<ul><li>应用层：接收方 ByteBuf 设置太大（Netty 默认 1024）</li><li>滑动窗口：假设发送方 256 bytes 表示一个完整报文，但由于接收方处理不及时且窗口大小足够大，这 256 bytes 字节就会缓冲在接收方的滑动窗口中，当滑动窗口中缓冲了多个报文就会粘包</li><li>Nagle 算法： TCP 协议如果发送的网络数据包太小，那么他本身会启用 Nagle 算法（可配置是否启用）对较小的数据包进行合并</li></ul></li></ul><p>举个例子理解：<br><img data-src="https://pic3.zhimg.com/80/v2-ef77947c1c0c490369f8ce0c3cca3c1a_720w.webp" alt=""><br>假设客户端分别发送了两个数据包 D1 和 D2 给服务端，由于服务端一次读取到的字节数是不确定的，故可能存在以下 4 种情况。</p><ul><li>服务端分两次读取到了两个独立的数据包，分别是 D1 和 D2，没有粘包和拆包；</li><li>服务端一次接收到了两个数据包，D1 和 D2 粘合在一起，被称为 TCP 粘包；</li><li>服务端分两次读取到了两个数据包，第一次读取到了完整的 D1 包和 D2 包的部分内容，第二次读取到了 D2 包的剩余内容，这被称为 TCP 拆包；</li><li>服务端分两次读取到了两个数据包，第一次读取到了 D1 包的部分内容 D1_1，第二次读取到了 D1 包的剩余内容 D1_2 和 D2 包的整包。</li></ul><p>如果此时服务端 TCP 接收滑窗非常小，而数据包 D1 和 D2 比较大，很有可能会发生第五种可能，即服务端分多次才能将 D1 和 D2 包接收完全，期间发生多次拆包。</p><p><strong>半 / 拆包</strong></p><ul><li>现象，发送 abcdef，接收 abc def</li><li>原因<ul><li>应用层：接收方 ByteBuf 小于实际发送数据量</li><li>滑动窗口：假设接收方的窗口只剩了 128 bytes，发送方的报文大小是 256 bytes，这时放不下了，只能先发送前 128 bytes，等待 ack 后才能发送剩余部分，这就造成了半包</li><li>MSS 限制：当发送的数据超过 MSS 限制后，会将数据切分发送，就会造成半包。MSS 是 TCP 报文段中的数据字段的最大长度。数据字段加上 TCP 首部才等于整个的 TCP 报文段。所以 MSS 并不是 TCP 报文段的最大长度，而是：MSS=TCP 报文段长度 - TCP 首部长</li></ul></li></ul><p>本质是因为 TCP 是流式协议，消息无边界</p><blockquote><p>解决方案</p></blockquote><p>由于底层的 TCP 无法理解上层的业务数据，所以在底层是无法保证数据包不被拆分和重组的，这个问题只能通过上层的应用协议栈设计来解决</p><ul><li>短连接：发一次数据包建立一次连接，这样连接建立到连接断开之间就是一次消息边界，缺点是效率低；</li><li>固定长度：每一条消息采用固定长度，如果不够，空位补空格，缺点是浪费空间；</li><li>分隔符：每一条消息采用分隔符，例如 <code>\n</code> ，缺点是需要转义；</li><li>将消息分为消息头和消息体：每一条消息分为 header 和 body，header 中包含 body 的长度（推荐）；类似与第二条，只是我们按照头部的 content-length 长度进行定长解码。</li></ul><p>本项目采取的是 <strong>消息头和消息体</strong> 来解决的半包问题，主要实现类为  <code>com.wxy.rpc.core.codec.RpcFrameDecoder</code>  ，这个类继承了 netty 中的  <code>io.netty.handler.codec.LengthFieldBasedFrameDecoder</code>  类，这个类是一种解码器，根据消息中长度字段的值动态拆分接收到的 ByteBufs。</p><p>在发送消息前，先约定用定长字节表示接下来数据的长度：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 最大长度，长度偏移，长度占用字节，长度调整，剥离字节数</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LengthFieldBasedFrameDecoder</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token doc-comment comment">/**</span></pre></td></tr><tr><td data-num="4"></td><td><pre>     * Creates a new instance.</pre></td></tr><tr><td data-num="5"></td><td><pre>     *</pre></td></tr><tr><td data-num="6"></td><td><pre>     * <span class="token keyword">@param</span> <span class="token parameter">maxFrameLength</span> 		帧的最大长度（单位为字节，下同）</pre></td></tr><tr><td data-num="7"></td><td><pre>     * <span class="token keyword">@param</span> <span class="token parameter">lengthFieldOffset</span> 	长度字段的偏移长度（这里的长度字段就是 消息长度字段）</pre></td></tr><tr><td data-num="8"></td><td><pre>     * <span class="token keyword">@param</span> <span class="token parameter">lengthFieldLength</span> 	长度字段的长度</pre></td></tr><tr><td data-num="9"></td><td><pre>     * <span class="token keyword">@param</span> <span class="token parameter">lengthAdjustment</span>  	要添加到长度字段值的补偿值</pre></td></tr><tr><td data-num="10"></td><td><pre>     * <span class="token keyword">@param</span> <span class="token parameter">initialBytesToStrip</span> 	从解码帧中取出的第一个字节数</pre></td></tr><tr><td data-num="11"></td><td><pre>     */</pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">LengthFieldBasedFrameDecoder</span><span class="token punctuation">(</span><span class="token keyword">int</span> maxFrameLength<span class="token punctuation">,</span> <span class="token keyword">int</span> lengthFieldOffset<span class="token punctuation">,</span> <span class="token keyword">int</span> lengthFieldLength<span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="13"></td><td><pre>                                        <span class="token keyword">int</span> lengthAdjustment<span class="token punctuation">,</span> <span class="token keyword">int</span> initialBytesToStrip<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">(</span>maxFrameLength<span class="token punctuation">,</span> lengthFieldOffset<span class="token punctuation">,</span> lengthFieldLength<span class="token punctuation">,</span> lengthAdjustment<span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="15"></td><td><pre>             initialBytesToStrip<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3RoaW5raW5nX2Zpb2EvYXJ0aWNsZS9kZXRhaWxzLzgwNTczNDgz">详细的参数说明 + 举例</span></p><p>所以，按照我们定义的消息协议，只需要创建一个  <code>new LengthFiledBasedFrameDecoder(1024, 12, 4, 0)</code>  的帧解码器就可以解决粘包半包问题了。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RpcFrameDecoder</span> <span class="token keyword">extends</span> <span class="token class-name">LengthFieldBasedFrameDecoder</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="2"></td><td><pre>  </pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token doc-comment comment">/**  </span></pre></td></tr><tr><td data-num="4"></td><td><pre>     * 得到当前约定协议的帧解码器，  </pre></td></tr><tr><td data-num="5"></td><td><pre>     * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pre</span><span class="token punctuation">></span></span><span class="token punctuation">&#123;</span><span class="token keyword">@code</span>  </pre></td></tr><tr><td data-num="6"></td><td><pre>     <span class="token code-section">*    <span class="token code language-java"><span class="token class-name"><span class="token namespace">this<span class="token punctuation">.</span></span>RpcFrameDecoder</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>  </span></span></pre></td></tr><tr><td data-num="7"></td><td><pre>     * <span class="token punctuation">&#125;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pre</span><span class="token punctuation">></span></span>  </pre></td></tr><tr><td data-num="8"></td><td><pre>     * 引用：<span class="token punctuation">&#123;</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">RpcFrameDecoder</span><span class="token punctuation">#</span><span class="token function">RpcFrameDecoder</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span></span><span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="9"></td><td><pre>     */    </pre></td></tr><tr><td data-num="10"></td><td><pre>     <span class="token keyword">public</span> <span class="token class-name">RpcFrameDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="11"></td><td><pre>  </pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token doc-comment comment">/**  </span></pre></td></tr><tr><td data-num="13"></td><td><pre>     * 构造方法  </pre></td></tr><tr><td data-num="14"></td><td><pre>     *  </pre></td></tr><tr><td data-num="15"></td><td><pre>     * <span class="token keyword">@param</span> <span class="token parameter">maxFrameLength</span>    数据帧的最大长度  </pre></td></tr><tr><td data-num="16"></td><td><pre>     * <span class="token keyword">@param</span> <span class="token parameter">lengthFieldOffset</span> 长度域的偏移字节数，或者说：定义长度域位于发送的字节数组中的下标，即发送的字节数组中下标为$<span class="token punctuation">&#123;</span>lengthFieldOffset<span class="token punctuation">&#125;</span>的地方是长度域的开始地方</pre></td></tr><tr><td data-num="17"></td><td><pre>     * <span class="token keyword">@param</span> <span class="token parameter">lengthFieldLength</span> 长度域所占的字节数，即发送字节数组bytes时, 字节数组bytes[lengthFieldOffset, lengthFieldOffset+lengthFieldLength]域对应于的定义长度域部分</pre></td></tr><tr><td data-num="18"></td><td><pre>     */  </pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">RpcFrameDecoder</span><span class="token punctuation">(</span><span class="token keyword">int</span> maxFrameLength<span class="token punctuation">,</span> <span class="token keyword">int</span> lengthFieldOffset<span class="token punctuation">,</span> <span class="token keyword">int</span> lengthFieldLength<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token keyword">super</span><span class="token punctuation">(</span>maxFrameLength<span class="token punctuation">,</span> lengthFieldOffset<span class="token punctuation">,</span> lengthFieldLength<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="22"></td><td><pre>  </pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><ol><li>LengthFieldBasedFrameDecoder 本质上是 ChannelHandler，一个处理入站事件的 ChannelHandler</li><li>LengthFieldBasedFrameDecoder 需要加入 ChannelPipeline 中，且位于链的头部</li></ol><h1 id="序列化算法"><a class="anchor" href="#序列化算法">#</a> 序列化算法</h1><p>所谓序列化和反序列化就是将对象转换成二进制流以及将二进制流再转换成对象的过程。因为网络通信依赖于字节流，而且这些请求信息都是不确定的，所以一般会选用通用且高效的序列化算法。比较常用的序列化算法有 FastJson、Kryo、Hessian、Protobuf 等，这些第三方序列化算法都比 Java 原生的序列化操作都更加高效。Dubbo 支持多种序列化算法，并定义了 Serialization 接口规范，所有序列化算法扩展都必须实现该接口，其中默认使用的是 Hessian 序列化算法。</p><p>序列化对于远程调用的响应速度、吞吐量、网络带宽消耗等同样也起着至关重要的作用，是我们提升分布式系统性能的最关键因素之一。</p><p>判断一个编码框架的优劣主要从以下几个方面：</p><ol><li>是否支持跨语言，支持语种是否丰富</li><li>编码后的码流</li><li>编解码的性能</li><li>类库是否小巧，API 使用是否方便</li><li>使用者开发的工作量和难度</li></ol><p>本项目实现了五种序列化算法，分别是：</p><p><strong>JDK、JSON、HESSIAN、KRYO 、PROTOSTUFF</strong>，其中 JSON 使用的是 Gson 实现，此外还可以使用 FastJson、Jackson 等实现 JSON 序列化。</p><table><thead><tr><th>序列化算法</th><th><strong>优点</strong></th><th><strong>缺点</strong></th></tr></thead><tbody><tr><td><strong>Kryo</strong></td><td>速度快，序列化后体积小</td><td>跨语言支持较复杂</td></tr><tr><td><strong>Hessian</strong></td><td>默认支持跨语言</td><td>较慢</td></tr><tr><td><strong>Protostuff</strong></td><td>速度快，基于 protobuf</td><td>需静态编译</td></tr><tr><td><strong>Json</strong></td><td>使用方便</td><td>性能一般</td></tr><tr><td><strong>Jdk</strong></td><td>使用方便，可序列化所有类</td><td>速度慢，占空间</td></tr></tbody></table><h1 id="动态代理"><a class="anchor" href="#动态代理">#</a> 动态代理</h1><p>RPC 框架怎么做到像调用本地接口一样调用远端服务呢？这必须依赖动态代理来实现。需要创建一个代理对象，在代理对象中完成数据报文编码，然后发起调用发送数据给服务提供方，以此屏蔽 RPC 框架的调用细节。因为代理类是在运行时生成的，所以代理类的生成速度、生成的字节码大小都会影响 RPC 框架整体的性能和资源消耗，所以需要慎重选择动态代理的实现方案。动态代理比较主流的实现方案有以下几种：JDK 动态代理、Cglib、Javassist、ASM、Byte Buddy，我们简单做一个对比和介绍。</p><ul><li>JDK 动态代理。在运行时可以动态创建代理类，但是 JDK 动态代理的功能比较局限，代理对象必须实现一个接口，否则抛出异常。因为代理类会继承 Proxy 类，然而 Java 是不支持多重继承的，只能通过接口实现多态。JDK 动态代理所生成的代理类是接口的实现类，不能代理接口中不存在的方法。JDK 动态代理是通过反射调用的形式代理类中的方法，比直接调用肯定是性能要慢的。</li><li>Cglib 动态代理。Cglib 是基于 ASM 字节码生成框架实现的，通过字节码技术生成的代理类，所以代理类的类型是不受限制的。而且 Cglib 生成的代理类是继承于被代理类，所以可以提供更加灵活的功能。在代理方法方面，Cglib 是有优势的，它采用了 FastClass 机制，为代理类和被代理类各自创建一个 Class，这个 Class 会为代理类和被代理类的方法分配 index 索引，FastClass 就可以通过 index 直接定位要调用的方法，并直接调用，这是一种空间换时间的优化思路。</li><li>Javassist 和 ASM。二者都是 Java 字节码操作框架，使用起来难度较大，需要开发者对 Class 文件结构以及 JVM 都有所了解，但是它们都比反射的性能要高。Byte Buddy 也是一个字节码生成和操作的类库，Byte Buddy 功能强大，相比于 Javassist 和 ASM，Byte Buddy 提供了更加便捷的 API，用于创建和修改 Java 类，无须理解字节码的格式，而且 Byte Buddy 更加轻量，性能更好。</li></ul><p>本项目实现了 【JDK 动态代理】 和 【CGLIB 动态代理】。</p><h1 id="服务注册与发现"><a class="anchor" href="#服务注册与发现">#</a> 服务注册与发现</h1><p>在分布式系统中，不同服务之间应该如何通信呢？传统的方式可以通过 HTTP 请求调用、保存服务端的服务列表等，这样做需要开发者主动感知到服务端暴露的信息，系统之间耦合严重。为了更好地将客户端和服务端解耦，以及实现服务优雅上线和下线，于是注册中心就出现了。</p><p>在 RPC 框架中，主要是使用注册中心来实现服务注册和发现的功能。服务端节点上线后自行向注册中心注册服务列表，节点下线时需要从注册中心将节点元数据信息移除。客户端向服务端发起调用时，自己负责从注册中心获取服务端的服务列表，然后在通过负载均衡算法选择其中一个服务节点进行调用。以上是最简单直接的服务端和客户端的发布和订阅模式，不需要再借助任何中间服务器，性能损耗也是最小的。</p><p>现在思考一个问题，服务在下线时需要从注册中心移除元数据，那么注册中心怎么才能感知到服务下线呢？我们最先想到的方法就是节点主动通知的实现方式，当节点需要下线时，向注册中心发送下线请求，让注册中心移除自己的元数据信息。但是如果节点异常退出，例如断网、进程崩溃等，那么注册中心将会一直残留异常节点的元数据，从而可能造成服务调用出现问题。</p><p>为了避免上述问题，实现服务优雅下线比较好的方式是采用主动通知 + 心跳检测的方案。除了主动通知注册中心下线外，还需要增加节点与注册中心的心跳检测功能，这个过程也叫作探活。心跳检测可以由节点或者注册中心负责，例如注册中心可以向服务节点每 60s 发送一次心跳包，如果 3 次心跳包都没有收到请求结果，可以任务该服务节点已经下线。</p><p>由此可见，采用注册中心的好处是可以解耦客户端和服务端之间错综复杂的关系，并且能够实现对服务的动态管理。服务配置可以支持动态修改，然后将更新后的配置推送到客户端和服务端，无须重启任何服务。</p><p>本项目用的就是依赖知识章节中的 <a href="#Zookeeper">Zookeeper</a> ，此外还可以考虑引入 Nacos、Redis 等实现服务注册于发现功能</p><h1 id="rpc调用方式"><a class="anchor" href="#rpc调用方式">#</a> RPC 调用方式</h1><h2 id="概述"><a class="anchor" href="#概述">#</a> 概述</h2><p>成熟的 RPC 框架一般会提供四种调用方式，分别为同步 Sync、异步 Future、回调 Callback 和单向 Oneway。RPC 框架的性能和吞吐量与合理使用调用方式是息息相关的，下面我们逐一介绍下四种调用方式的实现原理。</p><ul><li><p>Sync 同步调用。客户端线程发起 RPC 调用后，当前线程会一直阻塞，直至服务端返回结果或者处理超时异常。Sync 同步调用一般是 RPC 框架默认的调用方式，为了保证系统可用性，客户端设置合理的超时时间是非常重要的。虽说 Sync 是同步调用，但是客户端线程和服务端线程并不是同一个线程，实际在 RPC 框架内部还是异步处理的。Sync 同步调用的过程如下图所示<br><img data-src="https://github.com/viego1999/wxy-rpc/raw/master/images/Sync%E5%90%8C%E6%AD%A5%E8%B0%83%E7%94%A8.png" alt=""></p></li><li><p>Future 异步调用。客户端发起调用后不会再阻塞等待，而是拿到 RPC 框架返回的 Future 对象 (Future 对象封装了检查计算是否完成、检索计算的结果的方法、Callable 任务可以拿到一个 Future 对象)，调用结果会被服务端缓存，客户端自行决定后续何时获取返回结果。当客户端主动获取结果时，该过程是阻塞等待的。Future 异步调用过程如下图所示。<br><img data-src="https://github.com/viego1999/wxy-rpc/raw/master/images/Future%E5%BC%82%E6%AD%A5%E8%B0%83%E7%94%A8.png" alt=""></p></li><li><p>Callback 回调调用。如下图所示，客户端发起调用时，将 Callback 对象传递给 RPC 框架，无须同步等待返回结果，直接返回。当获取到服务端响应结果或者超时异常后，再执行用户注册的 Callback 回调。所以 Callback 接口一般包含 onResponse 和 onException 两个方法，分别对应成功返回和异常返回两种情况。<br><img data-src="https://github.com/viego1999/wxy-rpc/raw/master/images/Callback%E5%9B%9E%E8%B0%83%E8%B0%83%E7%94%A8.png" alt=""></p></li><li><p>Oneway 单向调用。客户端发起请求之后直接返回，忽略返回结果。Oneway 方式是最简单的，具体调用过程如下图所示。<br><img data-src="https://github.com/viego1999/wxy-rpc/raw/master/images/Onway%E5%8D%95%E5%90%91%E8%B0%83%E7%94%A8.png" alt=""></p></li></ul><p>四种调用方式都各有优缺点，很难说异步方式一定会比同步方式效果好，在不用的业务场景可以按需选取更合适的调用方式。</p><h2 id="实现"><a class="anchor" href="#实现">#</a> 实现</h2><p>本项目实现的是第一种 Sync 同步调用。具体的实现逻辑在类  <code>com.wxy.rpc.client.transport.netty.NettyRpcClient</code>  中，使用  <code>io.netty.util.concurrent.Promise</code>  去接受响应结果，将暂未处理的 <code>RpcResponse</code> 根据 <code>sequenceId</code> 信息存入 <code>ConcurrentHashMap</code>  中， <code>RpcResponseHadler</code>  根据  <code>sequenceId</code>  取出  <code>Promise</code>  对象存储的未处理的响应消息，处理后通过设置  <code>promise</code> 的状态来 <code>notify</code> 等待结果的线程并返回，核心代码如下：</p><figure class="highlight java"><figcaption data-lang="java"><span>title:NettyRpcClient</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NettyRpcClient</span> <span class="token keyword">implements</span> <span class="token class-name">RpcClient</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    </pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token comment">// ....</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    </pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">RpcMessage</span> <span class="token function">sendRpcRequest</span><span class="token punctuation">(</span><span class="token class-name">RequestMetadata</span> requestMetadata<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token comment">// 构建接收返回结果的 promise</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token class-name">Promise</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RpcMessage</span><span class="token punctuation">></span></span> promise<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token comment">// 获取 Channel 对象</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> <span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span>requestMetadata<span class="token punctuation">.</span><span class="token function">getServerAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestMetadata<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>channel<span class="token punctuation">.</span><span class="token function">isActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token comment">// 创建 promise 来接受结果         指定执行完成通知的线程</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultPromise</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>channel<span class="token punctuation">.</span><span class="token function">eventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            <span class="token comment">// 获取请求的序列号 ID</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            <span class="token keyword">int</span> sequenceId <span class="token operator">=</span> requestMetadata<span class="token punctuation">.</span><span class="token function">getRpcMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSequenceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token comment">// 存入还未处理的请求</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token class-name">RpcResponseHandler</span><span class="token punctuation">.</span><span class="token constant">UNPROCESSED_RPC_RESPONSES</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>sequenceId<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token comment">// 发送数据并监听发送状态</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            channel<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span>requestMetadata<span class="token punctuation">.</span><span class="token function">getRpcMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ChannelFutureListener</span><span class="token punctuation">)</span> future <span class="token operator">-></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>future<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>                    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"The client send the message successfully, msg: [&#123;&#125;]."</span><span class="token punctuation">,</span> requestMetadata<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>                    future<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>                    promise<span class="token punctuation">.</span><span class="token function">setFailure</span><span class="token punctuation">(</span>future<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>                    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"The client send the message failed."</span><span class="token punctuation">,</span> future<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>            <span class="token comment">// 等待结果返回（让出 cpu 资源，同步阻塞调用线程 main，其他线程去执行获取操作（eventLoop））</span></pre></td></tr><tr><td data-num="29"></td><td><pre>            promise<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>promise<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>                <span class="token comment">// 返回响应结果</span></pre></td></tr><tr><td data-num="32"></td><td><pre>                <span class="token keyword">return</span> promise<span class="token punctuation">.</span><span class="token function">getNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RpcException</span><span class="token punctuation">(</span>promise<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"The channel is inactivate."</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    </pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token comment">// ....</span></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h1 id="自定义注解集成到spring"><a class="anchor" href="#自定义注解集成到spring">#</a> 自定义注解集成到 Spring</h1><h2 id="自定义注解"><a class="anchor" href="#自定义注解">#</a> 自定义注解</h2><p>创建一个 @interface 的注解，然后就可以使用这个注解了，但是什么功能也没有</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">METHOD</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token annotation punctuation">@Inherited</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token annotation punctuation">@Documented</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">AnnotationTest</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token class-name">String</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span><span class="token string">""</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><ul><li>访问修饰符必须为 public, 不写默认为 public</li><li>关键字为 @interface</li><li>注解类型元素是注解中内容，根据需要标志参数，例如上面的注解的 value</li></ul><p>@Target、@Retention、@Inherited、@Documented，这四个注解就是元注解，元注解的作用就是负责注解其他注解</p><ul><li><p><strong>@Target</strong>：用于描述注解的使用范围，该注解可以使用在什么地方。多见 <code>ElementType.TYPE</code> 应用于类、接口（包括注解类型）、枚举 ； <code>ElementType.METHOD</code> 应用于方法，还有变量、包、形参等等，详细面向搜索引擎</p></li><li><p><strong>@Retention</strong>：表明该注解的生命周期。</p></li></ul><table><thead><tr><th>生命周期类型</th><th>描述</th></tr></thead><tbody><tr><td>RetentionPolicy.SOURCE</td><td>编译时被丢弃，不包含在类文件中</td></tr><tr><td>RetentionPolicy.CLASS</td><td>JVM 加载时被丢弃，包含在类文件中，默认值</td></tr><tr><td>RetentionPolicy.RUNTIME</td><td>由 JVM 加载，包含在类文件中，在运行时可以被获取到</td></tr></tbody></table><ul><li><p><strong>@Inherited</strong>：是一个标记注解，@Inherited 阐述了某个被标注的类型是被继承的。如果一个使用了 @Inherited 修饰的 annotation 类型被用于一个 class，则这个 annotation 将被用于该 class 的子类。</p></li><li><p><strong>@Documented</strong>：表明该注解标记的元素可以被 Javadoc 或类似的工具文档化</p></li></ul><h2 id="实现案例"><a class="anchor" href="#实现案例">#</a> 实现案例</h2><p>要想实现功能，需要我们通过拦截器、AOP 切面这些地方获取注解标志，然后实现我们的功能。</p><p>例如有个项目，前端是把 token 放到 json 里面传到后端（也有一些项目放到请求头的 header 里面，方式一样），没用注解之前，我们可能是通过调用公共的方法去校验 token, 如 validateToken (token)，然后每个接口都有这一段代码，我们用注解的模式替换</p><ol><li>首先我们创建一个注解，标志那些类需要校验 token</li></ol><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">METHOD</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">AppAuthenticationValidate</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">// 必填参数</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">requestParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><ol start="2"><li>然后再创建一个 AOP 切面类来拦截这个注解<br>拦截使用这个注解的方法，同时获取注解上面的 requestParams 参数，校验 json 里面必填的属性是否存在</li></ol><figure class="highlight java"><figcaption data-lang="java"><span>title:AppAuthenticationValidateAspect</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Aspect</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@Component</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token annotation punctuation">@Slf4j</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AppAuthenticationValidateAspect</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token annotation punctuation">@Reference</span><span class="token punctuation">(</span>check <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> timeout <span class="token operator">=</span> <span class="token number">18000</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">CommonUserService</span> commonUserService<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>	<span class="token annotation punctuation">@Before</span><span class="token punctuation">(</span><span class="token string">"@annotation(cn.com.bluemoon.admin.web.common.aspect.AppAuthenticationValidate)"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">repeatSumbitIntercept</span><span class="token punctuation">(</span> <span class="token class-name">JoinPoint</span> joinPoint<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token comment">// 获取接口的参数</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> o <span class="token operator">=</span> joinPoint<span class="token punctuation">.</span><span class="token function">getArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token class-name">JSONObject</span> jsonObject <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> parameterNames <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">CodeSignature</span><span class="token punctuation">)</span> joinPoint<span class="token punctuation">.</span><span class="token function">getSignature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getParameterNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token class-name">String</span> source <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>parameterNames<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token class-name">String</span> paramName <span class="token operator">=</span> parameterNames<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>            <span class="token keyword">if</span><span class="token punctuation">(</span>paramName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"source"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>                <span class="token comment">// 获取 token 来源</span></pre></td></tr><tr><td data-num="22"></td><td><pre>                source <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span>o<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>            <span class="token keyword">if</span><span class="token punctuation">(</span>paramName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"jsonObject"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>                jsonObject <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">JSONObject</span><span class="token punctuation">)</span> o<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span>jsonObject <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">WebException</span><span class="token punctuation">(</span><span class="token class-name">ResponseConstant</span><span class="token punctuation">.</span><span class="token constant">ILLEGAL_PARAM_CODE</span><span class="token punctuation">,</span> <span class="token class-name">ResponseConstant</span><span class="token punctuation">.</span><span class="token constant">ILLEGAL_PARAM_MSG</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token class-name">String</span> token <span class="token operator">=</span> jsonObject<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"token"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">WebException</span><span class="token punctuation">(</span><span class="token class-name">ResponseConstant</span><span class="token punctuation">.</span><span class="token constant">TOKEN_EXPIRED_CODE</span><span class="token punctuation">,</span><span class="token string">"登录超时，请重新登录"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token class-name">MethodSignature</span> signature <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">MethodSignature</span><span class="token punctuation">)</span> joinPoint<span class="token punctuation">.</span><span class="token function">getSignature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token class-name">Method</span> method <span class="token operator">=</span> signature<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token class-name">AppAuthenticationValidate</span> annotation <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">AppAuthenticationValidate</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> requestParams <span class="token operator">=</span> annotation<span class="token punctuation">.</span><span class="token function">requestParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token comment">// 校验必填参数</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token class-name">ParamsValidateUtil</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>jsonObject<span class="token punctuation">,</span>requestParams<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token class-name">ResponseBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> response <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>            response <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>commonUserService<span class="token punctuation">.</span><span class="token function">checkAppToken</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>            response <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>commonUserService<span class="token punctuation">.</span><span class="token function">checkAppTokenByAppType</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="48"></td><td><pre></pre></td></tr><tr><td data-num="49"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getIsSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">ResponseConstant</span><span class="token punctuation">.</span><span class="token constant">REQUEST_SUCCESS_CODE</span> <span class="token operator">==</span> response<span class="token punctuation">.</span><span class="token function">getResponseCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>            <span class="token class-name">String</span> empCode <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"---token =&#123;&#125;， empCode=&#123;&#125;--"</span><span class="token punctuation">,</span> token<span class="token punctuation">,</span> empCode<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>            jsonObject<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProcessParamConstant</span><span class="token punctuation">.</span><span class="token constant">APP_EMP_CODE</span><span class="token punctuation">,</span>empCode<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"---token验证不通过，token =&#123;&#125;---"</span><span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">WebException</span><span class="token punctuation">(</span><span class="token class-name">ResponseConstant</span><span class="token punctuation">.</span><span class="token constant">TOKEN_EXPIRED_CODE</span><span class="token punctuation">,</span> <span class="token string">"登录超时，请重新登录"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="58"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><ol start="3"><li>把注解加在需要校验的接口方法上</li></ol><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@AppAuthenticationValidate</span><span class="token punctuation">(</span>requestParams <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"billId"</span><span class="token punctuation">,</span> <span class="token string">"taskId"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>这个注解同时校验了必填字段，校验完 token 后同时会把 token 的用户信息加在 json 对象里面</p><h2 id="本项目中的实现"><a class="anchor" href="#本项目中的实现">#</a> 本项目中的实现</h2><p>在 Java 中为了让注解生效，需要利用到反射，但是当我们使用到 Spring 或者 Spring Boot 时，我们可以使用 Spring 的一些机制让自定义注解通过 @Import 注解完成一些操作</p><ul><li>@RpcComponentScan - 扫描被 @RpcService 标注的组件并将对应的 BeanDefiniton 对象注册到 Spring。</li></ul><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">TYPE</span><span class="token punctuation">)</span>  </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span>  </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token annotation punctuation">@Documented</span>  </pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token annotation punctuation">@Inherited</span>  </pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token annotation punctuation">@Import</span><span class="token punctuation">(</span><span class="token class-name">RpcBeanDefinitionRegistrar</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>  </pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">RpcComponentScan</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="7"></td><td><pre>  </pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token doc-comment comment">/**  </span></pre></td></tr><tr><td data-num="9"></td><td><pre>     * 扫描包路径  </pre></td></tr><tr><td data-num="10"></td><td><pre>     */  </pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token annotation punctuation">@AliasFor</span><span class="token punctuation">(</span><span class="token string">"basePackages"</span><span class="token punctuation">)</span>  </pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="13"></td><td><pre>  </pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token doc-comment comment">/**  </span></pre></td></tr><tr><td data-num="15"></td><td><pre>     * 扫描包路径  </pre></td></tr><tr><td data-num="16"></td><td><pre>     */  </pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token annotation punctuation">@AliasFor</span><span class="token punctuation">(</span><span class="token string">"value"</span><span class="token punctuation">)</span>  </pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">basePackages</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="19"></td><td><pre>  </pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight java"><figcaption data-lang="java"><span>title:RpcBeanDefinitionRegistrar</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 这里不需要 @Configuration 注解，因为我们已经通过 @Import 注解将操作引导本类中了</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@Slf4j</span>  </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RpcBeanDefinitionRegistrar</span> <span class="token keyword">implements</span> <span class="token class-name">ImportBeanDefinitionRegistrar</span><span class="token punctuation">,</span> <span class="token class-name">ResourceLoaderAware</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="4"></td><td><pre>  </pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">ResourceLoader</span> resourceLoader<span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="6"></td><td><pre>  </pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token annotation punctuation">@Override</span>  </pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setResourceLoader</span><span class="token punctuation">(</span><span class="token class-name">ResourceLoader</span> resourceLoader<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>resourceLoader <span class="token operator">=</span> resourceLoader<span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="11"></td><td><pre>  </pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token doc-comment comment">/**  </span></pre></td></tr><tr><td data-num="13"></td><td><pre>     * 此方法会在 spring 自定义扫描执行之后执行，这个时候 beanDefinitionMap 已经有扫描到的 beanDefinition 对象了  </pre></td></tr><tr><td data-num="14"></td><td><pre>     *  </pre></td></tr><tr><td data-num="15"></td><td><pre>     * <span class="token keyword">@param</span> <span class="token parameter">annotationMetadata</span> annotation metadata of the importing class  </pre></td></tr><tr><td data-num="16"></td><td><pre>     * <span class="token keyword">@param</span> <span class="token parameter">registry</span>           current bean definition registry  </pre></td></tr><tr><td data-num="17"></td><td><pre>     */    </pre></td></tr><tr><td data-num="18"></td><td><pre>     <span class="token annotation punctuation">@Override</span>  </pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">AnnotationMetadata</span> annotationMetadata<span class="token punctuation">,</span> <span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token comment">// 获取 RpcComponentScan 注解的属性和值  </span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token class-name">AnnotationAttributes</span> annotationAttributes <span class="token operator">=</span> <span class="token class-name">AnnotationAttributes</span><span class="token punctuation">.</span><span class="token function">fromMap</span><span class="token punctuation">(</span>annotationMetadata<span class="token punctuation">.</span><span class="token function">getAnnotationAttributes</span><span class="token punctuation">(</span><span class="token class-name">RpcComponentScan</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> basePackages <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>annotationAttributes <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="24"></td><td><pre>            <span class="token comment">// 此处去获取 RpcComponentScan 注解的 basePackages 值  </span></pre></td></tr><tr><td data-num="25"></td><td><pre>            basePackages <span class="token operator">=</span> annotationAttributes<span class="token punctuation">.</span><span class="token function">getStringArray</span><span class="token punctuation">(</span><span class="token string">"basePackages"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token comment">// 如果没有指定名称的话  </span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>basePackages<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="29"></td><td><pre>            basePackages <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">StandardAnnotationMetadata</span><span class="token punctuation">)</span> annotationMetadata<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getIntrospectedClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPackage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token comment">// 创建一个浏览 RpcService 注解的 Scanner        </span></pre></td></tr><tr><td data-num="32"></td><td><pre>		<span class="token comment">// 备注：此处可以继续扩展，例如扫描 spring bean 或者其他类型的 Scanner        </span></pre></td></tr><tr><td data-num="33"></td><td><pre>		<span class="token class-name">RpcClassPathBeanDefinitionScanner</span> rpcServiceScanner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RpcClassPathBeanDefinitionScanner</span><span class="token punctuation">(</span>registry<span class="token punctuation">,</span> <span class="token class-name">RpcService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="34"></td><td><pre>  </pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resourceLoader <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="36"></td><td><pre>            rpcServiceScanner<span class="token punctuation">.</span><span class="token function">setResourceLoader</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resourceLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="38"></td><td><pre>  </pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token comment">// 扫描包下的所有 Rpc bean 并返回注册成功的数量（scan 方法会调用 register 方法去注册扫描到的类并生成 BeanDefinition 注册到 spring 容器）  </span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token keyword">int</span> count <span class="token operator">=</span> rpcServiceScanner<span class="token punctuation">.</span><span class="token function">scan</span><span class="token punctuation">(</span>basePackages<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="41"></td><td><pre>        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"The number of BeanDefinition scanned and registered by RpcServiceScanner is &#123;&#125;."</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><ul><li>@RpcService - 该注解用来标注需要暴露的服务实现类，被标注的类将会被注入到 Spring 容器中，同时将对应服务信息注册到远程注册中心</li></ul><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">TYPE</span><span class="token punctuation">)</span>  </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span>  </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token annotation punctuation">@Documented</span>  </pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token annotation punctuation">@Inherited</span>  </pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">RpcService</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="6"></td><td><pre>  </pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token doc-comment comment">/**  </span></pre></td></tr><tr><td data-num="8"></td><td><pre>     * 对外暴露服务的接口类型，默认为 void.class  </pre></td></tr><tr><td data-num="9"></td><td><pre>     */    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> <span class="token function">interfaceClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token keyword">void</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="10"></td><td><pre>  </pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token doc-comment comment">/**  </span></pre></td></tr><tr><td data-num="12"></td><td><pre>     * 对外暴露服务的接口名（全限定名），默认为 ""  </pre></td></tr><tr><td data-num="13"></td><td><pre>     */    <span class="token class-name">String</span> <span class="token function">interfaceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">""</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="14"></td><td><pre>  </pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token doc-comment comment">/**  </span></pre></td></tr><tr><td data-num="16"></td><td><pre>     * 版本号，默认 1.0  </pre></td></tr><tr><td data-num="17"></td><td><pre>     */    <span class="token class-name">String</span> <span class="token function">version</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">"1.0"</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这两个是怎么关联的？</p><ul><li>BeanPostProcessor，“对象创建后处理器”，<strong>BBP 是连接 IOC 和 AOP 的桥梁。</strong> 详解见<span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8zODIwODMyNA==">参考 1</span> ，<span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vdHV5YW5nMTEyOS9wLzEyODY2NDg0Lmh0bWw=">参考 2</span></li><li>依赖了 rpcServer？</li></ul><figure class="highlight java"><figcaption data-lang="java"><span>title:RpcServerBeanPostProcessor</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Slf4j</span>  </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RpcServerBeanPostProcessor</span> <span class="token keyword">implements</span> <span class="token class-name">BeanPostProcessor</span><span class="token punctuation">,</span> <span class="token class-name">CommandLineRunner</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="3"></td><td><pre>  </pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ServiceRegistry</span> serviceRegistry<span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="5"></td><td><pre>  </pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">RpcServer</span> rpcServer<span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="7"></td><td><pre>  </pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">RpcServerProperties</span> properties<span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="9"></td><td><pre>  </pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">RpcServerBeanPostProcessor</span><span class="token punctuation">(</span><span class="token class-name">ServiceRegistry</span> serviceRegistry<span class="token punctuation">,</span> <span class="token class-name">RpcServer</span> rpcServer<span class="token punctuation">,</span> <span class="token class-name">RpcServerProperties</span> properties<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>serviceRegistry <span class="token operator">=</span> serviceRegistry<span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>rpcServer <span class="token operator">=</span> rpcServer<span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>properties <span class="token operator">=</span> properties<span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="15"></td><td><pre>  </pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token doc-comment comment">/**  </span></pre></td></tr><tr><td data-num="17"></td><td><pre>     * 在 bean 实例化后，初始化后，检测标注有 @RpcService 注解的类，将对应的服务类进行注册，对外暴露服务，同时进行本地服务注册  </pre></td></tr><tr><td data-num="18"></td><td><pre>     *  </pre></td></tr><tr><td data-num="19"></td><td><pre>     * <span class="token keyword">@param</span> <span class="token parameter">bean</span>     bean  </pre></td></tr><tr><td data-num="20"></td><td><pre>     * <span class="token keyword">@param</span> <span class="token parameter">beanName</span> beanName  </pre></td></tr><tr><td data-num="21"></td><td><pre>     * <span class="token keyword">@return</span> 返回增强后的 bean  </pre></td></tr><tr><td data-num="22"></td><td><pre>     * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">BeansException</span></span> Bean 异常  </pre></td></tr><tr><td data-num="23"></td><td><pre>     */  </pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token annotation punctuation">@SneakyThrows</span>  </pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">postProcessAfterInitialization</span><span class="token punctuation">(</span><span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token comment">// 判断当前 bean 是否被 @RpcService 注解标注  </span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAnnotationPresent</span><span class="token punctuation">(</span><span class="token class-name">RpcService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="28"></td><td><pre>            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"[&#123;&#125;] is annotated with [&#123;&#125;]."</span><span class="token punctuation">,</span> bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">RpcService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getCanonicalName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="29"></td><td><pre>            <span class="token comment">// 获取到该类的 @RpcService 注解  </span></pre></td></tr><tr><td data-num="30"></td><td><pre>            <span class="token class-name">RpcService</span> rpcService <span class="token operator">=</span> bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">RpcService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="31"></td><td><pre>            <span class="token class-name">String</span> interfaceName<span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="32"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>rpcService<span class="token punctuation">.</span><span class="token function">interfaceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="33"></td><td><pre>                interfaceName <span class="token operator">=</span> rpcService<span class="token punctuation">.</span><span class="token function">interfaceClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="34"></td><td><pre>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="35"></td><td><pre>                interfaceName <span class="token operator">=</span> rpcService<span class="token punctuation">.</span><span class="token function">interfaceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="36"></td><td><pre>            <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="37"></td><td><pre>            <span class="token class-name">String</span> version <span class="token operator">=</span> rpcService<span class="token punctuation">.</span><span class="token function">version</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="38"></td><td><pre>            <span class="token class-name">String</span> serviceName <span class="token operator">=</span> <span class="token class-name">ServiceUtil</span><span class="token punctuation">.</span><span class="token function">serviceKey</span><span class="token punctuation">(</span>interfaceName<span class="token punctuation">,</span> version<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="39"></td><td><pre>            <span class="token comment">// 构建 ServiceInfo 对象  </span></pre></td></tr><tr><td data-num="40"></td><td><pre>            <span class="token class-name">ServiceInfo</span> serviceInfo <span class="token operator">=</span> <span class="token class-name">ServiceInfo</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  </pre></td></tr><tr><td data-num="41"></td><td><pre>                    <span class="token punctuation">.</span><span class="token function">appName</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">getAppName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  </pre></td></tr><tr><td data-num="42"></td><td><pre>                    <span class="token punctuation">.</span><span class="token function">serviceName</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">)</span>  </pre></td></tr><tr><td data-num="43"></td><td><pre>                    <span class="token punctuation">.</span><span class="token function">version</span><span class="token punctuation">(</span>version<span class="token punctuation">)</span>  </pre></td></tr><tr><td data-num="44"></td><td><pre>                    <span class="token punctuation">.</span><span class="token function">address</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  </pre></td></tr><tr><td data-num="45"></td><td><pre>                    <span class="token punctuation">.</span><span class="token function">port</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  </pre></td></tr><tr><td data-num="46"></td><td><pre>                    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="47"></td><td><pre>            <span class="token comment">// 进行远程服务注册  </span></pre></td></tr><tr><td data-num="48"></td><td><pre>            serviceRegistry<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>serviceInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="49"></td><td><pre>            <span class="token comment">// 进行本地服务缓存注册  </span></pre></td></tr><tr><td data-num="50"></td><td><pre>            <span class="token class-name">LocalServiceCache</span><span class="token punctuation">.</span><span class="token function">addService</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> bean<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="51"></td><td><pre>        <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="52"></td><td><pre>        <span class="token keyword">return</span> bean<span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="54"></td><td><pre>  </pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token doc-comment comment">/**  </span></pre></td></tr><tr><td data-num="56"></td><td><pre>     * 开机自启动 - 此方法实现于 <span class="token punctuation">&#123;</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">CommandLineRunner</span></span><span class="token punctuation">&#125;</span> 接口，基于 springboot  </pre></td></tr><tr><td data-num="57"></td><td><pre>     *     * @param args incoming main method arguments 命令行参数  </pre></td></tr><tr><td data-num="58"></td><td><pre>     * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">Exception</span></span> 启动异常  </pre></td></tr><tr><td data-num="59"></td><td><pre>     */  </pre></td></tr><tr><td data-num="60"></td><td><pre>    <span class="token annotation punctuation">@Override</span>  </pre></td></tr><tr><td data-num="61"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="62"></td><td><pre>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> rpcServer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="63"></td><td><pre>        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Rpc server [&#123;&#125;] start, the appName is &#123;&#125;, the port is &#123;&#125;"</span><span class="token punctuation">,</span>  </pre></td></tr><tr><td data-num="64"></td><td><pre>                rpcServer<span class="token punctuation">,</span> properties<span class="token punctuation">.</span><span class="token function">getAppName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> properties<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="65"></td><td><pre>        <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addShutdownHook</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="66"></td><td><pre>            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="67"></td><td><pre>                <span class="token comment">// 当服务关闭之后，将服务从 注册中心 上清除（关闭连接）  </span></pre></td></tr><tr><td data-num="68"></td><td><pre>                serviceRegistry<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="69"></td><td><pre>            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="70"></td><td><pre>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="71"></td><td><pre>            <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="72"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="73"></td><td><pre>    <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="74"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><ul><li>@RpcReference - 服务注入注解，被标注的属性将自动注入服务的实现类（基于动态代理实现）</li></ul><figure class="highlight java"><figcaption data-lang="java"><span>title:RpcReference</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">FIELD</span><span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">METHOD</span><span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">ANNOTATION_TYPE</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>  </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span>  </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token annotation punctuation">@Documented</span>  </pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token annotation punctuation">@Inherited</span>  </pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">RpcReference</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="6"></td><td><pre>  </pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token doc-comment comment">/**  </span></pre></td></tr><tr><td data-num="8"></td><td><pre>     * 对外暴露服务的接口类型，默认为 void.class  </pre></td></tr><tr><td data-num="9"></td><td><pre>     */    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> <span class="token function">interfaceClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token keyword">void</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="10"></td><td><pre>  </pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token doc-comment comment">/**  </span></pre></td></tr><tr><td data-num="12"></td><td><pre>     * 对外暴露服务的接口名（全限定名），默认为 ""  </pre></td></tr><tr><td data-num="13"></td><td><pre>     */    <span class="token class-name">String</span> <span class="token function">interfaceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">""</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="14"></td><td><pre>  </pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token doc-comment comment">/**  </span></pre></td></tr><tr><td data-num="16"></td><td><pre>     * 版本号，默认 1.0  </pre></td></tr><tr><td data-num="17"></td><td><pre>     */    <span class="token class-name">String</span> <span class="token function">version</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">"1.0"</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="18"></td><td><pre>  </pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token doc-comment comment">/**  </span></pre></td></tr><tr><td data-num="20"></td><td><pre>     * 负载均衡策略，合法的值包括：random, roundrobin, leastactive  </pre></td></tr><tr><td data-num="21"></td><td><pre>     */    <span class="token class-name">String</span> <span class="token function">loadbalance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">""</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="22"></td><td><pre>  </pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token doc-comment comment">/**  </span></pre></td></tr><tr><td data-num="24"></td><td><pre>     * Service mock name, use interface name + Mock if not set     */    <span class="token class-name">String</span> <span class="token function">mock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">""</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="25"></td><td><pre>  </pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token doc-comment comment">/**  </span></pre></td></tr><tr><td data-num="27"></td><td><pre>     * 服务调用超时时间  </pre></td></tr><tr><td data-num="28"></td><td><pre>     */  </pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token keyword">int</span> <span class="token function">timeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token number">0</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="30"></td><td><pre>  </pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight java"><figcaption data-lang="java"><span>title:RpcClientBeanPostProcessor</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RpcClientBeanPostProcessor</span> <span class="token keyword">implements</span> <span class="token class-name">BeanPostProcessor</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="2"></td><td><pre>  </pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ClientStubProxyFactory</span> proxyFactory<span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="4"></td><td><pre>  </pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">RpcClientBeanPostProcessor</span><span class="token punctuation">(</span><span class="token class-name">ClientStubProxyFactory</span> proxyFactory<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>proxyFactory <span class="token operator">=</span> proxyFactory<span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="8"></td><td><pre>  </pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token doc-comment comment">/**  </span></pre></td></tr><tr><td data-num="10"></td><td><pre>     * 在 bean 实例化完后，扫描 bean 中需要进行 rpc 注入的属性，将对应的属性使用 代理对象 进行替换  </pre></td></tr><tr><td data-num="11"></td><td><pre>     *  </pre></td></tr><tr><td data-num="12"></td><td><pre>     * <span class="token keyword">@param</span> <span class="token parameter">bean</span>     bean 对象  </pre></td></tr><tr><td data-num="13"></td><td><pre>     * <span class="token keyword">@param</span> <span class="token parameter">beanName</span> bean 名称  </pre></td></tr><tr><td data-num="14"></td><td><pre>     * <span class="token keyword">@return</span> 后置增强后的 bean 对象  </pre></td></tr><tr><td data-num="15"></td><td><pre>     * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">BeansException</span></span> bean 异常  </pre></td></tr><tr><td data-num="16"></td><td><pre>     */  </pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token annotation punctuation">@Override</span>  </pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">postProcessAfterInitialization</span><span class="token punctuation">(</span><span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token comment">// 获取该 bean 的类的所有属性（getFields - 获取所有的 public 属性，getDeclaredFields - 获取所有声明的属性，不区分访问修饰符）  </span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token class-name">Field</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token comment">// 遍历所有属性  </span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Field</span> field <span class="token operator">:</span> fields<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="23"></td><td><pre>            <span class="token comment">// 判断是否被 RpcReference 注解标注  </span></pre></td></tr><tr><td data-num="24"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>field<span class="token punctuation">.</span><span class="token function">isAnnotationPresent</span><span class="token punctuation">(</span><span class="token class-name">RpcReference</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="25"></td><td><pre>                <span class="token comment">// 获得 RpcReference 注解  </span></pre></td></tr><tr><td data-num="26"></td><td><pre>                <span class="token class-name">RpcReference</span> rpcReference <span class="token operator">=</span> field<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">RpcReference</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="27"></td><td><pre>                <span class="token comment">// 默认类为属性当前类型  </span></pre></td></tr><tr><td data-num="28"></td><td><pre>                <span class="token comment">// filed.class = java.lang.reflect.Field  </span></pre></td></tr><tr><td data-num="29"></td><td><pre>                <span class="token comment">// filed.type = com.wxy.xxx.service.XxxService                Class&lt;?> clazz = field.getType();  </span></pre></td></tr><tr><td data-num="30"></td><td><pre>                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="31"></td><td><pre>                    <span class="token comment">// 如果指定了全限定类型接口名  </span></pre></td></tr><tr><td data-num="32"></td><td><pre>                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token string">""</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>rpcReference<span class="token punctuation">.</span><span class="token function">interfaceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="33"></td><td><pre>                        clazz <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>rpcReference<span class="token punctuation">.</span><span class="token function">interfaceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="34"></td><td><pre>                    <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="35"></td><td><pre>                    <span class="token comment">// 如果指定了接口类型  </span></pre></td></tr><tr><td data-num="36"></td><td><pre>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>rpcReference<span class="token punctuation">.</span><span class="token function">interfaceClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">void</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="37"></td><td><pre>                        clazz <span class="token operator">=</span> rpcReference<span class="token punctuation">.</span><span class="token function">interfaceClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="38"></td><td><pre>                    <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="39"></td><td><pre>                    <span class="token comment">// 获取指定类型的代理对象  </span></pre></td></tr><tr><td data-num="40"></td><td><pre>                    <span class="token class-name">Object</span> proxy <span class="token operator">=</span> proxyFactory<span class="token punctuation">.</span><span class="token function">getProxy</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> rpcReference<span class="token punctuation">.</span><span class="token function">version</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="41"></td><td><pre>                    <span class="token comment">// 关闭安全检查  </span></pre></td></tr><tr><td data-num="42"></td><td><pre>                    field<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="43"></td><td><pre>                    <span class="token comment">// 设置域的值为代理对象  </span></pre></td></tr><tr><td data-num="44"></td><td><pre>                    field<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>bean<span class="token punctuation">,</span> proxy<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="45"></td><td><pre>                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> <span class="token operator">|</span> <span class="token class-name">IllegalAccessException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="46"></td><td><pre>                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RpcException</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"Failed to obtain proxy object, the type of field %s is %s, "</span> <span class="token operator">+</span>  </pre></td></tr><tr><td data-num="47"></td><td><pre>                            <span class="token string">"and the specified loaded proxy type is %s."</span><span class="token punctuation">,</span> field<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> field<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> clazz<span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="48"></td><td><pre>                <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="49"></td><td><pre>            <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="50"></td><td><pre>        <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="51"></td><td><pre>        <span class="token keyword">return</span> bean<span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="53"></td><td><pre>  </pre></td></tr><tr><td data-num="54"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="自动配置"><a class="anchor" href="#自动配置">#</a> 自动配置</h2><p>实现  <code>rpc-client</code>  和  <code>rpc-server</code>  的  <code>starter</code>  模块，编写对应的自动配置的配置类以及  <code>spring.factories</code>  文件，引入对应的 <code>starter</code>  即可完成自动配置功能。</p><ul><li>咩意思呀？</li></ul><h1 id="梳理"><a class="anchor" href="#梳理">#</a> 梳理</h1><p>实现参考太复杂了，对我而言解释不够多，跟跳级了似的... 但又没时间从 0 开始。大概模块原理上面梳理了，但不像 x 马那种教程，有完整的环节，因此需要对着流程步骤一步步梳理源码，理解彼此建立联系的过程</p><p>首先是相对简单的<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL1NuYWlsY2xpbWIvZ3VpZGUtcnBjLWZyYW1ld29yaw==">这个</span>，没有自定义协议，网络传输用的<strong> Netty</strong>、序列化用的<strong> Kyro</strong>、注册中心<strong> Zookeeper</strong>、集成了 Spring 注解</p><p><strong>在客户端中</strong></p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SocketClientMain</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token class-name">RpcRequestTransport</span> rpcRequestTransport <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SocketRpcClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token class-name">RpcServiceConfig</span> rpcServiceConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RpcServiceConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token class-name">RpcClientProxy</span> rpcClientProxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RpcClientProxy</span><span class="token punctuation">(</span>rpcRequestTransport<span class="token punctuation">,</span> rpcServiceConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token class-name">HelloService</span> helloService <span class="token operator">=</span> rpcClientProxy<span class="token punctuation">.</span><span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token class-name">HelloService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token class-name">String</span> hello <span class="token operator">=</span> helloService<span class="token punctuation">.</span><span class="token function">hello</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Hello</span><span class="token punctuation">(</span><span class="token string">"111"</span><span class="token punctuation">,</span> <span class="token string">"222"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>hello<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><ol><li>创建了一个 RPC 请求发送器 <code>RpcRequestTransport</code> (接口)，基于 <code>SocketRpcClient</code> (实现，还有个基于 Netty 的 <code>NettyRpcClient</code> )，里面实现了 <code>sendRpcRequest</code> 函数，</li></ol></blockquote><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">sendRpcRequest</span><span class="token punctuation">(</span><span class="token class-name">RpcRequest</span> rpcRequest<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token class-name">InetSocketAddress</span> inetSocketAddress <span class="token operator">=</span> serviceDiscovery<span class="token punctuation">.</span><span class="token function">lookupService</span><span class="token punctuation">(</span>rpcRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">Socket</span> socket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="4"></td><td><pre>        socket<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>inetSocketAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token class-name">ObjectOutputStream</span> objectOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span>socket<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token comment">// Send data to the server through the output stream  </span></pre></td></tr><tr><td data-num="7"></td><td><pre>        objectOutputStream<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>rpcRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token class-name">ObjectInputStream</span> objectInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span>socket<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token comment">// Read RpcResponse from the input stream  </span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token keyword">return</span> objectInputStream<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> <span class="token operator">|</span> <span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RpcException</span><span class="token punctuation">(</span><span class="token string">"调用服务失败:"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><code>InetSocketAddress inetSocketAddress = serviceDiscovery.lookupService(rpcRequest);</code> 背后有一系列 RPC 服务的设置（如 zooker 地址、sleeptime、最大重试次数等）和负载均衡的处理，最后返回了 socket 连接的地址 <code>return new InetSocketAddress(host, port);</code> ，通过 socket 输入输出流，给服务端发送数据并得到发回的数据。这个逻辑很简单，但在实例化</p><blockquote><ol start="2"><li>封装了一层 <code>RpcClientProxy</code> ，存进 <code>rpcRequestTransport, rpcServiceConfig</code> ，将要实现的服务 <code>HelloService</code> 交给它代理</li></ol></blockquote><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">T</span> <span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> clazz<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span>clazz<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>clazz<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在调用 时就会执行代理中的 <code>invoke</code> 方法，在这个项目里进一步处理了要发送的 <code>rpcRequest</code> ，然后接收了 <code>rpcRequestTransport</code> 的返回值并回传，即 <code>String hello</code> 已经是服务端返回并处理后的结果了</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name">String</span> hello <span class="token operator">=</span> helloService<span class="token punctuation">.</span><span class="token function">hello</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Hello</span><span class="token punctuation">(</span><span class="token string">"111"</span><span class="token punctuation">,</span> <span class="token string">"222"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p><strong>在服务端中</strong></p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SocketServerMain</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token class-name">HelloService</span> helloService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HelloServiceImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token class-name">SocketRpcServer</span> socketRpcServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SocketRpcServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token class-name">RpcServiceConfig</span> rpcServiceConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RpcServiceConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="6"></td><td><pre>        rpcServiceConfig<span class="token punctuation">.</span><span class="token function">setService</span><span class="token punctuation">(</span>helloService<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="7"></td><td><pre>        socketRpcServer<span class="token punctuation">.</span><span class="token function">registerService</span><span class="token punctuation">(</span>rpcServiceConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="8"></td><td><pre>        socketRpcServer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>首先是提供功能的实现 (这一块拿出来放回客户端就是本地调用了)，然后服务端的 RPC 处理类的 <code>SocketRpcServer</code> 。 <code>RpcServiceConfig</code> 小套娃了一下，只是把要提供的服务实例放进去了，还设置了 group、version 等参数。重点是 <code>registerService</code> 将服务实例继续传入了处理类 <code>SocketRpcServer</code> ，里面隐藏了服务端的操作（像线程池，与 zookeeper 的连接，从 socket 监听接口获取数据，再回传的具体操作等等）, 最后 <code>start</code> 启动 <code>ServerSocket</code> 进行监听。</p><p>表层逻辑解析完了，重点还是两个 RPC 的实现 <code>SocketRpcClient,SocketRpcServer</code> ，明天继续。希望明年这个时候至少假期可以不泡实验室了，坚持... 个嘚，根据面经情况还得是保证能手撕算法先... 之前还是年前用 C++ 刷的代码随想录了，还要转 java，先优先把 LC 热题 100 再过一下吧...（4.4 留个 flag，这个 b 项目之后一定要做掉）</p></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">Edited on</span> <time title="Modified: 2024-04-04 15:40:30" itemprop="dateModified" datetime="2024-04-04T15:40:30+08:00">2024-04-04</time></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> Donate</button><p>Give me a cup of [coffee]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/images/wechatpay.jpg" alt="ZY WeChat Pay"><p>WeChat Pay</p></div></div></div><div id="copyright"><ul><li class="author"><strong>Post author: </strong>ZY <i class="ic i-at"><em>@</em></i>世界上只有一种真正的英雄主义，就是认清了生活的真相后还依然热爱它</li><li class="link"><strong>Post link: </strong><a href="https://zyakmd.github.io/2024/04/01/RPC%E9%A1%B9%E7%9B%AE/" title="RPC项目">https://zyakmd.github.io/2024/04/01/RPC项目/</a></li><li class="license"><strong>Copyright Notice: </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</a> unless stating additionally.</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2024/03/29/Docker/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;t.mwm.moe&#x2F;fj?769605" title="Docker"><span class="type">Previous Post</span> <span class="category"><i class="ic i-flag"></i></span><h3>Docker</h3></a></div><div class="item right"></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="Contents"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5"><span class="toc-number">1.</span> <span class="toc-text">概念</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%92%8Cmq%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">2.</span> <span class="toc-text">和 MQ 的区别</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A1%86%E6%9E%B6%E6%80%9D%E8%B7%AF"><span class="toc-number">3.</span> <span class="toc-text">框架思路</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%9B%AE%E6%A0%87%E5%92%8C%E5%86%85%E5%AE%B9"><span class="toc-number">4.</span> <span class="toc-text">目标和内容</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BE%9D%E8%B5%96%E7%9F%A5%E8%AF%86"><span class="toc-number">5.</span> <span class="toc-text">依赖知识</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#zookeeper"><span class="toc-number">5.1.</span> <span class="toc-text">ZooKeeper</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD"><span class="toc-number">5.1.1.</span> <span class="toc-text">功能</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E8%BF%9E%E6%8E%A5"><span class="toc-number">5.2.</span> <span class="toc-text">测试连接</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#netty"><span class="toc-number">5.3.</span> <span class="toc-text">Netty</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E5%8D%8F%E8%AE%AE-%E7%BC%96%E8%A7%A3%E7%A0%81"><span class="toc-number">6.</span> <span class="toc-text">消息协议、编解码</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E5%8D%8F%E8%AE%AE"><span class="toc-number">6.1.</span> <span class="toc-text">消息协议</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8D%8F%E8%AE%AE"><span class="toc-number">6.1.1.</span> <span class="toc-text">自定义协议</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E8%A7%A3%E7%A0%81"><span class="toc-number">6.2.</span> <span class="toc-text">编解码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#netty%E6%BA%90%E7%A0%81"><span class="toc-number">6.2.1.</span> <span class="toc-text">netty 源码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%AE%9E%E7%8E%B0"><span class="toc-number">6.2.2.</span> <span class="toc-text">自定义实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%AF%E8%83%BD%E5%AD%98%E5%9C%A8%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">6.2.3.</span> <span class="toc-text">可能存在的问题</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96%E7%AE%97%E6%B3%95"><span class="toc-number">7.</span> <span class="toc-text">序列化算法</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86"><span class="toc-number">8.</span> <span class="toc-text">动态代理</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E4%B8%8E%E5%8F%91%E7%8E%B0"><span class="toc-number">9.</span> <span class="toc-text">服务注册与发现</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#rpc%E8%B0%83%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="toc-number">10.</span> <span class="toc-text">RPC 调用方式</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-number">10.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0"><span class="toc-number">10.2.</span> <span class="toc-text">实现</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%B3%A8%E8%A7%A3%E9%9B%86%E6%88%90%E5%88%B0spring"><span class="toc-number">11.</span> <span class="toc-text">自定义注解集成到 Spring</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%B3%A8%E8%A7%A3"><span class="toc-number">11.1.</span> <span class="toc-text">自定义注解</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%A1%88%E4%BE%8B"><span class="toc-number">11.2.</span> <span class="toc-text">实现案例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%AC%E9%A1%B9%E7%9B%AE%E4%B8%AD%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">11.3.</span> <span class="toc-text">本项目中的实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E9%85%8D%E7%BD%AE"><span class="toc-number">11.4.</span> <span class="toc-text">自动配置</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A2%B3%E7%90%86"><span class="toc-number">12.</span> <span class="toc-text">梳理</span></a></li></ol></div><div class="related panel pjax" data-title="Related"></div><div class="overview panel" data-title="Overview"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="ZY" data-src="/images/avatar.jpg"><p class="name" itemprop="name">ZY</p><div class="description" itemprop="description">行到水穷处，坐看云起时</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">15</span> <span class="name">posts</span></a></div><div class="item categories"><a href="/categories/"><span class="count">2</span> <span class="name">categories</span></a></div><div class="item tags"><a href="/tags/"><span class="count">3</span> <span class="name">tags</span></a></div></nav><div class="social"><a href="https://github.com/zyakmd" title="https:&#x2F;&#x2F;github.com&#x2F;zyakmd" class="item github" rel="noopener" target="_blank"><i class="ic i-github"></i></a></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>Home</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>Posts</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>Archives</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>Categories</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>Tags</a></li></ul></li></ul></div></div></div><ul id="quick"><li class="prev pjax"></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>Random Posts</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/spring%E5%A4%8D%E4%B9%A0/" title="In spring复习">spring复习</a></div><span><a href="/2024/03/17/spring%E5%A4%8D%E4%B9%A0/SSM%E6%95%B4%E5%90%88/" title="SSM整合">SSM整合</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/spring%E5%A4%8D%E4%B9%A0/" title="In spring复习">spring复习</a></div><span><a href="/2024/03/15/spring%E5%A4%8D%E4%B9%A0/Spring%20MVC/" title="Spring MVC">Spring MVC</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/spring%E5%A4%8D%E4%B9%A0/" title="In spring复习">spring复习</a></div><span><a href="/2024/03/11/spring%E5%A4%8D%E4%B9%A0/Spring%20framework/" title="Spring framework">Spring framework</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/2024/03/22/%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE%E4%BC%98%E5%8C%96/" title="商城项目优化">商城项目优化</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/hexo%E4%BD%BF%E7%94%A8/" title="In hexo使用">hexo使用</a></div><span><a href="/2024/03/07/hexo%E4%BD%BF%E7%94%A8/%E5%9C%A8obisidian%E4%B8%8A%E4%BD%BF%E7%94%A8/" title="在obisidian上使用">在obisidian上使用</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/hexo%E4%BD%BF%E7%94%A8/" title="In hexo使用">hexo使用</a></div><span><a href="/2024/03/06/hexo%E4%BD%BF%E7%94%A8/hexo+github/" title="hexo + github 博客搭建">hexo + github 博客搭建</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/2024/03/21/Java%E7%AC%94%E8%AE%B0/" title="Java笔记">Java笔记</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/spring%E5%A4%8D%E4%B9%A0/" title="In spring复习">spring复习</a></div><span><a href="/2024/03/18/spring%E5%A4%8D%E4%B9%A0/Maven/" title="Maven">Maven</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/hexo%E4%BD%BF%E7%94%A8/" title="In hexo使用">hexo使用</a></div><span><a href="/2024/03/07/hexo%E4%BD%BF%E7%94%A8/%E7%BD%91%E7%AB%99%E6%A0%B7%E5%BC%8F/" title="网站样式">网站样式</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/2024/04/01/RPC%E9%A1%B9%E7%9B%AE/" title="RPC项目">RPC项目</a></span></li></ul></div></div><div class="status"><div class="copyright">&copy; 2023 – <span itemprop="copyrightYear">2024</span> <span class="with-love"><i class="ic i-"></i> </span><span class="author" itemprop="copyrightHolder">ZY @ ZY Blog</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="Symbols count total">468k words</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="Reading time total">7:05</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"2024/04/01/RPC项目/",favicon:{show:"（●´3｀●）Goooood",hide:"(´Д｀)Booooom"},search:{placeholder:"Search for Posts",empty:"We didn't find any results for the search: ${query}",stats:"${hits} results found in ${time} ms"},valine:!0,fancybox:!0,copyright:'Copied to clipboard successfully! <br> All articles in this blog are licensed under <i class="ic i-creative-commons"></i>BY-NC-SA.',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,debug:!1,model:{jsonPath:"/live2dw/assets/hijiki.model.json"},display:{position:"left",width:150,height:300},mobile:{show:!0},log:!1})</script></body></html><!-- rebuild by hrmmi -->